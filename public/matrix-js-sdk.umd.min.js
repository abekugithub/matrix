!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).matrixcs=t()}(this,function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;function t(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function r(e){return function(){var r=this,n=arguments;return new Promise(function(i,o){var s=e.apply(r,n);function a(e){t(s,i,o,a,c,"next",e)}function c(e){t(s,i,o,a,c,"throw",e)}a(void 0)})}}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e){var t=function(e,t){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t);if("object"!=n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==n(t)?t:t+""}function o(e,t,r){return(t=i(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var a,c,l={0:"O",1:"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ","ﱞ":"ﹲّ","ࣲ":"ٍ","ﱟ":"ﹴّ","ﳲ":"ﹷّ","ﱠ":"ﹶّ","ﳳ":"ﹹّ","ﱡ":"ﹸّ","ؚ":"ِ","̗":"ِ","ﳴ":"ﹻّ","ﱢ":"ﹺّ","ﱣ":"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\u2028":" ","\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":","ː":":","ꓽ":":","⩴":"::=","⧴":":→","！":"!","ǃ":"!","ⵑ":"!","‼":"!!","⁉":"!?","ʔ":"?","Ɂ":"?","ॽ":"?","Ꭾ":"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·","ᐧ":"·","⋯":"···","ⵈ":"···","ᑄ":"·<","⋗":"·>","ᐷ":"·>","ᑀ":"·>","ᔯ":"·4","ᑾ":"·b","ᒀ":"·ḃ","ᑺ":"·d","ᒘ":"·J","ᒶ":"·L","ᑶ":"·P","ᑗ":"·U","ᐺ":"·V","ᐼ":"·Ʌ","ᒮ":"·Γ","ᐎ":"·Δ","ᑙ":"·Ո","ᐌ":"·ᐁ","ᐐ":"·ᐄ","ᐒ":"·ᐅ","ᐔ":"·ᐆ","ᐗ":"·ᐊ","ᐙ":"·ᐋ","ᐾ":"·ᐲ","ᑂ":"·ᐴ","ᑆ":"·ᐹ","ᑛ":"·ᑏ","ᑔ":"·ᑐ","ᑝ":"·ᑐ","ᑟ":"·ᑑ","ᑡ":"·ᑕ","ᑣ":"·ᑖ","ᑴ":"·ᑫ","ᑸ":"·ᑮ","ᑼ":"·ᑰ","ᒒ":"·ᒉ","ᒔ":"·ᒋ","ᒖ":"·ᒌ","ᒚ":"·ᒎ","ᒜ":"·ᒐ","ᒞ":"·ᒑ","ᒬ":"·ᒣ","ᒰ":"·ᒦ","ᒲ":"·ᒧ","ᒴ":"·ᒨ","ᒸ":"·ᒫ","ᓉ":"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ","ᓋ":"·ᓇ","ᓍ":"·ᓈ","ᓜ":"·ᓓ","ᓞ":"·ᓕ","ᓠ":"·ᓖ","ᓢ":"·ᓗ","ᓤ":"·ᓘ","ᓦ":"·ᓚ","ᓨ":"·ᓛ","ᓶ":"·ᓭ","ᓸ":"·ᓯ","ᓺ":"·ᓰ","ᓼ":"·ᓱ","ᓾ":"·ᓲ","ᔀ":"·ᓴ","ᔂ":"·ᓵ","ᔗ":"·ᔐ","ᔙ":"·ᔑ","ᔛ":"·ᔒ","ᔝ":"·ᔓ","ᔟ":"·ᔔ","ᔡ":"·ᔕ","ᔣ":"·ᔖ","ᔱ":"·ᔨ","ᔳ":"·ᔩ","ᔵ":"·ᔪ","ᔷ":"·ᔫ","ᔹ":"·ᔭ","ᔻ":"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ","ᕎ":"·ᕌ","ᕛ":"·ᕚ","ᕨ":"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"'","＇":"'","‘":"'","’":"'","‛":"'","′":"'","‵":"'","՚":"'","׳":"'","`":"'","`":"'","｀":"'","´":"'","΄":"'","´":"'","᾽":"'","᾿":"'","῾":"'","ʹ":"'","ʹ":"'","ˈ":"'","ˊ":"'","ˋ":"'","˴":"'","ʻ":"'","ʽ":"'","ʼ":"'","ʾ":"'","ꞌ":"'","י":"'","ߴ":"'","ߵ":"'","ᑊ":"'","ᛌ":"'","𖽑":"'","𖽒":"'","᳓":"''",'"':"''","＂":"''","“":"''","”":"''","‟":"''","″":"''","‶":"''","〃":"''","״":"''","˝":"''","ʺ":"''","˶":"''","ˮ":"''","ײ":"''","‴":"'''","‷":"'''","⁗":"''''","Ɓ":"'B","Ɗ":"'D","ŉ":"'n","Ƥ":"'P","Ƭ":"'T","Ƴ":"'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬","く":"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/","〳":"/","Ⳇ":"/","ノ":"/","丿":"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\","﹨":"\\","∖":"\\","⟍":"\\","⧵":"\\","⧹":"\\","𝈏":"\\","𝈻":"\\","㇔":"\\","丶":"\\","⼂":"\\","⳹":"\\\\","⑊":"\\\\","⟈":"\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ","ъ":"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵","ð":"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<","ᐸ":"<","ᚲ":"<","⋖":"<·","Ⲵ":"<·","ᑅ":"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">","ᐳ":">","𖼿":">","ᑁ":">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー","ᅳ":"ー","ㅡ":"ー","一":"ー","⼀":"ー","ᆖ":"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ","ᆕ":"ーᅮ","ᅴ":"ー丨","ㅢ":"ー丨","ᆗ":"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2","Ƨ":"2","Ϩ":"2","Ꙅ":"2","ᒿ":"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁","ƻ":"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3","Ȝ":"3","Ʒ":"3","Ꝫ":"3","Ⳍ":"3","З":"3","Ӡ":"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂","Ҙ":"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4","Ꮞ":"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.","ᔰ":"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5","Ƽ":"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6","б":"6","Ꮾ":"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8","ȣ":"8","Ȣ":"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a","ａ":"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a","ɑ":"a","α":"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a","а":"a","ⷶ":"ͣ","Ａ":"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A","Α":"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A","А":"A","Ꭺ":"A","ᗅ":"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲","ǎ":"ă","Ǎ":"Ă","ȧ":"å","Ȧ":"Å","ẚ":"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA","æ":"ae","ӕ":"ae","Æ":"AE","Ӕ":"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ","ᗄ":"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b","Ƅ":"b","Ь":"b","Ꮟ":"b","ᑲ":"b","ᖯ":"b","Ｂ":"B","ℬ":"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B","Β":"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B","В":"B","Ᏼ":"B","ᗷ":"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B","ɓ":"b̔","ᑳ":"ḃ","ƃ":"b̄","Ƃ":"b̄","Б":"b̄","ƀ":"b̵","ҍ":"b̵","Ҍ":"b̵","ѣ":"b̵","Ѣ":"b̵","ᑿ":"b·","ᒁ":"ḃ·","ᒈ":"b'","Ы":"bl","в":"ʙ","ᏼ":"ʙ","ｃ":"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c","ϲ":"c","ⲥ":"c","с":"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C","Ｃ":"C","Ⅽ":"C","ℂ":"C","ℭ":"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C","С":"C","Ꮯ":"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠","ç":"c̦","ҫ":"c̦","Ç":"C̦","Ҫ":"C̦","Ƈ":"C'","℅":"c/o","℆":"c/u","🅭":"㏄\t⃝","⋴":"ꞓ","ɛ":"ꞓ","ε":"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ","є":"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ","Є":"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d","Ꮷ":"d","ᑯ":"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D","Ꭰ":"D","ᗞ":"D","ᗪ":"D","ꓓ":"D","ɗ":"d̔","ɖ":"d̨","ƌ":"d̄","đ":"d̵","Đ":"D̵","Ð":"D̵","Ɖ":"D̵","₫":"ḏ̵","ꝺ":"Ꝺ","ᑻ":"d·","ᒇ":"d'","ʤ":"dȝ","ǳ":"dz","ʣ":"dz","ǲ":"Dz","Ǳ":"DZ","ǆ":"dž","ǅ":"Dž","Ǆ":"DŽ","ʥ":"dʑ","ꭰ":"ᴅ","⸹":"ẟ","δ":"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ","ծ":"ẟ","ᕷ":"ẟ","℮":"e","ｅ":"e","ℯ":"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e","е":"e","ҽ":"e","ⷷ":"ͤ","⋿":"E","Ｅ":"E","ℰ":"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E","Ε":"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E","Е":"E","ⴹ":"E","Ꭼ":"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E","ě":"ĕ","Ě":"Ĕ","ɇ":"e̸","Ɇ":"E̸","ҿ":"ę","ꭼ":"ᴇ","ə":"ǝ","ә":"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ","ɚ":"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵","Ә":"Ə","𝈡":"Ɛ","ℇ":"Ɛ","Ԑ":"Ɛ","Ꮛ":"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ","з":"ɜ","ҙ":"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f","ſ":"f","ẝ":"f","ք":"f","𝈓":"F","ℱ":"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F","Ϝ":"F","𝟊":"F","ᖴ":"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F","ƒ":"f̦","Ƒ":"F̦","ᵮ":"f̴","℻":"FAX","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ʩ":"fŋ","ᖵ":"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ","ᖷ":"ꟻ","ｇ":"g","ℊ":"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g","ɡ":"g","ᶃ":"g","ƍ":"g","ց":"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G","Ꮐ":"G","Ᏻ":"G","ꓖ":"G","ᶢ":"ᵍ","ɠ":"g̔","ǧ":"ğ","Ǧ":"Ğ","ǵ":"ģ","ǥ":"g̵","Ǥ":"G̵","Ɠ":"G'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ","ｈ":"h","ℎ":"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h","һ":"h","հ":"h","Ꮒ":"h","Ｈ":"H","ℋ":"H","ℌ":"H","ℍ":"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H","Η":"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H","Н":"H","Ꮋ":"H","ᕼ":"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ","ɦ":"h̔","ꚕ":"h̔","Ᏺ":"h̔","Ⱨ":"H̩","Ң":"H̩","ħ":"h̵","ℏ":"h̵","ћ":"h̵","Ħ":"H̵","Ӊ":"H̦","Ӈ":"H̦","н":"ʜ","ꮋ":"ʜ","ң":"ʜ̩","ӊ":"ʜ̦","ӈ":"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ","Ꭸ":"Ⱶ","Ꮀ":"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i","ｉ":"i","ⅰ":"i","ℹ":"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i","ı":"i","𝚤":"i","ɪ":"i","ɩ":"i","ι":"i","ι":"i","ͺ":"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i","і":"i","ꙇ":"i","ӏ":"i","ꭵ":"i","Ꭵ":"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲","ǐ":"ĭ","Ǐ":"Ĭ","ɨ":"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii","ĳ":"ij","ⅳ":"iv","ⅸ":"ix","ｊ":"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j","ϳ":"j","ј":"j","Ｊ":"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J","Ј":"J","Ꭻ":"J","ᒍ":"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵","ᒙ":"J·","𝚥":"ȷ","յ":"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k","K":"K","Ｋ":"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K","Κ":"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K","К":"K","Ꮶ":"K","ᛕ":"K","ꓗ":"K","𐔘":"K","ƙ":"k̔","Ⱪ":"K̩","Қ":"K̩","₭":"K̵","Ꝁ":"K̵","Ҟ":"K̵","Ƙ":"K'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l",I:"l","Ｉ":"l","Ⅰ":"l","ℐ":"l","ℑ":"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l","Ɩ":"l","ｌ":"l","ⅼ":"l","ℓ":"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l","ǀ":"l","Ι":"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l","І":"l","Ӏ":"l","ו":"l","ן":"l","ا":"l","𞸀":"l","𞺀":"l","ﺎ":"l","ﺍ":"l","ߊ":"l","ⵏ":"l","ᛁ":"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L","ℒ":"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L","Ꮮ":"L","ᒪ":"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L","ﴼ":"l̋","ﴽ":"l̋","ł":"l̸","Ł":"L̸","ɭ":"l̨","Ɨ":"l̵","ƚ":"l̵","ɫ":"l̴","إ":"lٕ","ﺈ":"lٕ","ﺇ":"lٕ","ٳ":"lٕ","ŀ":"l·","Ŀ":"l·","ᒷ":"l·","🄂":"l,","⒈":"l.","ױ":"l'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点","ǉ":"lj","Ĳ":"lJ","ǈ":"Lj","Ǉ":"LJ","‖":"ll","∥":"ll","Ⅱ":"ll","ǁ":"ll","װ":"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点","Ю":"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点","ʪ":"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX","ɮ":"lȝ","ʫ":"lz","أ":"lٴ","ﺄ":"lٴ","ﺃ":"lٴ","ٲ":"lٴ","ٵ":"lٴ","ﷳ":"lكبر","ﷲ":"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ","Ｍ":"M","Ⅿ":"M","ℳ":"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M","Μ":"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M","М":"M","Ꮇ":"M","ᗰ":"M","ᛖ":"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n","ո":"n","ռ":"n","Ｎ":"N","ℕ":"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N","Ν":"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊","ɳ":"n̨","ƞ":"n̩","η":"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩","Ɲ":"N̦","ᵰ":"n̴","ǌ":"nj","ǋ":"Nj","Ǌ":"NJ","№":"No","ͷ":"ᴎ","и":"ᴎ","𐑍":"ᴎ","ņ":"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o","ｏ":"o","ℴ":"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o","ο":"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o","σ":"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o","о":"o","ჿ":"o","օ":"o","ס":"o","ه":"o","𞸤":"o","𞹤":"o","𞺄":"o","ﻫ":"o","ﻬ":"o","ﻪ":"o","ﻩ":"o","ھ":"o","ﮬ":"o","ﮭ":"o","ﮫ":"o","ﮪ":"o","ہ":"o","ﮨ":"o","ﮩ":"o","ﮧ":"o","ﮦ":"o","ە":"o","ഠ":"o","ဝ":"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O","Ｏ":"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O","Ο":"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O","О":"O","Օ":"O","ⵔ":"O","ዐ":"O","ଠ":"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º","ǒ":"ŏ","Ǒ":"Ŏ","ۿ":"ô","Ő":"Ö","ø":"o̸","ꬾ":"o̸","Ø":"O̸","ⵁ":"O̸","Ǿ":"Ó̸","ɵ":"o̵","ꝋ":"o̵","ө":"o̵","ѳ":"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵","Ɵ":"O̵","Ꝋ":"O̵","θ":"O̵","ϑ":"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵","Θ":"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵","Ө":"O̵","Ѳ":"O̵","ⴱ":"O̵","Ꮎ":"O̵","Ꮻ":"O̵","ꭴ":"ơ","ﳙ":"oٰ","🄁":"O,","🄀":"O.","ơ":"o'","Ơ":"O'","Ꭴ":"O'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀","œ":"oe","Œ":"OE","ɶ":"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO","ﳗ":"oج","ﱑ":"oج","ﳘ":"oم","ﱒ":"oم","ﶓ":"oمج","ﶔ":"oمم","ﱓ":"oى","ﱔ":"oى","ൟ":"oരo","တ":"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p","ｐ":"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p","ρ":"p","ϱ":"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p","р":"p","Ｐ":"P","ℙ":"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P","Ρ":"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P","Р":"P","Ꮲ":"P","ᑭ":"P","ꓑ":"P","𐊕":"P","ƥ":"p̔","ᵽ":"p̵","ᑷ":"p·","ᒆ":"P'","ᴩ":"ᴘ","ꮲ":"ᴘ","φ":"ɸ","ϕ":"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ","ф":"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q","գ":"q","զ":"q","ℚ":"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q","ʠ":"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ","κ":"ĸ","ϰ":"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ","к":"ĸ","ꮶ":"ĸ","қ":"ĸ̩","ҟ":"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r","г":"r","ꮁ":"r","𝈖":"R","ℛ":"R","ℜ":"R","ℝ":"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R","Ʀ":"R","Ꭱ":"R","Ꮢ":"R","𐒴":"R","ᖇ":"R","ꓣ":"R","𖼵":"R","ɽ":"r̨","ɼ":"r̩","ɍ":"r̵","ғ":"r̵","ᵲ":"r̴","ґ":"r'","𑣣":"rn",m:"rn","ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸","ɱ":"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ","я":"ᴙ","ᵳ":"ɾ̴","℩":"ɿ","ｓ":"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s","ƽ":"s","ѕ":"s","ꮪ":"s","𑣁":"s","𐑈":"s","Ｓ":"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S","Ѕ":"S","Տ":"S","Ꮥ":"S","Ꮪ":"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S","ʂ":"s̨","ᵴ":"s̴","ꞵ":"ß","β":"ß","ϐ":"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß","Ᏸ":"ß","🝜":"sss","ﬆ":"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ","Σ":"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T","Ｔ":"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T","Τ":"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T","Т":"T","Ꭲ":"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T","ƭ":"t̔","⍡":"T̈","Ⱦ":"T̸","Ț":"Ţ","Ʈ":"T̨","Ҭ":"T̩","₮":"T⃫","ŧ":"t̵","Ŧ":"T̵","ᵵ":"t̴","Ⴀ":"Ꞇ","Ꜩ":"T3","ʨ":"tɕ","℡":"TEL","ꝷ":"tf","ʦ":"ts","ʧ":"tʃ","ꜩ":"tȝ","τ":"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ","т":"ᴛ","ꭲ":"ᴛ","ҭ":"ᴛ̩","ţ":"ƫ","ț":"ƫ","Ꮏ":"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u","ʋ":"u","υ":"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u","ս":"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U","Ս":"U","ሀ":"U","𐓎":"U","ᑌ":"U","ꓴ":"U","𖽂":"U","𑢸":"U","ǔ":"ŭ","Ǔ":"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵","Ꮜ":"U̵","ᑘ":"U·","ᑧ":"U'","ᵫ":"ue","ꭣ":"uo","ṃ":"ꭑ","պ":"ɰ","ሣ":"ɰ","℧":"Ʊ","ᘮ":"Ʊ","ᘴ":"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v","ｖ":"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v","ν":"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v","ѵ":"v","ט":"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V","Ѵ":"V","ⴸ":"V","Ꮩ":"V","ᐯ":"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵","ᐻ":"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ","Λ":"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ","Л":"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ","ᐱ":"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦","ᐽ":"Ʌ·","ɯ":"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w","ѡ":"w","ԝ":"w","ա":"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W","Ꮃ":"W","Ꮤ":"W","ꓪ":"W","ѽ":"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ","м":"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x","ｘ":"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x","х":"x","ᕁ":"x","ᕽ":"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X","Ｘ":"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X","Χ":"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X","Х":"X","ⵝ":"X","ᚷ":"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ","Ҳ":"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll","ɣ":"y","ᶌ":"y","ｙ":"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y","ʏ":"y","ỿ":"y","ꭚ":"y","γ":"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y","у":"y","ү":"y","ყ":"y","𑣜":"y","Ｙ":"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y","Υ":"Y","ϒ":"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y","У":"Y","Ү":"Y","Ꭹ":"Y","Ꮍ":"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y","ƴ":"y̔","ɏ":"y̵","ұ":"y̵","¥":"Y̵","Ɏ":"Y̵","Ұ":"Y̵","ʒ":"ȝ","ꝫ":"ȝ","ⳍ":"ȝ","ӡ":"ȝ","ჳ":"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z","Ｚ":"Z","ℤ":"Z","ℨ":"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z","Ζ":"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z","Ꮓ":"Z","ꓜ":"Z","𑢩":"Z","ʐ":"z̨","ƶ":"z̵","Ƶ":"Z̵","ȥ":"z̦","Ȥ":"Z̦","ᵶ":"z̴","ƿ":"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ","ϩ":"ƨ","ꙅ":"ƨ","ь":"ƅ","ꮟ":"ƅ","ы":"ƅi","ꭾ":"ɂ","ˤ":"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ","Г":"Γ","Ꮁ":"Γ","ᒥ":"Γ","𖼇":"Γ","Ғ":"Γ̵","ᒯ":"Γ·","Ґ":"Γ'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ","ᐃ":"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲","ᐏ":"Δ·","ᐬ":"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ","µ":"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ","ϖ":"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π","п":"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π","П":"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ","ϛ":"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ","Ф":"Φ","Փ":"Φ","ቀ":"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ","ѱ":"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ","Ѱ":"Ψ","𐓑":"Ψ","ᛘ":"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω","Ω":"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω","ᘯ":"Ω","ᘵ":"Ω","𐊶":"Ω","⍹":"ω̲","ώ":"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ","җ":"ж̩","Җ":"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И","Й":"Ѝ","Ҋ":"Ѝ̦","ѝ":"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ","Ꮗ":"Ѡ","ᗯ":"Ѡ","Ѽ":"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ","ӌ":"ҷ","Ӌ":"Ҷ","Ҿ":"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ","և":"եւ","ኔ":"ձ","ﬔ":"մե","ﬕ":"մի","ﬗ":"մխ","ﬓ":"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո","በ":"Ո","ᑎ":"Ո","ꓵ":"Ո","ᑚ":"Ո·","ᑨ":"Ո'","ﬖ":"վն","₽":"Ք","˓":"ՙ","ʿ":"ՙ","ℵ":"א","ﬡ":"א","אָ":"אַ","אּ":"אַ","ﭏ":"אל","ℶ":"ב","ℷ":"ג","ℸ":"ד","ﬢ":"ד","ﬣ":"ה","יּ":"יִ","ﬤ":"כ","ﬥ":"ל","ﬦ":"ם","ﬠ":"ע","ﬧ":"ר","שׂ":"שׁ","שּ":"שׁ","שּׂ":"שּׁ","ﬨ":"ת","ﺀ":"ء","۽":"ء͈","ﺂ":"آ","ﺁ":"آ","ﭑ":"ٱ","ﭐ":"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب","ﺑ":"ب","ﺒ":"ب","ﺐ":"ب","ﺏ":"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ","ﲠ":"بo","ﳢ":"بo","ﲜ":"بج","ﰅ":"بج","ﲝ":"بح","ﰆ":"بح","ﷂ":"بحى","ﲞ":"بخ","ﰇ":"بخ","ﳒ":"بخ","ﱋ":"بخ","ﶞ":"بخى","ﱪ":"بر","ﱫ":"بز","ﲟ":"بم","ﳡ":"بم","ﱬ":"بم","ﰈ":"بم","ﱭ":"بن","ﱮ":"بى","ﰉ":"بى","ﱯ":"بى","ﰊ":"بى","ﭔ":"ٻ","ﭕ":"ٻ","ﭓ":"ٻ","ﭒ":"ٻ","ې":"ٻ","ﯦ":"ٻ","ﯧ":"ٻ","ﯥ":"ٻ","ﯤ":"ٻ","ﭜ":"ڀ","ﭝ":"ڀ","ﭛ":"ڀ","ﭚ":"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة","ö":"ة","ﺔ":"ة","ﺓ":"ة","ۃ":"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت","ﺗ":"ت","ﺘ":"ت","ﺖ":"ت","ﺕ":"ت","ﲥ":"تo","ﳤ":"تo","ﲡ":"تج","ﰋ":"تج","ﵐ":"تجم","ﶠ":"تجى","ﶟ":"تجى","ﲢ":"تح","ﰌ":"تح","ﵒ":"تحج","ﵑ":"تحج","ﵓ":"تحم","ﲣ":"تخ","ﰍ":"تخ","ﵔ":"تخم","ﶢ":"تخى","ﶡ":"تخى","ﱰ":"تر","ﱱ":"تز","ﲤ":"تم","ﳣ":"تم","ﱲ":"تم","ﰎ":"تم","ﵕ":"تمج","ﵖ":"تمح","ﵗ":"تمخ","ﶤ":"تمى","ﶣ":"تمى","ﱳ":"تن","ﱴ":"تى","ﰏ":"تى","ﱵ":"تى","ﰐ":"تى","ﭠ":"ٺ","ﭡ":"ٺ","ﭟ":"ٺ","ﭞ":"ٺ","ﭤ":"ٿ","ﭥ":"ٿ","ﭣ":"ٿ","ﭢ":"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج","ﺟ":"ج","ﺠ":"ج","ﺞ":"ج","ﺝ":"ج","ﲧ":"جح","ﰕ":"جح","ﶦ":"جحى","ﶾ":"جحى","ﷻ":"جل جلlلo","ﲨ":"جم","ﰖ":"جم","ﵙ":"جمح","ﵘ":"جمح","ﶧ":"جمى","ﶥ":"جمى","ﴝ":"جى","ﴁ":"جى","ﴞ":"جى","ﴂ":"جى","ﭸ":"ڃ","ﭹ":"ڃ","ﭷ":"ڃ","ﭶ":"ڃ","ﭴ":"ڄ","ﭵ":"ڄ","ﭳ":"ڄ","ﭲ":"ڄ","ﭼ":"چ","ﭽ":"چ","ﭻ":"چ","ﭺ":"چ","ﮀ":"ڇ","ﮁ":"ڇ","ﭿ":"ڇ","ﭾ":"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح","ﺣ":"ح","ﺤ":"ح","ﺢ":"ح","ﺡ":"ح","څ":"حۛ","ځ":"حٔ","ݲ":"حٔ","ﲩ":"حج","ﰗ":"حج","ﶿ":"حجى","ﲪ":"حم","ﰘ":"حم","ﵛ":"حمى","ﵚ":"حمى","ﴛ":"حى","ﳿ":"حى","ﴜ":"حى","ﴀ":"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ","ﺧ":"خ","ﺨ":"خ","ﺦ":"خ","ﺥ":"خ","ﲫ":"خج","ﰙ":"خج","ﰚ":"خح","ﲬ":"خم","ﰛ":"خم","ﴟ":"خى","ﴃ":"خى","ﴠ":"خى","ﴄ":"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د","ﺪ":"د","ﺩ":"د","ڈ":"دؕ","ﮉ":"دؕ","ﮈ":"دؕ","ڎ":"دۛ","ﮇ":"دۛ","ﮆ":"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ","ﺬ":"ذ","ﺫ":"ذ","ﱛ":"ذٰ","ڋ":"ڊؕ","ﮅ":"ڌ","ﮄ":"ڌ","ﮃ":"ڍ","ﮂ":"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر","ﺮ":"ر","ﺭ":"ر","ڑ":"رؕ","ﮍ":"رؕ","ﮌ":"رؕ","ژ":"رۛ","ﮋ":"رۛ","ﮊ":"رۛ","ڒ":"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ","ﱜ":"رٰ","ﷶ":"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز","ﺰ":"ز","ﺯ":"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س","ﺳ":"س","ﺴ":"س","ﺲ":"س","ﺱ":"س","ش":"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ","ﺷ":"سۛ","ﺸ":"سۛ","ﺶ":"سۛ","ﺵ":"سۛ","ݾ":"س̂","ﴱ":"سo","ﳨ":"سo","ﴲ":"سۛo","ﳪ":"سۛo","ﲭ":"سج","ﴴ":"سج","ﰜ":"سج","ﴭ":"سۛج","ﴷ":"سۛج","ﴥ":"سۛج","ﴉ":"سۛج","ﵝ":"سجح","ﵞ":"سجى","ﵩ":"سۛجى","ﲮ":"سح","ﴵ":"سح","ﰝ":"سح","ﴮ":"سۛح","ﴸ":"سۛح","ﴦ":"سۛح","ﴊ":"سۛح","ﵜ":"سحج","ﵨ":"سۛحم","ﵧ":"سۛحم","ﶪ":"سۛحى","ﲯ":"سخ","ﴶ":"سخ","ﰞ":"سخ","ﴯ":"سۛخ","ﴹ":"سۛخ","ﴧ":"سۛخ","ﴋ":"سۛخ","ﶨ":"سخى","ﷆ":"سخى","ﴪ":"سر","ﴎ":"سر","ﴩ":"سۛر","ﴍ":"سۛر","ﲰ":"سم","ﳧ":"سم","ﰟ":"سم","ﴰ":"سۛم","ﳩ":"سۛم","ﴨ":"سۛم","ﴌ":"سۛم","ﵡ":"سمج","ﵠ":"سمح","ﵟ":"سمح","ﵫ":"سۛمخ","ﵪ":"سۛمخ","ﵣ":"سمم","ﵢ":"سمم","ﵭ":"سۛمم","ﵬ":"سۛمم","ﴗ":"سى","ﳻ":"سى","ﴘ":"سى","ﳼ":"سى","ﴙ":"سۛى","ﳽ":"سۛى","ﴚ":"سۛى","ﳾ":"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص","ﺻ":"ص","ﺼ":"ص","ﺺ":"ص","ﺹ":"ص","ڞ":"صۛ","ࢯ":"ص̤̣","ﲱ":"صح","ﰠ":"صح","ﵥ":"صحح","ﵤ":"صحح","ﶩ":"صحى","ﲲ":"صخ","ﴫ":"صر","ﴏ":"صر","ﷵ":"صلعم","ﷹ":"صلى","ﷰ":"صلى","ﷺ":"صلى lللo علىo وسلم","ﲳ":"صم","ﰡ":"صم","ﷅ":"صمم","ﵦ":"صمم","ﴡ":"صى","ﴅ":"صى","ﴢ":"صى","ﴆ":"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض","ﺿ":"ض","ﻀ":"ض","ﺾ":"ض","ﺽ":"ض","ﲴ":"ضج","ﰢ":"ضج","ﲵ":"ضح","ﰣ":"ضح","ﵮ":"ضحى","ﶫ":"ضحى","ﲶ":"ضخ","ﰤ":"ضخ","ﵰ":"ضخم","ﵯ":"ضخم","ﴬ":"ضر","ﴐ":"ضر","ﲷ":"ضم","ﰥ":"ضم","ﴣ":"ضى","ﴇ":"ضى","ﴤ":"ضى","ﴈ":"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط","ﻃ":"ط","ﻄ":"ط","ﻂ":"ط","ﻁ":"ط","ڟ":"طۛ","ﲸ":"طح","ﰦ":"طح","ﴳ":"طم","ﴺ":"طم","ﰧ":"طم","ﵲ":"طمح","ﵱ":"طمح","ﵳ":"طمم","ﵴ":"طمى","ﴑ":"طى","ﳵ":"طى","ﴒ":"طى","ﳶ":"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ","ﻇ":"ظ","ﻈ":"ظ","ﻆ":"ظ","ﻅ":"ظ","ﲹ":"ظم","ﴻ":"ظم","ﰨ":"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع","ﻋ":"ع","ﻌ":"ع","ﻊ":"ع","ﻉ":"ع","ﲺ":"عج","ﰩ":"عج","ﷄ":"عجم","ﵵ":"عجم","ﷷ":"علىo","ﲻ":"عم","ﰪ":"عم","ﵷ":"عمم","ﵶ":"عمم","ﵸ":"عمى","ﶶ":"عمى","ﴓ":"عى","ﳷ":"عى","ﴔ":"عى","ﳸ":"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ","ﻏ":"غ","ﻐ":"غ","ﻎ":"غ","ﻍ":"غ","ﲼ":"غج","ﰫ":"غج","ﲽ":"غم","ﰬ":"غم","ﵹ":"غمم","ﵻ":"غمى","ﵺ":"غمى","ﴕ":"غى","ﳹ":"غى","ﴖ":"غى","ﳺ":"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف","ﻓ":"ف","ﻔ":"ف","ﻒ":"ف","ﻑ":"ف","ڧ":"ف","ﲾ":"فج","ﰭ":"فج","ﲿ":"فح","ﰮ":"فح","ﳀ":"فخ","ﰯ":"فخ","ﵽ":"فخم","ﵼ":"فخم","ﳁ":"فم","ﰰ":"فم","ﷁ":"فمى","ﱼ":"فى","ﰱ":"فى","ﱽ":"فى","ﰲ":"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ","ڤ":"ڡۛ","ﭬ":"ڡۛ","ﭭ":"ڡۛ","ﭫ":"ڡۛ","ﭪ":"ڡۛ","ڨ":"ڡۛ","ࢤ":"ڢۛ","ﭰ":"ڦ","ﭱ":"ڦ","ﭯ":"ڦ","ﭮ":"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق","ﻗ":"ق","ﻘ":"ق","ﻖ":"ق","ﻕ":"ق","ﳂ":"قح","ﰳ":"قح","ﷱ":"قلى","ﳃ":"قم","ﰴ":"قم","ﶴ":"قمح","ﵾ":"قمح","ﵿ":"قمم","ﶲ":"قمى","ﱾ":"قى","ﰵ":"قى","ﱿ":"قى","ﰶ":"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك","ﻛ":"ك","ﻜ":"ك","ﻚ":"ك","ﻙ":"ك","ک":"ك","ﮐ":"ك","ﮑ":"ك","ﮏ":"ك","ﮎ":"ك","ڪ":"ك","ڭ":"كۛ","ﯕ":"كۛ","ﯖ":"كۛ","ﯔ":"كۛ","ﯓ":"كۛ","ݣ":"كۛ","ﲀ":"كl","ﰷ":"كl","ﳄ":"كج","ﰸ":"كج","ﳅ":"كح","ﰹ":"كح","ﳆ":"كخ","ﰺ":"كخ","ﳇ":"كل","ﳫ":"كل","ﲁ":"كل","ﰻ":"كل","ﳈ":"كم","ﳬ":"كم","ﲂ":"كم","ﰼ":"كم","ﷃ":"كمم","ﶻ":"كمم","ﶷ":"كمى","ﲃ":"كى","ﰽ":"كى","ﲄ":"كى","ﰾ":"كى","ݢ":"ڬ","ﮔ":"گ","ﮕ":"گ","ﮓ":"گ","ﮒ":"گ","ࢰ":"گ","ڴ":"گۛ","ﮜ":"ڱ","ﮝ":"ڱ","ﮛ":"ڱ","ﮚ":"ڱ","ﮘ":"ڳ","ﮙ":"ڳ","ﮗ":"ڳ","ﮖ":"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل","ﻟ":"ل","ﻠ":"ل","ﻞ":"ل","ﻝ":"ل","ڷ":"لۛ","ڵ":"ل̆","ﻼ":"لl","ﻻ":"لl","ﻺ":"لlٕ","ﻹ":"لlٕ","ﻸ":"لlٴ","ﻷ":"لlٴ","ﳍ":"لo","ﻶ":"لآ","ﻵ":"لآ","ﳉ":"لج","ﰿ":"لج","ﶃ":"لجج","ﶄ":"لجج","ﶺ":"لجم","ﶼ":"لجم","ﶬ":"لجى","ﳊ":"لح","ﱀ":"لح","ﶵ":"لحم","ﶀ":"لحم","ﶂ":"لحى","ﶁ":"لحى","ﳋ":"لخ","ﱁ":"لخ","ﶆ":"لخم","ﶅ":"لخم","ﳌ":"لم","ﳭ":"لم","ﲅ":"لم","ﱂ":"لم","ﶈ":"لمح","ﶇ":"لمح","ﶭ":"لمى","ﲆ":"لى","ﱃ":"لى","ﲇ":"لى","ﱄ":"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م","ﻣ":"م","ﻤ":"م","ﻢ":"م","ﻡ":"م","ࢧ":"مۛ","۾":"م͈","ﲈ":"مl","ﳎ":"مج","ﱅ":"مج","ﶌ":"مجح","ﶒ":"مجخ","ﶍ":"مجم","ﷀ":"مجى","ﳏ":"مح","ﱆ":"مح","ﶉ":"محج","ﶊ":"محم","ﷴ":"محمد","ﶋ":"محى","ﳐ":"مخ","ﱇ":"مخ","ﶎ":"مخج","ﶏ":"مخم","ﶹ":"مخى","ﳑ":"مم","ﲉ":"مم","ﱈ":"مم","ﶱ":"ممى","ﱉ":"مى","ﱊ":"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن","ﻧ":"ن","ﻨ":"ن","ﻦ":"ن","ﻥ":"ن","ݨ":"نؕ","ݩ":"ن̆","ﳖ":"نo","ﳯ":"نo","ﶸ":"نجح","ﶽ":"نجح","ﶘ":"نجم","ﶗ":"نجم","ﶙ":"نجى","ﷇ":"نجى","ﳓ":"نح","ﱌ":"نح","ﶕ":"نحم","ﶖ":"نحى","ﶳ":"نحى","ﳔ":"نخ","ﱍ":"نخ","ﲊ":"نر","ﲋ":"نز","ﳕ":"نم","ﳮ":"نم","ﲌ":"نم","ﱎ":"نم","ﶛ":"نمى","ﶚ":"نمى","ﲍ":"نن","ﲎ":"نى","ﱏ":"نى","ﲏ":"نى","ﱐ":"نى","ۂ":"ۀ","ﮥ":"ۀ","ﮤ":"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و","ﻮ":"و","ﻭ":"و","ࢱ":"و","ۋ":"وۛ","ﯟ":"وۛ","ﯞ":"وۛ","ۇ":"و̓","ﯘ":"و̓","ﯗ":"و̓","ۆ":"و̆","ﯚ":"و̆","ﯙ":"و̆","ۉ":"و̂","ﯣ":"و̂","ﯢ":"و̂","ۈ":"وٰ","ﯜ":"وٰ","ﯛ":"وٰ","ؤ":"وٴ","ﺆ":"وٴ","ﺅ":"وٴ","ٶ":"وٴ","ٷ":"و̓ٴ","ﯝ":"و̓ٴ","ﷸ":"وسلم","ﯡ":"ۅ","ﯠ":"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى","ں":"ى","𞸝":"ى","𞹝":"ى","ﮟ":"ى","ﮞ":"ى","ࢽ":"ى","ﯨ":"ى","ﯩ":"ى","ﻰ":"ى","ﻯ":"ى","ي":"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى","ﻳ":"ى","ﻴ":"ى","ﻲ":"ى","ﻱ":"ى","ی":"ى","ﯾ":"ى","ﯿ":"ى","ﯽ":"ى","ﯼ":"ى","ے":"ى","ﮯ":"ى","ﮮ":"ى","ٹ":"ىؕ","ﭨ":"ىؕ","ﭩ":"ىؕ","ﭧ":"ىؕ","ﭦ":"ىؕ","ڻ":"ىؕ","ﮢ":"ىؕ","ﮣ":"ىؕ","ﮡ":"ىؕ","ﮠ":"ىؕ","پ":"ىۛ","ﭘ":"ىۛ","ﭙ":"ىۛ","ﭗ":"ىۛ","ﭖ":"ىۛ","ث":"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ","ﺛ":"ىۛ","ﺜ":"ىۛ","ﺚ":"ىۛ","ﺙ":"ىۛ","ڽ":"ىۛ","ۑ":"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆","ێ":"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ","ﲐ":"ىٰ","ﱝ":"ىٰ","ﳞ":"ىo","ﳱ":"ىo","ﳦ":"ىۛo","ئ":"ىٴ","ﺋ":"ىٴ","ﺌ":"ىٴ","ﺊ":"ىٴ","ﺉ":"ىٴ","ٸ":"ىٴ","ﯫ":"ىٴl","ﯪ":"ىٴl","ﲛ":"ىٴo","ﳠ":"ىٴo","ﯭ":"ىٴo","ﯬ":"ىٴo","ﯸ":"ىٴٻ","ﯷ":"ىٴٻ","ﯶ":"ىٴٻ","ﲗ":"ىٴج","ﰀ":"ىٴج","ﲘ":"ىٴح","ﰁ":"ىٴح","ﲙ":"ىٴخ","ﱤ":"ىٴر","ﱥ":"ىٴز","ﲚ":"ىٴم","ﳟ":"ىٴم","ﱦ":"ىٴم","ﰂ":"ىٴم","ﱧ":"ىٴن","ﯯ":"ىٴو","ﯮ":"ىٴو","ﯱ":"ىٴو̓","ﯰ":"ىٴو̓","ﯳ":"ىٴو̆","ﯲ":"ىٴو̆","ﯵ":"ىٴوٰ","ﯴ":"ىٴوٰ","ﯻ":"ىٴى","ﯺ":"ىٴى","ﱨ":"ىٴى","ﯹ":"ىٴى","ﰃ":"ىٴى","ﱩ":"ىٴى","ﰄ":"ىٴى","ﳚ":"ىج","ﱕ":"ىج","ﰑ":"ىۛج","ﶯ":"ىجى","ﳛ":"ىح","ﱖ":"ىح","ﶮ":"ىحى","ﳜ":"ىخ","ﱗ":"ىخ","ﲑ":"ىر","ﱶ":"ىۛر","ﲒ":"ىز","ﱷ":"ىۛز","ﳝ":"ىم","ﳰ":"ىم","ﲓ":"ىم","ﱘ":"ىم","ﲦ":"ىۛم","ﳥ":"ىۛم","ﱸ":"ىۛم","ﰒ":"ىۛم","ﶝ":"ىمم","ﶜ":"ىمم","ﶰ":"ىمى","ﲔ":"ىن","ﱹ":"ىۛن","ﲕ":"ىى","ﱙ":"ىى","ﲖ":"ىى","ﱚ":"ىى","ﱺ":"ىۛى","ﰓ":"ىۛى","ﱻ":"ىۛى","ﰔ":"ىۛى","ﮱ":"ۓ","ﮰ":"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ","Մ":"ሆ","Ռ":"ቡ","Ի":"ኮ","Պ":"ጣ","आ":"अा","ऒ":"अाॆ","ओ":"अाे","औ":"अाै","ऄ":"अॆ","ऑ":"अॉ","ऍ":"एॅ","ऎ":"एॆ","ऐ":"एे","ई":"र्इ","ઽ":"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्","আ":"অা","ৠ":"ঋৃ","ৡ":"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ","ਉ":"ੳੁ","ਊ":"ੳੂ","ਆ":"ਅਾ","ਐ":"ਅੈ","ਔ":"ਅੌ","ਇ":"ੲਿ","ਈ":"ੲੀ","ਏ":"ੲੇ","આ":"અા","ઑ":"અાૅ","ઓ":"અાે","ઔ":"અાૈ","ઍ":"અૅ","એ":"અે","ઐ":"અૈ","ଆ":"ଅା","௮":"அ","ர":"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ","ഉ":"உ","ஊ":"உள","ഊ":"உൗ","௭":"எ","௷":"எவ","ஜ":"ஐ","ജ":"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி","ണ":"ண","௺":"நீ","௴":"மீ","௰":"ய","ഴ":"ழ","ௗ":"ள","ை":"ன","ശ":"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ","ಅ":"అ","ಆ":"ఆ","ಇ":"ఇ","ౠ":"ఋా","ౡ":"ఌా","ಒ":"ఒ","ఔ":"ఒౌ","ಔ":"ఒౌ","ఓ":"ఒౕ","ಓ":"ఒౕ","ಜ":"జ","ಞ":"ఞ","ఢ":"డ̣","ಣ":"ణ","థ":"ధּ","భ":"బ̣","ಯ":"య","ఠ":"రּ","ಱ":"ఱ","ಲ":"ల","ష":"వ̣","హ":"వా","మ":"వు","ూ":"ుా","ౄ":"ృా","ೡ":"ಌಾ","ഈ":"ഇൗ","ഐ":"എെ","ഓ":"ഒാ","ഔ":"ഒൗ","ൡ":"ഞ","൫":"ദ്ര","൹":"നു","ഌ":"നു","ങ":"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ","റ":"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳","ฃ":"ข","ด":"ค","ต":"ค","ม":"ฆ","ຈ":"จ","ซ":"ช","ฏ":"ฎ","ท":"ฑ","ບ":"บ","ປ":"ป","ຝ":"ฝ","ພ":"พ","ຟ":"ฟ","ฦ":"ภ","ຍ":"ย","។":"ฯ","ๅ":"า","ำ":"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู","แ":"เเ","ໜ":"ຫນ","ໝ":"ຫມ","ຳ":"̊າ","༂":"འུྂཿ","༃":"འུྂ༔","ཪ":"ར","ༀ":"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ","က":"ဂာ","ၰ":"ဃှ","ၦ":"ပှ","ဟ":"ပာ","ၯ":"ပာှ","ၾ":"ၽှ","ဩ":"သြ","ဪ":"သြော်","႞":"ႃ̊","ឣ":"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ","ᢖ":"ᡜ","ᡕ":"ᠵ","ῶ":"Ꮿ","ᐍ":"ᐁ·","ᐫ":"ᐁᐠ","ᐑ":"ᐄ·","ᐓ":"ᐅ·","ᐭ":"ᐅᐠ","ᐕ":"ᐆ·","ᐘ":"ᐊ·","ᐮ":"ᐊᐠ","ᐚ":"ᐋ·","ᣝ":"ᐞᣟ","ᓑ":"ᐡ","ᕀ":"ᐩ","ᐿ":"ᐲ·","ᑃ":"ᐴ·","⍩":"ᐵ","ᑇ":"ᐹ·","ᑜ":"ᑏ·","⸧":"ᑐ","⊃":"ᑐ","ᑞ":"ᑐ·","ᑩ":"ᑐ'","⟉":"ᑐ/","⫗":"ᑐᑕ","ᑠ":"ᑑ·","⸦":"ᑕ","⊂":"ᑕ","ᑢ":"ᑕ·","ᑪ":"ᑕ'","ᑤ":"ᑖ·","ᑵ":"ᑫ·","ᒅ":"ᑫ'","ᑹ":"ᑮ·","ᑽ":"ᑰ·","ᘃ":"ᒉ","ᒓ":"ᒉ·","ᒕ":"ᒋ·","ᒗ":"ᒌ·","ᒛ":"ᒎ·","ᘂ":"ᒐ","ᒝ":"ᒐ·","ᒟ":"ᒑ·","ᒭ":"ᒣ·","ᒱ":"ᒦ·","ᒳ":"ᒧ·","ᒵ":"ᒨ·","ᒹ":"ᒫ·","ᓊ":"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·","ᓌ":"ᓇ·","ᓎ":"ᓈ·","ᘄ":"ᓓ","ᓝ":"ᓓ·","ᓟ":"ᓕ·","ᓡ":"ᓖ·","ᓣ":"ᓗ·","ᓥ":"ᓘ·","ᘇ":"ᓚ","ᓧ":"ᓚ·","ᓩ":"ᓛ·","ᓷ":"ᓭ·","ᓹ":"ᓯ·","ᓻ":"ᓰ·","ᓽ":"ᓱ·","ᓿ":"ᓲ·","ᔁ":"ᓴ·","ᔃ":"ᓵ·","ᔌ":"ᔋ<","ᔎ":"ᔋb","ᔍ":"ᔋᑕ","ᔏ":"ᔋᒐ","ᔘ":"ᔐ·","ᔚ":"ᔑ·","ᔜ":"ᔒ·","ᔞ":"ᔓ·","ᔠ":"ᔔ·","ᔢ":"ᔕ·","ᔤ":"ᔖ·","ᔲ":"ᔨ·","ᔴ":"ᔩ·","ᔶ":"ᔪ·","ᔸ":"ᔫ·","ᔺ":"ᔭ·","ᔼ":"ᔮ·","ᘢ":"ᕃ","ᣠ":"ᕃ·","ᘣ":"ᕆ","ᘤ":"ᕊ","ᕏ":"ᕌ·","ᖃ":"ᕐb","ᖄ":"ᕐḃ","ᖁ":"ᕐd","ᕿ":"ᕐP","ᙯ":"ᕐᑫ","ᕾ":"ᕐᑬ","ᖀ":"ᕐᑮ","ᖂ":"ᕐᑰ","ᖅ":"ᕐᒃ","ᕜ":"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·","ᕩ":"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·","ᖑ":"ᖕJ","ᙰ":"ᖕᒉ","ᖎ":"ᖕᒊ","ᖏ":"ᖕᒋ","ᖐ":"ᖕᒌ","ᖒ":"ᖕᒎ","ᖓ":"ᖕᒐ","ᖔ":"ᖕᒑ","ᙳ":"ᖖJ","ᙱ":"ᖖᒋ","ᙲ":"ᖖᒌ","ᙴ":"ᖖᒎ","ᙵ":"ᖖᒐ","ᙶ":"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ","ˡ":"ᣳ","ʳ":"ᣴ","ˢ":"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ","ᛡ":"ᚼ","⍿":"ᚽ","ᛂ":"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥","ㄱ":"ᄀ","ᆨ":"ᄀ","ᄁ":"ᄀᄀ","ㄲ":"ᄀᄀ","ᆩ":"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ","ᇃ":"ᄀᄅ","ᇻ":"ᄀᄇ","ᆪ":"ᄀᄉ","ㄳ":"ᄀᄉ","ᇄ":"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ","ㄴ":"ᄂ","ᆫ":"ᄂ","ᄓ":"ᄂᄀ","ᇅ":"ᄂᄀ","ᄔ":"ᄂᄂ","ㅥ":"ᄂᄂ","ᇿ":"ᄂᄂ","ᄕ":"ᄂᄃ","ㅦ":"ᄂᄃ","ᇆ":"ᄂᄃ","ퟋ":"ᄂᄅ","ᄖ":"ᄂᄇ","ᅛ":"ᄂᄉ","ᇇ":"ᄂᄉ","ㅧ":"ᄂᄉ","ᅜ":"ᄂᄌ","ᆬ":"ᄂᄌ","ㄵ":"ᄂᄌ","ퟌ":"ᄂᄎ","ᇉ":"ᄂᄐ","ᅝ":"ᄂᄒ","ᆭ":"ᄂᄒ","ㄶ":"ᄂᄒ","ᇈ":"ᄂᅀ","ㅨ":"ᄂᅀ","ㄷ":"ᄃ","ᆮ":"ᄃ","ᄗ":"ᄃᄀ","ᇊ":"ᄃᄀ","ᄄ":"ᄃᄃ","ㄸ":"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ","ᇋ":"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ","ㄹ":"ᄅ","ᆯ":"ᄅ","ꥤ":"ᄅᄀ","ᆰ":"ᄅᄀ","ㄺ":"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ","ᇌ":"ᄅᄀᄉ","ㅩ":"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ","ᄘ":"ᄅᄂ","ᇍ":"ᄅᄂ","ꥦ":"ᄅᄃ","ᇎ":"ᄅᄃ","ㅪ":"ᄅᄃ","ꥧ":"ᄅᄃᄃ","ᇏ":"ᄅᄃᄒ","ᄙ":"ᄅᄅ","ᇐ":"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ","ᆱ":"ᄅᄆ","ㄻ":"ᄅᄆ","ᇑ":"ᄅᄆᄀ","ᇒ":"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ","ᆲ":"ᄅᄇ","ㄼ":"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ","ᇓ":"ᄅᄇᄉ","ㅫ":"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ","ᇕ":"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ","ᇔ":"ᄅᄇᄒ","ꥬ":"ᄅᄉ","ᆳ":"ᄅᄉ","ㄽ":"ᄅᄉ","ᇖ":"ᄅᄉᄉ","ᄛ":"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ","ᇘ":"ᄅᄏ","ᆴ":"ᄅᄐ","ㄾ":"ᄅᄐ","ᆵ":"ᄅᄑ","ㄿ":"ᄅᄑ","ᄚ":"ᄅᄒ","ㅀ":"ᄅᄒ","ᄻ":"ᄅᄒ","ᆶ":"ᄅᄒ","ퟲ":"ᄅᄒ","ᇗ":"ᄅᅀ","ㅬ":"ᄅᅀ","ퟛ":"ᄅᅌ","ᇙ":"ᄅᅙ","ㅭ":"ᄅᅙ","ퟜ":"ᄅᅙᄒ","ㅁ":"ᄆ","ᆷ":"ᄆ","ꥯ":"ᄆᄀ","ᇚ":"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ","ᇛ":"ᄆᄅ","ퟠ":"ᄆᄆ","ᄜ":"ᄆᄇ","ㅮ":"ᄆᄇ","ᇜ":"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ","ᇝ":"ᄆᄉ","ㅯ":"ᄆᄉ","ᇞ":"ᄆᄉᄉ","ᄝ":"ᄆᄋ","ㅱ":"ᄆᄋ","ᇢ":"ᄆᄋ","ퟢ":"ᄆᄌ","ᇠ":"ᄆᄎ","ᇡ":"ᄆᄒ","ᇟ":"ᄆᅀ","ㅰ":"ᄆᅀ","ㅂ":"ᄇ","ᆸ":"ᄇ","ᄞ":"ᄇᄀ","ㅲ":"ᄇᄀ","ᄟ":"ᄇᄂ","ᄠ":"ᄇᄃ","ㅳ":"ᄇᄃ","ퟣ":"ᄇᄃ","ᇣ":"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ","ᄈ":"ᄇᄇ","ㅃ":"ᄇᄇ","ퟦ":"ᄇᄇ","ᄬ":"ᄇᄇᄋ","ㅹ":"ᄇᄇᄋ","ᄡ":"ᄇᄉ","ㅄ":"ᄇᄉ","ᆹ":"ᄇᄉ","ᄢ":"ᄇᄉᄀ","ㅴ":"ᄇᄉᄀ","ᄣ":"ᄇᄉᄃ","ㅵ":"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ","ᄤ":"ᄇᄉᄇ","ᄥ":"ᄇᄉᄉ","ᄦ":"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ","ᄫ":"ᄇᄋ","ㅸ":"ᄇᄋ","ᇦ":"ᄇᄋ","ᄧ":"ᄇᄌ","ㅶ":"ᄇᄌ","ퟨ":"ᄇᄌ","ᄨ":"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ","ᄩ":"ᄇᄐ","ㅷ":"ᄇᄐ","ᄪ":"ᄇᄑ","ᇤ":"ᄇᄑ","ꥴ":"ᄇᄒ","ᇥ":"ᄇᄒ","ㅅ":"ᄉ","ᆺ":"ᄉ","ᄭ":"ᄉᄀ","ㅺ":"ᄉᄀ","ᇧ":"ᄉᄀ","ᄮ":"ᄉᄂ","ㅻ":"ᄉᄂ","ᄯ":"ᄉᄃ","ㅼ":"ᄉᄃ","ᇨ":"ᄉᄃ","ᄰ":"ᄉᄅ","ᇩ":"ᄉᄅ","ᄱ":"ᄉᄆ","ퟪ":"ᄉᄆ","ᄲ":"ᄉᄇ","ㅽ":"ᄉᄇ","ᇪ":"ᄉᄇ","ᄳ":"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ","ᄊ":"ᄉᄉ","ㅆ":"ᄉᄉ","ᆻ":"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ","ᄴ":"ᄉᄉᄉ","ᄵ":"ᄉᄋ","ᄶ":"ᄉᄌ","ㅾ":"ᄉᄌ","ퟯ":"ᄉᄌ","ᄷ":"ᄉᄎ","ퟰ":"ᄉᄎ","ᄸ":"ᄉᄏ","ᄹ":"ᄉᄐ","ퟱ":"ᄉᄐ","ᄺ":"ᄉᄑ","ퟮ":"ᄉᅀ","ㅇ":"ᄋ","ᆼ":"ᄋ","ᅁ":"ᄋᄀ","ᇬ":"ᄋᄀ","ᇭ":"ᄋᄀᄀ","ᅂ":"ᄋᄃ","ꥶ":"ᄋᄅ","ᅃ":"ᄋᄆ","ᅄ":"ᄋᄇ","ᅅ":"ᄋᄉ","ᇱ":"ᄋᄉ","ㆂ":"ᄋᄉ","ᅇ":"ᄋᄋ","ㆀ":"ᄋᄋ","ᇮ":"ᄋᄋ","ᅈ":"ᄋᄌ","ᅉ":"ᄋᄎ","ᇯ":"ᄋᄏ","ᅊ":"ᄋᄐ","ᅋ":"ᄋᄑ","ꥷ":"ᄋᄒ","ᅆ":"ᄋᅀ","ᇲ":"ᄋᅀ","ㆃ":"ᄋᅀ","ㅈ":"ᄌ","ᆽ":"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ","ᅍ":"ᄌᄋ","ᄍ":"ᄌᄌ","ㅉ":"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ","ㅊ":"ᄎ","ᆾ":"ᄎ","ᅒ":"ᄎᄏ","ᅓ":"ᄎᄒ","ㅋ":"ᄏ","ᆿ":"ᄏ","ㅌ":"ᄐ","ᇀ":"ᄐ","ꥹ":"ᄐᄐ","ㅍ":"ᄑ","ᇁ":"ᄑ","ᅖ":"ᄑᄇ","ᇳ":"ᄑᄇ","ퟺ":"ᄑᄉ","ᅗ":"ᄑᄋ","ㆄ":"ᄑᄋ","ᇴ":"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ","ㅎ":"ᄒ","ᇂ":"ᄒ","ᇵ":"ᄒᄂ","ᇶ":"ᄒᄅ","ᇷ":"ᄒᄆ","ᇸ":"ᄒᄇ","ꥻ":"ᄒᄉ","ᅘ":"ᄒᄒ","ㆅ":"ᄒᄒ","ᄽ":"ᄼᄼ","ᄿ":"ᄾᄾ","ㅿ":"ᅀ","ᇫ":"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ","ㆁ":"ᅌ","ᇰ":"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ","ᅏ":"ᅎᅎ","ᅑ":"ᅐᅐ","ㆆ":"ᅙ","ᇹ":"ᅙ","ꥼ":"ᅙᅙ","ㅤ":"ᅠ","ㅏ":"ᅡ","ᆣ":"ᅡー","ᅶ":"ᅡᅩ","ᅷ":"ᅡᅮ","ᅢ":"ᅡ丨","ㅐ":"ᅡ丨","ㅑ":"ᅣ","ᅸ":"ᅣᅩ","ᅹ":"ᅣᅭ","ᆤ":"ᅣᅮ","ᅤ":"ᅣ丨","ㅒ":"ᅣ丨","ㅓ":"ᅥ","ᅼ":"ᅥー","ᅺ":"ᅥᅩ","ᅻ":"ᅥᅮ","ᅦ":"ᅥ丨","ㅔ":"ᅥ丨","ㅕ":"ᅧ","ᆥ":"ᅧᅣ","ᅽ":"ᅧᅩ","ᅾ":"ᅧᅮ","ᅨ":"ᅧ丨","ㅖ":"ᅧ丨","ㅗ":"ᅩ","ᅪ":"ᅩᅡ","ㅘ":"ᅩᅡ","ᅫ":"ᅩᅡ丨","ㅙ":"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨","ᅿ":"ᅩᅥ","ᆀ":"ᅩᅥ丨","ힰ":"ᅩᅧ","ᆁ":"ᅩᅧ丨","ᆂ":"ᅩᅩ","ힱ":"ᅩᅩ丨","ᆃ":"ᅩᅮ","ᅬ":"ᅩ丨","ㅚ":"ᅩ丨","ㅛ":"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨","ᆄ":"ᅭᅣ","ㆇ":"ᅭᅣ","ᆆ":"ᅭᅣ","ᆅ":"ᅭᅣ丨","ㆈ":"ᅭᅣ丨","ힴ":"ᅭᅥ","ᆇ":"ᅭᅩ","ᆈ":"ᅭ丨","ㆉ":"ᅭ丨","ㅜ":"ᅮ","ᆉ":"ᅮᅡ","ᆊ":"ᅮᅡ丨","ᅯ":"ᅮᅥ","ㅝ":"ᅮᅥ","ᆋ":"ᅮᅥー","ᅰ":"ᅮᅥ丨","ㅞ":"ᅮᅥ丨","ힵ":"ᅮᅧ","ᆌ":"ᅮᅧ丨","ᆍ":"ᅮᅮ","ᅱ":"ᅮ丨","ㅟ":"ᅮ丨","ힶ":"ᅮ丨丨","ㅠ":"ᅲ","ᆎ":"ᅲᅡ","ힷ":"ᅲᅡ丨","ᆏ":"ᅲᅥ","ᆐ":"ᅲᅥ丨","ᆑ":"ᅲᅧ","ㆊ":"ᅲᅧ","ᆒ":"ᅲᅧ丨","ㆋ":"ᅲᅧ丨","ힸ":"ᅲᅩ","ᆓ":"ᅲᅮ","ᆔ":"ᅲ丨","ㆌ":"ᅲ丨","ㆍ":"ᆞ","ퟅ":"ᆞᅡ","ᆟ":"ᆞᅥ","ퟆ":"ᆞᅥ丨","ᆠ":"ᆞᅮ","ᆢ":"ᆞᆞ","ᆡ":"ᆞ丨","ㆎ":"ᆞ丨","ヘ":"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄","不":"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨","ᅵ":"丨","ㅣ":"丨","⼁":"丨","ᆜ":"丨ー","ᆘ":"丨ᅡ","ᆙ":"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨","ᆚ":"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ","ᆛ":"丨ᅮ","ퟃ":"丨ᅲ","ᆝ":"丨ᆞ","ퟄ":"丨丨","串":"串","丸":"丸","丹":"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀","亂":"亂","㇚":"亅","⼅":"亅","了":"了","ニ":"二","⼆":"二","𠄢":"𠄢","⼇":"亠","亮":"亮","⼈":"人","イ":"亻","⺅":"亻","什":"什","仌":"仌","令":"令","你":"你","倂":"併","倂":"併","侀":"侀","來":"來","例":"例","侮":"侮","侮":"侮","侻":"侻","便":"便","值":"値","倫":"倫","偺":"偺","備":"備","像":"像","僚":"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿","兀":"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全","兩":"兩","ハ":"八","⼋":"八","六":"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况","冷":"冷","凉":"凉","凌":"凌","凜":"凜","凞":"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃","切":"切","切":"切","列":"列","利":"利","㓟":"㓟","刺":"刺","刻":"刻","剆":"剆","割":"割","剷":"剷","劉":"劉","𠠄":"𠠄","カ":"力","力":"力","⼒":"力","劣":"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉","勒":"勒","勞":"勞","勤":"勤","勤":"勤","勵":"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕","北":"北","北":"北","⼕":"匚","⼖":"匸","匿":"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博","ト":"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即","卵":"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶","參":"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣","ロ":"口","⼝":"口","囗":"口","⼞":"口","句":"句","叫":"叫","叱":"叱","吆":"吆","吏":"吏","吝":"吝","吸":"吸","呂":"呂","呈":"呈","周":"周","咞":"咞","咢":"咢","咽":"咽","䎛":"㖈","哶":"哶","唐":"唐","啓":"啓","啟":"啓","啕":"啕","啣":"啣","善":"善","善":"善","喇":"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳","嗀":"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器","囹":"囹","圖":"圖","圗":"圗","⼟":"土","士":"土","⼠":"土","型":"型","城":"城","㦳":"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀","塚":"塚","塚":"塚","塞":"塞","填":"塡","壿":"墫","墬":"墬","墳":"墳","壘":"壘","壟":"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊","タ":"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄","奈":"奈","契":"契","奔":"奔","奢":"奢","女":"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦","嬀":"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀","宅":"宅","𡧈":"𡧈","寃":"寃","寘":"寘","寧":"寧","寧":"寧","寧":"寧","寮":"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸","尿":"尿","屠":"屠","屢":"屢","層":"層","履":"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦","崙":"崙","嵃":"嵃","嵐":"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲","嶺":"嶺","⼮":"巛","巢":"巢","エ":"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾","帲":"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干","年":"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广","度":"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶","廊":"廊","廊":"廊","廉":"廉","廒":"廒","廓":"廓","廙":"廙","廬":"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱","弄":"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳","律":"律","㣣":"㣣","徚":"徚","復":"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志","念":"念","忹":"忹","怒":"怒","怜":"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘","惡":"惡","𢛔":"𢛔","愈":"愈","慨":"慨","慄":"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎","憐":"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲","懶":"懶","懶":"懶","戀":"戀","⼽":"戈","成":"成","戛":"戛","戮":"戮","戴":"戴","⼾":"戶","戸":"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱","拉":"拉","拏":"拏","拓":"拓","拔":"拔","拼":"拼","拾":"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨","捻":"捻","掃":"掃","掠":"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮","搉":"㩁","撚":"撚","撝":"撝","擄":"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬","數":"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗","料":"料","⽄":"斤","⽅":"方","旅":"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日","易":"易","曶":"㫚","㫤":"㫤","晉":"晉","晩":"晚","晴":"晴","晴":"晴","暑":"暑","暑":"暑","暈":"暈","㬈":"㬈","暜":"暜","暴":"暴","曆":"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰","更":"更","書":"書","⽉":"月","𣍟":"𣍟","肦":"朌","胐":"朏","胊":"朐","脁":"朓","胶":"㬵","朗":"朗","朗":"朗","朗":"朗","脧":"朘","望":"望","望":"望","幐":"㬺","䐠":"㬻","𣎓":"𣎓","膧":"朣","𣎜":"𣎜","⽊":"木","李":"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃","柿":"杮","杻":"杻","枅":"枅","林":"林","㭉":"㭉","𣏕":"𣏕","柳":"柳","柺":"柺","栗":"栗","栟":"栟","桒":"桒","𣑭":"𣑭","梁":"梁","梅":"梅","梅":"梅","梎":"梎","梨":"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝","槩":"㮣","樧":"榝","榣":"榣","槪":"槪","樂":"樂","樂":"樂","樂":"樂","樓":"樓","𣚣":"𣚣","檨":"檨","櫓":"櫓","櫛":"櫛","欄":"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲","歷":"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟","殮":"殮","⽎":"殳","殺":"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧","沈":"沈","沿":"沿","泌":"泌","泍":"泍","泥":"泥","𣲼":"𣲼","洛":"洛","洞":"洞","洴":"洴","派":"派","流":"流","流":"流","流":"流","洖":"洖","浩":"浩","浪":"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞","淋":"淋","淚":"淚","淪":"淪","淹":"淹","渚":"渚","港":"港","湮":"湮","潙":"溈","滋":"滋","滋":"滋","溜":"溜","溺":"溺","滇":"滇","滑":"滑","滛":"滛","㴳":"㴳","漏":"漏","漢":"漢","漢":"漢","漣":"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆","濫":"濫","濾":"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災","炙":"炙","炭":"炭","烈":"烈","烙":"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅","煉":"煉","𤋮":"𤋮","熜":"熜","燎":"燎","燐":"燐","𤎫":"𤎫","爐":"爐","爛":"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛","牢":"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯","狀":"狀","𤜵":"𤜵","狼":"狼","猪":"猪","猪":"猪","𤠔":"𤠔","獵":"獵","獺":"獺","⽞":"玄","率":"率","率":"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥","玲":"玲","㺸":"㺸","㺸":"㺸","珞":"珞","琉":"琉","理":"理","琢":"琢","瑇":"瑇","瑜":"瑜","瑩":"瑩","瑱":"瑱","瑱":"瑱","璅":"璅","璉":"璉","璘":"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶","留":"留","略":"略","異":"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒","痢":"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝","療":"療","癩":"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼","益":"益","益":"益","盛":"盛","盧":"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳","省":"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹","晣":"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝","硏":"研","硎":"硎","硫":"硫","碌":"碌","碌":"碌","碑":"碑","磊":"磊","磌":"磌","磌":"磌","磻":"磻","䃣":"䃣","礪":"礪","⽰":"示","⺭":"礻","礼":"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝","神":"神","祥":"祥","視":"視","視":"視","祿":"祿","𥚚":"𥚚","禍":"禍","禎":"禎","福":"福","福":"福","𥛅":"𥛅","禮":"禮","⽱":"禸","⽲":"禾","秊":"秊","䄯":"䄯","秫":"秫","稜":"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱","立":"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹","笠":"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐","簾":"簾","籠":"籠","⽶":"米","类":"类","粒":"粒","精":"精","糒":"糒","糖":"糖","糨":"糨","䊠":"䊠","糣":"糣","糧":"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀","紐":"紐","索":"索","累":"累","絶":"絕","絣":"絣","絛":"絛","綠":"綠","綾":"綾","緇":"緇","練":"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉","縷":"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙","罹":"罹","罺":"罺","羅":"羅","𦌾":"𦌾","⽺":"羊","羕":"羕","羚":"羚","羽":"羽","⽻":"羽","翺":"翺","老":"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳","聆":"聆","聠":"聠","𦖨":"𦖨","聯":"聯","聰":"聰","聾":"聾","⾀":"聿","⺺":"肀","⾁":"肉","肋":"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙","腁":"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵","朦":"䑃","臘":"臘","⾂":"臣","臨":"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮","良":"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽","若":"若","若":"若","苦":"苦","𦬼":"𦬼","茶":"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓","菉":"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華","菱":"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭","落":"落","葉":"葉","蔿":"蒍","𦳕":"𦳕","𦵫":"𦵫","蓮":"蓮","蓱":"蓱","蓳":"蓳","蓼":"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬","藍":"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡","藺":"藺","蘆":"蘆","䕫":"䕫","蘒":"蘒","蘭":"蘭","𧃒":"𧃒","虁":"蘷","蘿":"蘿","⾌":"虍","⻁":"虎","虐":"虐","虜":"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊","螺":"螺","蠁":"蠁","䗹":"䗹","蠟":"蠟","⾎":"血","行":"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤","裂":"裂","𧙧":"𧙧","裏":"裏","裗":"裗","裞":"裞","裡":"裡","裸":"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁","襤":"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆","見":"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦","詽":"訮","訞":"䚶","䚾":"䚾","䛇":"䛇","誠":"誠","說":"說","說":"說","調":"調","請":"請","諒":"諒","論":"論","諭":"諭","諭":"諭","諸":"諸","諸":"諸","諾":"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹","識":"識","讀":"讀","讏":"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆","豈":"豈","豕":"豕","⾗":"豕","豣":"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁","賂":"賂","賈":"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起","趆":"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼","跺":"跥","路":"路","跰":"跰","躛":"躗","⾝":"身","車":"車","⾞":"車","軔":"軔","輧":"軿","輦":"輦","輪":"輪","輸":"輸","輸":"輸","輻":"輻","轢":"轢","⻋":"车","⾟":"辛","辞":"辞","辰":"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡","連":"連","逸":"逸","逸":"逸","遲":"遲","遼":"遼","𨗒":"𨗒","𨗭":"𨗭","邏":"邏","⾢":"邑","邔":"邔","郎":"郎","郞":"郎","郞":"郎","郱":"郱","都":"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉","酪":"酪","醙":"醙","醴":"醴","⾤":"釆","里":"里","⾥":"里","量":"量","金":"金","⾦":"金","鈴":"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼","錄":"錄","鍊":"鍊","鎮":"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕","閭":"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝","阮":"阮","陋":"陋","降":"降","陵":"陵","陸":"陸","陼":"陼","隆":"隆","隣":"隣","䧦":"䧦","⾪":"隶","隷":"隷","隸":"隷","隸":"隷","⾫":"隹","雃":"雃","離":"離","難":"難","難":"難","⾬":"雨","零":"零","雷":"雷","霣":"霣","𩅅":"𩅅","露":"露","靈":"靈","⾭":"靑","⻘":"青","靖":"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋","領":"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻","類":"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢","飯":"飯","飼":"飼","䬳":"䬳","館":"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂","駱":"駱","駾":"駾","驪":"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚","魯":"魯","鱀":"鱀","鱗":"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎","鶴":"鶴","𪄅":"𪄅","䳸":"䳸","鷺":"鷺","𪈎":"𪈎","鸞":"鸞","鹃":"鹂","⿄":"鹵","鹿":"鹿","⿅":"鹿","𪊑":"𪊑","麗":"麗","麟":"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍","黎":"黎","䵖":"䵖","⿊":"黑","黒":"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿","龍":"龍","⿓":"龍","龎":"龎","⻰":"龙","龜":"龜","龜":"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"};var d=s(function(){if(c)return a;c=1;var e=l,t=RegExp(Object.keys(e).map(function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}).join("|"),"g");function r(t){return e[t]}return a=function(e){return e.replace(t,r)}}());const u=Object.prototype.toString,h=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function g(e){var t;if(!(e&&(t=e,"[object Error]"===u.call(t))&&"TypeError"===e.name&&"string"==typeof e.message))return!1;const{message:r,stack:n}=e;return"Load failed"===r?void 0===n||"__sentry_captured__"in e:!!r.startsWith("error sending request for url")||h.has(r)}function p(e,t,{min:r=0,allowInfinity:n=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw new TypeError(`Expected \`${e}\` to be ≥ ${r}.`)}}class v extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function m(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function _({error:e,attemptNumber:t,retriesConsumed:r,startTime:n,options:i}){const o=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(o instanceof v)throw o.originalError;const s=Number.isFinite(i.retries)?Math.max(0,i.retries-r):i.retries,a=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:o,attemptNumber:t,retriesLeft:s,retriesConsumed:r});if(await i.onFailedAttempt(c),m(n,a)<=0)throw o;const l=await i.shouldConsumeRetry(c),d=m(n,a);if(d<=0||s<=0)throw o;if(o instanceof TypeError&&!g(o)){if(l)throw o;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw o;if(!l)return i.signal?.throwIfAborted(),!1;const u=function(e,t){const r=Math.max(1,e+1),n=t.randomize?Math.random()+1:1;let i=Math.round(n*t.minTimeout*t.factor**(r-1));return i=Math.min(i,t.maxTimeout),i}(r,i),h=Math.min(u,d);return h>0&&await new Promise((e,t)=>{const r=()=>{clearTimeout(n),i.signal?.removeEventListener("abort",r),t(i.signal.reason)},n=setTimeout(()=>{i.signal?.removeEventListener("abort",r),e()},h);i.unref&&n.unref?.(),i.signal?.addEventListener("abort",r,{once:!0})}),i.signal?.throwIfAborted(),!0}async function f(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,p("factor",t.factor,{min:0,allowInfinity:!1}),p("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),p("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),p("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let r=0,n=0;const i=performance.now();for(;!Number.isFinite(t.retries)||n<=t.retries;){r++;try{t.signal?.throwIfAborted();const n=await e(r);return t.signal?.throwIfAborted(),n}catch(e){await _({error:e,attemptNumber:r,retriesConsumed:n,startTime:i,options:t})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}let y=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class b extends y{constructor(){super(...arguments),o(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class w extends y{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var S=function(e){return e.Self="m.self",e.Pin="m.pin",e}({}),E=new w("m.asset","org.matrix.msc3488.asset"),R=new w("m.ts","org.matrix.msc3488.ts"),I=new w("m.location","org.matrix.msc3488.location"),k=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({}),T="main";function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function O(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var M=new Map;function P(e){return e instanceof String&&(e=e.toString()),M.has(e)||M.set(e,e),M.get(e)}function D(e,t){var r=null!=t?t:new URLSearchParams,n=function(e){null!=o&&(Array.isArray(o)?o.forEach(t=>{r.append(e,String(t))}):r.append(e,String(o)))};for(var[i,o]of Object.entries(e))n(i);return r}function A(e,t,r){var n=O(O({},r),{},{[t]:r[e]});return delete n[e],n}function x(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];null!=n&&(e=e.replace(r,encodeURIComponent(n)))}return e}function U(e,t,r){var n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e.splice(n,1),!0}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e.splice(n,1),!0;return!1}function L(e,t){for(var r of t)if(!e.hasOwnProperty(r))throw new Error("Missing required key: "+r)}function N(e){return JSON.parse(JSON.stringify(e))}function F(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!F(e[r],t[r]))return!1}else{for(var n in t)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;for(var i in e)if(t.hasOwnProperty(i)!==e.hasOwnProperty(i)||!F(e[i],t[i]))return!1}return!0}function j(e){if("object"!=typeof e)return e;if(null==e||Array.isArray(e))return e;var t=[];for(var[r,n]of Object.entries(e))t.push([r,j(n)]);return t.sort((e,t)=>se(e[0],t[0])),t}function B(e){return"number"==typeof e&&isFinite(e)}function K(e){return"string"==typeof e?d(e.normalize("NFD").replace(V,"")):""}function q(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}var V=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function W(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function G(e){return W(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function H(e){return null!=e&&e.endsWith("/")?e.slice(0,-1):e}function z(e,t){return new Promise(r=>{setTimeout(r,e,t)})}function $(e,t,r){return J.apply(this,arguments)}function J(){return J=r(function*(e,t,r){var n=Date.now();try{return yield r()}finally{var i=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(i-n,"ms"))}}),J.apply(this,arguments)}function Y(e){return null==e}function Q(e,t){return X.apply(this,arguments)}function X(){return(X=r(function*(e,t){for(var r of e)yield t(yield r)})).apply(this,arguments)}function Z(e){return Promise.resolve(e())}var ee=(()=>{for(var e="",t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function te(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ee;return e.padEnd(t,r[0])}function re(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee,n=BigInt(r.length);if(e<=n)return null!==(t=r[Number(e)-1])&&void 0!==t?t:"";var i=e/n,o=Number(e%n)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(n)-1),re(i,r)+r[o]}function ne(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee,r=BigInt(t.length),n=BigInt(0),i=e.length-1,o=BigInt(0);i>=0;i--,o++){var s=e.charCodeAt(i)-t.charCodeAt(0);n+=BigInt(1+s)*r**o}return n}function ie(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee;return re(ne(e,t)+BigInt(1),t)}function oe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ee;return re(ne(e,t)-BigInt(1),t)}function se(e,t){return e<t?-1:e>t?1:0}function ae(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(var[n,i]of Object.entries(t))e[n]instanceof Object&&i?ae(e[n],i):null==i&&r||ve(e,n,i);return e}function ce(e){var t;return null!==(t=R.findIn(e.getContent()))&&void 0!==t?t:-1}function le(e,t){return ce(t)-ce(e)}function de(e){return[k.Read,k.ReadPrivate].includes(e)}function ue(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e===t;if(e.size!==t.size)return!1;for(var[n,i]of e){var o=t.get(n);if(void 0===o||!r(i,o))return!1}return!0}function he(e){return e instanceof Map?ge(e):Array.isArray(e)?e.map(e=>he(e)):e}function ge(e){var t=new Map;for(var[r,n]of e)t.set(r,he(n));return Object.fromEntries(t.entries())}function pe(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function ve(e,t,r){if(pe(t))throw new Error("Trying to modify prototype or constructor");e[t]=r}function me(e){return!(pe(e.room_id)||pe(e.sender)||pe(e.event_id))}class _e extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var fe="migrationState",ye=function(e){return e[e.NOT_STARTED=0]="NOT_STARTED",e[e.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",e[e.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",e[e.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",e[e.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",e[e.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",e}({}),be=50;function we(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Se(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?we(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):we(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function Ee(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)}function Re(e){var t=e.split("/");return{senderKey:decodeURIComponent(t[0]),sessionId:decodeURIComponent(t[1])}}class Ie{constructor(){o(this,"migrationState",ye.NOT_STARTED),o(this,"account",null),o(this,"crossSigningKeys",null),o(this,"privateKeys",{}),o(this,"sessions",{}),o(this,"inboundGroupSessions",{}),o(this,"inboundGroupSessionsWithheld",{}),o(this,"rooms",{}),o(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return r(function*(){return null!==e.account})()}startup(){var e=this;return r(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return r(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return r(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){t(this.privateKeys[r]||null)}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){n((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}storeEndToEndSession(e,t,r,n){var i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),ve(i,t,r)}getEndToEndSessionsBatch(){var e=this;return r(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=be)return t;return 0===t.length?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return r(function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t.sessions[r]||{};delete i[n],0===Object.keys(i).length&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var i=Ee(e,t);n(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}storeEndToEndInboundGroupSession(e,t,r,n){var i=Ee(e,t);this.inboundGroupSessions[i]=r}countEndToEndInboundGroupSessions(){var e=this;return r(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return r(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(Se(Se({},Re(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=be)return t;return 0===t.length?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return r(function*(){for(var{senderKey:r,sessionId:n}of e){var i=Ee(r,n);delete t.inboundGroupSessions[i]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var r=Ee(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}doTxn(e,t,r){return Promise.resolve(r(null))}}var ke=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;var Te=/^[\w-]+$/;function Ce(e,t,r,n,i){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6?arguments[6]:void 0,a=arguments.length>7?arguments[7]:void 0;if("string"!=typeof t||!t)return"";if(!t.startsWith("mxc://"))return o?t:"";var c,[l,d,...u]=t.slice(6).split("/");if(u.length>0||!function(e){var t=ke.exec(e);return(null==t?void 0:t[0])===e}(l)||!function(e){var t=Te.exec(e);return(null==t?void 0:t[0])===e}(d))return"";a&&(s=!0);var h=!!r||!!n||!!i?"thumbnail":"download";c=a?"/_matrix/client/v1/media/".concat(h):"/_matrix/media/v3/".concat(h);var g=new URL("".concat(c,"/").concat(l,"/").concat(d),e);return r&&g.searchParams.set("width",Math.round(r).toString()),n&&g.searchParams.set("height",Math.round(n).toString()),i&&g.searchParams.set("method",i),"boolean"==typeof s&&g.searchParams.set("allow_redirect",JSON.stringify(s)),g.href}var Oe,Me={exports:{}},Pe=Me.exports;var De=(Oe||(Oe=1,function(e){var t,r;t=Pe,r=function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],i={},o=null;function s(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var r=this.getLevel(),i=0;i<n.length;i++){var o=n[i];this[o]=i<r?e:this.methodFactory(o,r,this.name)}if(this.log=this.debug,typeof console===t&&r<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function d(n,i,o){return function(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?a:void 0!==console[n]?s(console,n):void 0!==console.log?s(console,"log"):e)}(n)||l.apply(this,arguments)}function u(e,r){var s,a,l,u=this,h="loglevel";function g(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=encodeURIComponent(h),i=r.indexOf(n+"=");-1!==i&&(e=/^([^;]+)/.exec(r.slice(i+n.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function p(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=r||d,u.getLevel=function(){return null!=l?l:null!=a?a:s},u.setLevel=function(e,r){return l=p(e),!1!==r&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+r+";"}catch(e){}}}(l),c.call(u)},u.setDefaultLevel=function(e){a=p(e),g()||u.setLevel(e,!1)},u.resetLevel=function(){l=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(o!==u&&(s=p(o.getLevel())),c.call(u),o===u)for(var e in i)i[e].rebuild()},s=p(o?o.getLevel():"WARN");var v=g();null!=v&&(l=p(v)),c.call(u)}(o=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new u(e,o.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=h),o},o.getLoggers=function(){return i},o.default=o,o},e.exports?e.exports=r():t.log=r()}(Me)),Me.exports),Ae=s(De);Ae.methodFactory=function(e,t,r){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return this.prefix&&r.unshift(this.prefix),"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e?console[e](...r):console.log(...r)}};var xe=function e(t){var r="matrix"+(void 0===t?"":"-".concat(t)),n=Ae.getLogger(r);return void 0===n.getChild&&(n.prefix=t,n.getChild=r=>{var i=e((null!=t?t:"")+r);return i.methodFactory=n.methodFactory,i.rebuild(),i},n.setLevel(Ae.levels.DEBUG,!1)),n}();class Ue{constructor(e,t){this.parent=e,o(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}class Le{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new Le(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(0===n.length)t="";else if(n[0]instanceof Error){var o=n.shift();t=o.stack||o.message}else t="string"==typeof n[0]?n.shift():"%O";this.debugInstance(e+" "+t,...n)}}var Ne,Fe={exports:{}};function je(){if(Ne)return Fe.exports;Ne=1;var e,t="object"==typeof Reflect?Reflect:null,r=t&&"function"==typeof t.apply?t.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}Fe.exports=i,Fe.exports.once=function(e,t){return new Promise(function(r,n){function i(r){e.removeListener(t,o),n(r)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}p(e,t,o,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&p(e,"error",t,r)}(e,i,{once:!0})})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function s(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function a(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function c(e,t,r,n){var i,o,c,l;if(s(r),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),c=o[t]),void 0===c)c=o[t]=r,++e._eventsCount;else if("function"==typeof c?c=o[t]=n?[r,c]:[c,r]:n?c.unshift(r):c.push(r),(i=a(e))>0&&c.length>i&&!c.warned){c.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=c.length,l=d,console&&console.warn&&console.warn(l)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=l.bind(n);return i.listener=r,n.wrapFn=i,i}function u(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):g(i,i.length)}function h(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function p(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(o){n.once&&e.removeEventListener(t,i),r(o)})}}return Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return a(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var l=c.length,d=g(c,l);for(n=0;n<l;++n)r(d[n],this,t)}return!0},i.prototype.addListener=function(e,t){return c(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return c(this,e,t,!0)},i.prototype.once=function(e,t){return s(t),this.on(e,d(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return s(t),this.prependListener(e,d(this,e,t)),this},i.prototype.removeListener=function(e,t){var r,n,i,o,a;if(s(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){a=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,a||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},i.prototype.listeners=function(e){return u(this,e,!0)},i.prototype.rawListeners=function(e){return u(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},i.prototype.listenerCount=h,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},Fe.exports}var Be=je(),Ke=function(e){return e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e}({});class qe extends Be.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,n=this;return r(function*(){for(var r=t.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=t[o];var s=n.listeners(e);return Promise.allSettled(s.map(e=>e(...i))).then(()=>s.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var Ve=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.PolicyRuleUser="m.policy.rule.user",e.PolicyRuleRoom="m.policy.rule.room",e.PolicyRuleServer="m.policy.rule.server",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.SecretRequest="m.secret.request",e.SecretSend="m.secret.send",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.CallNotify="org.matrix.msc4075.call.notify",e.RTCNotification="org.matrix.msc4075.rtc.notification",e.RTCDecline="org.matrix.msc4310.rtc.decline",e}({}),We=function(e){return e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread",e}({}),Ge=function(e){return e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request",e}({}),He="type",ze=function(e){return e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e}({}),$e="org.matrix.msgid",Je=new w("m.room.purpose","org.matrix.msc3088.purpose"),Ye=new w("m.enabled","org.matrix.msc3088.enabled"),Qe=new w("m.data_tree","org.matrix.msc3089.data_tree"),Xe=new w("m.leaf","org.matrix.msc3089.leaf"),Ze=new w("m.branch","org.matrix.msc3089.branch"),et=new w("m.room.marker","org.matrix.msc2716.marker"),tt=new w("with_rel_types","org.matrix.msc3912.with_relations"),rt=new w("io.element.functional_members","io.element.functional_members"),nt=new w("m.visibility","org.matrix.msc3531.visibility"),it=new w("enabled","org.matrix.msc3881.enabled"),ot=new w("device_id","org.matrix.msc3881.device_id"),st=new w("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),at=new w("thread_id","org.matrix.msc4023.thread_id"),ct=new y("membership","io.element.msc4115.membership"),lt=function(e){return e.Ban="ban",e.Invite="invite",e.Join="join",e.Knock="knock",e.Leave="leave",e}({}),dt=function(e){return e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing",e}({});class ut extends qe{constructor(e,t){super(),this.roomId=e,this.userId=t,o(this,"_isOutOfBand",!1),o(this,"modified",-1),o(this,"requestedProfileInfo",!1),o(this,"typing",!1),o(this,"name",void 0),o(this,"rawDisplayName",void 0),o(this,"powerLevel",0),o(this,"user",void 0),o(this,"membership",void 0),o(this,"disambiguate",!1),o(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,i=null!==(r=e.getDirectionalContent().displayname)&&void 0!==r?r:"";if(e.getType()===Ve.RoomMember){this._isOutOfBand=!1,this.events.member=e;var o=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&xe.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,r){if(!t||t===e)return!1;if(!r)return!1;var n=K(t);if(!n)return!1;if(ht.test(n))return!0;if(gt.test(t))return!0;var i=r.getUserIdsWithDisplayName(t);return!!i.some(t=>t!==e)}(this.userId,i,t);var s=this.name;this.name=function(e,t,r){return t&&t!==e?r?q(t)+" ("+e+")":K(t)?q(t):e:e}(this.userId,i,this.disambiguate),this.rawDisplayName=q(null!==(n=e.getDirectionalContent().displayname)&&void 0!==n?n:""),this.rawDisplayName&&K(this.rawDisplayName)||(this.rawDisplayName=this.userId),o!==this.membership&&(this.updateModifiedTime(),this.emit(dt.Membership,e,this,o)),s!==this.name&&(this.updateModifiedTime(),this.emit(dt.Name,e,this,s))}}setPowerLevel(e,t){var r=this.powerLevel;this.powerLevel=e,r!==this.powerLevel&&(this.updateModifiedTime(),this.emit(dt.PowerLevel,t,this))}setTypingEvent(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(dt.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===lt.Leave&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===lt.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===lt.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=arguments.length>5?arguments[5]:void 0,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],a=this.getMxcAvatarUrl();if(!a&&!i)return null;var c=Ce(e,a,t,r,n,o,void 0,s);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}var ht=/@.+:.+/,gt=/[\u200E\u200F\u202A-\u202F]/;var pt,vt={},mt={},_t={};function ft(){if(pt)return _t;function e(e,r){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,r){if(!e)return;if("string"==typeof e)return t(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return t(e,r)}(e))||r){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw s}}}}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function r(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}pt=1,Object.defineProperty(_t,"__esModule",{value:!0}),_t.NamespacedMap=void 0;var n=function(){function t(r){var n,i,o;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=this,i="internalMap",o=new Map,i in n?Object.defineProperty(n,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[i]=o,r){var s,a=e(r);try{for(a.s();!(s=a.n()).done;){var c=s.value;this.set(c[0],c[1])}}catch(e){a.e(e)}finally{a.f()}}}return r(t,[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}]),t}();return _t.NamespacedMap=n,_t}var yt,bt={};function wt(){if(yt)return bt;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t){var r=i();return function(){var n,i=s(t);if(r){var o=s(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(this,n)}}function r(e){var t="function"==typeof Map?new Map:void 0;return r=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return n(e,arguments,s(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),o(i,e)},r(e)}function n(e,t,r){return n=i()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&o(i,r.prototype),i},n.apply(null,arguments)}function i(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}yt=1,Object.defineProperty(bt,"__esModule",{value:!0}),bt.InvalidEventError=void 0;var a=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}(i,e);var r,n=t(i);function i(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),n.call(this,e)}return r=i,Object.defineProperty(r,"prototype",{writable:!1}),r}(r(Error));return bt.InvalidEventError=a,bt}var St,Et={},Rt={},It={};function kt(){if(St)return It;function e(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}St=1,Object.defineProperty(It,"__esModule",{value:!0}),It.ExtensibleEvent=void 0;var t=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.wireFormat=e}return e(t,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),t}();return It.ExtensibleEvent=t,It}var Tt,Ct={};function Ot(){if(Tt)return Ct;function e(e){return null!=e}return Tt=1,Object.defineProperty(Ct,"__esModule",{value:!0}),Ct.isOptionalAString=function(t){return e(t)&&"string"==typeof t},Ct.isProvided=e,Ct}var Mt,Pt,Dt={},At={};function xt(){if(Mt)return At;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,r){return t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(e,r)}function r(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var i,o=n(t);if(r){var s=n(this).constructor;i=Reflect.construct(o,arguments,s)}else i=o.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(this,i)}}function n(e){return n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}Mt=1,Object.defineProperty(At,"__esModule",{value:!0}),At.UnstableValue=At.NamespacedValue=void 0;var s=function(){function e(t,r){if(i(this,e),this.stable=t,this.unstable=r,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return o(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();At.NamespacedValue=s;var a=function(e){!function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),r&&t(e,r)}(s,e);var n=r(s);function s(e,t){var r;if(i(this,s),!(r=n.call(this,e,t)).unstable)throw new Error("Unstable value must be supplied");return r}return o(s,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),s}(s);return At.UnstableValue=a,At}function Ut(){if(Pt)return Dt;Pt=1,Object.defineProperty(Dt,"__esModule",{value:!0}),Dt.M_TEXT=Dt.M_NOTICE=Dt.M_MESSAGE=Dt.M_HTML=Dt.M_EMOTE=void 0;var e=xt(),t=new e.UnstableValue("m.message","org.matrix.msc1767.message");Dt.M_MESSAGE=t;var r=new e.UnstableValue("m.text","org.matrix.msc1767.text");Dt.M_TEXT=r;var n=new e.UnstableValue("m.html","org.matrix.msc1767.html");Dt.M_HTML=n;var i=new e.UnstableValue("m.emote","org.matrix.msc1767.emote");Dt.M_EMOTE=i;var o=new e.UnstableValue("m.notice","org.matrix.msc1767.notice");return Dt.M_NOTICE=o,Dt}var Lt,Nt,Ft={};function jt(){if(Lt)return Ft;return Lt=1,Object.defineProperty(Ft,"__esModule",{value:!0}),Ft.isEventTypeSame=function(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)},Ft}function Bt(){if(Nt)return Rt;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}Nt=1,Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.MessageEvent=void 0;var t=kt(),r=Ot(),n=wt(),i=Ut(),o=jt();function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){g(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function d(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=h(t);if(r){var o=h(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return u(t)}(this,n)}}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(v,e);var t,s,h,p=d(v);function v(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),g(u(t=p.call(this,e)),"text",void 0),g(u(t),"html",void 0),g(u(t),"renderings",void 0);var o=i.M_MESSAGE.findIn(t.wireContent),s=i.M_TEXT.findIn(t.wireContent),a=i.M_HTML.findIn(t.wireContent);if((0,r.isProvided)(o)){if(!Array.isArray(o))throw new n.InvalidEventError("m.message contents must be an array");var c=o.find(function(e){return!(0,r.isProvided)(e.mimetype)||"text/plain"===e.mimetype}),l=o.find(function(e){return"text/html"===e.mimetype});if(!c)throw new n.InvalidEventError("m.message is missing a plain text representation");t.text=c.body,t.html=null==l?void 0:l.body,t.renderings=o}else{if(!(0,r.isOptionalAString)(s))throw new n.InvalidEventError("Missing textual representation for event");t.text=s,t.html=a,t.renderings=[{body:s,mimetype:"text/plain"}],t.html&&t.renderings.push({body:t.html,mimetype:"text/html"})}return t}return t=v,h=[{key:"from",value:function(e,t){var r;return new v({type:i.M_MESSAGE.name,content:(r={},g(r,i.M_TEXT.name,e),g(r,i.M_HTML.name,t),r)})}}],(s=[{key:"isEmote",get:function(){return i.M_EMOTE.matches(this.wireFormat.type)||(0,r.isProvided)(i.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return i.M_NOTICE.matches(this.wireFormat.type)||(0,r.isProvided)(i.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,i.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=g({},i.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=g({},i.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:a(a({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}])&&c(t.prototype,s),h&&c(t,h),Object.defineProperty(t,"prototype",{writable:!1}),v}(t.ExtensibleEvent);return Rt.MessageEvent=p,Rt}var Kt,qt={};function Vt(){if(Kt)return qt;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}Kt=1,Object.defineProperty(qt,"__esModule",{value:!0}),qt.NoticeEvent=void 0;var t=Bt(),r=Ut(),n=jt();function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},s.apply(this,arguments)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function c(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=l(t);if(r){var o=l(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(this,n)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&a(e,t)}(g,e);var t,d,u,h=c(g);function g(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,g),h.call(this,e)}return t=g,u=[{key:"from",value:function(e,t){var n;return new g({type:r.M_NOTICE.name,content:(n={},i(n,r.M_TEXT.name,e),i(n,r.M_HTML.name,t),n)})}}],(d=[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,n.isEventTypeSame)(e,r.M_NOTICE)||s(l(g.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=s(l(g.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}])&&o(t.prototype,d),u&&o(t,u),Object.defineProperty(t,"prototype",{writable:!1}),g}(t.MessageEvent);return qt.NoticeEvent=d,qt}var Wt,Gt,Ht={};function zt(){if(Wt)return Ht;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}Wt=1,Object.defineProperty(Ht,"__esModule",{value:!0}),Ht.EmoteEvent=void 0;var t=Bt(),r=Ut(),n=jt();function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},s.apply(this,arguments)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function c(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=l(t);if(r){var o=l(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(this,n)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&a(e,t)}(g,e);var t,d,u,h=c(g);function g(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,g),h.call(this,e)}return t=g,u=[{key:"from",value:function(e,t){var n;return new g({type:r.M_EMOTE.name,content:(n={},i(n,r.M_TEXT.name,e),i(n,r.M_HTML.name,t),n)})}}],(d=[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,n.isEventTypeSame)(e,r.M_EMOTE)||s(l(g.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=s(l(g.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}])&&o(t.prototype,d),u&&o(t,u),Object.defineProperty(t,"prototype",{writable:!1}),g}(t.MessageEvent);return Ht.EmoteEvent=d,Ht}function $t(){if(Gt)return Et;Gt=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.LEGACY_M_ROOM_MESSAGE=void 0,Et.parseMRoomMessage=function(n){var o,c,l;if(i.M_MESSAGE.findIn(n.content)||i.M_TEXT.findIn(n.content))return new e.MessageEvent(n);var d,u=null===(o=n.content)||void 0===o?void 0:o.msgtype,h=null===(c=n.content)||void 0===c?void 0:c.body,g="org.matrix.custom.html"===(null===(l=n.content)||void 0===l?void 0:l.format)?n.content.formatted_body:null;return"m.text"===u?new e.MessageEvent(s(s({},n),{},{content:s(s({},n.content),{},(d={},a(d,i.M_TEXT.name,h),a(d,i.M_HTML.name,g),d))})):"m.notice"===u?new t.NoticeEvent(s(s({},n),{},{content:s(s({},n.content),{},(p={},a(p,i.M_TEXT.name,h),a(p,i.M_HTML.name,g),p))})):"m.emote"===u?new r.EmoteEvent(s(s({},n),{},{content:s(s({},n.content),{},(v={},a(v,i.M_TEXT.name,h),a(v,i.M_HTML.name,g),v))})):null;var p,v};var e=Bt(),t=Vt(),r=zt(),n=xt(),i=Ut();function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){a(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var c=new n.NamespacedValue("m.room.message");return Et.LEGACY_M_ROOM_MESSAGE=c,Et}var Jt,Yt={};function Qt(){if(Jt)return Yt;Jt=1,Object.defineProperty(Yt,"__esModule",{value:!0}),Yt.parseMMessage=function(i){if(t.M_EMOTE.matches(i.type))return new r.EmoteEvent(i);if(t.M_NOTICE.matches(i.type))return new n.NoticeEvent(i);return new e.MessageEvent(i)};var e=Bt(),t=Ut(),r=zt(),n=Vt();return Yt}var Xt,Zt={};function er(){if(Xt)return Zt;Xt=1,Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.M_POLL_START=Zt.M_POLL_RESPONSE=Zt.M_POLL_KIND_UNDISCLOSED=Zt.M_POLL_KIND_DISCLOSED=Zt.M_POLL_END=void 0;var e=xt(),t=new e.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");Zt.M_POLL_KIND_DISCLOSED=t;var r=new e.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");Zt.M_POLL_KIND_UNDISCLOSED=r;var n=new e.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");Zt.M_POLL_START=n;var i=new e.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");Zt.M_POLL_RESPONSE=i;var o=new e.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return Zt.M_POLL_END=o,Zt}var tr,rr={},nr={};function ir(){if(tr)return nr;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}tr=1,Object.defineProperty(nr,"__esModule",{value:!0}),nr.PollStartEvent=nr.PollAnswerSubevent=void 0;var t=er(),r=Bt(),n=Ut(),i=wt(),o=xt(),s=jt(),a=kt();function c(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return l(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){b(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function p(e,t,r){return t&&g(e.prototype,t),r&&g(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function v(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function _(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=y(t);if(r){var o=y(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return f(t)}(this,n)}}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function b(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var w=function(e){v(r,e);var t=_(r);function r(e){var n;h(this,r),b(f(n=t.call(this,e)),"id",void 0);var o=e.content.id;if(!o||"string"!=typeof o)throw new i.InvalidEventError("Answer ID must be a non-empty string");return n.id=o,n}return p(r,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:u({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new r({type:"org.matrix.sdk.poll.answer",content:b({id:e},n.M_TEXT.name,t)})}}]),r}(r.MessageEvent);nr.PollAnswerSubevent=w;var S=function(e){v(l,e);var a=_(l);function l(e){var n;h(this,l),b(f(n=a.call(this,e)),"question",void 0),b(f(n),"kind",void 0),b(f(n),"rawKind",void 0),b(f(n),"maxSelections",void 0),b(f(n),"answers",void 0);var o=t.M_POLL_START.findIn(n.wireContent);if(!o.question)throw new i.InvalidEventError("A question is required");if(n.question=new r.MessageEvent({type:"org.matrix.sdk.poll.question",content:o.question}),n.rawKind=o.kind,t.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=t.M_POLL_KIND_DISCLOSED:n.kind=t.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(o.max_selections)&&o.max_selections>0?o.max_selections:1,!Array.isArray(o.answers))throw new i.InvalidEventError("Poll answers must be an array");var s=o.answers.slice(0,20).map(function(e){return new w({type:"org.matrix.sdk.poll.answer",content:e})});if(s.length<=0)throw new i.InvalidEventError("No answers available");return n.answers=s,n}return p(l,[{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,t.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:t.M_POLL_START.name,content:(e={},b(e,t.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(e){return e.serialize().content})}),b(e,n.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map(function(e,t){return"".concat(t+1,". ").concat(e.text)}).join("\n"))),e)}}}],[{key:"from",value:function(e,r,i){var s,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new l({type:t.M_POLL_START.name,content:(s={},b(s,n.M_TEXT.name,e),b(s,t.M_POLL_START.name,{question:b({},n.M_TEXT.name,e),kind:i instanceof o.NamespacedValue?i.name:i,max_selections:a,answers:r.map(function(e){return b({id:c(Array(16)).map(function(){return E.charAt(Math.floor(Math.random()*E.length))}).join("")},n.M_TEXT.name,e)})}),s)})}}]),l}(a.ExtensibleEvent);nr.PollStartEvent=S;var E="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";return nr}var or,sr,ar={},cr={};function lr(){if(or)return cr;or=1,Object.defineProperty(cr,"__esModule",{value:!0}),cr.REFERENCE_RELATION=void 0;var e=new(xt().NamespacedValue)("m.reference");return cr.REFERENCE_RELATION=e,cr}function dr(){if(sr)return ar;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}sr=1,Object.defineProperty(ar,"__esModule",{value:!0}),ar.PollResponseEvent=void 0;var t=kt(),r=er(),n=wt(),i=lr(),o=jt();function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function c(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=d(t);if(r){var o=d(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return l(t)}(this,n)}}function l(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&a(e,t)}(p,e);var t,d,h,g=c(p);function p(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,p),u(l(t=g.call(this,e)),"internalAnswerIds",void 0),u(l(t),"internalSpoiled",void 0),u(l(t),"pollEventId",void 0);var r=t.wireContent["m.relates_to"];if(!i.REFERENCE_RELATION.matches(null==r?void 0:r.rel_type)||"string"!=typeof(null==r?void 0:r.event_id))throw new n.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=r.event_id,t.validateAgainst(null),t}return t=p,h=[{key:"from",value:function(e,t){return new p({type:r.M_POLL_RESPONSE.name,content:u({"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:t}},r.M_POLL_RESPONSE.name,{answers:e})})}}],(d=[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=r.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var n=t.answers;if(n.some(function(e){return"string"!=typeof e})||0===n.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(n.some(function(t){return!e.answers.some(function(e){return e.id===t})}))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);n=n.slice(0,e.maxSelections)}this.internalAnswerIds=n,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,r.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:r.M_POLL_RESPONSE.name,content:u({"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:this.pollEventId}},r.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}])&&s(t.prototype,d),h&&s(t,h),Object.defineProperty(t,"prototype",{writable:!1}),p}(t.ExtensibleEvent);return ar.PollResponseEvent=h,ar}var ur,hr,gr,pr={};function vr(){if(ur)return pr;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}ur=1,Object.defineProperty(pr,"__esModule",{value:!0}),pr.PollEndEvent=void 0;var t=er(),r=wt(),n=lr(),i=Bt(),o=Ut(),s=jt();function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function u(t){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,i=g(t);if(r){var o=g(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return h(t)}(this,n)}}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var v=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(_,e);var a,g,v,m=u(_);function _(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,_),p(h(t=m.call(this,e)),"pollEventId",void 0),p(h(t),"closingMessage",void 0);var o=t.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(null==o?void 0:o.rel_type)||"string"!=typeof(null==o?void 0:o.event_id))throw new r.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=o.event_id,t.closingMessage=new i.MessageEvent(t.wireFormat),t}return a=_,v=[{key:"from",value:function(e,r){var i;return new _({type:t.M_POLL_END.name,content:(i={"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:e}},p(i,t.M_POLL_END.name,{}),p(i,o.M_TEXT.name,r),i)})}}],(g=[{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,t.M_POLL_END)}},{key:"serialize",value:function(){return{type:t.M_POLL_END.name,content:c(p({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}])&&l(a.prototype,g),v&&l(a,v),Object.defineProperty(a,"prototype",{writable:!1}),_}(kt().ExtensibleEvent);return pr.PollEndEvent=v,pr}function mr(){if(hr)return rr;hr=1,Object.defineProperty(rr,"__esModule",{value:!0}),rr.parseMPoll=function(i){if(e.M_POLL_START.matches(i.type))return new t.PollStartEvent(i);if(e.M_POLL_RESPONSE.matches(i.type))return new r.PollResponseEvent(i);if(e.M_POLL_END.matches(i.type))return new n.PollEndEvent(i);return null};var e=er(),t=ir(),r=dr(),n=vr();return rr}function _r(){if(gr)return mt;gr=1,Object.defineProperty(mt,"__esModule",{value:!0}),mt.ExtensibleEvents=void 0;var e=ft(),t=wt(),r=$t(),n=Qt(),i=Ut(),o=er(),s=mr();function a(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return c(e,t)}(e))||t){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var u=function(){function c(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),d(this,"interpreters",new e.NamespacedMap([[r.LEGACY_M_ROOM_MESSAGE,r.parseMRoomMessage],[i.M_MESSAGE,n.parseMMessage],[i.M_EMOTE,n.parseMMessage],[i.M_NOTICE,n.parseMMessage],[o.M_POLL_START,s.parseMPoll],[o.M_POLL_RESPONSE,s.parseMPoll],[o.M_POLL_END,s.parseMPoll]])),d(this,"_unknownInterpretOrder",[i.M_MESSAGE])}var u,h,g;return u=c,g=[{key:"defaultInstance",get:function(){return c._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return c.defaultInstance.unknownInterpretOrder},set:function(e){c.defaultInstance.unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){c.defaultInstance.registerInterpreter(e,t)}},{key:"parse",value:function(e){return c.defaultInstance.parse(e)}}],(h=[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var r,n=a(this.unknownInterpretOrder);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(this.interpreters.has(i)){var o=this.interpreters.get(i)(e);if(o)return o}}}catch(e){n.e(e)}finally{n.f()}return null}catch(e){if(e instanceof t.InvalidEventError)return null;throw e}}}])&&l(u.prototype,h),g&&l(u,g),Object.defineProperty(u,"prototype",{writable:!1}),c}();return mt.ExtensibleEvents=u,d(u,"_defaultInstance",new u),mt}var fr,yr={};var br,wr,Sr={};var Er=(wr||(wr=1,function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=_r();Object.keys(t).forEach(function(r){"default"!==r&&"__esModule"!==r&&(r in e&&e[r]===t[r]||Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[r]}}))});var r=(fr||(fr=1,Object.defineProperty(yr,"__esModule",{value:!0})),yr);Object.keys(r).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===r[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[t]}}))});var n=wt();Object.keys(n).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===n[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return n[t]}}))});var i=xt();Object.keys(i).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===i[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return i[t]}}))});var o=ft();Object.keys(o).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===o[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}}))});var s=Ot();Object.keys(s).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===s[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return s[t]}}))});var a=function(){if(br)return Sr;br=1,Object.defineProperty(Sr,"__esModule",{value:!0}),Sr.LegacyMsgType=void 0,Sr.isEventLike=function(r,n){var i=r.content;return n===e.Text?t.M_MESSAGE.matches(r.type)||"m.room.message"===r.type&&"m.text"===(null==i?void 0:i.msgtype):n===e.Emote?t.M_EMOTE.matches(r.type)||"m.room.message"===r.type&&"m.emote"===(null==i?void 0:i.msgtype):n===e.Notice&&(t.M_NOTICE.matches(r.type)||"m.room.message"===r.type&&"m.notice"===(null==i?void 0:i.msgtype))};var e,t=Ut();return Sr.LegacyMsgType=e,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(e||(Sr.LegacyMsgType=e={})),Sr}();Object.keys(a).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===a[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return a[t]}}))});var c=jt();Object.keys(c).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===c[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return c[t]}}))});var l=$t();Object.keys(l).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===l[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return l[t]}}))});var d=Qt();Object.keys(d).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===d[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return d[t]}}))});var u=mr();Object.keys(u).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===u[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return u[t]}}))});var h=lr();Object.keys(h).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===h[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return h[t]}}))});var g=kt();Object.keys(g).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===g[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return g[t]}}))});var p=Ut();Object.keys(p).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===p[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return p[t]}}))});var v=Bt();Object.keys(v).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===v[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return v[t]}}))});var m=zt();Object.keys(m).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===m[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return m[t]}}))});var _=Vt();Object.keys(_).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===_[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return _[t]}}))});var f=er();Object.keys(f).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===f[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return f[t]}}))});var y=ir();Object.keys(y).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===y[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return y[t]}}))});var b=dr();Object.keys(b).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===b[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return b[t]}}))});var w=vr();Object.keys(w).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===w[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return w[t]}}))})}(vt)),vt);var Rr=function(e){return e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e}({});class Ir extends qe{constructor(e){super(),this.userId=e,o(this,"modified",-1),o(this,"displayName",void 0),o(this,"rawDisplayName",void 0),o(this,"avatarUrl",void 0),o(this,"presenceStatusMsg",void 0),o(this,"presence","offline"),o(this,"lastActiveAgo",0),o(this,"lastPresenceTs",0),o(this,"currentlyActive",!1),o(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new Ir(e);return t.reEmitter.reEmit(r,[Rr.AvatarUrl,Rr.DisplayName,Rr.Presence,Rr.CurrentlyActive,Rr.LastPresenceTs]),r}setPresenceEvent(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];for(var n of((e.getContent().presence!==this.presence||t)&&r.push(Rr.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(Rr.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(Rr.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push(Rr.CurrentlyActive),this.presence=e.getContent().presence,r.push(Rr.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime(),r))this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var kr=function(e){return e.Backward="b",e.Forward="f",e}({});class Tr{static setEventMetadata(e,t,r){e.setMetadata(t,r)}constructor(e){var t,r;this.eventTimelineSet=e,o(this,"roomId",void 0),o(this,"name",void 0),o(this,"events",[]),o(this,"baseIndex",0),o(this,"startState",void 0),o(this,"endState",void 0),o(this,"startToken",null),o(this,"endToken",null),o(this,"prevTimeline",null),o(this,"nextTimeline",null),o(this,"paginationRequests",{[kr.Backward]:null,[kr.Forward]:null}),this.roomId=null!==(t=null===(r=e.room)||void 0===r?void 0:r.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new eu(this.roomId),this.endState=new eu(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null===(t=this.startState)||void 0===t||t.setStateEvents(e,{timelineWasEmpty:n}),null===(r=this.endState)||void 0===r||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new Tr(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=t,this.endState=null==t?void 0:t.clone(),r}fork(e){var t=this.getState(e),r=new Tr(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=null==t?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==Tr.BACKWARDS)return this.startState;if(e==Tr.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===kr.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===kr.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==Tr.BACKWARDS)return this.prevTimeline;if(e==Tr.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==Tr.BACKWARDS)this.prevTimeline=e;else{if(t!=Tr.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:r,roomState:n,timelineWasEmpty:i,addToState:o}=t;n||(n=r?this.startState:this.endState);var s,a,c=this.getTimelineSet();c.room&&(Tr.setEventMetadata(e,n,r),o&&e.isState()&&c.room.getUnfilteredTimelineSet()===c&&(null===(s=n)||void 0===s||s.setStateEvents([e],{timelineWasEmpty:i}),e.sender&&(e.getType()!==Ve.RoomMember||r)||Tr.setEventMetadata(e,n,r)));a=r?0:this.events.length,this.events.splice(a,0,e),r&&this.baseIndex++}insertEvent(e,t,r,n){var i=this.getTimelineSet();i.room&&(Tr.setEventMetadata(e,r,!1),n&&e.isState()&&i.room.getUnfilteredTimelineSet()===i&&(r.setStateEvents([e],{}),e.sender&&e.getType()!==Ve.RoomMember||Tr.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}o(Tr,"BACKWARDS",kr.Backward),o(Tr,"FORWARDS",kr.Forward);var Cr,Or=function(e){return e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e}({});class Mr extends qe{constructor(e,t,n,i){var s;super(),s=this,this.relationType=e,this.eventType=t,this.altEventTypes=i,o(this,"relationEventIds",new Set),o(this,"relations",new Set),o(this,"annotationsByKey",{}),o(this,"annotationsBySender",{}),o(this,"sortedAnnotationsByKey",[]),o(this,"targetEvent",null),o(this,"creationEmitted",!1),o(this,"client",void 0),o(this,"onEventStatus",(e,t)=>{e.isSending()?t===xr.CANCELLED&&(e.removeListener(zd.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(zd.Status,this.onEventStatus)}),o(this,"onBeforeRedaction",function(){var e=r(function*(e){if(s.relations.has(e)){if(s.relations.delete(e),s.relationType===We.Annotation)s.removeAnnotationFromAggregation(e);else if(s.relationType===We.Replace&&s.targetEvent&&!s.targetEvent.isState()){var t=yield s.getLastReplacement();s.targetEvent.makeReplaced(t)}e.removeListener(zd.BeforeRedaction,s.onBeforeRedaction),s.emit(Or.Redaction,e)}});return function(t){return e.apply(this,arguments)}}()),this.client=n instanceof Mi?n.client:n}addEvent(e){var t=this;return r(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(r){var n=r.rel_type,i=e.getType();if(t.relationType===n&&function(e,t){return[t,...arguments.length>2&&void 0!==arguments[2]?arguments[2]:[]].includes(e)}(i,t.eventType,t.altEventTypes)){if(e.isSending()&&e.on(zd.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===We.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===We.Replace&&t.targetEvent&&!t.targetEvent.isState()){var o=yield t.getLastReplacement();t.targetEvent.makeReplaced(o)}e.on(zd.BeforeRedaction,t.onBeforeRedaction),t.emit(Or.Add,e),t.maybeEmitCreated()}else xe.error("Event relation info doesn't match this container")}else xe.error("Event must have relation info")}})()}removeEvent(e){var t=this;return r(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===We.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===We.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(Or.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{var r=e[1];return t[1].size-r.size});var i=e.getSender(),o=this.annotationsBySender[i];o||(o=this.annotationsBySender[i]=new Set),o.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{var r=e[1];return t[1].size-r.size}));var i=e.getSender(),o=this.annotationsBySender[i];o&&o.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==We.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==We.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return r(function*(){if(e.relationType!==We.Replace)return null;if(!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(We.Replace),r=null==t?void 0:t.origin_server_ts,n=e.getRelations().reduce((t,n)=>n.getSender()!==e.targetEvent.getSender()||r&&r>n.getTs()||t&&t.getTs()>n.getTs()?t:n,null);return null!=n&&n.shouldAttemptDecryption()&&e.client.getCrypto()?yield n.attemptDecryption(e.client.getCrypto()):null!=n&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return r(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===We.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(zd.RelationsCreated,this.relationType,this.eventType))}}class Pr{constructor(e,t){this.client=e,this.room=t,o(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return null===(n=this.relations.get(e))||void 0===n||null===(n=n.get(t))||void 0===n?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,n=[];for(var i of r.values())for(var o of i.values())n.push(...o.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!e.isRedacted()&&e.status!==xr.CANCELLED){var r=e.getRelation();if(r){var n=()=>{e.isDecryptionFailure()?e.once(zd.Decrypted,n):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())e.once(zd.Decrypted,n);else{var{event_id:i,rel_type:o}=r,s=e.getType(),a=this.relations.get(i);a||(a=new Map,this.relations.set(i,a));var c=a.get(o);c||(c=new Map,a.set(o,c));var l=c.get(s);if(!l){var d,u,h;l=new Mr(o,s,this.client),c.set(s,l);var g=null!==(d=this.room)&&void 0!==d?d:null==t?void 0:t.room,p=null!==(u=null!==(h=null==t?void 0:t.findEventById(i))&&void 0!==h?h:null==g?void 0:g.findEventById(i))&&void 0!==u?u:null==g?void 0:g.getPendingEvent(i);p&&l.setTargetEvent(p)}l.addEvent(e)}}}}}Cr=xe.log.bind(xe);var Dr=function(e){return e.Ignore="ignore",e.Replace="replace",e}({});class Ar extends qe{constructor(e){var t,r,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;super(),this.room=e,this.thread=a,this.threadListType=c,o(this,"relations",void 0),o(this,"timelineSupport",void 0),o(this,"displayPendingEvents",void 0),o(this,"liveTimeline",void 0),o(this,"timelines",void 0),o(this,"_eventIdToTimeline",new Map),o(this,"filter",void 0),this.timelineSupport=Boolean(i.timelineSupport),this.liveTimeline=new Tr(this),this.displayPendingEvents=!1!==i.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=i.filter,this.relations=null!==(t=null===(r=this.room)||void 0===r?void 0:r.relations)&&void 0!==t?t:new Pr(null!==(n=null==e?void 0:e.client)&&void 0!==n?n:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,i=r?n.forkLive(Tr.FORWARDS):n.fork(Tr.FORWARDS);r?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&n.setPaginationToken(t,Tr.FORWARDS),i.setPaginationToken(null!=e?e:null,Tr.BACKWARDS),this.liveTimeline=i,this.emit(Oi.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(null==e)return null;var t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(t){return t.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new Tr(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,n,i){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this.filter||(e=this.filter.filterRoomTimeline(e)).length){var o=t?Tr.BACKWARDS:Tr.FORWARDS,s=t?Tr.FORWARDS:Tr.BACKWARDS,a=!1,c=!1;for(var l of e){var d=l.getId(),u=this._eventIdToTimeline.get(d);if(u)if(c=!1,u!=n){var h=n.getNeighbouringTimeline(o);if(h)Cr(u==h?"Event "+d+" in neighbouring timeline - switching to "+u:"Event "+d+" already in a different timeline "+u),n=u;else{xe.info("Already have timeline for "+d+" - joining timeline "+n+" to "+u);var g=u===this.liveTimeline,p=n===this.liveTimeline,v=o===Tr.BACKWARDS&&g,m=o===Tr.FORWARDS&&p;v||m?(v&&xe.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+u+")"),m&&xe.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(u,o),u.setNeighbouringTimeline(n,s),n=u,a=!0)}}else Cr("Event "+d+" already in timeline "+n);else this.addEventToTimeline(l,n,{toStartOfTimeline:t,addToState:r}),c=!0,a=!0}if(c||!a){if(o===Tr.FORWARDS&&n===this.liveTimeline)return xe.warn({lastEventWasNew:c,didUpdate:a}),void xe.warn("Refusing to set forwards pagination token of live timeline "+"".concat(n," to ").concat(i));n.setPaginationToken(null!=i?i:null,o)}}}addLiveEvent(e,t){var{duplicateStrategy:r,fromCache:n,roomState:i,timelineWasEmpty:o,addToState:s}=t;if(this.filter&&!this.filter.filterRoomTimeline([e]).length)return;var a=this._eventIdToTimeline.get(e.getId());if(a)if(r===Dr.Replace){Cr("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var c=a.getEvents(),l=0;l<c.length;l++)if(c[l].getId()===e.getId()){i||(i=a.getState(Tr.FORWARDS)),Tr.setEventMetadata(e,i,!1),c[l]=e;break}}else Cr("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:n,roomState:i,timelineWasEmpty:o,addToState:s})}addEventToTimeline(e,t,r){var n,{toStartOfTimeline:i,fromCache:o=!1,roomState:s,timelineWasEmpty:a,addToState:c}=r;if(t.getTimelineSet()!==this)throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(n=this.thread)||void 0===n?void 0:n.id,")"));var l=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var d,u="event=".concat(l);return e.threadRootId&&(u+="(belongs to thread=".concat(e.threadRootId,")")),void xe.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(u," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(d=this.thread)||void 0===d?void 0:d.id,")"))}t.addEvent(e,{toStartOfTimeline:i,roomState:s,timelineWasEmpty:a,addToState:c}),this._eventIdToTimeline.set(l,t);var h={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!o};this.emit(Oi.Timeline,e,this.room,Boolean(i),!1,h)}insertEventIntoTimeline(e,t,r,n){var i;if(t.getTimelineSet()!==this)throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(i=this.thread)||void 0===i?void 0:i.id,")"));var o=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var s,a="event=".concat(o);return e.threadRootId&&(a+="(belongs to thread=".concat(e.threadRootId,")")),void xe.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(a," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(s=this.thread)||void 0===s?void 0:s.id,")"))}var c=e.relationEventId;if(c){for(var l=this.findEventById(c),d=t.getEvents(),u=void 0!==l?d.indexOf(l):0;u<d.length;u++){if(d[u].getTs()>e.getTs())break}t.insertEvent(e,u,r,n),this._eventIdToTimeline.set(o,t);var h={timeline:t,liveEvent:!1};this.emit(Oi.Timeline,e,this.room,!1,!1,h)}else this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r,addToState:n})}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(Oi.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(void 0===r)return null;if(void 0===n)return null;if(r===n){for(var i=void 0,o=void 0,s=r.getEvents(),a=0;a<s.length&&(void 0===i||void 0===o);a++){var c=s[a].getId();c==e&&(i=a),c==t&&(o=a)}var l=i-o;return l<0?-1:l>0?1:0}for(var d=r;d;){if(d===n)return-1;d=d.getNeighbouringTimeline(Tr.FORWARDS)}for(d=r;d;){if(d===n)return 1;d=d.getNeighbouringTimeline(Tr.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var t,{threadId:r,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===r;n||i||xe.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat(null===(t=this.room)||void 0===t?void 0:t.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId));return n}}var xr=function(e){return e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled",e}({});class Ur{constructor(e,t){this.roomId=e}}class Lr{constructor(e){this.target=e,o(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var i=function(t){if(n.has(t))return 1;var i=function(){if("error"!==t||0!==r.target.listenerCount("error")){for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];r.target.emit(t,...i,e)}};e.on(t,i),n.set(t,i)};for(var o of t)i(o)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);0===r.size&&this.reEmitters.delete(e)}}}class Nr extends Lr{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var Fr=new b("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");class jr{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},i=Object.keys(n),o=[];return this.userId&&null!=n&&null!==(r=n[qd.name])&&void 0!==r&&r.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,i,o)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[Bd.name]:this.filterJson[Bd.name],[Kd.name]:this.filterJson[Kd.name]}).filter(e=>{var[t,r]=e;return r}))}checkFields(e,t,r,n,i,o){var s={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){var r=t.slice(0,-1);return e.slice(0,r.length)===r}return e===t}(r,e)}};for(var a in s){var c=s[a],l="not_"+a,d=this.filterJson[l];if(null!=d&&d.some(c))return!1;var u=this.filterJson[a];if(u&&!u.some(c))return!1}var h=this.filterJson.contains_url;if(void 0!==h&&h!==n)return!1;var g=this.filterJson[Kd.name];if(void 0!==g&&!this.arrayMatchesFilter(g,i))return!1;var p=this.filterJson[Bd.name];return!(void 0!==p&&!this.arrayMatchesFilter(p,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every(e=>t.includes(e))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function Br(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Kr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Br(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Br(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function qr(e,t,r){for(var n=t.split("."),i=e,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=r}class Vr{static fromJson(e,t,r){var n=new Vr(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,o(this,"definition",{}),o(this,"roomFilter",void 0),o(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new jr(r,this.userId),this.roomTimelineFilter=new jr((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){qr(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=Kr(Kr({},this.definition),{},{room:Kr(Kr({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:Kr(Kr({},null===(r=this.definition)||void 0===r||null===(r=r.room)||void 0===r?void 0:r.timeline),{},{[Fr.name]:e})})})}setLazyLoadMembers(e){qr(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){qr(this.definition,"room.include_leave",e)}}function Wr(e){return null!=e}o(Vr,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});var Gr=new Er.UnstableValue("m.message","org.matrix.msc1767.message"),Hr=new Er.UnstableValue("m.text","org.matrix.msc1767.text"),zr=new Er.UnstableValue("m.html","org.matrix.msc1767.html"),$r=new Er.NamespacedValue("m.reference");function Jr(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var r=t,n=e;return r.matches(n.name)||Wr(n.altName)&&r.matches(n.altName)}var Yr=new y("m.topic");function Qr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Xr(e,t){return{msgtype:Ge.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function Zr(e,t){return{msgtype:Ge.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function en(e,t){return{msgtype:Ge.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function tn(e){return{msgtype:Ge.Text,body:e}}function rn(e){return{msgtype:Ge.Notice,body:e}}function nn(e){return{msgtype:Ge.Emote,body:e}}var on=(e,t,r,n)=>{var i="at ".concat(new Date(r).toISOString());return[t===S.Self?"User":void 0,"Location",n?'"'.concat(n,'"'):void 0,e,i].filter(Boolean).join(" ")},sn=(e,t,r,n,i)=>{var s=null!=e?e:on(t,i||S.Self,r,n),a=r?{[R.name]:r}:{};return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Qr(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Qr(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({msgtype:Ge.Location,body:s,geo_uri:t,[I.name]:{description:n,uri:t},[E.name]:{type:i||S.Self},[Hr.name]:s},a)},an=(e,t)=>{var r=[];return Wr(t)&&r.push({body:t,mimetype:"text/html"}),Wr(e)&&r.push({body:e,mimetype:"text/plain"}),{topic:e,[Yr.name]:{"m.text":r}}},cn=e=>{var t,{description:r,timeout:n,live:i}=e,o=null!==(t=R.findIn(e))&&void 0!==t?t:void 0,s=E.findIn(e);return{description:r,timeout:n,live:i,assetType:null==s?void 0:s.type,timestamp:o}},ln=e=>{var t,r=I.findIn(e),n=null!==(t=R.findIn(e))&&void 0!==t?t:void 0;return{description:null==r?void 0:r.description,uri:null==r?void 0:r.uri,timestamp:n}},dn=Object.freeze({__proto__:null,getTextForLocationEvent:on,makeBeaconContent:(e,t,r,n)=>({[I.name]:{description:n,uri:e},[R.name]:t,"m.relates_to":{rel_type:$r.name,event_id:r}}),makeBeaconInfoContent:(e,t,r,n,i)=>({description:r,timeout:e,live:t,[R.name]:i||Date.now(),[E.name]:{type:null!=n?n:S.Self}}),makeEmoteMessage:nn,makeHtmlEmote:en,makeHtmlMessage:Xr,makeHtmlNotice:Zr,makeLocationContent:sn,makeNotice:rn,makeTextMessage:tn,makeTopicContent:an,parseBeaconContent:ln,parseBeaconInfoContent:cn,parseLocationEvent:e=>{var t,r,n=I.findIn(e),i=E.findIn(e),o=R.findIn(e),s=Hr.findIn(e),a=null!==(t=null==n?void 0:n.uri)&&void 0!==t?t:null==e?void 0:e.geo_uri,c=null==n?void 0:n.description,l=null!==(r=null==i?void 0:i.type)&&void 0!==r?r:S.Self,d=null!=s?s:e.body;return sn(d,a,null!=o?o:void 0,c,l)},parseTopicContent:e=>{var t,r,n,i,o,s=Yr.findIn(e),a=Array.isArray(s)?s:null==s?void 0:s["m.text"];return Array.isArray(a)?{text:null!==(t=null!==(r=null==a||null===(n=a.find(e=>!Wr(e.mimetype)||"text/plain"===e.mimetype))||void 0===n?void 0:n.body)&&void 0!==r?r:e.topic)&&void 0!==t?t:void 0,html:null==a||null===(i=a.find(e=>"text/html"===e.mimetype))||void 0===i?void 0:i.body}:{text:null!==(o=e.topic)&&void 0!==o?o:void 0}}}),un=function(e){return e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate",e}({}),hn=(e,t,r)=>r>=e&&e+t>=r,gn=e=>"".concat(e.getRoomId(),"_").concat(e.getStateKey());class pn extends qe{constructor(e){super(),this.rootEvent=e,o(this,"roomId",void 0),o(this,"_beaconInfo",void 0),o(this,"_isLive",void 0),o(this,"livenessWatchTimeout",void 0),o(this,"_latestLocationEvent",void 0),o(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(un.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return gn(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&ln(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(gn(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(un.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(un.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=null===(t=e.filter(e=>{var t=e.getContent(),r=ln(t);if(!r.uri||!r.timestamp)return!1;var{timestamp:n}=r;return this._beaconInfo.timestamp&&hn(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)}).sort(le))||void 0===t?void 0:t[0];r&&(this._latestLocationEvent=r,this.emit(un.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=cn(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&hn(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(un.LivenessChange,this.isLive,this)}}}function vn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function mn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?vn(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):vn(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _n(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new $d({content:{[t.getId()]:{[r]:{[e]:mn({ts:t.getTs()},!n&&{thread_id:Pd(t)})}}},type:Ve.Receipt,room_id:t.getRoomId()})}class fn extends qe{constructor(){super(...arguments),o(this,"receipts",new _e(()=>new Map)),o(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:k.Read,[o,s]=null!==(t=null===(r=this.receipts.get(i))||void 0===r?void 0:r.get(e))&&void 0!==t?t:[null,null];return n?o:null!=s?s:o}compareReceipts(e,t){var r;return null!==(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))&&void 0!==r?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(null===(t=e.data)||void 0===t||!t.thread_id)return!0;if(e.data.thread_id===T){if(Dd(r))return!0}else if(r.threadRootId===e.data.thread_id)return!0;return xe.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,i,o=this.getReadReceiptForUserId(e,t,k.Read),s=this.getReadReceiptForUserId(e,t,k.ReadPrivate);return null!=o&&o.eventId&&null!=s&&s.eventId&&(i=this.compareReceipts(o,s)),i?null!==(n=i<0?s:o)&&void 0!==n?n:null:null!==(r=null!=s?s:o)&&void 0!==r?r:null}addReceiptToStructure(e,t,r,n,i){var o,s,a=this.receipts.getOrCreate(t),c=a.get(r);c||(c=[null,null],a.set(r,c));var l,d=c[0];i&&(d=null!==(l=c[1])&&void 0!==l?l:c[0]);var u={eventId:e,data:n};if(d&&this.compareReceipts(d,u)>=0)return;var h=i?c[0]:u,g=i?u:c[1],p=null;h&&g&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,g.eventId));var v=null===p||p<0,m=null!==(o=c[1])&&void 0!==o?o:c[0];if(i&&v?c[1]=u:i||(c[0]=u,v||(c[1]=null)),m!==(null!==(s=c[1])&&void 0!==s?s:c[0])){if(m&&this.receiptCacheByEventId.get(m.eventId)){var _=m.eventId;this.receiptCacheByEventId.set(_,this.receiptCacheByEventId.get(_).filter(e=>e.type!==t||e.userId!==r)),this.receiptCacheByEventId.get(_).length<1&&this.receiptCacheByEventId.delete(_)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(null==t?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(Ci.Total,0),this.setUnread(Ci.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.addReceipt(_n(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(e){return de(e.type)}).map(function(e){return e.userId})}}var yn=new Er.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),bn=new Er.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),wn=new Er.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),Sn=new Er.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),En=new Er.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),Rn=function(e){return e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations",e}({}),In=(e,t)=>({responseEvents:e.filter(e=>{if(!e.isDecryptionFailure())return Sn.matches(e.getType())&&e.getTs()<=t})});class kn extends qe{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,o(this,"roomId",void 0),o(this,"pollEvent",void 0),o(this,"_isFetchingResponses",!1),o(this,"relationsNextBatch",void 0),o(this,"responses",null),o(this,"endEvent",void 0),o(this,"undecryptableRelationEventIds",new Set),o(this,"countUndecryptableEvents",e=>{var t=e.filter(e=>e.isDecryptionFailure()).map(e=>e.getId()),r=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==r&&this.emit(Rn.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return r(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(En.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(Rn.End)),this.responses){var r=(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=In([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach(e=>{this.responses.addEvent(e)}),this.emit(Rn.Responses,this.responses))}}fetchResponses(){var e=this;return r(function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(t=>e.matrixClient.decryptEventIfNeeded(t)));var i=e.responses||new Mr("m.reference",Sn.name,e.matrixClient,[Sn.altName]),o=n.events.find(e=>En.matches(e.getType()));e.validateEndEvent(o)&&(e.endEvent=o,e.refilterResponsesOnEnd(),e.emit(Rn.End));var s=(null===(t=e.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:a}=In(n.events,s);a.forEach(e=>{i.addEvent(e)}),e.relationsNextBatch=null!==(r=n.nextBatch)&&void 0!==r?r:void 0,e.responses=i,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(Rn.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(e=>{var r;e.getTs()>t&&(null===(r=this.responses)||void 0===r||r.removeEvent(e))}),this.emit(Rn.Responses,this.responses)}}validateEndEvent(e){if(!e)return!1;if(this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var Tn=e=>{var t=e.getType();return Er.M_POLL_START.matches(t)||Sn.matches(t)||En.matches(t)};class Cn{constructor(e){o(this,"room",void 0),o(this,"threadedReceipts",void 0),o(this,"unthreadedReceipts",void 0),o(this,"danglingReceipts",void 0),o(this,"onTimelineEvent",e=>{var t=e.getId();if(t){var r=this.danglingReceipts.remove(t);null==r||r.forEach(e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)})}}),this.room=e,this.threadedReceipts=new An(e),this.unthreadedReceipts=new Dn(e),this.danglingReceipts=new xn,e.on(Oi.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[i,o]of Object.entries(n))for(var[s,a]of Object.entries(o)){this.room.findEventById(r)?a.thread_id?this.threadedReceipts.set(a.thread_id,r,i,s,a.ts,t):this.unthreadedReceipts.set(r,i,s,a.ts,t):this.danglingReceipts.add(new Mn(r,i,s,a,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&Ln(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return xe.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var i=Pd(n),o=this.threadedReceipts.get(i,e);return!(!o||!Ln(o.eventId,t,this.room))||!!this.userSentLatestEventInThread(i,e)}userSentLatestEventInThread(e,t){var r,n=e===T?this.room.getLiveTimeline().getEvents():null===(r=this.room.getThread(e))||void 0===r?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class On{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class Mn{constructor(e,t,r,n,i){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=i}}class Pn{constructor(e){o(this,"room",void 0),o(this,"real",void 0),o(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&Ln(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!==(e=this.synthetic)&&void 0!==e?e:this.real}getByType(e){return e?this.synthetic:this.real}}class Dn{constructor(e){o(this,"room",void 0),o(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i){var o,s,a,c,l=Un(this.data,r,()=>new Pn(this.room)),d=l.getByType(i);d&&(o=d.eventId,s=e,a=this.room,c=a.compareEventOrdering(o,s),null!==c&&c>0)||l.set(i,new On(e,t,n))}get(e){var t;return null===(t=this.data.get(e))||void 0===t?void 0:t.get()}}class An{constructor(e){o(this,"room",void 0),o(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i,o){Un(this.data,e,()=>new Dn(this.room)).set(t,r,n,i,o)}get(e,t){var r;return null===(r=this.data.get(e))||void 0===r?void 0:r.get(t)}}class xn{constructor(){o(this,"data",new Map)}add(e){Un(this.data,e.eventId,()=>[]).push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function Un(e,t,r){var n=e.get(t);if(n)return n;var i=r();return e.set(t,i),i}function Ln(e,t,r){var n=r.compareEventOrdering(e,t);return null!==n&&n>=0}function Nn(e,t,r){var n=e.findEventById(t),i=e.findEventById(r);if(!n||!i)return null;var o=Dd(n),s=Dd(i);return o&&s?function(e,t,r,n,i){var o=e.getUnfilteredTimelineSet(),s=o.compareEventOrdering(t,r);if(null!==s)return s;var a=o.getTimelineForEvent(t);if(a===o.getLiveTimeline())return 1;var c=o.getTimelineForEvent(r);if(c===o.getLiveTimeline())return-1;return Fn(n,i)}(e,t,r,n,i):function(e,t,r,n){var i=Pd(r),o=Pd(n),s=r.getThread();return s&&i===o?s.timelineSet.compareEventOrdering(e,t):Fn(r,n)}(t,r,n,i)}function Fn(e,t){var r=e.getTs(),n=t.getTs();return r<n?-1:r>n?1:0}var jn=function(e){return e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e.Options="OPTIONS",e.Head="HEAD",e.Patch="PATCH",e}({});function Bn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Kn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Bn(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Bn(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class qn extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return 429===this.httpStatus}getRetryAfterMs(){var e,t=null===(e=this.httpHeaders)||void 0===e?void 0:e.get("Retry-After");if(null!=t){if(/^\d+$/.test(t)){var r=1e3*Number.parseInt(t);if(!Number.isFinite(r))throw new Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class Vn extends qn{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),r&&(s="".concat(s," (").concat(r,")")),super("MatrixError: ".concat(s),t,i),this.url=r,this.event=n,o(this,"errcode",void 0),o(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return"M_LIMIT_EXCEEDED"===this.errcode||("M_UNKNOWN"===this.errcode||void 0===this.errcode)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(null!==e)return e;if("M_LIMIT_EXCEEDED"===this.errcode&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,n,i={};if(this.httpHeaders)for(var[o,s]of this.httpHeaders)i[o]=s;return{http_status:null!==(e=this.httpStatus)&&void 0!==e?e:400,http_headers:i,url:null!==(t=this.url)&&void 0!==t?t:"",response:Kn({errcode:null!==(r=this.errcode)&&void 0!==r?r:"M_UNKNOWN",error:null!==(n=this.data.error)&&void 0!==n?n:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new Vn(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function Wn(e,t){if(!(e instanceof qn&&e.isRateLimitError()))return t;try{var r;return null!==(r=e.getRetryAfterMs())&&void 0!==r?r:t}catch(e){return t}}class Gn extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class Hn extends Error{constructor(e){var t;super(null!==(t=null==e?void 0:e.message)&&void 0!==t?t:"")}get name(){return"TokenRefreshError"}}class zn extends Error{constructor(e){var t;super(null!==(t=null==e?void 0:e.message)&&void 0!==t?t:"")}get name(){return"TokenRefreshLogoutError"}}var $n,Jn=function(e){return e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e}({}),Yn={};var Qn=function(){if($n)return Yn;$n=1;var e=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,t=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,r=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,n=/\\([\u000b\u0020-\u00ff])/g,i=/([\\"])/g,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function s(e){var n=String(e);if(r.test(n))return n;if(n.length>0&&!t.test(n))throw new TypeError("invalid parameter value");return'"'+n.replace(i,"\\$1")+'"'}function a(e){this.parameters=Object.create(null),this.type=e}return Yn.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,n=e.type;if(!n||!o.test(n))throw new TypeError("invalid type");var i=n;if(t&&"object"==typeof t)for(var a,c=Object.keys(t).sort(),l=0;l<c.length;l++){if(a=c[l],!r.test(a))throw new TypeError("invalid parameter name");i+="; "+a+"="+s(t[a])}return i},Yn.parse=function(t){if(!t)throw new TypeError("argument string is required");var r="object"==typeof t?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(t):t;if("string"!=typeof r)throw new TypeError("argument string is required to be a string");var i=r.indexOf(";"),s=-1!==i?r.slice(0,i).trim():r.trim();if(!o.test(s))throw new TypeError("invalid media type");var c=new a(s.toLowerCase());if(-1!==i){var l,d,u;for(e.lastIndex=i;d=e.exec(r);){if(d.index!==i)throw new TypeError("invalid parameter format");i+=d[0].length,l=d[1].toLowerCase(),34===(u=d[2]).charCodeAt(0)&&-1!==(u=u.slice(1,-1)).indexOf("\\")&&(u=u.replace(n,"$1")),c.parameters[l]=u}if(i!==r.length)throw new TypeError("invalid parameter format")}return c},Yn}();function Xn(e){var t=new AbortController;return setTimeout(()=>{t.abort()},e),t.signal}function Zn(e){var t=new AbortController;function r(){for(var t of e)t.removeEventListener("abort",n)}function n(){t.abort(),r()}for(var i of e){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:t.signal,cleanup:r}}function ei(e,t){var r,n,i,o=ti(e)?new Headers(e.getAllResponseHeaders().trim().split(/[\r\n]+/).map(e=>{var t=e.indexOf(":");return[e.substring(0,t),e.substring(t+1)]})):e.headers;try{i=function(e){var t=e.get("Content-Type");if(null===t)return null;try{return Qn.parse(t)}catch(e){throw new Error("Error parsing Content-Type '".concat(t,"': ").concat(e))}}(o)}catch(e){return e}return"application/json"===(null===(r=i)||void 0===r?void 0:r.type)&&t?new Vn(JSON.parse(t),e.status,ti(e)?e.responseURL:e.url,void 0,o):"text/plain"===(null===(n=i)||void 0===n?void 0:n.type)?new qn("Server returned ".concat(e.status," error: ").concat(t),e.status,o):new qn("Server returned ".concat(e.status," error"),e.status,o)}function ti(e){return"getResponseHeader"in e}function ri(e,t){return ni.apply(this,arguments)}function ni(){return(ni=r(function*(e,t){for(var r=0,n=null;r<e;)try{if(r>0){var i=1e3*Math.pow(2,r);xe.log("network operation failed ".concat(r," times, retrying in ").concat(i,"ms...")),yield z(i)}return yield t()}catch(e){if(!(e instanceof Gn))throw e;r+=1,n=e}throw n})).apply(this,arguments)}function ii(e,t,r){return t>4||e instanceof Gn&&!r||e.httpStatus&&4===Math.floor(e.httpStatus/100)&&429!==e.httpStatus||"AbortError"===e.name||"M_TOO_LARGE"===e.name?-1:Wn(e,1e3*Math.pow(2,t))}var oi=function(e){return e.Success="success",e.Failure="failure",e.Logout="logout",e}({});class si{constructor(e){this.opts=e,o(this,"tokenRefreshPromise",void 0),o(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return r(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return r(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;e.latestTokenRefreshExpiry&&(e.latestTokenRefreshExpiry.getTime()-Date.now()<=500&&(yield e._handleUnknownToken()))})()}handleUnknownToken(e,t){var n=this;return r(function*(){return n._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var n=this;return r(function*(){if(null!=e&&e.expiry&&e.expiry.getTime()-Date.now()>=6e4)return oi.Logout;if(!e||(null==e?void 0:e.accessToken)===n.opts.accessToken){var r;null!==(r=n.tokenRefreshPromise)&&void 0!==r||(n.tokenRefreshPromise=n.doTokenRefresh(t));try{return yield n.tokenRefreshPromise}finally{n.tokenRefreshPromise=void 0}}return oi.Success})()}doTokenRefresh(e){var t=this;return r(function*(){var r;if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction)return null===(r=t.opts.logger)||void 0===r||r.error("Unable to refresh token - no refresh token or refresh function"),oi.Logout;e&&e>1&&(yield z(1e3*Math.min(32,2**e)));try{var n,i;null===(n=t.opts.logger)||void 0===n||n.debug("Attempting to refresh token");var{accessToken:o,refreshToken:s,expiry:a}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=o,t.opts.refreshToken=s,t.latestTokenRefreshExpiry=a,null===(i=t.opts.logger)||void 0===i||i.debug("... token refresh complete, new token expiry:",a),oi.Success}catch(e){var c,l;return e instanceof zn||e instanceof Vn?(null===(l=t.opts.logger)||void 0===l||l.error("Failed to refresh token",e),oi.Logout):(null===(c=t.opts.logger)||void 0===c||c.warn("Failed to refresh token",e),oi.Failure)}})()}}function ai(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function ci(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ai(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ai(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class li{constructor(e,t){var r;if(this.eventEmitter=e,this.opts=t,o(this,"abortController",new AbortController),o(this,"tokenRefresher",void 0),L(t,["baseUrl","prefix"]),!t.onlyData)throw new Error("Constructing FetchHttpApi without `onlyData=true` is no longer supported.");t.useAuthorizationHeader=null===(r=t.useAuthorizationHeader)||void 0===r||r,this.tokenRefresher=new si(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,i){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var o=void 0,s=void 0;e===jn.Get?o=r:s=r;var a=this.getUrl(t,o,n,this.opts.idBaseUrl),c={json:!0,headers:{}};return i&&(c.headers.Authorization="Bearer ".concat(i)),this.requestOtherUrl(e,a,s,c)}authedRequest(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return this.doAuthedRequest(1,e,t,r,n,i)}doAuthedRequest(e,t,n,i,o){var s=arguments,a=this;return r(function*(){var r=s.length>5&&void 0!==s[5]?s[5]:{},c=N(r);c.abortSignal=r.abortSignal;var l=yield a.tokenRefresher.prepareForRequest();l.accessToken&&(a.opts.useAuthorizationHeader?(c.headers||(c.headers={}),c.headers.Authorization||(c.headers.Authorization="Bearer ".concat(l.accessToken)),i.access_token&&delete i.access_token):i.access_token||(i.access_token=l.accessToken));try{return yield a.request(t,n,i,o,c)}catch(s){if(!(s instanceof Vn))throw s;if("M_UNKNOWN_TOKEN"===s.errcode){var d=yield a.tokenRefresher.handleUnknownToken(l,e);if(d===oi.Success)return a.doAuthedRequest(e+1,t,n,i,o,r);if(d===oi.Failure)throw new Hn(s);null!=c&&c.inhibitLogoutEmit||a.eventEmitter.emit(Jn.SessionLoggedOut,s)}else"M_CONSENT_NOT_GIVEN"==s.errcode&&a.eventEmitter.emit(Jn.NoConsent,s.message,s.data.consent_uri);throw s}})()}request(e,t,r,n,i){var o=this.getUrl(t,r,null==i?void 0:i.prefix,null==i?void 0:i.baseUrl);return this.requestOtherUrl(e,o,n,i)}requestOtherUrl(e,t,n){var i=arguments,o=this;return r(function*(){var r,s,a,c,l=i.length>3&&void 0!==i[3]?i[3]:{};if(void 0!==l.json&&void 0!==l.rawResponseBody)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var d=o.sanitizeUrlForLogs(t);null===(r=o.opts.logger)||void 0===r||r.debug("FetchHttpApi: --\x3e ".concat(e," ").concat(d));var u=Object.assign({},l.headers||{}),h=!l.rawResponseBody&&!1!==l.json;h&&(u.Accept||(u.Accept="application/json"));var g,p=null!==(s=l.localTimeoutMs)&&void 0!==s?s:o.opts.localTimeoutMs,v=null!==(a=l.keepAlive)&&void 0!==a&&a,m=[o.abortController.signal];void 0!==p&&m.push(Xn(p)),l.abortSignal&&m.push(l.abortSignal),!1!==l.json&&(null==n||null===(c=n.constructor)||void 0===c?void 0:c.name)===Object.name?(g=JSON.stringify(n),u["Content-Type"]||(u["Content-Type"]="application/json")):g=n;var _,{signal:f,cleanup:y}=Zn(m),b=Date.now();try{var w;_=yield o.fetch(t,{signal:f,method:e,body:g,headers:u,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:v,priority:l.priority}),null===(w=o.opts.logger)||void 0===w||w.debug("FetchHttpApi: <-- ".concat(e," ").concat(d," [").concat(Date.now()-b,"ms ").concat(_.status,"]"))}catch(t){var S;if(null===(S=o.opts.logger)||void 0===S||S.debug("FetchHttpApi: <-- ".concat(e," ").concat(d," [").concat(Date.now()-b,"ms ").concat(t,"]")),"AbortError"===t.name)throw t;throw new Gn("fetch failed",t)}finally{y()}if(!_.ok)throw ei(_,yield _.text());return l.rawResponseBody?yield _.blob():h?yield _.json():yield _.text()})()}sanitizeUrlForLogs(e){try{var t;t="string"==typeof e?new URL(e):e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var i=r.toString(),o=i?"?".concat(i):"";return t.origin+t.pathname+o}catch(e){return"??"}}getUrl(e,t,r,n){var i=null!=n?n:this.opts.baseUrl,o=i.endsWith("/")?i.slice(0,-1):i,s=new URL(o+(null!=r?r:this.opts.prefix)+e);(this.opts.extraParams||t)&&D(ci(ci({},this.opts.extraParams),t),s.searchParams);return s}}var di,ui=function(e){return e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e}({}),hi=function(e){return e.V2="/_matrix/identity/v2",e}({}),gi=function(e){return e.V1="/_matrix/media/v1",e.V3="/_matrix/media/v3",e}({}),pi=0,vi=[],mi=function(){};function _i(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];(t=t||0)<0&&(t=0);var o=Date.now()+t,s=pi++,a={runAt:o,func:e,params:n,key:s},c=function(e,t){var r=0,n=e.length;for(;r<n;){var i=r+n>>1;t(e[i])>0?n=i:r=i+1}return r}(vi,function(e){return e.runAt-o});return vi.splice(c,0,a),yi(),s}function fi(e){if(0!==vi.length){var t;for(t=0;t<vi.length;t++){if(vi[t].key==e){vi.splice(t,1);break}}0===t&&yi()}}function yi(){di&&globalThis.clearTimeout(di);var e=vi[0];if(e){var t=Date.now(),r=Math.min(e.runAt-t,1e3);di=globalThis.setTimeout(bi,r)}}function bi(){for(var e=Date.now(),t=[];;){var r=vi[0];if(!r||r.runAt>e)break;var n=vi.shift();mi(n.key),t.push(n)}for(var i of(yi(),t))try{i.func.apply(globalThis,i.params)}catch(e){xe.error("Uncaught exception in callback function",e)}}class wi extends li{constructor(){super(...arguments),o(this,"uploads",[])}uploadContent(e){var t,r,n,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=null===(t=o.includeFilename)||void 0===t||t,a=null!==(r=o.abortController)&&void 0!==r?r:new AbortController,c=(null!==(n=o.type)&&void 0!==n?n:e.type)||"application/octet-stream",l=null!==(i=o.name)&&void 0!==i?i:e.name,d={loaded:0,total:0,abortController:a},u=Promise.withResolvers();if(globalThis.XMLHttpRequest){var h=new globalThis.XMLHttpRequest,g=function(){h.abort(),u.reject(new Error("Timeout"))},p=_i(g,3e4);h.onreadystatechange=function(){if(h.readyState===globalThis.XMLHttpRequest.DONE){fi(p);try{if(0===h.status)throw new DOMException(h.statusText,"AbortError");if(!h.responseText)throw new Error("No response body.");h.status>=400?u.reject(ei(h,h.responseText)):u.resolve(JSON.parse(h.responseText))}catch(e){if("AbortError"===e.name)return void u.reject(e);u.reject(new Gn("request failed",e))}}},h.upload.onprogress=e=>{var t;fi(p),d.loaded=e.loaded,d.total=e.total,p=_i(g,3e4),null===(t=o.progressHandler)||void 0===t||t.call(o,{loaded:e.loaded,total:e.total})};var v=this.getUrl("/upload",void 0,gi.V3);s&&l&&v.searchParams.set("filename",encodeURIComponent(l)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&v.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),h.open(jn.Post,v.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&h.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),h.setRequestHeader("Content-Type",c),h.send(e),a.signal.addEventListener("abort",()=>{h.abort()})}else{var m={};s&&l&&(m.filename=l);var _={"Content-Type":c};this.authedRequest(jn.Post,"/upload",m,e,{prefix:gi.V3,headers:_,abortSignal:a.signal}).then(u.resolve,u.reject)}return d.promise=u.promise.finally(()=>{U(this.uploads,e=>e===d)}),a.signal.addEventListener("abort",()=>{U(this.uploads,e=>e===d),u.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(d),d.promise}cancelUpload(e){var t=this.uploads.find(t=>t.promise===e);return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:gi.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var Si=function(e){return e.Stable="stable",e.Unstable="unstable",e}({});class Ei{constructor(e,t){var n=this;this.logger=e,this.http=t,o(this,"capabilities",void 0),o(this,"retryTimeout",void 0),o(this,"refreshTimeout",void 0),o(this,"fetchCapabilities",r(function*(){var e=yield n.http.authedRequest(jn.Get,"/capabilities");return n.capabilities=e.capabilities,n.capabilities})),o(this,"poll",r(function*(){try{yield n.fetchCapabilities(),n.clearTimeouts(),n.refreshTimeout=setTimeout(n.poll,216e5),n.logger.debug("Fetched new server capabilities")}catch(t){n.clearTimeouts();var e=Math.floor(3e4+5e3*Math.random());n.retryTimeout=setTimeout(n.poll,e),n.logger.warn("Failed to refresh capabilities: retrying in ".concat(e,"ms"),t)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}function Ri(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ii(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ri(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ri(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var ki="10",Ti=["1","2","3","4","5","6","7","8","9","10"],Ci=function(e){return e.Highlight="highlight",e.Total="total",e}({}),Oi=function(e){return e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications",e.Summary="Room.Summary",e}({});class Mi extends fn{constructor(e,t,n){var i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(),i=this,this.roomId=e,this.client=t,this.myUserId=n,this.opts=s,o(this,"reEmitter",void 0),o(this,"txnToEvent",new Map),o(this,"notificationCounts",{}),o(this,"bumpStamp",void 0),o(this,"threadNotifications",new Map),o(this,"cachedThreadReadReceipts",new Map),o(this,"oldestThreadedReceiptTs",1/0),o(this,"unthreadedReceipts",new Map),o(this,"timelineSets",void 0),o(this,"polls",new Map),o(this,"threadsTimelineSets",[]),o(this,"filteredTimelineSets",{}),o(this,"timelineNeedsRefresh",!1),o(this,"pendingEventList",void 0),o(this,"blacklistUnverifiedDevices",void 0),o(this,"selfMembership",void 0),o(this,"heroes",null),o(this,"getTypeWarning",!1),o(this,"membersPromise",void 0),o(this,"name",void 0),o(this,"normalizedName",void 0),o(this,"tags",{}),o(this,"accountData",new Map),o(this,"summary",null),o(this,"oldState",void 0),o(this,"currentState",void 0),o(this,"relations",void 0),o(this,"threads",new Map),o(this,"visibilityEvents",new Map),o(this,"roomReceipts",new Cn(this)),o(this,"threadTimelineSetsPromise",null),o(this,"threadsReady",!1),o(this,"updateThreadRootEvents",(e,t,r)=>{var n,i;e.length&&(this.updateThreadRootEvent(null===(n=this.threadsTimelineSets)||void 0===n?void 0:n[0],e,t,r),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(i=this.threadsTimelineSets)||void 0===i?void 0:i[1],e,t,r))}),o(this,"updateThreadRootEvent",(e,t,r,n)=>{e&&t.rootEvent&&(n&&e.removeEvent(t.id),Fd.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:Dr.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:r,addToState:!1}))}),o(this,"tryApplyRedaction",e=>{if(e.isRedaction()){var t=e.event.redacts,r=t?this.findEventById(t):void 0;r&&this.applyEventAsRedaction(e,r)}else if(e.getType()===Ve.RoomMember){var n=e.getContent().membership;if(n!==lt.Ban&&(n!==lt.Leave||e.getStateKey()===e.getSender()))return;if(!0!==e.getContent()["org.matrix.msc4293.redact_events"])return;if(!this.getLiveTimeline().getState(kr.Forward).maySendRedactionForEvent(e,e.getSender()))return;var i=this.getTimelineSets().map(e=>e.getTimelines()).reduce((e,t)=>(e.push(...t),e),[]).map(t=>t.getEvents().filter(t=>t.getSender()===e.getStateKey())).reduce((e,t)=>(e.push(...t),t),[]);for(var o of i)this.applyEventAsRedaction(e,o)}}),this.setMaxListeners(100),this.reEmitter=new Nr(this),s.pendingEventOrdering=s.pendingEventOrdering||_d.Chronological,this.name=e,this.normalizedName=e,this.relations=new Pr(this.client,this),this.on(Oi.Receipt,this.onReceipt),this.timelineSets=[new Ar(this,s)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[Oi.Timeline,Oi.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===_d.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(e=>{var n=this.client.getEventMapper({decrypt:!1});e.forEach(function(){var e=r(function*(e){var r=n(e);yield t.decryptEventIfNeeded(r),r.setStatus(xr.NOT_SENT),i.addPendingEvent(r,r.getTxnId())});return function(t){return e.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return r(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if(null!==(t=e.client)&&void 0!==t&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Vd.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch(t){return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return r(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(e=>e.event.event_id===t),i=r.slice(n).reverse().map(t=>e.client.decryptEventIfNeeded(t));yield Promise.allSettled(i)}})()}decryptAllEvents(){var e=this;return r(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(t=>e.client.decryptEventIfNeeded(t));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(Ve.RoomCreate,"");return null!==(e=null==t?void 0:t.getSender())&&void 0!==e?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return r(function*(){var t={};try{t=yield e.client.getCapabilities()}catch(e){}var r=t["m.room_versions"];if(!r)for(var n of(r={default:ki,available:{}},Ti))r.available[n]=Si.Stable;var i=e.checkVersionAgainstCapability(r);if(i.urgent&&i.needsUpgrade){xe.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(e){xe.warn("Failed to refresh room version capabilities",e)}if(!(r=t["m.room_versions"]))return xe.warn("No room version capability - assuming upgrade required."),i;i=e.checkVersionAgainstCapability(r)}return i})()}checkVersionAgainstCapability(e){var t=this.getVersion();xe.log("[".concat(this.roomId,"] Current version: ").concat(t)),xe.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?xe.warn("URGENT upgrade required on ".concat(this.roomId)):xe.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(Ve.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=U(this.pendingEventList,function(t){return t.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.some(t=>t.getId()===e))&&void 0!==t&&t}getPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.find(t=>t.getId()===e))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],i=this.getLastThread();if(!i)return n;var o=i.events[i.events.length-1];return(null!==(e=null==n?void 0:n.getTs())&&void 0!==e?e:0)>(null!==(t=null==o?void 0:o.getTs())&&void 0!==t?t:0)?n:o}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;var i=t.events[t.events.length-1],o=e.events[e.events.length-1];return(null!==(r=null==i?void 0:i.getTs())&&void 0!==r?r:0)>=(null!==(n=null==o?void 0:o.getTs())&&void 0!==n?n:0)?t:e},void 0)}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:lt.Leave}getDMInviter(){var e,t=this.getMember(this.myUserId);if(t)return t.getDMInviter();if(this.selfMembership===lt.Invite&&2===this.getInvitedAndJoinedMemberCount())return null===(e=this.heroes)||void 0===e||null===(e=e[0])||void 0===e?void 0:e.userId}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var r=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return r?r.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(rt.name,"");return Array.isArray(null==e?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(e=>{"join"!==e.membership&&"invite"!==e.membership||t.includes(e.userId)||r++}),!(r>2)){var n=null===(e=this.heroes)||void 0===e?void 0:e.filter(e=>!t.includes(e.userId)),i=Array.isArray(n)&&n.length;if(i){for(var o of n){if(o.fromMSC4186){var s=new ut(this.roomId,o.userId);return s.setMembershipEvent(new $d({event_id:"$"+this.roomId+o.userId+(new Date).getTime(),type:Ve.RoomMember,state_key:o.userId,content:{displayname:o.displayName,avatar_url:o.avatarUrl}})),s}var a=this.getMember(o.userId);if(a)return a}var c=n.map(e=>this.getMember(e.userId)).find(e=>!!e);if(c)return c}var l=this.getMembers(),d=null==l?void 0:l.filter(e=>!t.includes(e.userId));if(d.length<=2){var u=d.find(e=>e.userId!==this.myUserId);if(u)return u}if(i){var h=n.map(e=>this.client.getUser(e.userId)).find(e=>!!e);if(h){var g=new ut(this.roomId,h.userId);return g.user=h,g}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===lt.Leave&&this.cleanupAfterLeaving(),this.emit(Oi.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return r(function*(){var t=e.client.store.getSyncToken();return(yield e.client.members(e.roomId,void 0,lt.Leave,null!=t?t:void 0)).chunk})()}loadMembers(){var e=this;return r(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);return(null===r||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),xe.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId))),{memberEvents:r.filter(me).map(e.client.getEventMapper()),fromServer:t}})()}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer)).catch(e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){var t=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event});return xe.log("LL: telling store to write ".concat(t.length)+" members for room ".concat(this.roomId)),this.client.store.setOutOfBandMembers(this.roomId,t).catch(e=>{xe.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{xe.error(e)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return r(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{xe.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),xe.log(e)})}refreshLiveTimeline(){var e=this;return r(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(Tr.FORWARDS),n=t.getPaginationToken(Tr.BACKWARDS),i=t.getEvents(),o=i[i.length-1];xe.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var s,a=e.getUnfilteredTimelineSet();o?(e.resetLiveTimeline(null,null),e.emit(Oi.TimelineRefresh,e,a),s=yield e.client.getEventTimeline(a,o.getId())):s=yield e.client.getLatestTimeline(a);var c=a.getLiveTimeline();!c||null===c.getPaginationToken(kr.Forward)&&null===c.getPaginationToken(kr.Backward)&&0===c.getEvents().length?(xe.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),s.setPaginationToken(r,Tr.FORWARDS),a.setLiveTimeline(s),e.fixUpLegacyTimelineFields()):xe.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(Oi.TimelineRefresh,e,a)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(Tr.BACKWARDS),this.currentState=this.getLiveTimeline().getState(Tr.FORWARDS),e!==this.oldState&&this.emit(Oi.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(Oi.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[Zd.Events,Zd.Members,Zd.NewMember,Zd.Update,Zd.Marker,un.New,un.Update,un.Destroy,un.LivenessChange]),this.reEmitter.reEmit(this.currentState,[Zd.Events,Zd.Members,Zd.NewMember,Zd.Update,Zd.Marker,un.New,un.Update,un.Destroy,un.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var i of Object.values(n))for(var[o,s]of Object.entries(i))if(de(o)&&s)for(var[a,c]of Object.entries(s))if(c&&"object"==typeof c){var l=c;a===this.client.getUserId()&&(void 0===l.thread_id?r=!0:"string"==typeof l.thread_id&&t.push(l.thread_id))}for(var d of(r&&(t=this.getThreads().filter(e=>this.getThreadUnreadNotificationCount(e.id,Ci.Total)>0||this.getThreadUnreadNotificationCount(e.id,Ci.Highlight)>0).map(e=>e.id)).push("main"),t)){var u,h="main"===d?this.getLiveTimeline():null===(u=this.getThread(d))||void 0===u?void 0:u.liveTimeline;if(h){for(var g=h.getEvents(),p=0,v=g.length-1;v>=0;v--){var m;if(v===g.length-20)return;var _=g[v];if(this.hasUserReadEvent(this.client.getUserId(),_.getId()))break;var f=this.client.getPushActionsForEvent(_);p+=null!=f&&null!==(m=f.tweaks)&&void 0!==m&&m.highlight?1:0}"main"===d?this.setUnreadNotificationCount(Ci.Highlight,p):this.setThreadUnreadNotificationCount(d,Ci.Highlight,p)}else xe.warn("Couldn't find timeline for thread ID ".concat(d," in room ").concat(this.roomId))}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){if(t=r[n].findEventById(e))return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ci.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=null!==(n=r[e])&&void 0!==n?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ci.Total,r=arguments.length>1?arguments[1]:void 0;return null!==(e=!!r.threadRootId&&!r.isThreadRoot?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))&&void 0!==e?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ci.Total;return null!==(e=this.notificationCounts[t])&&void 0!==e?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ci.Total;return null!==(t=null===(r=this.threadNotifications.get(e))||void 0===r?void 0:r[n])&&void 0!==t?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if((null!==(t=e.highlight)&&void 0!==t?t:0)>0||(null!==(r=e.total)&&void 0!==r?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,i,o=Ii({highlight:null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n.highlight,total:null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i.total},{[t]:r});this.threadNotifications.set(e,o),this.emit(Oi.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if((null!==(r=t.highlight)&&void 0!==r?r:0)>0)return Ci.Highlight;(null!==(n=t.total)&&void 0!==n?n:0)>0&&!e&&(e=Ci.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(Oi.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(Oi.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,r=null===(t=e["m.heroes"])||void 0===t?void 0:t.map(e=>({userId:e,fromMSC4186:!1})),n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(r)&&(this.heroes=r.filter(e=>e.userId!=this.myUserId)),this.emit(Oi.Summary,e)}setMSC4186SummaryData(e,t,r){e&&(this.heroes=e.filter(e=>e.user_id!==this.myUserId).map(e=>({userId:e.user_id,displayName:e.displayname,avatarUrl:e.avatar_url,fromMSC4186:!0}))),void 0!==t&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),void 0!==r&&Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),this.emit(Oi.Summary,{"m.heroes":this.heroes?this.heroes.map(e=>e.userId):[],"m.joined_member_count":t,"m.invited_member_count":r})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=this.currentState.getStateEvents(Ve.RoomAvatar,"");if(!s&&!i)return null;var a=s?s.getContent().url:null;return a?Ce(e,a,t,r,n,void 0,void 0,o):null}getMxcAvatarUrl(){var e;return(null===(e=this.currentState.getStateEvents(Ve.RoomAvatar,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(Ve.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(Ve.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,r,n,i){n.getTimelineSet().addEventsToTimeline(e,t,r,n,i)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(lt.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return r(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(lt.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(lt.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(Ve.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return!!r&&r.membership===t}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var i=Object.assign({filter:e,pendingEvents:n},this.opts),o=new Ar(this,i);this.reEmitter.reEmit(o,[Oi.Timeline,Oi.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));var s=this.getLiveTimeline();if(t){s.getEvents().forEach(function(e){o.addLiveEvent(e,{addToState:!1})});for(var a=s;a.getNeighbouringTimeline(Tr.BACKWARDS);)a=a.getNeighbouringTimeline(Tr.BACKWARDS);o.getLiveTimeline().setPaginationToken(a.getPaginationToken(Tr.BACKWARDS),Tr.BACKWARDS)}else if(r){var c=s.getPaginationToken(kr.Forward);o.getLiveTimeline().setPaginationToken(c,kr.Backward)}return o}getThreadListFilter(){var e=arguments,t=this;return r(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:Vd.All,n=t.client.getUserId(),i=new Vr(n),o={room:{timeline:{[Kd.name]:[qd.name]}}};r===Vd.My&&(o.room.timeline[Bd.name]=[n]),i.setDefinition(o);var s=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),i);return i.filterId=s,i})()}createThreadTimelineSet(e){var t=this;return r(function*(){var r;if(Fd.hasServerSideListSupport)r=new Ar(t,Ii(Ii({},t.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:Vd.All),t.reEmitter.reEmit(r,[Oi.Timeline,Oi.TimelineReset]);else if(Fd.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new Ar(t,{pendingEvents:!1}),Array.from(t.threads).forEach(n=>{var[,i]=n;if(0!==i.length){var o=i.timeline.some(e=>e.getSender()===t.client.getUserId());(e!==Vd.My||o)&&r.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)Tr.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return r(function*(){if(!e.threadsReady&&e.client.supportsThreads()){if(Fd.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Vd.All),e.fetchRoomThreadList(Vd.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,kr.Backward,t);if(!r.length)return;var n,i=r.map(e.client.getEventMapper()).sort((e,t)=>{var r=e.getServerAggregatedRelation(qd.name),n=t.getServerAggregatedRelation(qd.name);return r.latest_event.origin_server_ts-n.latest_event.origin_server_ts}),o=e.getLiveTimeline().getState(Tr.FORWARDS);for(var s of i){var a,c={duplicateStrategy:Dr.Ignore,fromCache:!1,addToState:!1,roomState:o};null===(a=e.threadsTimelineSets[0])||void 0===a||a.addLiveEvent(s,c);var l,d=s.getServerAggregatedRelation(qd.name);if(null!=d&&d.current_user_participated)null===(l=e.threadsTimelineSets[1])||void 0===l||l.addLiveEvent(s,c),n=s}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),n&&e.client.decryptEventIfNeeded(n)}e.on(Ud.NewReply,e.onThreadReply),e.on(Ud.Update,e.onThreadUpdate),e.on(Ud.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return r(function*(){for(var r of e)try{if(!r.isEncrypted()&&!Tn(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(e){xe.warn("Error processing poll event",r.getId(),e)}})()}processPollEvent(e){var t=this;return r(function*(){if(e.isDecryptionFailure())e.once(zd.Decrypted,e=>{t.processPollEvent(e)});else if(Er.M_POLL_START.matches(e.getType()))try{var r=new kn(e,t.client,t);t.polls.set(e.getId(),r),t.emit(Rn.New,r),e.once(zd.BeforeRedaction,e=>{t.polls.delete(e.getId())})}catch(e){}else{var n=e.relationEventId;if(n&&t.polls.has(n)){var i=t.polls.get(n);null==i||i.onNewRelation(e)}}})()}fetchRoomThreadList(e){var t=this;return r(function*(){if(t.client.supportsThreads()&&0!==t.threadsTimelineSets.length){var r=e===Vd.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:i}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,kr.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(null!=i?i:null,kr.Backward),n.length){var o=n.map(t.client.getEventMapper());t.processThreadRoots(o,!0);var s=t.getLiveTimeline().getState(Tr.FORWARDS);for(var a of o)r.addLiveEvent(a,{duplicateStrategy:Dr.Replace,fromCache:!1,roomState:s,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=null==r||null===(t=r.getEvents())||void 0===t?void 0:t.find(t=>t.getId()===e.id);for(var i of(n?e.clearEventMetadata(n):xe.debug("onThreadDelete: Could not find root event in room timeline"),this.threadsTimelineSets))i.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(null===(n=this.client)||void 0===n||!n.supportsThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=r&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var i,o,s=e.isRelation(qd.name),a=e.getAssociatedId(),c=e.threadRootId;if(a&&!s&&(c===a||null!=r&&r.has(a)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};a&&(i=null!==(o=this.findEventById(a))&&void 0!==o?o:null==t?void 0:t.find(e=>e.getId()===a));return i&&!s?this.eventShouldLiveIn(i,t,r):null!=c?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:c}:!a||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getThread(e);if(n)n.addEvents(t,r);else{var i,o=null!==(i=this.findEventById(e))&&void 0!==i?i:t.find(t=>t.getId()===e);this.createThread(e,o,t,r)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var r={};for(var n of e){var i,{threadId:o,shouldLiveInThread:s}=this.eventShouldLiveIn(n);s&&!r[o]&&(r[o]=[]),null===(i=r[o])||void 0===i||i.push(n)}Object.entries(r).map(e=>{var[r,n]=e;return this.addThreadedEvents(r,n,t)})}createThread(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var o=this.relations.getAllChildEventsForEvent(t.getId());null!=o&&o.length&&(n=n.concat(o.filter(e=>!e.isRelation(We.Replace))))}var s=new Fd(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(r=this.cachedThreadReadReceipts.get(e))&&void 0!==r?r:[]});return this.reEmitter.reEmit(s,[Ud.Delete,Ud.Update,Ud.NewReply,Oi.Timeline,Oi.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(s.id,s),s.addEvents(n,!1),this.threadsReady&&s.initialEventsFetched&&this.updateThreadRootEvents(s,i,!1),this.emit(Ud.New,s,i),s}applyEventAsRedaction(e,t){var r=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var n=this.currentState.getStateEvents(t.getType(),t.getStateKey());(null==n?void 0:n.getId())===t.getId()&&this.currentState.setStateEvents([t])}this.emit(Oi.Redaction,e,this,r),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){if(this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(var[t,r]of this.txnToEvent)if(r.getId()===e.getId()){xe.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());var n=e.getUnsigned();n.transaction_id=t,e.setUnsigned(n);break}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:i,addToState:o}=t;for(var s of this.timelineSets)s.addLiveEvent(e,{duplicateStrategy:r,fromCache:i,timelineWasEmpty:n,addToState:o});e.sender&&e.getType()!==Ve.RoomRedaction&&this.addReceipt(_n(e.sender.userId,e,k.Read),!0)}addPendingEvent(e,t){if(e.status!==xr.SENDING&&e.status!==xr.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(Tr.setEventMetadata(e,this.getLiveTimeline().getState(Tr.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(e=>e.status===xr.NOT_SENT)&&(xe.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(xr.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(e=>e.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(Oi.Redaction,e,this,n.threadRootId))}}else for(var i of this.timelineSets)i.getFilter()?i.getFilter().filterRoomTimeline([e]).length&&i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(Oi.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(e=>Ii(Ii({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{var t=e.type===Ve.RoomMessageEncrypted,r=this.hasEncryptionStateEvent();return t||!r});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),i=t.status;xe.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(i)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:o,threadId:s}=this.eventShouldLiveIn(e),a=s?this.getThread(s):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,r,n),o)for(var c of this.timelineSets)c.handleRemoteEcho(t,r,n);this.emit(Oi.LocalEchoUpdated,t,this,r,i)}updatePendingEvent(e,t,r){if(xe.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==xr.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==xr.SENT&&this.getTimelineForEvent(r)){var n=this.findEventById(r);if(!(null==n?void 0:n.getUnsigned().transaction_id)&&n){var i=n.getUnsigned();i.transaction_id=e.getTxnId(),n.setUnsigned(i),this.removeEvent(n.getId()),this.handleRemoteEcho(n,e)}return}var o=e.status,s=e.getId();if(!o)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var a=Pi[o];if(null==a||!a.includes(t))throw new Error("Invalid EventStatus transition ".concat(o,"->").concat(t));if(e.setStatus(t),t==xr.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:c,threadId:l}=this.eventShouldLiveIn(e),d=l?this.getThread(l):void 0;if(null==d||d.setEventMetadata(e),null==d||d.timelineSet.replaceEventId(s,r),c)for(var u of this.timelineSets)u.replaceEventId(s,r)}else if(t==xr.CANCELLED){if(this.pendingEventList){var h=this.getPendingEvent(s);this.removePendingEvent(s),null!=h&&h.isRedaction()&&this.revertRedactionLocalEcho(h)}this.removeEvent(s)}this.savePendingEvents(),this.emit(Oi.LocalEchoUpdated,e,this,s,o)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(Oi.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(Tr.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(Tr.FORWARDS)+")");if(t.getNeighbouringTimeline(Tr.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var n=this;return r(function*(){var{duplicateStrategy:r,fromCache:i,timelineWasEmpty:o=!1,addToState:s}=t;if(r&&-1===["replace","ignore"].indexOf(r))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");n.assertTimelineSetsAreLive();var a=n.findThreadRoots(e),c={},l={duplicateStrategy:r,fromCache:i,timelineWasEmpty:o,addToState:s},d=[...e];for(var u of e){var h;if(n.processLiveEvent(u),u.getUnsigned().transaction_id){var g=n.txnToEvent.get(u.getUnsigned().transaction_id);if(g){n.handleRemoteEcho(u,g);continue}}var{shouldLiveInRoom:p,shouldLiveInThread:v,threadId:m=""}=n.eventShouldLiveIn(u,d,a);if(!v&&!p&&u.isRelation())try{var _=new $d(yield n.client.fetchRoomEvent(n.roomId,u.relationEventId));if(d.push(_),_.threadRootId){a.add(_.threadRootId);var f=u.getUnsigned();f[at.name]=_.threadRootId,u.setUnsigned(f)}({shouldLiveInRoom:p,shouldLiveInThread:v,threadId:m=""}=n.eventShouldLiveIn(u,d,a))}catch(e){xe.error("Failed to load parent event of unhandled relation",e)}v&&!c[m]&&(c[m]=[]),null===(h=c[m])||void 0===h||h.push(u),p?n.addLiveEvent(u,l):!v&&u.isRelation()&&n.relations.aggregateChildEvent(u)}Object.entries(c).forEach(e=>{var[t,r]=e;n.addThreadedEvents(t,r,!1)})})()}partitionThreadedEvents(e){if(this.client.supportsThreads()){var t=this.findThreadRoots(e);return e.reduce((r,n)=>{var{shouldLiveInRoom:i,shouldLiveInThread:o,threadId:s}=this.eventShouldLiveIn(n,e,t);return i&&r[0].push(n),o&&(n.setThreadId(null!=s?s:""),r[1].push(n)),o||i||r[2].push(n),r},[[],[],[]])}return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;null!=n&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(e=>{Object.keys(r[e]).forEach(n=>{Object.keys(r[e][n]).forEach(i=>{var o,s,a,c,l=r[e][n][i],d=!l.thread_id||l.thread_id===T,u=d?this:this.threads.get(null!==(o=l.thread_id)&&void 0!==o?o:"");if(u){if(u.addReceiptToStructure(e,n,i,l,t),!t&&this.client.isInitialSyncComplete()&&i===this.client.getUserId()){var h=u.timeline[u.timeline.length-1];h&&e===h.getId()&&i===h.getSender()&&(u.setUnread(Ci.Total,0),u.setUnread(Ci.Highlight,0))}}else this.cachedThreadReadReceipts.set(l.thread_id,[...null!==(c=this.cachedThreadReadReceipts.get(l.thread_id))&&void 0!==c?c:[],{eventId:e,receiptType:n,userId:i,receipt:l,synthetic:t}]);i===this.client.getUserId()&&!d&&l.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=l.ts),!l.thread_id&&l.ts>(null!==(s=null===(a=this.unthreadedReceipts.get(i))||void 0===a?void 0:a.ts)&&void 0!==s?s:0)&&this.unthreadedReceipts.set(i,l)})})}),this.emit(Oi.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===Ve.Typing?this.currentState.setTypingEvent(t):t.getType()===Ve.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(Ve.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===lt.Invite)(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new $d({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}var r=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=K(this.name.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase(),this.summary=new Ur(this.roomId,{title:this.name}),r!==this.name&&this.emit(Oi.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(Oi.Tags,e,this)}addAccountData(e){for(var t of e){"m.tag"===t.getType()&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(Oi.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===lt.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(Ve.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(Ve.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===lt.Join,r=this.currentState.getStateEvents(Ve.RoomPowerLevels,""),n=r&&r.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(Ve.RoomCreate,"");if(e)return e.getContent()[He];this.getTypeWarning||(xe.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===ze.Space}isCallRoom(){return this.getType()===ze.UnstableCall}isElementVideoRoom(){return this.getType()===ze.ElementVideo}findPredecessor(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.getLiveTimeline().getState(Tr.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case Di.Actual:return e.name;case Di.Generated:return"Inviting"===e.subtype?"Inviting ".concat(Ai(e.names,e.count)):Ai(e.names,e.count);case Di.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){if(!(arguments.length>1&&void 0!==arguments[1]&&arguments[1])){var t=this.currentState.getStateEvents(Ve.RoomName,"");if(null!=t&&t.getContent().name)return this.roomNameGenerator({type:Di.Actual,name:t.getContent().name})}var r=this.getCanonicalAlias();if(r)return this.roomNameGenerator({type:Di.Actual,name:r});var n=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=this.getFunctionalMembers(),o=[];if(this.heroes)this.heroes.forEach(e=>{if(i.includes(e.userId))n--;else if(e.displayName)o.push(e.displayName);else{var t=this.getMember(e.userId);o.push(t?t.name:e.userId)}});else{var s=this.currentState.getMembers().filter(t=>t.userId!==e&&(t.membership===lt.Invite||t.membership===lt.Join));s=s.filter(e=>{var{userId:t}=e;return!i.includes(t)||(n--,!1)});var a=new Intl.Collator;s.sort((e,t)=>a.compare(e.userId,t.userId)),s=s.slice(0,5),o=s.map(e=>e.name)}if(n)return this.roomNameGenerator({type:Di.Generated,names:o,count:n});if(this.getMyMembership()==lt.Join){var c=this.currentState.getStateEvents(Ve.RoomThirdPartyInvite);if(null!=c&&c.length){var l=c.map(e=>e.getContent().display_name);return this.roomNameGenerator({type:Di.Generated,subtype:"Inviting",names:l,count:l.length+1})}}var d,u=o;return u.length||(u=this.currentState.getMembers().filter(t=>t.userId!==e&&t.membership!==lt.Invite&&t.membership!==lt.Join).map(e=>e.name)),u.length&&(d=this.roomNameGenerator({type:Di.Generated,names:u,count:u.length+1})),this.roomNameGenerator({type:Di.EmptyRoom,oldName:d})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r)if(nt.name&&this.currentState.maySendStateEvent(nt.name,r)||nt.altName&&this.currentState.maySendStateEvent(nt.altName,r)){var n=this.visibilityEvents.get(t.eventId);if(n){for(var i=n.length-1,o=Math.max(0,n.length-30);i>=o;--i){if(n[i].getTs()<e.getTs())break}-1===i?n.unshift(e):n.splice(i+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var s=this.findEventById(t.eventId);s&&s.applyVisibilityEvent(t)}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=null==t?void 0:t.event_id,n=this.visibilityEvents.get(r);if(n){var i=n.findIndex(t=>t.getId()===e.getId());if(-1!==i&&(n.splice(i,1),i===n.length)){var o=this.findEventById(r);if(!o)return;if(0===i)this.visibilityEvents.delete(r),o.applyVisibilityEvent();else{var s=n[n.length-1].asVisibilityChange();if(!s)throw new Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(s)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(t&&0!=t.length){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,r.getTs()<e.getTs()||e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(e=>this.getThreadUnreadNotificationCount(e.id,Ci.Total)>0);for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return Nn(this,e,t)}hasEncryptionStateEvent(){var e;return Boolean(null===(e=this.getLiveTimeline().getState(Tr.FORWARDS))||void 0===e?void 0:e.getStateEvents(Ve.RoomEncryption,""))}}var Pi={[xr.ENCRYPTING]:[xr.SENDING,xr.NOT_SENT,xr.CANCELLED],[xr.SENDING]:[xr.ENCRYPTING,xr.QUEUED,xr.NOT_SENT,xr.SENT],[xr.QUEUED]:[xr.SENDING,xr.NOT_SENT,xr.CANCELLED],[xr.SENT]:[],[xr.NOT_SENT]:[xr.SENDING,xr.QUEUED,xr.CANCELLED],[xr.CANCELLED]:[]},Di=function(e){return e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e}({});function Ai(e,t){var r=t-1;return e.length?1===e.length&&r<=1?e[0]:2===e.length&&r<=2?"".concat(e[0]," and ").concat(e[1]):r>1?"".concat(e[0]," and ").concat(r," others"):"".concat(e[0]," and 1 other"):"Empty room"}var xi=function(e){return e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported",e}({}),Ui=function(e){return e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion",e.RelationsRecursion="RelationsRecursion",e.IntentionalMentions="IntentionalMentions",e}({}),Li={[Ui.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[Ui.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[Ui.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[Ui.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[Ui.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[Ui.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[Ui.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function Ni(){return(Ni=r(function*(e){var t=new Map;for(var[r,n]of Object.entries(Li)){var i,o,s,a,c=null!==(i=null===(o=e.versions)||void 0===o?void 0:o.includes(n.matrixVersion||""))&&void 0!==i&&i,l=null!==(s=null===(a=n.unstablePrefixes)||void 0===a?void 0:a.every(t=>{var r;return!0===(null===(r=e.unstable_features)||void 0===r?void 0:r[t])}))&&void 0!==s&&s;c?t.set(r,xi.Stable):l?t.set(r,xi.Unstable):t.set(r,xi.Unsupported)}return t})).apply(this,arguments)}function Fi(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function ji(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Fi(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Fi(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var Bi=function(e){return e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING",e}({}),Ki=["org.matrix.msc2716v3"];function qi(e,t){return"FILTER_SYNC_".concat(e)+(t?"_"+t:"")}var Vi=function(e){return e.Offline="offline",e.Online="online",e.Unavailable="unavailable",e}({});function Wi(e){return ji({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:_d.Chronological,threadSupport:!1},e)}function Gi(e){return ji({canResetEntireTimeline:e=>!1},e)}class Hi{constructor(e,t,n){var i=this;this.client=e,o(this,"opts",void 0),o(this,"syncOpts",void 0),o(this,"_peekRoom",null),o(this,"currentSyncRequest",void 0),o(this,"abortController",void 0),o(this,"syncState",null),o(this,"syncStateData",void 0),o(this,"catchingUp",!1),o(this,"running",!1),o(this,"keepAliveTimer",void 0),o(this,"connectionReturnedResolvers",void 0),o(this,"notifEvents",[]),o(this,"failedSyncCount",0),o(this,"storeIsInvalid",!1),o(this,"presence",void 0),o(this,"getPushRules",r(function*(){try{i.syncOpts.logger.debug("Getting push rules...");var e=yield i.client.getPushRules();i.syncOpts.logger.debug("Got push rules"),i.client.pushRules=e}catch(e){if(i.syncOpts.logger.error("Getting push rules failed",e),i.shouldAbortSync(e))return;return i.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,e),i.getPushRules()}})),o(this,"buildDefaultFilter",()=>{var e=new Vr(this.client.credentials.userId);return this.client.canSupport.get(Ui.ThreadUnreadNotifications)!==xi.Unsupported&&e.setUnreadThreadNotifications(!0),e}),o(this,"prepareLazyLoadingForSync",r(function*(){i.syncOpts.logger.debug("Prepare lazy loading for sync..."),i.client.isGuest()&&(i.opts.lazyLoadMembers=!1),i.opts.lazyLoadMembers&&(i.syncOpts.logger.debug("Enabling lazy load on sync filter..."),i.opts.filter||(i.opts.filter=i.buildDefaultFilter()),i.opts.filter.setLazyLoadMembers(!0))})),o(this,"storeClientOptions",r(function*(){try{i.syncOpts.logger.debug("Storing client options..."),yield i.client.storeClientOptions(),i.syncOpts.logger.debug("Stored client options")}catch(e){throw i.syncOpts.logger.error("Storing client options failed",e),e}})),o(this,"getFilter",r(function*(){var e,t;i.syncOpts.logger.debug("Getting filter..."),e=i.opts.filter?i.opts.filter:i.buildDefaultFilter();try{t=yield i.client.getOrCreateFilter(qi(i.client.credentials.userId),e)}catch(e){return i.syncOpts.logger.error("Getting filter failed",e),i.shouldAbortSync(e)?{}:(i.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield i.recoverFromSyncStartupError(i.savedSyncPromise,e),i.getFilter())}return{filter:e,filterId:t}})),o(this,"savedSyncPromise",void 0),o(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=Wi(t),this.syncOpts=Gi(n),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[Oi.Timeline,Oi.TimelineReset])}createRoom(e){var t=zi(this.client,e,this.opts);return t.on(Zd.Marker,(e,r)=>{this.onMarkerStateEvent(t,e,r)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r?this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh."):Ki.includes(e.getVersion())||t.getSender()===e.getCreator()?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(Oi.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return r(function*(){var t,n=e.client,i=new Vr(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var o=e.opts.pollTimeout+8e4,s={timeout:0,filter:yield n.getOrCreateFilter(qi(n.credentials.userId,"LEFT_ROOMS"),i),"org.matrix.msc4222.use_state_after":!0},a=yield n.http.authedRequest(jn.Get,"/sync",s,void 0,{localTimeoutMs:o}),c=[];null!==(t=a.rooms)&&void 0!==t&&t.leave&&(c=e.mapSyncResponseToRoomArray(a.rooms.leave));var l=yield Promise.all(c.map(function(){var t=r(function*(t){var r=t.room;if(t.isBrandNewRoom){t.timeline=t.timeline||{prev_batch:null,events:[]},r.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,Tr.BACKWARDS);var{timelineEvents:i}=yield e.mapAndInjectRoomEvents(t);return r.recalculate(),n.store.storeRoom(r),n.emit(kd.Room,r),e.processEventsForNotifs(r,i),r}});return function(e){return t.apply(this,arguments)}}()));return l.filter(Boolean)})()}peek(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;if((null===(t=this._peekRoom)||void 0===t?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then(t=>{var r;if((null===(r=this._peekRoom)||void 0===r?void 0:r.roomId)!==e)throw new Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];var i=N(t.state).map(n.getEventMapper()),o=t.state.map(n.getEventMapper()),s=t.messages.chunk.map(n.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(n.getEventMapper()).forEach(function(e){var t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=Ir.createUser(e.getContent().user_id,n)).setPresenceEvent(e),n.store.storeUser(t)),n.emit(kd.Event,e)}),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(i),this._peekRoom.currentState.setStateEvents(o),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(s.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),t.messages.start),n.store.storeRoom(this._peekRoom),n.emit(kd.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var n,i=this;this._peekRoom===e?this.client.http.authedRequest(jn.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(n=this.abortController)||void 0===n?void 0:n.signal}).then(function(){var t=r(function*(t){if(i._peekRoom===e){t.chunk.filter(function(e){return"m.presence"===e.type}).map(i.client.getEventMapper()).forEach(e=>{var t=i.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=Ir.createUser(e.getContent().user_id,i.client)).setPresenceEvent(e),i.client.store.storeUser(t)),i.client.emit(kd.Event,e)});var r=t.chunk.filter(function(t){return t.room_id===e.roomId&&t.event_id}).map(i.client.getEventMapper());yield e.addLiveEvents(r,{addToState:!0}),i.peekPoll(e,t.end)}else i.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId)});return function(e){return t.apply(this,arguments)}}(),r=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,r),setTimeout(()=>{this.peekPoll(e,t)},3e4)}):this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}recoverFromSyncStartupError(e,t){var n=this;return r(function*(){yield e;var r=n.startKeepAlives();n.updateSyncState(Bi.Error,{error:t}),yield r})()}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Bi.Error,{error:e}),!0)}sync(){var e=this;return r(function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,null===(t=globalThis.window)||void 0===t||null===(r=t.addEventListener)||void 0===r||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then(t=>(e.syncOpts.logger.debug("Got saved sync token"),t));e.savedSyncPromise=e.client.store.getSavedSync().then(t=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!t)),t)return e.syncFromCache(t)}).catch(t=>{e.syncOpts.logger.error("Getting saved sync failed",t)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:i,filter:o}=yield e.getFilter();if(o){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var s=i,a=yield n;if(a)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var c=e.buildDefaultFilter();c.setDefinition(o.getDefinition()),c.setTimelineLimit(e.opts.initialSyncLimit),s=JSON.stringify(c.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:s},a)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:i})}})()}stop(){var e,t,r;this.syncOpts.logger.debug("SyncApi.stop"),null===(e=globalThis.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(r=this.abortController)||void 0===r||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedResolvers&&(this.startKeepAlives(0),!0)}syncFromCache(e){var t=this;return r(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},i={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,i)}catch(e){t.syncOpts.logger.error("Error processing cached sync",e)}t.storeIsInvalid||t.updateSyncState(Bi.Prepared,n)})()}doSync(e){var t=this;return r(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(e){if(yield t.onSyncError(e))return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var i={oldSyncToken:null!=r?r:void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(i,n)}catch(e){t.syncOpts.logger.error("Caught /sync error",e),t.client.emit(kd.SyncUnexpectedError,e)}yield t.client.store.setSyncData(n),i.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(Bi.Prepared,i),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(i)),t.updateSyncState(Bi.Syncing,i),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Bi.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(jn.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+8e4,abortSignal:null===(r=this.abortController)||void 0===r?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==Bi.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var i={filter:n,timeout:r,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?i.set_presence=Vi.Offline:void 0!==this.presence&&(i.set_presence=this.presence),t?i.since=t:i._cacheBuster=Date.now(),[Bi.Reconnecting,Bi.Error].includes(this.getSyncState())&&(i.timeout=0),i}setPresence(e){this.presence=e}onSyncError(e){var t=this;return r(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Bi.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var r=t.startKeepAlives();return t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=3?Bi.Error:Bi.Reconnecting,{error:e}),(yield r)&&t.getSyncState()===Bi.Error&&t.updateSyncState(Bi.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var n=this;return r(function*(){var i,o,s,a,c=n.client;if(Array.isArray(null===(i=t.presence)||void 0===i?void 0:i.events)&&t.presence.events.filter(me).map(c.getEventMapper()).forEach(function(e){var t=c.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=Ir.createUser(e.getSender(),c)).setPresenceEvent(e),c.store.storeUser(t)),c.emit(kd.Event,e)}),Array.isArray(null===(o=t.account_data)||void 0===o?void 0:o.events)){var l=t.account_data.events.filter(me).map(c.getEventMapper()),d=l.reduce((e,t)=>(e[t.getType()]=c.store.getAccountData(t.getType()),e),{});c.store.storeAccountDataEvents(l),l.forEach(function(e){if(e.getType()===Ve.PushRules){var t=e.getContent();c.setPushRules(t)}var r=d[e.getType()];return c.emit(kd.AccountData,e,r),e})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var u=t.to_device.events.filter(me);$i(n.syncOpts.cryptoCallbacks?yield n.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(u):u.map(e=>({message:e,encryptionInfo:null})),c)}else n.catchingUp=!1;var h=[],g=[],p=[],v=[];t.rooms&&(t.rooms.invite&&(h=n.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(g=n.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(p=n.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(v=n.mapSyncResponseToRoomArray(t.rooms.knock))),n.notifEvents=[],yield Q(h,function(){var e=r(function*(e){var t=e.room,r=n.mapSyncEventsFormat(e.invite_state,t);yield n.injectRoomEvents(t,r,void 0),e.isBrandNewRoom?(t.recalculate(),c.store.storeRoom(t),c.emit(kd.Room,t)):t.recalculate(),r.forEach(function(e){c.emit(kd.Event,e)})});return function(t){return e.apply(this,arguments)}}()),yield Q(g,function(){var t=r(function*(t){var r,i=t.room,o=n.mapSyncEventsFormat(t.state,i),s=n.mapSyncEventsFormat(t["org.matrix.msc4222.state_after"],i),a=n.mapSyncEventsFormat(t.timeline,i,!1),l=n.mapSyncEventsFormat(t.ephemeral),d=n.mapSyncEventsFormat(t.account_data),u=t["org.matrix.msc4222.state_after"]?s:o.concat(a),h=n.isRoomEncrypted(i,u);if(t.unread_notifications){var g,p;if(!h||0===t.unread_notifications.notification_count)i.setUnreadNotificationCount(Ci.Total,null!==(g=t.unread_notifications.notification_count)&&void 0!==g?g:0);if(!h||i.getUnreadNotificationCount(Ci.Highlight)<=0)i.setUnreadNotificationCount(Ci.Highlight,null!==(p=t.unread_notifications.highlight_count)&&void 0!==p?p:0)}var v=null!==(r=t[Fr.name])&&void 0!==r?r:t[Fr.altName];if(v)for(var[m,_]of(i.resetThreadUnreadNotificationCountFromSync(Object.keys(v)),Object.entries(v))){var f;if(!h||0===_.notification_count)i.setThreadUnreadNotificationCount(m,Ci.Total,null!==(f=_.notification_count)&&void 0!==f?f:0);var y,b=i.getThreadUnreadNotificationCount(m,Ci.Highlight)<=0;if(!h||h&&b)i.setThreadUnreadNotificationCount(m,Ci.Highlight,null!==(y=_.highlight_count)&&void 0!==y?y:0)}else i.resetThreadUnreadNotificationCountFromSync();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,Tr.BACKWARDS);else if(t.timeline.limited){for(var w,S=!0,E=a.length-1;E>=0;E--){var R=a[E].getId();if(i.getTimelineForEvent(R)){n.syncOpts.logger.debug("Already have event ".concat(R," in limited sync - not resetting")),S=!1,a.splice(0,E);break}}if(S)i.resetLiveTimeline(t.timeline.prev_batch,n.syncOpts.canResetEntireTimeline(i.roomId)?null:null!==(w=e.oldSyncToken)&&void 0!==w?w:null),c.resetNotifTimelineSet()}if(n.syncOpts.cryptoCallbacks)for(var I of u)I.isState()&&I.getType()===Ve.RoomEncryption&&""===I.getStateKey()&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(i,I));for(var k of a.filter(e=>e.isState()))yield n.client.decryptEventIfNeeded(k);try{"org.matrix.msc4222.state_after"in t?yield n.injectRoomEvents(i,void 0,s,a,e.fromCache):yield n.injectRoomEvents(i,o,void 0,a,e.fromCache)}catch(I){n.syncOpts.logger.error("Failed to process events on room ".concat(i.roomId,":"),I)}t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(l),i.addAccountData(d),i.recalculate(),t.isBrandNewRoom&&(c.store.storeRoom(i),c.emit(kd.Room,i)),n.processEventsForNotifs(i,a);var T=e=>c.emit(kd.Event,e);o.forEach(T),a.forEach(T),l.forEach(T),d.forEach(T),i.decryptCriticalEvents()});return function(e){return t.apply(this,arguments)}}()),yield Q(p,function(){var e=r(function*(e){var t=e.room,{timelineEvents:r,stateEvents:i,stateAfterEvents:o}=yield n.mapAndInjectRoomEvents(e),s=n.mapSyncEventsFormat(e.account_data);t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(c.store.storeRoom(t),c.emit(kd.Room,t)),n.processEventsForNotifs(t,r),null==i||i.forEach(function(e){c.emit(kd.Event,e)}),null==o||o.forEach(function(e){c.emit(kd.Event,e)}),r.forEach(function(e){c.emit(kd.Event,e)}),s.forEach(function(e){c.emit(kd.Event,e)})});return function(t){return e.apply(this,arguments)}}()),yield Q(v,function(){var e=r(function*(e){var t=e.room,r=n.mapSyncEventsFormat(e.knock_state,t);yield n.injectRoomEvents(t,r,void 0),e.isBrandNewRoom?(t.recalculate(),c.store.storeRoom(t),c.emit(kd.Room,t)):t.recalculate(),r.forEach(function(e){c.emit(kd.Event,e)})});return function(t){return e.apply(this,arguments)}}()),e.oldSyncToken&&n.notifEvents.length&&(n.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),n.notifEvents.forEach(function(e){var t;null===(t=c.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e,{addToState:!0})})),t.device_lists&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield null===(s=n.syncOpts.cryptoCallbacks)||void 0===s?void 0:s.processKeyCounts(t.device_one_time_keys_count,null!==(a=t.device_unused_fallback_key_types)&&void 0!==a?a:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.running)return clearTimeout(this.keepAliveTimer),void(this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0));var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(jn.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(e=this.abortController)||void 0===e?void 0:e.signal}).then(()=>{r()},e=>{400==e.httpStatus||404==e.httpStatus?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(Bi.Error,{error:e}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(e=>!pe(e)).map(r=>{var n=t.store.getRoom(r),i=!1;return n||(n=this.createRoom(r),i=!0),ji(ji({},e[r]),{},{room:n,isBrandNewRoom:i})})}mapSyncEventsFormat(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(me).map(function(e){return t&&(e.room_id=t.roomId),n(e)})}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(lt.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then(function(t){var n=r.events.member;(null==n?void 0:n.getContent().membership)===lt.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})}})}}findEncryptionEvent(e){return null==e?void 0:e.find(e=>e.getType()===Ve.RoomEncryption&&""===e.getStateKey())}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return r(function*(){var r=t.mapSyncEventsFormat(e.state,e.room),n=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),i=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,n,i):yield t.injectRoomEvents(e.room,r,void 0,i),{timelineEvents:i,stateEvents:r,stateAfterEvents:n}})()}injectRoomEvents(e,t,n,i){var o=arguments,s=this;return r(function*(){var r=o.length>4&&void 0!==o[4]&&o[4],a=null!=n?n:t,c=e.getLiveTimeline(),l=0==c.getEvents().length;if(l){for(var d of a)s.client.getPushActionsForEvent(d);c.initialiseState(a,{timelineWasEmpty:l})}s.resolveInvites(e),e.recalculate(),l||(e.oldState.setStateEvents(a),e.currentState.setStateEvents(a)),yield e.addLiveEvents(i||[],{fromCache:r,timelineWasEmpty:l,addToState:void 0===n}),s.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,i=this.client.getPushActionsForEvent(r);null!=i&&i.notify&&null!==(n=i.tweaks)&&void 0!==n&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(kd.Sync,this.syncState,r,t)}}function zi(e,t,r){var{timelineSupport:n}=e,i=new Mi(t,e,e.getUserId(),{lazyLoadMembers:r.lazyLoadMembers,pendingEventOrdering:r.pendingEventOrdering,timelineSupport:n});return e.reEmitter.reEmit(i,[Oi.Name,Oi.Redaction,Oi.RedactionCancelled,Oi.Receipt,Oi.Tags,Oi.LocalEchoUpdated,Oi.AccountData,Oi.MyMembership,Oi.Timeline,Oi.TimelineReset,Zd.Events,Zd.Members,Zd.NewMember,Zd.Update,un.New,un.Update,un.Destroy,un.LivenessChange]),i.on(Zd.NewMember,(t,r,n)=>{var i;n.user=null!==(i=e.getUser(n.userId))&&void 0!==i?i:void 0,e.reEmitter.reEmit(n,[dt.Name,dt.Typing,dt.PowerLevel,dt.Membership])}),i}function $i(e,t){var r=[];e.map(e=>{if("m.key.verification.cancel"===e.message.type){var t=e.message.content.transaction_id;t&&r.push(t)}return e}).forEach(function(e){var n=e.message,i=n.content,o=new $d(Object.assign({},n));if("m.key.verification.start"===n.type||"m.key.verification.request"===n.type){var s=i.transaction_id;r.includes(s)&&o.flagCancelled()}e.encryptionInfo&&o.makeEncrypted(Ve.RoomMessageEncrypted,{ciphertext:""},e.encryptionInfo.senderCurve25519KeyBase64,""),t.emit(kd.ToDeviceEvent,o),t.emit(kd.ReceivedToDeviceMessage,e)})}class Ji{constructor(){o(this,"accountData",new Map),o(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return r(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return r(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return r(function*(){return Promise.resolve()})()}destroy(){return r(function*(){})()}}const Yi=[];for(let e=0;e<256;++e)Yi.push((e+256).toString(16).slice(1));let Qi;const Xi=new Uint8Array(16);var Zi={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function eo(e,t,r){const n=(e=e||{}).random??e.rng?.()??function(){if(!Qi){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Qi=crypto.getRandomValues.bind(crypto)}return Qi(Xi)}();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=15&n[6]|64,n[8]=63&n[8]|128,function(e,t=0){return(Yi[e[t+0]]+Yi[e[t+1]]+Yi[e[t+2]]+Yi[e[t+3]]+"-"+Yi[e[t+4]]+Yi[e[t+5]]+"-"+Yi[e[t+6]]+Yi[e[t+7]]+"-"+Yi[e[t+8]]+Yi[e[t+9]]+"-"+Yi[e[t+10]]+Yi[e[t+11]]+Yi[e[t+12]]+Yi[e[t+13]]+Yi[e[t+14]]+Yi[e[t+15]]).toLowerCase()}(n)}var to,ro,no,io,oo,so={},ao={},co={exports:{}};function lo(){if(to)return co.exports;to=1;var e=co.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(e).forEach(function(t){e[t].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})}),co.exports}function uo(){return ro||(ro=1,function(e){var t=function(e){return String(Number(e))===e?Number(e):e},r=function(e,r,n){var i=e.name&&e.names;e.push&&!r[e.push]?r[e.push]=[]:i&&!r[e.name]&&(r[e.name]={});var o=e.push?{}:i?r[e.name]:r;!function(e,r,n,i){if(i&&!n)r[i]=t(e[1]);else for(var o=0;o<n.length;o+=1)null!=e[o+1]&&(r[n[o]]=t(e[o+1]))}(n.match(e.reg),o,e.names,e.name),e.push&&r[e.push].push(o)},n=lo(),i=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(i).forEach(function(e){var t=e[0],i=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),s=o[o.length-1]);for(var a=0;a<(n[t]||[]).length;a+=1){var c=n[t][a];if(c.reg.test(i))return r(c,s,i)}}),t.media=o,t};var o=function(e,r){var n=r.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&r.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var r=[],n=e.split(" ").map(t),i=0;i<n.length;i+=3)r.push({component:n[i],ip:n[i+1],port:n[i+2]});return r},e.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})})},e.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var r,n=!1;return"~"!==e[0]?r=t(e):(r=t(e.substring(1,e.length)),n=!0),{scid:r,paused:n}})})}}(ao)),ao}function ho(){if(io)return no;io=1;var e=lo(),t=/%[sdv%]/g,r=function(e){var r=1,n=arguments,i=n.length;return e.replace(t,function(e){if(r>=i)return e;var t=n[r];switch(r+=1,e){case"%%":return"%";case"%s":return String(t);case"%d":return Number(t);case"%v":return""}})},n=function(e,t,n){var i=[e+"="+(t.format instanceof Function?t.format(t.push?n:n[t.name]):t.format)];if(t.names)for(var o=0;o<t.names.length;o+=1){var s=t.names[o];t.name?i.push(n[t.name][s]):i.push(n[t.names[o]])}else i.push(n[t.name]);return r.apply(null,i)},i=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];return no=function(t,r){r=r||{},null==t.version&&(t.version=0),null==t.name&&(t.name=" "),t.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var s=r.outerOrder||i,a=r.innerOrder||o,c=[];return s.forEach(function(r){e[r].forEach(function(e){e.name in t&&null!=t[e.name]?c.push(n(r,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){c.push(n(r,e,t))})})}),t.media.forEach(function(t){c.push(n("m",e.m[0],t)),a.forEach(function(r){e[r].forEach(function(e){e.name in t&&null!=t[e.name]?c.push(n(r,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){c.push(n(r,e,t))})})})}),c.join("\r\n")+"\r\n"}}var go=function(){if(oo)return so;oo=1;var e=uo(),t=ho(),r=lo();return so.grammar=r,so.write=t,so.parse=e.parse,so.parseParams=e.parseParams,so.parseFmtpConfig=e.parseFmtpConfig,so.parsePayloads=e.parsePayloads,so.parseRemoteCandidates=e.parseRemoteCandidates,so.parseImageAttributes=e.parseImageAttributes,so.parseSimulcastStreamList=e.parseSimulcastStreamList,so}();function po(e,t){if("function"==typeof e.toBase64)return e.toBase64(t);var r=btoa(e.reduce((e,t)=>e+String.fromCharCode(t),""));return t.omitPadding&&(r=r.replace(/={1,2}$/,"")),"base64url"===t.alphabet&&(r=r.replace(/\+/g,"-").replace(/\//g,"_")),r}function vo(e){return po(e,{alphabet:"base64",omitPadding:!1})}function mo(e){return po(e,{alphabet:"base64",omitPadding:!0})}function _o(e){return po(e,{alphabet:"base64url",omitPadding:!0})}function fo(e){return function(e,t){return"function"==typeof Uint8Array.fromBase64?Uint8Array.fromBase64(e,t):Uint8Array.from(atob(e),e=>e.charCodeAt(0))}(e.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}function yo(e){return function(e,t){if(t.length<2||t.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(e<1||e>32768)throw new Error("Requested random string length must be between 1 and 32768");var r=256-256%t.length,n=new Uint8Array(Math.floor(1.3*e)),i=n.length,o=[];for(;o.length<e;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var s=n[i++];s<r&&o.push(t[s%t.length])}return o.join("")}(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}var bo="org.matrix.msc3077.sdp_stream_metadata",wo=function(e){return e.Usermedia="m.usermedia",e.Screenshare="m.screenshare",e}({}),So=null,Eo=0,Ro=function(e){return e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed",e}({});class Io extends qe{constructor(e){super(),o(this,"stream",void 0),o(this,"sdpMetadataStreamId",void 0),o(this,"userId",void 0),o(this,"deviceId",void 0),o(this,"purpose",void 0),o(this,"speakingVolumeSamples",void 0),o(this,"client",void 0),o(this,"call",void 0),o(this,"roomId",void 0),o(this,"audioMuted",void 0),o(this,"videoMuted",void 0),o(this,"localVolume",1),o(this,"measuringVolumeActivity",!1),o(this,"audioContext",void 0),o(this,"analyser",void 0),o(this,"frequencyBinCount",void 0),o(this,"speakingThreshold",-60),o(this,"speaking",!1),o(this,"volumeLooperTimeout",void 0),o(this,"_disposed",!1),o(this,"_connected",!1),o(this,"onAddTrack",()=>{this.emit(Ro.NewStream,this.stream)}),o(this,"onCallState",e=>{e===ds.Connected?this.connected=!0:e===ds.Connecting&&(this.connected=!1)}),o(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var e=-1/0;for(var t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(Ro.VolumeChanged,e);var r=!1;for(var n of this.speakingVolumeSamples)if(n>this.speakingThreshold){r=!0;break}this.speaking!==r&&(this.speaking=r,this.emit(Ro.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(ps.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(Ro.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(Ro.NewStream,this.stream)}}initVolumeMeasuring(){this.hasAudioTrack&&(this.audioContext||(this.audioContext=(null===So&&(So=new AudioContext),Eo++,So)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount))}getMember(){var e,t=this.client.getRoom(this.roomId);return null!==(e=null==t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(Ro.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(Ro.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return xe.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===wo.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new Io({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t,r;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(ps.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,0===--Eo&&(null===(r=So)||void 0===r||r.close(),So=null)),this._disposed=!0,this.emit(Ro.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(Ro.LocalVolumeChanged,e)}}var ko=function(e){return e.Incoming="Call.incoming",e}({});class To{constructor(e){o(this,"calls",void 0),o(this,"callEventBuffer",void 0),o(this,"nextSeqByCall",new Map),o(this,"toDeviceEventBuffers",new Map),o(this,"client",void 0),o(this,"candidateEventsByCall",void 0),o(this,"eventBufferPromiseChain",void 0),o(this,"onSync",()=>{var e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(e)):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)}),o(this,"onRoomTimeline",e=>{this.callEventBuffer.push(e)}),o(this,"onToDeviceEvent",e=>{var t=e.getContent();if(t.call_id)if(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0!==t.seq){var r=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==r){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);var n=this.toDeviceEventBuffers.get(t.call_id),i=n.findIndex(e=>e.getContent().seq>t.seq);-1===i?n.push(e):n.splice(i,0,e)}else{var o=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(o,t.seq+1);for(var s=this.toDeviceEventBuffers.get(o),a=s&&s.shift();a&&a.getContent().seq===this.nextSeqByCall.get(o);)this.callEventBuffer.push(a),this.nextSeqByCall.set(o,a.getContent().seq+1),a=s.shift()}}else this.callEventBuffer.push(e);else this.callEventBuffer.push(e)}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(kd.Sync,this.onSync),this.client.on(Oi.Timeline,this.onRoomTimeline),this.client.on(kd.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(kd.Sync,this.onSync),this.client.removeListener(Oi.Timeline,this.onRoomTimeline),this.client.removeListener(kd.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return r(function*(){yield Promise.all(e.map(e=>t.client.decryptEventIfNeeded(e)));var r=e.filter(e=>{var t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}),n=new Set;for(var i of r){var o=i.getType();o!==Ve.CallAnswer&&o!==Ve.CallHangup||n.add(i.getContent().call_id)}for(var s of r){var a=s.getType(),c=s.getContent().call_id;if(a!==Ve.CallInvite||!n.has(c))try{yield t.handleCallEvent(s)}catch(e){xe.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}})()}handleCallEvent(e){var t=this;return r(function*(){var r;t.client.emit(kd.ReceivedVoipEvent,e);var n,i,o=e.getContent(),s=e.getRoomId()||(null===(r=t.client.groupCallEventHandler.getGroupCallById(o.conf_id))||void 0===r||null===(r=r.room)||void 0===r?void 0:r.roomId),a=o.conf_id,c=e.getType(),l=e.getSender(),d=o.call_id?t.calls.get(o.call_id):void 0;if(a){if(!(i=t.client.groupCallEventHandler.getGroupCallById(a)))return void xe.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(a,", type=").concat(c,")"));if(!(n=o.device_id))return xe.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(l,")")),void i.emit(Zo.Error,new ns(l));if(o.dest_session_id!==t.client.getSessionId())return void xe.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}var u=l===t.client.credentials.userId&&(void 0===n||n===t.client.getDeviceId());if(s)if(c!==Ve.CallInvite)if(c!==Ve.CallCandidates){var h;if([Ve.CallHangup,Ve.CallReject].includes(c))d?d.state!==ds.Ended&&(c===Ve.CallHangup?d.onHangupReceived(o):d.onRejectReceived(o),d.state===ds.Ended&&t.calls.delete(o.call_id)):(d=null!==(h=Rs(t.client,s,{opponentDeviceId:n,opponentSessionId:o.sender_session_id}))&&void 0!==h?h:void 0)&&(d.callId=o.call_id,d.initWithHangup(e),t.calls.set(o.call_id,d));else if(d&&d.hasPeerConnection){if(e.getContent().party_id!==d.ourPartyId)switch(c){case Ve.CallAnswer:u?d.state===ds.Ringing&&d.onAnsweredElsewhere(o):d.onAnswerReceived(e);break;case Ve.CallSelectAnswer:d.onSelectAnswerReceived(e);break;case Ve.CallNegotiate:d.onNegotiateReceived(e);break;case Ve.CallAssertedIdentity:case Ve.CallAssertedIdentityPrefix:d.onAssertedIdentityReceived(e);break;case Ve.CallSDPStreamMetadataChanged:case Ve.CallSDPStreamMetadataChangedPrefix:d.onSDPStreamMetadataChangedReceived(e)}}else xe.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(c,")"))}else{if(u)return;d?d.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(o.call_id)||t.candidateEventsByCall.set(o.call_id,[]),t.candidateEventsByCall.get(o.call_id).push(e))}else{var g,p,v;if(u)return;if(e.getLocalAge()>o.lifetime-3e3)return;if(d&&d.state===ds.Ended)return;if(d&&xe.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(o.call_id,")")),o.invitee&&o.invitee!==t.client.getUserId())return;var m=(null!==(g=t.client.getTurnServersExpiry())&&void 0!==g?g:0)-Date.now();if(xe.info("CallEventHandler handleCallEvent() current turn creds expire in "+m+" ms"),!(d=null!==(p=Rs(t.client,s,{forceTURN:t.client.forceTURN,opponentDeviceId:n,groupCallId:a,opponentSessionId:o.sender_session_id}))&&void 0!==p?p:void 0))return void xe.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(o.call_id,")"));d.callId=o.call_id;var _,f=null===(v=i)||void 0===v?void 0:v.getGroupCallStats();f&&d.initStats(f);try{yield d.initWithInvite(e)}catch(e){var y;if(e instanceof _s)if(e.code===ts.UnknownDevice)null===(y=i)||void 0===y||y.emit(Zo.Error,e);else xe.error(e)}if(t.calls.set(d.callId,d),t.candidateEventsByCall.get(d.callId))for(var b of t.candidateEventsByCall.get(d.callId))d.onRemoteIceCandidatesReceived(b);for(var w of t.calls.values()){var S,E=[ds.WaitLocalMedia,ds.CreateOffer,ds.InviteSent].includes(w.state);if(d.roomId===w.roomId&&w.direction===hs.Outbound&&(null===(S=d.getOpponentMember())||void 0===S?void 0:S.userId)===w.invitee&&E){_=w;break}}_?_.callId>d.callId?(xe.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(d.callId,", outgoingId=").concat(_.callId,")")),_.replacedBy(d)):(xe.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(d.callId,", outgoingId=").concat(_.callId,")")),d.hangup(vs.Replaced,!0)):t.client.emit(ko.Incoming,d)}})()}}var Co=function(e){return e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants",e}({});class Oo{constructor(e){this.client=e,o(this,"groupCalls",new Map),o(this,"roomDeferreds",new Map),o(this,"onRoomsChanged",e=>{this.createGroupCallForRoom(e)}),o(this,"onRoomStateChanged",(e,t)=>{if(e.getType()===Ve.GroupCallPrefix){var r=e.getStateKey(),n=e.getContent(),i=this.groupCalls.get(t.roomId);i||n["m.terminated"]||e.isRedacted()?i&&i.groupCallId===r?n["m.terminated"]||e.isRedacted()?i.terminate(!1):n["m.type"]!==i.type&&xe.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(t.roomId,")")):i&&i.groupCallId!==r&&xe.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(t.roomId,")")):this.createGroupCallFromRoomStateEvent(e)}})}start(){var e=this;return r(function*(){e.client.getSyncState()!==Bi.Syncing&&(xe.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(t=>{var r=()=>{if(e.client.getSyncState()===Bi.Syncing)return e.client.off(kd.Sync,r),t()};e.client.on(kd.Sync,r)}));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(kd.Room,e.onRoomsChanged),e.client.on(Zd.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(kd.Room,this.onRoomsChanged),this.client.removeListener(Zd.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t,r=this.roomDeferreds.get(e);void 0===r&&((r={prom:new Promise(e=>{t=e})}).resolve=t,this.roomDeferreds.set(e,r));return r}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(Ve.GroupCallPrefix),r=t.sort((e,t)=>t.getTs()-e.getTs());for(var n of r){if(!n.getContent()["m.terminated"]&&!n.isRedacted()){xe.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(n){var i=e.getStateKey(),o=r["m.type"];if(Object.values(Qo).includes(o)){var s=r["m.intent"];if(Object.values(Yo).includes(s)){var a,c=Boolean(r["io.element.ptt"]);if(null!=r&&r.dataChannelsEnabled&&null!=r&&r.dataChannelOptions){var{ordered:l,maxPacketLifeTime:d,maxRetransmits:u,protocol:h}=r.dataChannelOptions;a={ordered:l,maxPacketLifeTime:d,maxRetransmits:u,protocol:h}}var g=new as(this.client,n,o,c,s,i,(null==r?void 0:r.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,a,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,g),this.client.emit(Co.Incoming,g),g}xe.warn("Received invalid group call intent (type=".concat(o,", roomId=").concat(t,")"))}else xe.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(o,", roomId=").concat(t,")"))}else xe.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"))}}class Mo{constructor(){o(this,"bandwidth",{}),o(this,"bitrate",{}),o(this,"packetLoss",{}),o(this,"transport",[])}}class Po{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class Do{static buildReport(e,t,r,n){var i=null==e?void 0:e.get(t.localCandidateId),o=null==e?void 0:e.get(t.remoteCandidateId);if(o&&i){var s=void 0!==o.ip?o.ip:o.address,a=o.port,c="".concat(s,":").concat(a),l=void 0!==i.ip?i.ip:i.address,d=i.port,u="".concat(l,":").concat(d),h=o.protocol;r.some(e=>e.ip===c&&e.type===h&&e.localIp===u)||r.push({ip:c,type:h,localIp:u,isFocus:n,localCandidateType:i.candidateType,remoteCandidateType:o.candidateType,networkType:i.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return r}}class Ao{constructor(){o(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((t,n)=>{t.find(t=>t==e)&&(r=n)}),r}parse(e,t){var r=go.parse(e),n=new Map;r.media.forEach(e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t,r=[];null===(t=e.ssrcs)||void 0===t||t.forEach(e=>{"cname"===e.attribute&&r.push("".concat(e.id))}),n.set("".concat(e.mid),r)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class xo{constructor(e){this.pc=e}getLocalTracks(e){return this.pc.getTransceivers().filter(e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection).filter(e=>null!==e.sender).map(e=>e.sender).map(e=>e.track).filter(t=>null!==t&&t.kind===e)}getTackById(e){return this.pc.getTransceivers().map(t=>null!==(null==t?void 0:t.sender.track)&&t.sender.track.id===e?t.sender.track:null!==(null==t?void 0:t.receiver.track)&&t.receiver.track.id===e?t.receiver.track:void 0).find(e=>void 0!==e)}getLocalTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(t=>t.mid===e);return null==r||null===(t=r.sender)||void 0===t||null===(t=t.track)||void 0===t?void 0:t.id}getRemoteTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(t=>t.mid===e);return null==r||null===(t=r.receiver)||void 0===t||null===(t=t.track)||void 0===t?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e)}}class Uo{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,o(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),o(this,"bitrate",{download:0,upload:0}),o(this,"resolution",{width:-1,height:-1}),o(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),o(this,"framerate",0),o(this,"jitter",0),o(this,"codec",""),o(this,"isAlive",!0),o(this,"isMuted",!1),o(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class Lo{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,o(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var n=this.track2stats.get(r);if(!n){var i=this.mediaTrackHandler.getTackById(r);if(void 0===i)return;var o="audio"===i.kind?i.kind:"video";n=new Uo(r,t,o),this.track2stats.set(r,n)}return n}}findLocalVideoTrackStats(e){if(0!==this.mediaTrackHandler.getLocalTracks("video").length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class No{static getNonNegativeValue(e){var t=e;return"number"!=typeof t&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class Fo{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var i=e.getFramerate();if(!i){if(r){var o=t.timestamp-r.timestamp;if(o>0&&t.framesSent)i=(t.framesSent-r.framesSent)/o*1e3}if(!i)return}i=n?Math.round(i/n):0,e.setFramerate(i)}static buildCodec(e,t,r){var n=null==e?void 0:e.get(r.codecId);if(n){var i=n.mimeType.split("/")[1];i&&t.setCodec(i)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:Fo.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n="outbound-rtp"===t.type?"packetsSent":"packetsReceived",i=t[n];(!i||i<0)&&(i=0);var o=No.getNonNegativeValue(r[n]),s=Math.max(0,i-o),a=No.getNonNegativeValue(t.packetsLost),c=No.getNonNegativeValue(r.packetsLost),l=Math.max(0,a-c);e.setLoss({packetsTotal:s+l,packetsLost:l,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,r,n){var i=No.getNonNegativeValue(e),o=No.getNonNegativeValue(t),s=Math.max(0,i-o),a=r-n,c=0;return a>0&&(c=Math.round(8*s/a)),c}static setTrackStatsState(e,t){var r;if(void 0!==t){var n="remote"===e.getType()?t.receiver.track:null==t||null===(r=t.sender)||void 0===r?void 0:r.track;null!=n&&"ended"!==n.readyState?(e.muted=n.muted,e.enabled=n.enabled,e.alive=!0):e.alive=!1}else e.alive=!1}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(e=>"remote"===e.getType()),i=n.filter(e=>"audio"===e.kind);return n.forEach(e=>{var n,o,s="video"===e.kind?t:r;(s.count++,e.alive&&e.muted&&s.muted++,s.maxJitter<e.getJitter()&&(s.maxJitter=e.getJitter()),s.maxPacketLoss<e.getLoss().packetsLost&&(s.maxPacketLoss=e.getLoss().packetsLost),i.length>0)&&(s.concealedAudio+=null===(n=e.getAudioConcealment())||void 0===n?void 0:n.concealedAudio,s.totalAudio+=null===(o=e.getAudioConcealment())||void 0===o?void 0:o.totalAudioDuration)}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"===t.type){var r=null==t?void 0:t.jitter;if(void 0!==r){var n=No.getNonNegativeValue(r);e.setJitter(Math.round(1e3*n))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if("inbound-rtp"===t.type){var r=1e3*(null==t?void 0:t.totalSamplesDuration)/(null==t?void 0:t.totalSamplesReceived)*(null==t?void 0:t.concealedSamples),n=1e3*(null==t?void 0:t.totalSamplesDuration);e.setAudioConcealment(r,n)}}}class jo{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},i=0,o=0,s={local:new Map,remote:new Map},a={local:new Map,remote:new Map},c={local:new Map,remote:new Map},l=new Map,d=new Map,u=0,h=0,g=0,p=0,v=0,m=0;for(var[_,f]of e){var y=f.getLoss(),b=y.isDownloadStream?"download":"upload";if(r[b]+=y.packetsTotal,n[b]+=y.packetsLost,i+=f.getBitrate().download,o+=f.getBitrate().upload,"audio"===f.kind){var w=f.getAudioConcealment();v+=w.concealedAudio,m+=w.totalAudioDuration,u+=f.getBitrate().download,h+=f.getBitrate().upload}else g+=f.getBitrate().download,p+=f.getBitrate().upload;s[f.getType()].set(_,f.getResolution()),a[f.getType()].set(_,f.getFramerate()),c[f.getType()].set(_,f.getCodec()),"remote"===f.getType()&&(l.set(_,f.getJitter()),"audio"===f.kind&&d.set(_,f.getAudioConcealment())),f.resetBitrate()}return t.bitrate={upload:o,download:i},t.bitrate.audio={upload:h,download:u},t.bitrate.video={upload:p,download:g},t.packetLoss={total:jo.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:jo.calculatePacketLoss(n.download,r.download),upload:jo.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=d,t.totalAudioConcealment={concealedAudio:v,totalAudioDuration:m},t.framerate=a,t.resolution=s,t.codec=c,t.jitter=l,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Bo{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),i=[];return n.forEach(e=>{var t,r=null!==(t=e.sender)&&void 0!==t&&t.track?Bo.buildTrackStats(e.sender.track,"sender"):null,n=Bo.buildTrackStats(e.receiver.track,"receiver");i.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:r,receiver:n})}),{callId:e,opponentMemberId:t,transceiver:i,callFeeds:[]}}static buildTrackStats(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"--",i=null===(t=e.getSettings())||void 0===t?void 0:t.deviceId,o=null===(r=e.getConstraints())||void 0===r?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:null!=i?i:"unknown",constrainDeviceId:null!=o?o:"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";return t.forEach(t=>{var n=t.stream.getAudioTracks(),i=t.stream.getVideoTracks(),o=n.length>0?Bo.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,s=i.length>0?Bo.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,a={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:o,video:s,purpose:t.purpose,prefix:r,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(a)}),e}}function Ko(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function qo(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ko(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ko(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class Vo{constructor(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=i,o(this,"isActive",!0),o(this,"previousStatsReport",void 0),o(this,"currentStatsReport",void 0),o(this,"connectionStats",new Mo),o(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new Lo(new Ao,new xo(r))}processStats(e,t){var n=this;return r(function*(){var r={isFirstCollection:void 0===n.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(n.isActive){var i=n.pc.getStats();if("function"==typeof(null==i?void 0:i.then))return i.then(i=>{var o,s;n.currentStatsReport="function"==typeof(null==i?void 0:i.result)?i.result():i;try{n.processStatsReport(e,t)}catch(e){return n.handleError(e),r}n.previousStatsReport=n.currentStatsReport,r.receivedMedia=n.connectionStats.bitrate.download,r.receivedAudioMedia=(null===(o=n.connectionStats.bitrate.audio)||void 0===o?void 0:o.download)||0,r.receivedVideoMedia=(null===(s=n.connectionStats.bitrate.video)||void 0===s?void 0:s.download)||0;var a=Fo.buildTrackSummary(Array.from(n.trackStats.getTrack2stats().values()));return qo(qo({},r),{},{audioTrackSummary:a.audioTrackSummary,videoTrackSummary:a.videoTrackSummary})}).catch(e=>(n.handleError(e),r));n.isActive=!1}return Promise.resolve(r)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,null===(r=this.currentStatsReport)||void 0===r||r.forEach(e=>{var t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=Po.buildBandwidthReport(e),this.connectionStats.transport=Do.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){var r=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!r)return;if(t&&Fo.buildPacketsLost(r,e,t),"inbound-rtp"===e.type){Fo.buildFramerateResolution(r,e),t&&Fo.buildBitrateReceived(r,e,t);var i=this.trackStats.findTransceiverByTrackId(r.trackId);Fo.setTrackStatsState(r,i),Fo.buildJitter(r,e),Fo.buildAudioConcealment(r,e)}else t&&(n.set(r.trackId,No.getNonNegativeValue(e.bytesSent)),Fo.buildBitrateSend(r,e,t));Fo.buildCodec(this.currentStatsReport,r,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){var o=this.trackStats.findLocalVideoTrackStats(e);if(!o)return;Fo.buildFramerateResolution(o,e),Fo.calculateSimulcastFramerate(o,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(Bo.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,xe.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=jo.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(qo(qo({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var Wo=function(e){return e.CONNECTION_STATS="StatsReport.connection_stats",e.CALL_FEED_REPORT="StatsReport.call_feed_report",e.BYTE_SENT_STATS="StatsReport.byte_sent_stats",e.SUMMARY_STATS="StatsReport.summary_stats",e}({});class Go extends qe{emitByteSendReport(e){this.emit(Wo.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(Wo.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(Wo.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(Wo.SUMMARY_STATS,e)}}class Ho{constructor(e){this.emitter=e}build(e){var t=e.filter(e=>!e.isFirstCollection),r=t.length,n=e.length;if(0!==r){var i={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,s=0;t.forEach(e=>{this.countTrackListReceivedMedia(i,e),this.countConcealedAudio(i,e),o=this.buildMaxJitter(o,e),s=this.buildMaxPacketLoss(s,e)});var a={percentageReceivedMedia:Number((i.receivedMedia/r).toFixed(5)),percentageReceivedVideoMedia:Number((i.receivedVideo/r).toFixed(5)),percentageReceivedAudioMedia:Number((i.receivedAudio/r).toFixed(5)),maxJitter:o,maxPacketLoss:s,percentageConcealedAudio:Number(i.totalAudio>0?(i.concealedAudio/i.totalAudio).toFixed(5):0),peerConnections:n};this.emitter.emitSummaryStatsReport(a)}}static extendSummaryReport(e,t){var r=[],n=[];for(var i of t)for(var o of(n.push(i),i[1]))r.push(o);e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,r.length-1)?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||0===t.videoTrackSummary.count||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class zo{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,o(this,"timer",void 0),o(this,"gatherers",new Map),o(this,"reports",new Go),o(this,"summaryStatsReportGatherer",new Ho(this.reports))}start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new Vo(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;null===(r=this.getStatsReportGatherer(e))||void 0===r||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(e=>this.summaryStatsReportGatherer.build(e)).catch(e=>{xe.error("Could not build summary stats report",e)})}setInterval(e){this.interval=e}}function $o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Jo(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?$o(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var Yo=function(e){return e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room",e}({}),Qo=function(e){return e.Video="m.video",e.Voice="m.voice",e}({}),Xo=function(e){return e.CallEnded="call_ended",e}({}),Zo=function(e){return e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="group_call_error",e}({}),es=function(e){return e.ConnectionStats="GroupCall.connection_stats",e.ByteSentStats="GroupCall.byte_sent_stats",e.SummaryStats="GroupCall.summary_stats",e.CallFeedStats="GroupCall.call_feed_stats",e}({}),ts=function(e){return e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed",e}({});class rs extends Error{constructor(e,t,r){r?(super(t+": "+r),o(this,"code",void 0)):(super(t),o(this,"code",void 0)),this.code=e}}class ns extends rs{constructor(e){super(ts.UnknownDevice,"No device found for "+e),this.userId=e}}var is=function(e){return e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended",e}({}),os=36e5;function ss(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class as extends qe{constructor(e,t,r,n,i,s,a,c,l){var d,u,h=arguments.length>9&&void 0!==arguments[9]&&arguments[9],g=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=i,this.dataChannelsEnabled=a,this.dataChannelOptions=c,this.useLivekit=h,o(this,"activeSpeakerInterval",1e3),o(this,"retryCallInterval",5e3),o(this,"participantTimeout",15e3),o(this,"pttMaxTransmitTime",2e4),o(this,"activeSpeaker",void 0),o(this,"localCallFeed",void 0),o(this,"localScreenshareFeed",void 0),o(this,"localDesktopCapturerSourceId",void 0),o(this,"userMediaFeeds",[]),o(this,"screenshareFeeds",[]),o(this,"groupCallId",void 0),o(this,"allowCallWithoutVideoAndAudio",void 0),o(this,"calls",new Map),o(this,"callHandlers",new Map),o(this,"activeSpeakerLoopInterval",void 0),o(this,"retryCallLoopInterval",void 0),o(this,"retryCallCounts",new Map),o(this,"reEmitter",void 0),o(this,"transmitTimer",null),o(this,"participantsExpirationTimer",null),o(this,"resendMemberStateTimer",null),o(this,"initWithAudioMuted",!1),o(this,"initWithVideoMuted",!1),o(this,"initCallFeedPromise",void 0),o(this,"_livekitServiceURL",void 0),o(this,"stats",void 0),o(this,"statsCollectIntervalTime",0),o(this,"onConnectionStats",e=>{this.emit(es.ConnectionStats,{report:e})}),o(this,"onByteSentStats",e=>{this.emit(es.ByteSentStats,{report:e})}),o(this,"onSummaryStats",e=>{Ho.extendSummaryReport(e,this.participants),this.emit(es.SummaryStats,{report:e})}),o(this,"onCallFeedReport",e=>{this.localCallFeed&&(e=Bo.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));var t=[];this.forEachCall(r=>{r.callId===e.callId&&r.getFeeds().forEach(e=>t.push(e))}),e=Bo.expandCallFeedReport(e,t,"from-call-feed"),this.emit(es.CallFeedStats,{report:e})}),o(this,"_state",is.LocalCallFeedUninitialized),o(this,"_participants",new Map),o(this,"_creationTs",null),o(this,"_enteredViaAnotherSession",!1),o(this,"onIncomingCall",e=>{var t,r;if(e.roomId===this.room.roomId)if(e.state===ds.Ringing){if(!e.groupCallId||e.groupCallId!==this.groupCallId)return xe.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),void e.reject();var n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0!==n)if(this.useLivekit)xe.info("Received incoming call whilst in signaling-only mode! Ignoring.");else{var i=null!==(r=this.calls.get(n))&&void 0!==r?r:new Map,o=i.get(e.getOpponentDeviceId());if((null==o?void 0:o.callId)!==e.callId){xe.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(n,", callId=").concat(e.callId,")")),o&&o.hangup(vs.Replaced,!1),i.set(e.getOpponentDeviceId(),e),this.calls.set(n,i),this.initCall(e);var s=this.getLocalFeeds().map(e=>e.clone());if(!this.callExpected(e))for(var a of s)Ss(a.stream.getAudioTracks(),!1),Ss(a.stream.getVideoTracks(),!1);e.answerWithCallFeeds(s),this.emit(Zo.CallsChanged,this.calls)}}else xe.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"))}else xe.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"))}),o(this,"onRetryCallLoop",()=>{var e=!1;for(var[{userId:t},r]of this.participants){var n=this.calls.get(t),i=this.retryCallCounts.get(t);for(var[o,s]of r){var a,c,l=null==n?void 0:n.get(o),d=null!==(a=null===(c=i)||void 0===c?void 0:c.get(o))&&void 0!==a?a:0;(null==l?void 0:l.getOpponentSessionId())!==s.sessionId&&this.wantsOutgoingCall(t,o)&&d<3&&(void 0===i&&(i=new Map,this.retryCallCounts.set(t,i)),i.set(o,d+1),e=!0)}}e&&this.placeOutgoingCalls()}),o(this,"onCallFeedsChanged",e=>{var t=ss(e),r=e.getOpponentDeviceId();if(!t)throw new Error("Cannot change call feeds without user id");var n=this.getUserMediaFeed(t,r),i=e.remoteUsermediaFeed,o=i!==n,s=this.calls.get(t),a=null==s?void 0:s.get(r);if((null==a?void 0:a.callId)===e.callId){o&&(!n&&i?this.addUserMediaFeed(i):n&&i?this.replaceUserMediaFeed(n,i):n&&!i&&this.removeUserMediaFeed(n));var c=this.getScreenshareFeed(t,r),l=e.remoteScreensharingFeed;l!==c&&(!c&&l?this.addScreenshareFeed(l):c&&l?this.replaceScreenshareFeed(c,l):c&&!l&&this.removeScreenshareFeed(c))}}),o(this,"onCallStateChanged",(e,t,r)=>{var n;if(t!==ds.Ended){var i=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==i&&e.setMicrophoneMuted(i);var o=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==o&&e.setLocalVideoMuted(o);var s=null===(n=e.getOpponentMember())||void 0===n?void 0:n.userId;if(t===ds.Connected&&s){var a=this.retryCallCounts.get(s);null==a||a.delete(e.getOpponentDeviceId()),0===(null==a?void 0:a.size)&&this.retryCallCounts.delete(s)}}}),o(this,"onCallHangup",e=>{var t,r;if(e.hangupReason!==vs.Replaced){var n=null!==(t=null===(r=e.getOpponentMember())||void 0===r?void 0:r.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,i=this.calls.get(n);(null==i?void 0:i.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),i.delete(e.getOpponentDeviceId()),0===i.size&&this.calls.delete(n),this.emit(Zo.CallsChanged,this.calls))}}),o(this,"onCallReplaced",(e,t)=>{var r=e.getOpponentMember().userId,n=this.calls.get(r);void 0===n&&(n=new Map,this.calls.set(r,n)),e.hangup(vs.Replaced,!1),this.initCall(t),n.set(e.getOpponentDeviceId(),t),this.emit(Zo.CallsChanged,this.calls)}),o(this,"onActiveSpeakerLoop",()=>{var e=void 0,t=void 0;for(var r of this.userMediaFeeds)if(!(r.isLocal()&&this.userMediaFeeds.length>1)){var n=r.speakingVolumeSamples.reduce((e,t)=>e+Math.max(t,-60))/r.speakingVolumeSamples.length;(!e||n>e)&&(e=n,t=r)}t&&this.activeSpeaker!==t&&e&&e>-60&&(this.activeSpeaker=t,this.emit(Zo.ActiveSpeakerChanged,this.activeSpeaker))}),o(this,"onRoomState",()=>this.updateParticipants()),o(this,"onParticipantsChanged",()=>{this.forEachCall(e=>{var t=this.callExpected(e);for(var r of e.getLocalFeeds())Ss(r.stream.getAudioTracks(),!r.isAudioMuted()&&t),Ss(r.stream.getVideoTracks(),!r.isVideoMuted()&&t)}),this.state!==is.Entered||this.useLivekit||this.placeOutgoingCalls()}),o(this,"onStateChanged",(e,t)=>{e!==is.Entered&&t!==is.Entered&&e!==is.Ended||(this.updateParticipants(),this.updateMemberState().catch(e=>xe.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),e)))}),o(this,"onLocalFeedsChanged",()=>{this.state===is.Entered&&this.updateMemberState().catch(e=>xe.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),e))}),this.reEmitter=new Lr(this),this.groupCallId=null!=s?s:fs(),this._livekitServiceURL=g,this.creationTs=null!==(d=null===(u=t.currentState.getStateEvents(Ve.GroupCallPrefix,this.groupCallId))||void 0===u?void 0:u.getTs())&&void 0!==d?d:null,this.updateParticipants(),t.on(Zd.Update,this.onRoomState),this.on(Zo.ParticipantsChanged,this.onParticipantsChanged),this.on(Zo.GroupCallStateChanged,this.onStateChanged),this.on(Zo.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!l}create(){var e=this;return r(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(Co.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return r(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,Ve.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Zo.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing;ue(e,t,(e,t)=>ue(e,t,r))||(this._participants=e,this.emit(Zo.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}callExpected(e){var t,r=ss(e),n=null===r?null:this.room.getMember(r),i=e.getOpponentDeviceId();return null!==n&&void 0!==i&&void 0!==(null===(t=this.participants.get(n))||void 0===t?void 0:t.get(i))}initLocalCallFeed(){var e=this;return r(function*(){if(e.useLivekit)xe.info("Livekit group call: not starting local call feed.");else{if(e.state!==is.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=is.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}}})()}initLocalCallFeedInternal(){var e=this;return r(function*(){var t;xe.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Qo.Video)}catch(r){if(!e.allowCallWithoutVideoAndAudio)throw e.state=is.LocalCallFeedUninitialized,r;t=new MediaStream}if(e._state!==is.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new Io({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:wo.Usermedia,audioMuted:e.initWithAudioMuted||0===t.getAudioTracks().length||e.isPtt,videoMuted:e.initWithVideoMuted||0===t.getVideoTracks().length});Ss(t.getAudioTracks(),!r.isAudioMuted()),Ss(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=is.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return r(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),i=t.localCallFeed.isVideoMuted();xe.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(i,")")),Ss(e.getAudioTracks(),!n),Ss(e.getVideoTracks(),!i),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return r(function*(){if(e.state===is.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==is.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));for(var t of(xe.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=is.Entered,e.client.on(ko.Incoming,e.onIncomingCall),e.client.callEventHandler.calls.values()))e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===is.Entered&&(this.forEachCall(e=>e.hangup(vs.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(ko.Incoming,this.onIncomingCall),null===(e=this.stats)||void 0===e||e.stop())}leave(){this.dispose(),this.state=is.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return r(function*(){var r=!(e.length>0&&void 0!==e[0])||e[0];if(t.dispose(),t.room.off(Zd.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(Co.Ended,t),t.state=is.Ended,r){var n=t.room.currentState.getStateEvents(Ve.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,Ve.GroupCallPrefix,Jo(Jo({},n.getContent()),{},{"m.terminated":Xo.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}setMicrophoneMuted(e){var t=this;return r(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var n=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(null!==t.transmitTimer&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(t=>{var r;return null===(r=t.localUsermediaFeed)||void 0===r?void 0:r.setAudioVideoMuted(e,null)});var i=function(){var e=r(function*(){var e=[];t.forEachCall(t=>e.push(t.sendMetadataUpdate())),yield Promise.all(e).catch(e=>xe.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),e))});return function(){return e.apply(this,arguments)}}();if(n&&(yield i()),t.localCallFeed){if(xe.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")")),!(yield t.checkAudioPermissionIfNecessary(e)))return!1;t.localCallFeed.setAudioVideoMuted(e,null),Ss(t.localCallFeed.stream.getAudioTracks(),!e)}else xe.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(r=>Ss(r.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(r))),t.emit(Zo.LocalMuteStateChanged,e,t.isLocalVideoMuted()),n||(yield i()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return r(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(0===(null==r?void 0:r.getTracks().length))return xe.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch(r){return xe.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return r(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){xe.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),Ss(t.localCallFeed.stream.getVideoTracks(),!e)}catch(r){return xe.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else xe.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(t=>n.push(t.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(r=>Ss(r.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(r))),t.emit(Zo.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]?t[1]:{};if(e===n.isScreensharing())return e;if(!e)return n.forEachCall(e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)}),n.client.getMediaHandler().stopScreensharingStream(n.localScreenshareFeed.stream),n.removeScreenshareFeed(n.localScreenshareFeed),n.localScreenshareFeed=void 0,n.localDesktopCapturerSourceId=void 0,n.emit(Zo.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{xe.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var i=yield n.client.getMediaHandler().getScreensharingStream(r),o=function*(e){var t=()=>{n.setScreensharingEnabled(!1),e.removeEventListener("ended",t)};e.addEventListener("ended",t)};for(var s of i.getTracks())yield*o(s);return xe.log("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),n.localDesktopCapturerSourceId=r.desktopCapturerSourceId,n.localScreenshareFeed=new Io({client:n.client,roomId:n.room.roomId,userId:n.client.getUserId(),deviceId:n.client.getDeviceId(),stream:i,purpose:wo.Screenshare,audioMuted:!1,videoMuted:!1}),n.addScreenshareFeed(n.localScreenshareFeed),n.emit(Zo.LocalScreenshareStateChanged,!0,n.localScreenshareFeed,n.localDesktopCapturerSourceId),n.forEachCall(e=>e.pushLocalFeed(n.localScreenshareFeed.clone())),!0}catch(e){if(r.throwOnFail)throw e;return xe.error("GroupCall ".concat(n.groupCallId," setScreensharingEnabled() enabling screensharing error"),e),n.emit(Zo.Error,new rs(ts.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(r){var n,o=null!==(n=e.calls.get(r))&&void 0!==n?n:new Map,s=function(n){var i=o.get(n);if((null==i?void 0:i.getOpponentSessionId())!==c.sessionId&&e.wantsOutgoingCall(r,n)){t=!0,void 0!==i&&(xe.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(r,", deviceId=").concat(n,", callId=").concat(i.callId,")")),i.hangup(vs.NewSession,!1));var s=Rs(e.client,e.room.roomId,{invitee:r,opponentDeviceId:n,opponentSessionId:c.sessionId,groupCallId:e.groupCallId});null===s?(xe.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(r,", device=").concat(n,")")),o.delete(n)):(e.initCall(s),o.set(n,s),xe.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(r,", deviceId=").concat(n,", sessionId=").concat(c.sessionId,")")),s.placeCallWithCallFeeds(e.getLocalFeeds().map(e=>e.clone()),c.screensharing).then(()=>{e.dataChannelsEnabled&&s.createDataChannel("datachannel",e.dataChannelOptions)}).catch(t=>{xe.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(r,")"),t),t instanceof _s&&t.code===ts.UnknownDevice?e.emit(Zo.Error,t):e.emit(Zo.Error,new rs(ts.PlaceCallFailed,"Failed to place call to ".concat(r))),s.hangup(vs.SignallingFailed,!1),o.get(n)===s&&o.delete(n)}))}};for(var[a,c]of i)s(a);o.size>0?e.calls.set(r,o):e.calls.delete(r)};for(var[{userId:n},i]of this.participants)r(n);t&&this.emit(Zo.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(Ve.GroupCallMemberPrefix):this.room.currentState.getStateEvents(Ve.GroupCallMemberPrefix,e)}initCall(e){var t=ss(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(t,r)=>this.onCallStateChanged(e,t,r),i=this.onCallHangup,o=t=>this.onCallReplaced(e,t),s=this.callHandlers.get(t);void 0===s&&(s=new Map,this.callHandlers.set(t,s)),s.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:i,onCallReplaced:o}),e.on(ps.FeedsChanged,r),e.on(ps.State,n),e.on(ps.Hangup,i),e.on(ps.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(ps)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=ss(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var i=this.callHandlers.get(r),{onCallFeedsChanged:o,onCallStateChanged:s,onCallHangup:a,onCallReplaced:c}=i.get(n);if(e.removeListener(ps.FeedsChanged,o),e.removeListener(ps.State,s),e.removeListener(ps.Hangup,a),e.removeListener(ps.Replaced,c),i.delete(r),0===i.size&&this.callHandlers.delete(r),e.hangupReason!==vs.Replaced){var l=this.getUserMediaFeed(r,n);l&&this.removeUserMediaFeed(l);var d=this.getScreenshareFeed(r,n);d&&this.removeScreenshareFeed(d)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Zo.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Zo.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Zo.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Zo.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Zo.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(Zo.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Zo.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(e)if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state!==is.Ended){var t=new Map,r=Date.now(),n=this.state===is.Entered||this.enteredViaAnotherSession,i=1/0;for(var o of this.getMemberStateEvents()){var s=this.room.getMember(o.getStateKey()),a=o.getContent(),c=(Array.isArray(a["m.calls"])?a["m.calls"]:[]).find(e=>e["m.call_id"]===this.groupCallId),l=(Array.isArray(null==c?void 0:c["m.devices"])?c["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>r&&Array.isArray(e.feeds));if(n||(null==s?void 0:s.userId)!==this.client.getUserId()||(l=l.filter(e=>e.device_id!==this.client.getDeviceId())),l.length>0&&(null==s?void 0:s.membership)===lt.Join){var d=new Map;for(var u of(t.set(s,d),l))d.set(u.device_id,{sessionId:u.session_id,screensharing:u.feeds.some(e=>e.purpose===wo.Screenshare)}),u.expires_ts<i&&(i=u.expires_ts)}}if(n){var h=t.get(e);void 0===h&&(h=new Map,t.set(e,h)),h.has(this.client.getDeviceId())||h.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(e=>e.purpose===wo.Screenshare)})}this.participants=t,i<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),i-r))}else this.participants=new Map;else xe.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"))}updateDevices(e){var t=arguments,n=this;return r(function*(){var r,i=t.length>1&&void 0!==t[1]&&t[1],o=Date.now(),s=n.client.getUserId(),a=n.getMemberStateEvents(s),c=null!==(r=null==a?void 0:a.getContent())&&void 0!==r?r:{},l=Array.isArray(c["m.calls"])?c["m.calls"]:[],d=null,u=[];for(var h of l)h["m.call_id"]===n.groupCallId?d=h:u.push(h);null===d&&(d={});var g=(Array.isArray(d["m.devices"])?d["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>o&&Array.isArray(e.feeds)),p=e(g);if(null!==p){var v=[...u];p.length>0&&v.push(Jo(Jo({},d),{},{"m.call_id":n.groupCallId,"m.devices":p}));var m={"m.calls":v};yield n.client.sendStateEvent(n.room.roomId,Ve.GroupCallMemberPrefix,m,s,{keepAlive:i})}})()}addDeviceToMemberState(){var e=this;return r(function*(){yield e.updateDevices(t=>[...t.filter(t=>t.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+os,feeds:e.getLocalFeeds().map(e=>({purpose:e.purpose}))}])})()}updateMemberState(){var e=this;return r(function*(){null!==e.resendMemberStateTimer&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===is.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(r(function*(){xe.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){xe.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),27e5)):yield e.updateDevices(t=>t.filter(t=>t.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return r(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(e=>[e.device_id,e]));yield e.updateDevices(t=>{var n=t.filter(t=>{var n=r.get(t.device_id);return void 0!==(null==n?void 0:n.last_seen_ts)&&!(t.device_id===e.client.getDeviceId()&&e.state!==is.Entered&&!e.enteredViaAnotherSession)});return n.length===t.length?null:n})})()}getGroupCallStats(){if(void 0===this.stats){var e=this.client.getUserId()||"unknown";this.stats=new zo(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(Wo.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(Wo.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(Wo.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(Wo.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function cs(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function ls(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?cs(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):cs(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var ds=function(e){return e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended",e}({}),us=function(e){return e.Voice="voice",e.Video="video",e}({}),hs=function(e){return e.Inbound="inbound",e.Outbound="outbound",e}({}),gs=function(e){return e.Local="local",e.Remote="remote",e}({}),ps=function(e){return e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event",e.PeerConnectionCreated="peer_connection_created",e}({}),vs=function(e){return e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session",e}({}),ms=6e4;class _s extends Error{constructor(e,t,r){super(t+": "+r),o(this,"code",void 0),this.code=e}}function fs(){return Date.now().toString()+yo(16)}function ys(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}function bs(e,t){return e+":"+t}class ws extends qe{constructor(e){var t,n;if(super(),t=this,o(this,"roomId",void 0),o(this,"callId",void 0),o(this,"invitee",void 0),o(this,"hangupParty",void 0),o(this,"hangupReason",void 0),o(this,"direction",void 0),o(this,"ourPartyId",void 0),o(this,"peerConn",void 0),o(this,"toDeviceSeq",0),o(this,"isPtt",!1),o(this,"_state",ds.Fledgling),o(this,"client",void 0),o(this,"forceTURN",void 0),o(this,"turnServers",void 0),o(this,"candidateSendQueue",[]),o(this,"candidateSendTries",0),o(this,"candidatesEnded",!1),o(this,"feeds",[]),o(this,"transceivers",new Map),o(this,"inviteOrAnswerSent",!1),o(this,"waitForLocalAVStream",!1),o(this,"successor",void 0),o(this,"opponentMember",void 0),o(this,"opponentVersion",void 0),o(this,"opponentPartyId",void 0),o(this,"opponentCaps",void 0),o(this,"iceDisconnectedTimeout",void 0),o(this,"iceReconnectionTimeOut",void 0),o(this,"inviteTimeout",void 0),o(this,"removeTrackListeners",new Map),o(this,"remoteOnHold",!1),o(this,"callStatsAtEnd",void 0),o(this,"makingOffer",!1),o(this,"ignoreOffer",!1),o(this,"isSettingRemoteAnswerPending",!1),o(this,"responsePromiseChain",void 0),o(this,"remoteCandidateBuffer",new Map),o(this,"remoteAssertedIdentity",void 0),o(this,"remoteSDPStreamMetadata",void 0),o(this,"callLengthInterval",void 0),o(this,"callStartTime",void 0),o(this,"opponentDeviceId",void 0),o(this,"hasOpponentDeviceInfo",void 0),o(this,"opponentSessionId",void 0),o(this,"groupCallId",void 0),o(this,"stopVideoTrackTimer",void 0),o(this,"isOnlyDataChannelAllowed",void 0),o(this,"stats",void 0),o(this,"gotLocalIceCandidate",e=>{if(e.candidate){if(this.candidatesEnded&&xe.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),xe.debug("Call ".concat(this.callId," got local ICE ").concat(e.candidate.sdpMid," ").concat(e.candidate.candidate)),this.callHasEnded())return;""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)}}),o(this,"onIceGatheringStateChange",e=>{var t;xe.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),"complete"===(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)&&(this.queueCandidate(null),xe.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),o(this,"getLocalOfferFailed",e=>{xe.error("Call ".concat(this.callId," getLocalOfferFailed() running"),e),this.emit(ps.Error,new _s(vs.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(gs.Local,vs.LocalOfferFailed,!1)}),o(this,"getUserMediaFailed",e=>{this.successor?this.successor.getUserMediaFailed(e):(xe.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),e),this.emit(ps.Error,new _s(vs.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(gs.Local,vs.NoUserMedia,!1))}),o(this,"placeCallFailed",e=>{this.successor?this.successor.placeCallFailed(e):(xe.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),e),this.emit(ps.Error,new _s(vs.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(gs.Local,vs.IceFailed,!1))}),o(this,"onIceConnectionStateChanged",()=>{var e,t,r,n,i,o;if(!this.callHasEnded()){if(xe.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),["connected","completed"].includes(null!==(r=null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)&&void 0!==r?r:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=ds.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(ps.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},1e3));else if("failed"==(null===(i=this.peerConn)||void 0===i?void 0:i.iceConnectionState)){var s,a;if(this.candidatesEnded=!1,null!==(s=this.peerConn)&&void 0!==s&&s.restartIce)this.candidatesEnded=!1,xe.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat(null===(a=this.peerConn)||void 0===a?void 0:a.iceConnectionState,")")),this.peerConn.restartIce();else xe.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(vs.IceFailed,!1)}else"disconnected"==(null===(o=this.peerConn)||void 0===o?void 0:o.iceConnectionState)&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var e,t,r;xe.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),null!==(r=this.peerConn)&&void 0!==r&&r.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},2e3),this.iceDisconnectedTimeout=setTimeout(()=>{xe.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(vs.IceFailed,!1)},3e4),this.state=ds.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var c of this.getRemoteFeeds())c.setAudioVideoMuted(!0,!0)}}),o(this,"onSignallingStateChanged",()=>{var e;xe.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.signalingState,")"))}),o(this,"onTrack",e=>{if(0!==e.streams.length){var t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){var r=()=>{0===t.getTracks().length&&(xe.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(t.id,")")),this.deleteFeedByStream(t),t.removeEventListener("removetrack",r),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",r),this.removeTrackListeners.set(t,r)}}else xe.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(e.track.kind,")"))}),o(this,"onDataChannel",e=>{this.emit(ps.DataChannel,e.channel,this)}),o(this,"onNegotiationNeeded",r(function*(){xe.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state===ds.CreateOffer||0!==t.opponentVersion?t.queueGotLocalOffer():xe.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"))})),o(this,"onHangupReceived",e=>{xe.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(e)||this.state===ds.Ringing?this.terminate(gs.Remote,e.reason||vs.UserHangup,!0):xe.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(e.party_id,": our partner is ").concat(this.opponentPartyId))}),o(this,"onRejectReceived",e=>{xe.debug("Call ".concat(this.callId," onRejectReceived() running")),[ds.InviteSent,ds.Ringing].includes(this.state)||this.state===ds.Fledgling&&this.direction===hs.Inbound?this.terminate(gs.Remote,e.reason||vs.UserHangup,!0):xe.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),o(this,"onAnsweredElsewhere",e=>{xe.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(gs.Remote,vs.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");for(var i of(this.forceTURN=null!==(n=e.forceTURN)&&void 0!==n&&n,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]}),this.turnServers))L(i,["urls"]);this.callId=fs(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return r(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return r(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(ps.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(ps.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?us.Video:us.Voice}get hasLocalUserMediaVideoTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===wo.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===wo.Usermedia&&!(null===(t=e.stream)||void 0===t||!t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return Boolean(null===(e=this.transceivers.get(bs(wo.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return Boolean(null===(e=this.transceivers.get(bs(wo.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===wo.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===wo.Screenshare)}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===wo.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===wo.Screenshare)}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return r(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(e.client.getCrypto()){var r=e.invitee||(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId);if(!r)throw new Error("Couldn't find opponent user ID to init crypto");throw e.hasOpponentDeviceInfo=!1,new ns(r)}e.hasOpponentDeviceInfo=!0}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(this.opponentSupportsSDPStreamMetadata()){var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;r?this.getFeedByStreamId(e.id)?xe.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):(this.feeds.push(new Io({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:i})),this.emit(ps.FeedsChanged,this.feeds,this),xe.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))):xe.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"))}else this.pushRemoteFeedWithoutMetadata(e)}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=wo.Usermedia,i=null===(t=this.feeds.find(e=>!e.isLocal()))||void 0===t?void 0:t.stream;i&&e.id!==i.id?xe.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")")):this.getFeedByStreamId(e.id)?xe.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):(this.feeds.push(new Io({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(ps.FeedsChanged,this.feeds,this),xe.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")")))}pushNewLocalFeed(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.client.getUserId();Ss(e.getAudioTracks(),!0),Ss(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?xe.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):this.pushLocalFeed(new Io({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.feeds.some(t=>e.stream.id===t.stream.id))xe.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));else{if(this.feeds.push(e),r){var n=function(){xe.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(i.id,", kind=").concat(i.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(i.enabled,")"));var r=bs(e.purpose,i.kind);if(t.transceivers.has(r)){var n=t.transceivers.get(r);n.sender.replaceTrack(i),n.direction="inactive"===n.direction?"sendonly":"sendrecv"}else{var o=t.peerConn.addTrack(i,e.stream),s=t.peerConn.getTransceivers().find(e=>e.sender===o);s?t.transceivers.set(r,s):xe.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var i of e.stream.getTracks())n()}xe.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(ps.FeedsChanged,this.feeds,this)}}removeLocalFeed(e){var t=bs(e.purpose,"audio"),r=bs(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var i=this.transceivers.get(n);i.sender&&this.peerConn.removeTrack(i.sender)}e.purpose===wo.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(ps.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);t?this.deleteFeed(t):xe.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"))}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(ps.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return r(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return r(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(e=>{r.push(e)}),r}})()}initWithInvite(e){var t=this;return r(function*(){var r,n=e.getContent();t.direction=hs.Inbound,(yield t.client.checkTurnServers())||xe.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var i=n[bo];i?t.updateRemoteSDPStreamMetadata(i):xe.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(ps.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),xe.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(e){return xe.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),e),void t.terminate(gs.Local,vs.SetRemoteDescription,!1)}var o=null===(r=t.feeds.find(e=>!e.isLocal()))||void 0===r?void 0:r.stream;if(!(t.isOnlyDataChannelAllowed||o&&0!==o.getTracks().length))return xe.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),void t.terminate(gs.Local,vs.SetRemoteDescription,!1);if(t.state=ds.Ringing,e.getLocalAge()){var s=setTimeout(()=>{var e;t.state==ds.Ringing&&(xe.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=gs.Remote,t.state=ds.Ended,t.stopAllMedia(),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),null===(e=t.stats)||void 0===e||e.removeStatsReportGatherer(t.callId),t.emit(ps.Hangup,t))},n.lifetime-e.getLocalAge()),a=e=>{e!==ds.Ringing&&(clearTimeout(s),t.off(ps.State,a))};t.on(ps.State,a)}})()}initWithHangup(e){this.state=ds.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(xe.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):Y(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(xe.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t)}answer(e,t){var n=this;return r(function*(){if(!n.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(n.localUsermediaStream||n.waitForLocalAVStream)n.waitForLocalAVStream&&(n.state=ds.WaitLocalMedia);else{var r=n.state,i=n.shouldAnswerWithMediaType(e,n.hasRemoteUserMediaAudioTrack,"audio"),o=n.shouldAnswerWithMediaType(t,n.hasRemoteUserMediaVideoTrack,"video");n.state=ds.WaitLocalMedia,n.waitForLocalAVStream=!0;try{var s,a=yield n.client.getMediaHandler().getUserMediaStream(i,o);n.waitForLocalAVStream=!1;var c=[new Io({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:null!==(s=n.client.getDeviceId())&&void 0!==s?s:void 0,stream:a,purpose:wo.Usermedia,audioMuted:!1,videoMuted:!1})];n.localScreensharingFeed&&c.push(n.localScreensharingFeed),n.answerWithCallFeeds(c)}catch(e){if(!o)return void n.getUserMediaFailed(e);xe.warn("Call ".concat(n.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),n.state=r,n.waitForLocalAVStream=!1,yield n.answer(i,!1)}}}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){xe.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===ds.WaitLocalMedia?(xe.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[ds.CreateOffer,ds.InviteSent].includes(this.state)&&(e.direction===hs.Outbound?e.queueGotCallFeedsForAnswer([]):(xe.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(e=>e.clone())))),this.successor=e,this.emit(ps.Replaced,e,this),this.hangup(vs.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(xe.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(gs.Local,e,!t),![ds.Fledgling,ds.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&0!==this.opponentVersion||e!==vs.UserHangup)&&(r.reason=e),this.sendVoipEvent(Ve.CallHangup,r)}}reject(){if(this.state!==ds.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return xe.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),void this.hangup(vs.UserHangup,!0);xe.debug("Rejecting call: "+this.callId),this.terminate(gs.Local,vs.UserHangup,!0),this.sendVoipEvent(Ve.CallReject,{})}upgradeCall(e,t){var n=this;return r(function*(){if((e||t)&&n.opponentSupportsSDPStreamMetadata())try{xe.debug("Call ".concat(n.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var r=e||n.hasLocalUserMediaAudioTrack,i=t||n.hasLocalUserMediaVideoTrack,o=yield n.client.getMediaHandler().getUserMediaStream(r,i,!1);yield n.updateLocalUsermediaStream(o,e,t)}catch(e){xe.error("Call ".concat(n.callId," upgradeCall() failed to upgrade the call"),e),n.emit(ps.Error,new _s(vs.NoUserMedia,"Failed to get camera access: ",e),n)}})()}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}setScreensharingEnabled(e,t){var n=this;return r(function*(){if(e&&n.isScreensharing())return xe.warn("Call ".concat(n.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!n.isScreensharing())return xe.warn("Call ".concat(n.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!n.opponentSupportsSDPStreamMetadata())return n.setScreensharingEnabledWithoutMetadataSupport(e,t);if(xe.debug("Call ".concat(n.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),!e){var r=n.transceivers.get(bs(wo.Screenshare,"audio")),i=n.transceivers.get(bs(wo.Screenshare,"video"));for(var o of[r,i])o&&o.sender&&n.peerConn.removeTrack(o.sender);return n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}try{var s=yield n.client.getMediaHandler().getScreensharingStream(t);return!!s&&(n.pushNewLocalFeed(s,wo.Screenshare),!0)}catch(e){return xe.error("Call ".concat(n.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),e),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var n=this;return r(function*(){if(xe.debug("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),!e){var r,i,o=null===(r=n.localUsermediaStream)||void 0===r?void 0:r.getTracks().find(e=>"video"===e.kind),s=null===(i=n.transceivers.get(bs(wo.Usermedia,"video")))||void 0===i?void 0:i.sender;return null==s||s.replaceTrack(null!=o?o:null),n.client.getMediaHandler().stopScreensharingStream(n.localScreensharingStream),n.deleteFeedByStream(n.localScreensharingStream),!1}try{var a,c=yield n.client.getMediaHandler().getScreensharingStream(t);if(!c)return!1;var l=c.getTracks().find(e=>"video"===e.kind),d=null===(a=n.transceivers.get(bs(wo.Usermedia,"video")))||void 0===a?void 0:a.sender;return null==d||d.replaceTrack(null!=l?l:null),n.pushNewLocalFeed(c,wo.Screenshare,!1),!0}catch(e){return xe.error("Call ".concat(n.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),e),!1}})()}updateLocalUsermediaStream(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2&&void 0!==t[2]&&t[2],o=n.localUsermediaFeed,s=r||!o.isAudioMuted()&&!n.remoteOnHold,a=i||!o.isVideoMuted()&&!n.remoteOnHold;for(var c of(xe.log("Call ".concat(n.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(s,", video=").concat(a,")")),Ss(e.getAudioTracks(),s),Ss(e.getVideoTracks(),a),n.localUsermediaStream.getTracks()))n.localUsermediaStream.removeTrack(c),c.stop();for(var l of e.getTracks())n.localUsermediaStream.addTrack(l);var d=function*(){var t=bs(wo.Usermedia,u.kind),r=n.transceivers.get(t),i=null==r?void 0:r.sender,s=!1;if(i)try{xe.info("Call ".concat(n.callId," updateLocalUsermediaStream() replacing track (id=").concat(u.id,", kind=").concat(u.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")")),yield i.replaceTrack(u),r.direction="inactive"===r.direction?"sendonly":"sendrecv",s=!0}catch(e){xe.warn("Call ".concat(n.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),e)}if(!s){xe.info("Call ".concat(n.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(u.id,", kind=").concat(u.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")"));var a=n.peerConn.addTrack(u,n.localUsermediaStream),c=n.peerConn.getTransceivers().find(e=>e.sender===a);c?n.transceivers.set(t,c):xe.warn("Call ".concat(n.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var u of e.getTracks())yield*d()})()}setLocalVideoMuted(e){var t=this;return r(function*(){var r,n;if(xe.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),e||void 0===t.stopVideoTrackTimer||(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e)return null===(n=t.localUsermediaFeed)||void 0===n||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted();if(!e&&0===t.localUsermediaStream.getVideoTracks().length){var i=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(i)}return null===(r=t.localUsermediaFeed)||void 0===r||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var e of t.localUsermediaStream.getVideoTracks())e.stop(),t.localUsermediaStream.removeTrack(e)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}setMicrophoneMuted(e){var t=this;return r(function*(){var r;return xe.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?e||t.hasUserMediaAudioSender&&t.hasLocalUserMediaAudioTrack?(null===(r=t.localUsermediaFeed)||void 0===r||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){for(var t of(this.remoteOnHold=e,this.peerConn.getTransceivers()))t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(ps.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==ds.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if("audio"===(null===(r=t.track)||void 0===r?void 0:r.kind)&&t.dtmf)return void t.dtmf.insertDTMF(e)}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;xe.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),Ss(this.localUsermediaStream.getAudioTracks(),!e),Ss(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return r(function*(){yield e.sendVoipEvent(Ve.CallSDPStreamMetadataChangedPrefix,{[bo]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.successor)this.successor.queueGotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=ds.CreateOffer,xe.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}}sendAnswer(){var e=this;return r(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[bo]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();xe.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(Ve.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(t){e.state=ds.Ringing,t instanceof Vn&&t.event&&e.client.cancelPendingEvent(t.event);var n=vs.SendAnswer,i="Failed to send answer";throw"UnknownDeviceError"==t.name&&(n=vs.UnknownDevices,i="Unknown devices present in the room"),e.emit(ps.Error,new _s(n,i,t),e),t}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=go.parse(e.sdp);r.media.forEach(e=>{var r=new Map,n=new Map;for(var i of e.rtp)r.set(i.payload,i.codec),n.set(i.codec,i.payload);for(var o of t)if(o.mediaType===e.type)if(n.has(o.codec)){var s=[];void 0!==o.enableDtx&&s.push("usedtx=".concat(o.enableDtx?"1":"0")),void 0!==o.maxAverageBitrate&&s.push("maxaveragebitrate=".concat(o.maxAverageBitrate));var a=!1;for(var c of e.fmtp)r.get(c.payload)===o.codec&&(a=!0,c.config+=";"+s.join(";"));a||e.fmtp.push({payload:n.get(o.codec),config:s.join(";")})}else xe.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(o.codec," as it's not present."))}),e.sdp=go.write(r)}createOffer(){var e=this;return r(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,ys(e.isPtt)),t})()}createAnswer(){var e=this;return r(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,ys(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return r(function*(){if(!t.callHasEnded()){for(var r of(t.waitForLocalAVStream=!1,e))t.pushLocalFeed(r);var n;t.state=ds.CreateAnswer;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(e){return xe.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),e),void t.terminate(gs.Local,vs.CreateAnswer,!0)}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded())return;if(t.state=ds.Connecting,yield new Promise(e=>{setTimeout(e,200)}),t.callHasEnded())return;t.sendAnswer()}catch(e){return xe.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),e),void t.terminate(gs.Local,vs.SetLocalDescription,!0)}}})()}onRemoteIceCandidatesReceived(e){var t=this;return r(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(n){var i=0===r.version?null:r.party_id||null;if(void 0!==t.opponentPartyId)t.partyIdMatches(r)?yield t.addIceCandidates(n):xe.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));else if(i){xe.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var o=t.remoteCandidateBuffer.get(i)||[];o.push(...n),t.remoteCandidateBuffer.set(i,o)}}else xe.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"))}})()}onAnswerReceived(e){var t=this;return r(function*(){var r=e.getContent();if(xe.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded())xe.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));else if(void 0===t.opponentPartyId){t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=ds.Connecting;var n=r[bo];n?t.updateRemoteSDPStreamMetadata(n):xe.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,xe.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(e){return t.isSettingRemoteAnswerPending=!1,xe.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),e),void t.terminate(gs.Local,vs.SetRemoteDescription,!1)}if(null!==t.opponentPartyId)try{yield t.sendVoipEvent(Ve.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(e){xe.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),e)}}else xe.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId))})()}onSelectAnswerReceived(e){var t=this;return r(function*(){if(t.direction===hs.Inbound){var r=e.getContent().selected_party_id;null!=r?r!==t.ourPartyId&&(xe.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(gs.Remote,vs.AnsweredElsewhere,!0)):xe.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"))}else xe.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"))})()}onNegotiateReceived(e){var t=this;return r(function*(){var r=e.getContent(),n=r.description;if(n&&n.sdp&&n.type){var i=t.direction===hs.Inbound,o=!t.makingOffer&&("stable"===t.peerConn.signalingState||t.isSettingRemoteAnswerPending),s="offer"===n.type&&!o;if(t.ignoreOffer=!i&&s,t.ignoreOffer)xe.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));else{var a=t.isLocalOnHold(),c=r[bo];c?t.updateRemoteSDPStreamMetadata(c):xe.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending="answer"==n.type,yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,xe.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),"offer"===n.type){var l,d;try{t.getRidOfRTXCodecs(),d=yield t.createAnswer()}catch(e){return xe.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),e),void t.terminate(gs.Local,vs.CreateAnswer,!0)}yield t.peerConn.setLocalDescription(d),xe.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(Ve.CallNegotiate,{lifetime:ms,description:null===(l=t.peerConn.localDescription)||void 0===l?void 0:l.toJSON(),[bo]:t.getLocalSDPStreamMetadata(!0)})}}catch(e){t.isSettingRemoteAnswerPending=!1,xe.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),e)}var u=t.isLocalOnHold();a!==u&&(t.emit(ps.LocalHoldUnhold,u,t),t.emit(ps.HoldUnhold,u))}}else xe.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"))})()}updateRemoteSDPStreamMetadata(e){for(var t of(this.remoteSDPStreamMetadata=ae(this.remoteSDPStreamMetadata||{},e,!0),this.getRemoteFeeds())){var r,n=t.stream.id,i=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(null==i?void 0:i.audio_muted,null==i?void 0:i.video_muted),t.purpose=null===(r=this.remoteSDPStreamMetadata[n])||void 0===r?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent()[bo];this.updateRemoteSDPStreamMetadata(t)}onAssertedIdentityReceived(e){var t=this;return r(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(ps.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===ds.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return r(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){return void e.getLocalOfferFailed(t)}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return r(function*(){if(xe.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded())xe.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));else{var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(t){return xe.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),t),void e.terminate(gs.Local,vs.CreateOffer,!0)}try{yield e.peerConn.setLocalDescription(t)}catch(t){return xe.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),t),void e.terminate(gs.Local,vs.SetLocalDescription,!0)}if("gathering"===e.peerConn.iceGatheringState&&(yield new Promise(e=>{setTimeout(e,200)})),!e.callHasEnded()){var r,n,i=e.state===ds.CreateOffer?Ve.CallInvite:Ve.CallNegotiate,o={lifetime:ms};if(i===Ve.CallInvite&&e.invitee&&(o.invitee=e.invitee),e.state===ds.CreateOffer)o.offer=null===(r=e.peerConn.localDescription)||void 0===r?void 0:r.toJSON();else o.description=null===(n=e.peerConn.localDescription)||void 0===n?void 0:n.toJSON();o.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},o[bo]=e.getLocalSDPStreamMetadata(!0);var s=e.discardDuplicateCandidates();xe.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(s," candidates that will be sent in offer"));try{yield e.sendVoipEvent(i,o)}catch(t){xe.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),t),t instanceof Vn&&t.event&&e.client.cancelPendingEvent(t.event);var a=vs.SignallingFailed,c="Signalling failed";return e.state===ds.CreateOffer&&(a=vs.SendInvite,c="Failed to send invite"),"UnknownDeviceError"==t.name&&(a=vs.UnknownDevices,c="Unknown devices present in the room"),e.emit(ps.Error,new _s(a,c,t),e),void e.terminate(gs.Local,a,!1)}e.sendCandidateQueue(),e.state===ds.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=ds.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===ds.InviteSent&&e.hangup(vs.InviteTimeout,!1)},ms))}}})()}getRidOfRTXCodecs(){if(RTCRtpReceiver.getCapabilities&&RTCRtpSender.getCapabilities){var e=this.transceivers.get(bs(wo.Screenshare,"video"));if(e&&e.setCodecPreferences){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var i of[...t,...r])if("video/rtx"!==i.mimeType){n.push(i);try{e.setCodecPreferences(n)}catch(e){xe.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",i,e),n.pop()}}}}}sendVoipEvent(e,t){var n=this;return r(function*(){var r,i=ls(ls({},t),{},{version:"1",call_id:n.callId,party_id:n.ourPartyId,conf_id:n.groupCallId});if(n.opponentDeviceId){var o,s=n.toDeviceSeq++,a=ls(ls({},i),{},{device_id:n.client.deviceId,sender_session_id:n.client.getSessionId(),dest_session_id:n.opponentSessionId,seq:s,[$e]:Zi.randomUUID&&!r?Zi.randomUUID():eo(r)});n.emit(ps.SendVoipEvent,{type:"toDevice",eventType:e,userId:n.invitee||(null===(o=n.getOpponentMember())||void 0===o?void 0:o.userId),opponentDeviceId:n.opponentDeviceId,content:a},n);var c=n.invitee||n.getOpponentMember().userId;if(n.client.getUseE2eForGroupCall()){if(!n.hasOpponentDeviceInfo)return void xe.warn("Call ".concat(n.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));throw new Error("Unimplemented")}yield n.client.sendToDevice(e,new Map([[c,new Map([[n.opponentDeviceId,a]])]]))}else{var l;n.emit(ps.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:n.roomId,content:i,userId:n.invitee||(null===(l=n.getOpponentMember())||void 0===l?void 0:l.userId)},n),yield n.client.sendEvent(n.roomId,e,i)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state!==ds.Ringing&&this.inviteOrAnswerSent){var t=this.direction===hs.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];""===n.candidate?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return r(function*(){var r=yield t.client.getProfileInfo(e),n=fs(),i={replacement_id:fs(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(Ve.CallReplaces,i),yield t.terminate(gs.Local,vs.Transferred,!0)})()}transferToCall(e){var t=this;return r(function*(){var r,n,i=null===(r=e.getOpponentMember())||void 0===r?void 0:r.userId,o=i?yield t.client.getProfileInfo(i):void 0,s=null===(n=t.getOpponentMember())||void 0===n?void 0:n.userId,a=s?yield t.client.getProfileInfo(s):void 0,c=fs(),l={replacement_id:fs(),target_user:{id:s,display_name:null==a?void 0:a.displayname,avatar_url:null==a?void 0:a.avatar_url},await_call:c};yield e.sendVoipEvent(Ve.CallReplaces,l);var d={replacement_id:fs(),target_user:{id:i,display_name:null==o?void 0:o.displayname,avatar_url:null==o?void 0:o.avatar_url},create_call:c};yield t.sendVoipEvent(Ve.CallReplaces,d),yield t.terminate(gs.Local,vs.Transferred,!0),yield e.terminate(gs.Local,vs.Transferred,!0)})()}terminate(e,t,n){var i=this;return r(function*(){var r;if(!i.callHasEnded()){for(var[o,s]of(i.hangupParty=e,i.hangupReason=t,i.state=ds.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),void 0!==i.iceDisconnectedTimeout&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),void 0!==i.stopVideoTrackTimer&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0),i.removeTrackListeners))o.removeEventListener("removetrack",s);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&"closed"!==i.peerConn.signalingState&&i.peerConn.close(),null===(r=i.stats)||void 0===r||r.removeStatsReportGatherer(i.callId),n&&i.emit(ps.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}})()}stopAllMedia(){for(var e of(xe.debug("Call ".concat(this.callId," stopAllMedia() running")),this.feeds))if(e.isLocal()&&e.purpose===wo.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===wo.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal())for(var t of(xe.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")")),e.stream.getTracks()))t.stop()}checkForErrorListener(){if(0===this.listeners(Ke.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return r(function*(){if(0!==e.candidateSendQueue.length&&!e.callHasEnded()){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(e=>e.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),xe.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(Ve.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(r){if(r instanceof Vn&&r.event&&e.client.cancelPendingEvent(r.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){xe.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),r);var n=vs.SignallingFailed;return e.emit(ps.Error,new _s(n,"Signalling failed",r),e),void e.hangup(n,!1)}var i=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,xe.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(i,"ms"),r),setTimeout(()=>{e.sendCandidateQueue()},i)}}})()}placeCall(e,t){var n=this;return r(function*(){if(!e)throw new Error("You CANNOT start a call without audio");var r;n.state=ds.WaitLocalMedia;try{var i,o=yield n.client.getMediaHandler().getUserMediaStream(e,t);Ss(o.getAudioTracks(),!0),Ss(o.getVideoTracks(),!0),r=new Io({client:n.client,roomId:n.roomId,userId:n.client.getUserId(),deviceId:null!==(i=n.client.getDeviceId())&&void 0!==i?i:void 0,stream:o,purpose:wo.Usermedia,audioMuted:!1,videoMuted:!1})}catch(e){return void n.getUserMediaFailed(e)}try{yield n.placeCallWithCallFeeds([r])}catch(e){return void n.placeCallFailed(e)}})()}placeCallWithCallFeeds(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]&&t[1];n.checkForErrorListener(),n.direction=hs.Outbound,yield n.initOpponentCrypto(),n.client.callEventHandler.calls.set(n.callId,n),(yield n.client.checkTurnServers())||xe.warn("Call ".concat(n.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),n.peerConn=n.createPeerConnection(),n.emit(ps.PeerConnectionCreated,n.peerConn,n),n.gotCallFeedsForInvite(e,r)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return null===(e=this.stats)||void 0===e||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t,r,n=e.getContent();(xe.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0,this.opponentMember)&&(null===(r=this.stats)||void 0===r||r.updateOpponentMember(this.callId,this.opponentMember.userId))}addBufferedIceCandidates(){var e=this;return r(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(xe.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return r(function*(){for(var r of e){null!==r.sdpMid&&void 0!==r.sdpMid||null!==r.sdpMLineIndex&&void 0!==r.sdpMLineIndex?xe.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")")):xe.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates"));try{yield t.peerConn.addIceCandidate(r)}catch(e){t.ignoreOffer?xe.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),e):xe.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),e)}}})()}get hasPeerConnection(){return Boolean(this.peerConn)}initStats(e){this.stats=e,this.stats.start()}}function Ss(e,t){for(var r of e)r.enabled=t}function Es(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{var e,t,r;if(!Boolean(null!==(e=null!==(t=null!==(r=window.RTCPeerConnection)&&void 0!==r?r:window.RTCSessionDescription)&&void 0!==t?t:window.RTCIceCandidate)&&void 0!==e?e:navigator.mediaDevices))return"test"!==process.env.NODE_ENV&&xe.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return xe.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function Rs(e,t,r){if(!Es())return null;var n=!!r&&r.forceTURN,i={client:e,roomId:t,invitee:null==r?void 0:r.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n,opponentDeviceId:null==r?void 0:r.opponentDeviceId,opponentSessionId:null==r?void 0:r.opponentSessionId,groupCallId:null==r?void 0:r.groupCallId},o=new ws(i);return e.reEmitter.reEmit(o,Object.values(ps)),o}var Is=function(e){return e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e}({}),ks=function(e){return e.Highlight="highlight",e.Sound="sound",e}({}),Ts=function(e){return e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<=",e}({});function Cs(e){return"==2"===e||"2"===e}var Os=function(e){return e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.EventPropertyContains="event_property_contains",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started",e}({}),Ms=function(e){return e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e}({}),Ps=function(e){return e.Master=".m.rule.master",e.IsUserMention=".m.rule.is_user_mention",e.IsRoomMention=".m.rule.is_room_mention",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({});function Ds(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function As(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ds(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ds(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var xs=[Ms.Override,Ms.ContentSpecific,Ms.RoomSpecific,Ms.SenderSpecific,Ms.Underride],Us={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:Os.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:Os.SenderNotificationPermission,key:"room"}],actions:[Is.Notify,{set_tweak:ks.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:Os.EventMatch,key:"type",pattern:"m.reaction"}],actions:[Is.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:Os.EventMatch,key:"type",pattern:Ve.RoomServerAcl},{kind:Os.EventMatch,key:"state_key",pattern:""}],actions:[]}},Ls=Symbol("UserDefinedRules"),Ns=[Ps.Master,Ls,Ps.SuppressNotices,Ps.InviteToSelf,Ps.MemberEvent,Ps.IsUserMention,Ps.ContainsDisplayName,Ps.IsRoomMention,Ps.AtRoomNotification,Ps.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],Fs={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:Os.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:Os.CallStarted}],actions:[Is.Notify,{set_tweak:ks.Sound,value:"default"}]}},js=[Ls,Ps.IncomingCall,".org.matrix.msc3914.rule.room.call",Ps.EncryptedDM,Ps.DM,Ps.Message,Ps.EncryptedMessage];function Bs(e,t,r,n,i){var o=r.filter(e=>e.default),s=r.filter(e=>!e.default);function a(r){r===Ls?l.push(...s):r in n?(e.warn("Adding default global ".concat(t," push rule ").concat(r)),l.push(n[r])):e.warn("Missing default global ".concat(t," push rule ").concat(r))}var c=0,l=[];for(var d of o){var u=i.indexOf(d.rule_id);if(-1!==u){for(;u>c;){a(i[c]),c+=1}l.push(d),c+=1}else l.push(d)}for(var h of i.slice(c))a(h);return l}class Ks{constructor(e){this.client=e,o(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===Is.Notify?t.notify=!0:"object"==typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e,t){var r=JSON.parse(JSON.stringify(t));return r||(r={}),r.global||(r.global={}),r.global.override||(r.global.override=[]),r.global.underride||(r.global.underride=[]),r.global.override=Bs(e,Ms.Override,r.global.override,Us,Ns),r.global.underride=Bs(e,Ms.Underride,r.global.underride,Fs,js),r}static getPushRuleGlobRegex(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"i",[n,i]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],o="".concat(t,"-").concat(r,"-").concat(e);return Ks.cachedGlobToRegex[o]||(Ks.cachedGlobToRegex[o]=new RegExp(n+"("+G(e)+")"+i,r)),Ks.cachedGlobToRegex[o]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var i of n.conditions)i.kind===Os.EventMatch&&(t.delete(i.key),this.parsedKeys.set(i.key,Ks.partsForDottedKey(i.key)));t.forEach(e=>this.parsedKeys.delete(e))}matchingRuleFromKindSet(e,t){for(var r of xs){var n=t[r];if(n)for(var i of n)if(i.enabled){var o=this.templateRuleToRaw(r,i);if(o&&this.ruleMatchesEvent(o,e))return As(As({},i),{},{kind:r})}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case Ms.Underride:case Ms.Override:r.conditions=t.conditions;break;case Ms.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Os.EventMatch,key:"room_id",value:t.rule_id});break;case Ms.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Os.EventMatch,key:"user_id",value:t.rule_id});break;case Ms.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:Os.EventMatch,key:"content.body",pattern:t.pattern})}return r}eventFulfillsCondition(e,t){switch(e.kind){case Os.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case Os.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case Os.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case Os.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case Os.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case Os.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case Os.CallStarted:case Os.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return!(null==n||!n.currentState)&&n.currentState.mayTriggerNotifOfType(r,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;var o=i[1],s=parseInt(i[2]);if(isNaN(s))return!1;switch(o){case"":case"==":return n==s;case"<":return n<s;case">":return n>s;case"<=":return n<=s;case">=":return n>=s;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var i=this.client.getRoom(t.getRoomId()),o=null==i||null===(r=i.currentState)||void 0===r?void 0:r.getMember(this.client.credentials.userId);if(!o)return!1;var s=o.name,a=new RegExp("(^|\\W)"+W(s)+"(\\W|$)","i");return n.body.search(a)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if("string"!=typeof r)return!1;if(e.value)return e.value===r;if("string"!=typeof e.pattern)return!1;var n=Ks.getPushRuleGlobRegex(e.pattern,"content.body"===e.key);return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;var r=this.valueForDottedKey(e.key,t);return!!Array.isArray(r)&&r.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||F(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],r="",n=!1;for(var i of e)n?(r+="\\"===i||"."===i?i:"\\"+i,n=!1):"."==i?(t.push(r),r=""):"\\"==i?n=!0:r+=i;return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r,n=this.parsedKeys.get(e);void 0===n&&(n=Ks.partsForDottedKey(e),this.parsedKeys.set(e,n));var i=n[0],o=0;for("content"===i?(r=t.getContent(),++o):"type"===i?(r=t.getType(),++o):r=t.event;o<n.length;++o){if(Y(r))return;r=r[n[o]]}return r}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=Ks.actionListToActionsObject(r.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=r.kind==Ms.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==Ps.ContainsUserName&&e.rule_id!==Ps.ContainsDisplayName&&e.rule_id!==Ps.AtRoomNotification)&&!(null!==(r=e.conditions)&&void 0!==r&&r.some(e=>!this.eventFulfillsCondition(e,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return null!==(t=null==r?void 0:r.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(void 0!==(null===(r=this.client.pushRules)||void 0===r?void 0:r[t]))for(var n of xs)if(void 0!==this.client.pushRules[t][n])for(var i of this.client.pushRules[t][n])if(i.rule_id===e)return{rule:i,kind:n}}return null}}o(Ks,"cachedGlobToRegex",{});var qs=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],Vs=qs[0],Ws=qs[qs.length-1],Gs=function(e){return e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR",e}({}),Hs=function(e){return e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON",e.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",e}({});class zs{static fromDiscoveryConfig(e){var t=this;return r(function*(){var r,n={"m.homeserver":{state:zs.FAIL_ERROR,error:zs.ERROR_INVALID,base_url:null},"m.identity_server":{state:zs.PROMPT,error:null,base_url:null}};if(null==e||!e["m.homeserver"])return xe.error("No m.homeserver key in config"),n["m.homeserver"].state=zs.FAIL_PROMPT,n["m.homeserver"].error=zs.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return xe.error("No m.homeserver base_url in config"),n["m.homeserver"].state=zs.FAIL_PROMPT,n["m.homeserver"].error=zs.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var i=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!i)return xe.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=zs.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var o=yield t.fetchWellKnownObject("".concat(i,"/_matrix/client/versions"));if(!o||!Array.isArray(null===(r=o.raw)||void 0===r?void 0:r.versions))return xe.error("Invalid /versions response"),n["m.homeserver"].error=zs.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=i,Promise.resolve(n);var s=new Set(o.raw.versions),a=!1;for(var c of qs)if(s.has(c)){a=!0;break}if(!a)return xe.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=zs.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=i,Promise.resolve(n);n["m.homeserver"]={state:zs.SUCCESS,error:null,base_url:i};var l="";if(e["m.identity_server"]){var d={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:zs.FAIL_PROMPT,error:zs.ERROR_INVALID_IS,base_url:null}};if(!(l=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url)))return xe.error("Invalid base_url for m.identity_server"),d["m.identity_server"].error=zs.ERROR_INVALID_IS_BASE_URL,Promise.resolve(d);var u=yield t.fetchWellKnownObject("".concat(l,"/_matrix/identity/v2"));if(null==u||!u.raw||u.action!==Gs.SUCCESS)return xe.error("Invalid /v2 response"),d["m.identity_server"].error=zs.ERROR_INVALID_IDENTITY_SERVER,d["m.identity_server"].base_url=l,Promise.resolve(d)}return l&&l.toString().length>0&&(n["m.identity_server"]={state:zs.SUCCESS,error:null,base_url:l}),Object.keys(e).forEach(t=>{if("m.homeserver"===t||"m.identity_server"===t){var r=["error","state","base_url"];for(var i of Object.keys(e[t]))r.includes(i)||(n[t][i]=e[t][i])}else n[t]=e[t]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return r(function*(){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:zs.FAIL_ERROR,error:zs.ERROR_INVALID,base_url:null},"m.identity_server":{state:zs.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),i=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return i&&i.action===Gs.SUCCESS?zs.fromDiscoveryConfig(i.raw):(xe.error("No response or error when parsing .well-known"),i.reason&&xe.error(i.reason),i.action===Gs.IGNORE?r["m.homeserver"]={state:zs.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=zs.FAIL_PROMPT,r["m.homeserver"].error=zs.ERROR_INVALID),Promise.resolve(r))})()}static getRawClientConfig(e){var t=this;return r(function*(){var r;if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n&&null!==(r=n.raw)&&void 0!==r?r:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(e){xe.error("Could not parse url",e)}if(null===(t=r)||void 0===t||!t.hostname)return!1;if("http:"!==r.protocol&&"https:"!==r.protocol)return!1;var n=r.port?":".concat(r.port):"",i=r.pathname?r.pathname:"",o="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(i);return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return xe.error(e),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){zs.fetchFn=e}static fetchWellKnownObject(e){return r(function*(){var t;try{if(404===(t=yield zs.fetch(e,{method:jn.Get,signal:Xn(5e3)})).status)return{raw:{},action:Gs.IGNORE,reason:zs.ERROR_MISSING_WELLKNOWN};if(200!==t.status)return{raw:{},action:Gs.FAIL_PROMPT,reason:"General failure"}}catch(e){var r=e,n="";return"object"==typeof r&&(n=null==r?void 0:r.message),{error:r,raw:{},action:Gs.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:Gs.SUCCESS}}catch(e){var i=e;return{error:i,raw:{},action:Gs.FAIL_PROMPT,reason:"SyntaxError"===(null==i?void 0:i.name)?zs.ERROR_INVALID_JSON:zs.ERROR_INVALID}}})()}}o(zs,"ERROR_INVALID",Hs.Invalid),o(zs,"ERROR_GENERIC_FAILURE",Hs.GenericFailure),o(zs,"ERROR_INVALID_HS_BASE_URL",Hs.InvalidHsBaseUrl),o(zs,"ERROR_INVALID_HOMESERVER",Hs.InvalidHomeserver),o(zs,"ERROR_INVALID_IS_BASE_URL",Hs.InvalidIsBaseUrl),o(zs,"ERROR_INVALID_IDENTITY_SERVER",Hs.InvalidIdentityServer),o(zs,"ERROR_INVALID_IS",Hs.InvalidIs),o(zs,"ERROR_MISSING_WELLKNOWN",Hs.MissingWellknown),o(zs,"ERROR_INVALID_JSON",Hs.InvalidJson),o(zs,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Hs.UnsupportedHomeserverSpecVersion),o(zs,"ALL_ERRORS",Object.keys(Hs)),o(zs,"FAIL_ERROR",Gs.FAIL_ERROR),o(zs,"FAIL_PROMPT",Gs.FAIL_PROMPT),o(zs,"PROMPT",Gs.PROMPT),o(zs,"SUCCESS",Gs.SUCCESS),o(zs,"fetchFn",void 0);var $s=function(e){return e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e}({});class Js{constructor(e){this.ourEvent=e,o(this,"timeline",void 0),o(this,"ourEventIndex",0),o(this,"paginateTokens",{[kr.Backward]:null,[kr.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?kr.Backward:kr.Forward]}setPaginateToken(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?kr.Backward:kr.Forward]=null!=e?e:null}addEvents(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class Ys{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),i=(r.events_after||[]).map(t),o=new Js(t(e.result)),s=o.ourEvent.threadRootId;return n=n.filter(e=>e.threadRootId===s),i=i.filter(e=>e.threadRootId===s),o.setPaginateToken(r.start,!0),o.addEvents(n,!0),o.addEvents(i,!1),o.setPaginateToken(r.end,!1),new Ys(e.rank,o)}constructor(e,t){this.rank=e,this.context=t}}var Qs=function(e){return e.Public="public",e.Private="private",e}({}),Xs=function(e){return e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e}({}),Zs=function(e){return e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e}({}),ea=function(e){return e.RoomMembership="m.room_membership",e}({}),ta=function(e){return e.CanJoin="can_join",e.Forbidden="forbidden",e}({}),ra=function(e){return e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable",e}({});function na(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function ia(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?na(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):na(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function oa(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function sa(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?oa(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):oa(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class aa{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return r(function*(){yield e.client.sendStateEvent(e.roomId,Ze.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return r(function*(){yield t.client.sendStateEvent(t.roomId,Ze.name,sa(sa({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return r(function*(){yield t.client.sendStateEvent(t.roomId,Ze.name,sa(sa({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return r(function*(){var t=(yield e.getFileEvent()).getOriginalContent().file,r=e.client.mxcUrlToHttp(t.url);if(!r)throw new Error("No HTTP URL available for ".concat(t.url));return{info:t,httpUrl:r}})()}getFileEvent(){var e=this;return r(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(Tr.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,n,i){var o=this;return r(function*(){var r=yield o.directory.createFile(e,t,n,sa(sa({},null!=i?i:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:We.Replace,event_id:o.id}}));return yield o.client.sendStateEvent(o.roomId,Ze.name,{active:!0,name:e,version:o.version+1},r.event_id),yield o.client.sendStateEvent(o.roomId,Ze.name,sa(sa({},o.indexEvent.getContent()),{},{active:!1}),o.id),r})()}getVersionHistory(){var e=this;return r(function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n,i=[...r.getLiveTimeline().getEvents()].reverse(),o=yield e.getFileEvent();do{if(n=i.find(e=>e.replacingEventId()===o.getId())){var s=e.directory.getFile(n.getId());if(!s)break;t.push(s),o=n}}while(n);return t})()}}function ca(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function la(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ca(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ca(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var da={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[Ve.RoomPowerLevels]:100,[Ve.RoomHistoryVisibility]:100,[Ve.RoomTombstone]:100,[Ve.RoomEncryption]:100,[Ve.RoomName]:50,[Ve.RoomMessage]:50,[Ve.RoomMessageEncrypted]:50,[Ve.Sticker]:50},users:{}},ua=function(e){return e.Viewer="viewer",e.Editor="editor",e.Owner="owner",e}({});class ha{constructor(e,t){if(this.client=e,this.roomId=t,o(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(Ve.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)})}setName(e){var t=this;return r(function*(){yield t.client.sendStateEvent(t.roomId,Ve.RoomName,{name:e},"")})()}invite(e){var t=arguments,n=this;return r(function*(){var r=!(t.length>1&&void 0!==t[1])||t[1],i=[n.retryInvite(e)];r&&i.push(...n.getDirectories().map(t=>t.invite(e,r))),yield Promise.all(i)})()}retryInvite(e){var t=this;return r(function*(){var r,n;yield(r=()=>t.client.invite(t.roomId,e),n=e=>!(e instanceof Vn&&"M_FORBIDDEN"===e.errcode),f(e=>r(e),{retries:1/0,shouldRetry:n?e=>{var{error:t}=e;return n(t)}:void 0,factor:2,minTimeout:3e3,maxTimeout:15e3}))})()}setPermissions(e,t){var n=this;return r(function*(){var r,i=n.room.currentState.getStateEvents(Ve.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var o=(null==i?void 0:i.getContent())||{},s=o.users_default||0,a=o.events_default||50,c=(null===(r=o.events)||void 0===r?void 0:r[Ve.RoomPowerLevels])||100,l=o.users||{};switch(t){case ua.Viewer:l[e]=s;break;case ua.Editor:l[e]=a;break;case ua.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}o.users=l,yield n.client.sendStateEvent(n.roomId,Ve.RoomPowerLevels,o,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(Ve.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var i=(null==n?void 0:n.getContent())||{},o=i.users_default||0,s=i.events_default||50,a=(null===(t=i.events)||void 0===t?void 0:t[Ve.RoomPowerLevels])||100,c=(null===(r=i.users)||void 0===r?void 0:r[e])||o;return c>=a?ua.Owner:c>=s?ua.Editor:ua.Viewer}createDirectory(e){var t=this;return r(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,Ve.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,Ve.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(Ve.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var i=this.client.unstableGetFileTreeSpace(n);i&&e.push(i)}}catch(e){xe.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return r(function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[lt.Invite,lt.Knock,lt.Join],i=e.room.currentState.getStateEvents(Ve.RoomMember);for(var o of i){if(o.getStateKey()!==e.client.getUserId()&&n.includes(o.getContent().membership)){var s=o.getStateKey();if(!s)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,s,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order})).filter(e=>e.roomId);return t.sort((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return se(e.order,t.order);var r,n,i,o,s=this.client.getRoom(e.roomId),a=this.client.getRoom(t.roomId);if(!s||!a)return se(e.roomId,t.roomId);var c=null!==(r=null===(n=s.currentState.getStateEvents(Ve.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==r?r:0,l=null!==(i=null===(o=a.currentState.getStateEvents(Ve.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==i?i:0;return c===l?se(e.roomId,t.roomId):c-l}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(Ve.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");var t=e.getStateKey();if(!t)throw new Error("No state key found for parent");var r=this.client.getRoom(t);if(!r)throw new Error("Unable to locate room for parent");return r}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom().currentState.getStateEvents(Ve.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}setOrder(e){var t=this;return r(function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),i=n.currentState.getStateEvents(Ve.SpaceChild),o=t.getOrderedChildren(i);e=Math.max(Math.min(e,o.length-1),0);var s=t.getOrder()<e;s&&e===o.length-1?e--:s||0!==e||e++;var a=o[s?e:e-1],c=o[s?e+1:e],l=ee[0],d=!1;if(a)if(e===o.length-1)null!=c&&c.order&&(l=ie(c.order));else{var u=null==a?void 0:a.order,h=null==c?void 0:c.order;u&&h?l=u===h?ie(u):function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ee,n=Math.max(e.length,t.length),i=ne(te(e,n,r),r),o=ne(te(t,n,r),r),s=(i+o)/BigInt(2);return s===i||s==o?re(s,r)+r[0]:re(s,r)}(u,h):u?l=ie(u):h?l=oe(h):d=!0}else null!=c&&c.order&&(l=oe(c.order));if(d){for(var g,p=0;p<=e;p++){var v=o[p];if(0===p&&(g=v.order),v.order)g=v.order;else{var m;g=g?ie(g):ee[0];var _=n.currentState.getStateEvents(Ve.SpaceChild,v.roomId),f=null!==(m=null==_?void 0:_.getContent())&&void 0!==m?m:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,Ve.SpaceChild,la(la({},f),{},{order:g}),v.roomId)}}g&&(l=ie(g))}var y=n.currentState.getStateEvents(Ve.SpaceChild,t.roomId),b=null!==(r=null==y?void 0:y.getContent())&&void 0!==r?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,Ve.SpaceChild,la(la({},b),{},{order:l}),t.roomId)})()}createFile(e,t,n,i){var o=this;return r(function*(){var{content_uri:r}=yield o.client.uploadContent(t,{includeFilename:!1});n.url=r;var s={msgtype:Ge.File,body:e,url:r,file:n};(i=null!=i?i:{})["m.new_content"]&&(i["m.new_content"]=s);var a=yield o.client.sendMessage(o.roomId,la(la(la({},i),s),{},{[Xe.name]:{}}));return yield o.client.sendStateEvent(o.roomId,Ze.name,{active:!0,name:e},a.event_id),a})()}getFile(e){var t=this.room.currentState.getStateEvents(Ze.name,e);return t?new aa(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(Ze.name))&&void 0!==e?e:[]).map(e=>new aa(this.client,e,this))}}var ga=function(e){return e.Recent="recent",e.Rank="rank",e}({}),pa=function(e){return e.LocalStreamsChanged="local_streams_changed",e}({});class va extends qe{constructor(e){super(),this.client=e,o(this,"audioInput",void 0),o(this,"audioSettings",void 0),o(this,"videoInput",void 0),o(this,"localUserMediaStream",void 0),o(this,"userMediaStreams",[]),o(this,"screensharingStreams",[]),o(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return r(function*(){xe.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return r(function*(){xe.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return r(function*(){xe.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var n=this;return r(function*(){xe.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),n.audioInput=e,n.videoInput=t,yield n.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return r(function*(){if(0!==e.userMediaStreams.length){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams)for(var i of(xe.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")")),n.getTracks()))i.stop();for(var o of(e.userMediaStreams=[],e.localUserMediaStream=void 0,e.client.callEventHandler.calls.values()))if(!o.callHasEnded()&&t.has(o.callId)){var{audio:s,video:a}=t.get(o.callId);xe.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(o.callId,")"));var c=yield e.getUserMediaStream(s,a);o.callHasEnded()||(yield o.updateLocalUsermediaStream(c))}for(var l of e.client.groupCallEventHandler.groupCalls.values())if(l.localCallFeed){xe.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(l.groupCallId,")"));var d=yield e.getUserMediaStream(!0,l.type===Qo.Video);l.state!==is.Ended&&(yield l.updateLocalUsermediaStream(d))}e.emit(pa.LocalStreamsChanged)}})()}hasAudioDevice(){return r(function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind).length>0}catch(e){return xe.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}})()}hasVideoDevice(){return r(function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).length>0}catch(e){return xe.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}})()}getUserMediaStream(e,t){var n=arguments,i=this;return r(function*(){var r=!(n.length>2&&void 0!==n[2])||n[2];return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,r)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,r),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,n){var i=this;return r(function*(){var r,o,s,a=e&&(yield i.hasAudioDevice()),c=t&&(yield i.hasVideoDevice()),l=!0;i.localUserMediaStream?(a!==i.localUserMediaStream.getAudioTracks().length>0&&(l=!1),c!==i.localUserMediaStream.getVideoTracks().length>0&&(l=!1),a&&(null===(o=i.localUserMediaStream.getAudioTracks()[0])||void 0===o||null===(o=o.getSettings())||void 0===o?void 0:o.deviceId)!==i.audioInput&&(l=!1),c&&(null===(s=i.localUserMediaStream.getVideoTracks()[0])||void 0===s||null===(s=s.getSettings())||void 0===s?void 0:s.deviceId)!==i.videoInput&&(l=!1)):l=!1;if(l){var d;if(r=i.localUserMediaStream.clone(),xe.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat(null===(d=i.localUserMediaStream)||void 0===d?void 0:d.id," newStreamId=").concat(r.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(c,")")),!a)for(var u of r.getAudioTracks())r.removeTrack(u);if(!c)for(var h of r.getVideoTracks())r.removeTrack(h)}else{var g=i.getUserMediaContraints(a,c);for(var p of(r=yield navigator.mediaDevices.getUserMedia(g),xe.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(r.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(c,", constraints=").concat(JSON.stringify(g),")")),r.getTracks())){var v=p.getSettings();"audio"===p.kind?i.audioInput=v.deviceId:"video"===p.kind&&(i.videoInput=v.deviceId)}n&&(i.localUserMediaStream=r)}return n&&i.userMediaStreams.push(r),i.emit(pa.LocalStreamsChanged),r})()}stopUserMediaStream(e){for(var t of(xe.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r=this.userMediaStreams.indexOf(e);if(-1!==r&&(xe.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(pa.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var i;if(null!==(i=this.localUserMediaStream)&&void 0!==i&&i.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return r(function*(){var r,n=e.length>0&&void 0!==e[0]?e[0]:{},i=!(e.length>1&&void 0!==e[1])||e[1];if(0===t.screensharingStreams.length){var o=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(xe.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getUserMedia(o)):(xe.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getDisplayMedia(o))}else{var s=t.screensharingStreams[t.screensharingStreams.length-1];xe.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(s.id,")")),r=s.clone()}return i&&t.screensharingStreams.push(r),t.emit(pa.LocalStreamsChanged),r})()}stopScreensharingStream(e){for(var t of(xe.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r=this.screensharingStreams.indexOf(e);-1!==r&&(xe.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(pa.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams)for(var t of(xe.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(pa.LocalStreamsChanged)}getUserMediaContraints(e,t){var r=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:null!=r&&r,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=r&&r,video:!0}}}var ma=function(e){return e.RequestFinished="FINISHED",e.Complete="COMPLETE",e}({}),_a=function(e){return e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess",e}({}),fa=function(e){return e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e}({});class ya{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return _a.PreProcess}onRequest(e){var t=this;return r(function*(){return e&&(xe.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return r(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class ba{constructor(e,t){this.client=e,this.cryptoCallbacks=t,o(this,"nextBatch",null)}name(){return"to_device"}when(){return _a.PreProcess}onRequest(e){var t=this;return r(function*(){return{since:null!==t.nextBatch?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return r(function*(){var r=e.events||[];$i(t.cryptoCallbacks?yield t.cryptoCallbacks.preprocessToDeviceMessages(r):r.map(e=>({message:e,encryptionInfo:null})),t.client),t.nextBatch=e.next_batch})()}}class wa{constructor(e){this.client=e}name(){return"account_data"}when(){return _a.PostProcess}onRequest(e){return r(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return r(function*(){for(var r in e.global&&e.global.length>0&&t.processGlobalAccountData(e.global),e.rooms){var n=Ia(t.client,r,e.rooms[r]),i=t.client.getRoom(r);i?(i.addAccountData(n),n.forEach(e=>{t.client.emit(kd.Event,e)})):xe.warn("got account data for room but room doesn't exist on client:",r)}})()}processGlobalAccountData(e){var t=Ia(this.client,void 0,e),r=t.reduce((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e),{});this.client.store.storeAccountDataEvents(t),t.forEach(e=>{if(e.getType()===Ve.PushRules){var t=e.getContent();this.client.setPushRules(t)}var n=r[e.getType()];return this.client.emit(kd.AccountData,e,n),e})}}class Sa{constructor(e){this.client=e}name(){return"typing"}when(){return _a.PostProcess}onRequest(e){return r(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return r(function*(){if(null!=e&&e.rooms)for(var r in e.rooms)ka(t.client,r,[e.rooms[r]])})()}}class Ea{constructor(e){this.client=e}name(){return"receipts"}when(){return _a.PostProcess}onRequest(e){return r(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return r(function*(){if(null!=e&&e.rooms)for(var r in e.rooms)ka(t.client,r,[e.rooms[r]])})()}}class Ra{constructor(e,t,r,n){this.slidingSync=e,this.client=t,o(this,"opts",void 0),o(this,"syncOpts",void 0),o(this,"syncState",null),o(this,"syncStateData",void 0),o(this,"lastPos",null),o(this,"failCount",0),o(this,"notifEvents",[]),this.opts=Wi(r),this.syncOpts=Gi(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[Oi.Timeline,Oi.TimelineReset]),this.slidingSync.on(fa.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(fa.RoomData,this.onRoomData.bind(this));var i=[new ba(this.client,this.syncOpts.cryptoCallbacks),new wa(this.client),new Sa(this.client),new Ea(this.client)];this.syncOpts.cryptoCallbacks&&i.push(new ya(this.syncOpts.cryptoCallbacks)),i.forEach(e=>{this.slidingSync.registerExtension(e)})}onRoomData(e,t){var n=this;return r(function*(){var r=n.client.store.getRoom(e);if(!r){if(!t.initial)return void n.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);r=zi(n.client,e,n.opts)}yield n.processRoomData(n.client,r,t)})()}onLifecycle(e,t,r){switch(r&&this.syncOpts.logger.debug("onLifecycle",e,r),e){case ma.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(Bi.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(Bi.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case ma.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>3?Bi.Error:Bi.Reconnecting,{error:new Vn(r)}),this.shouldAbortSync(new Vn(r)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys((null==t?void 0:t.rooms)||[]).length," rooms"))}}syncLeftRooms(){return r(function*(){return[]})()}peek(e){return r(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new Mi(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[Oi.Name,Oi.Redaction,Oi.RedactionCancelled,Oi.Receipt,Oi.Tags,Oi.LocalEchoUpdated,Oi.AccountData,Oi.MyMembership,Oi.Timeline,Oi.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[Zd.Events,Zd.Members,Zd.NewMember,Zd.Update]),e.currentState.on(Zd.NewMember,(e,t,r)=>{var n;r.user=null!==(n=this.client.getUser(r.userId))&&void 0!==n?n:void 0,this.client.reEmitter.reEmit(r,[dt.Name,dt.Typing,dt.PowerLevel,dt.Membership])})}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Bi.Error,{error:e}),!0)}processRoomData(e,t,n){var i=this;return r(function*(){n=function(e,t,r){if(!r.name)return r;for(var n of r.required_state)if(n.type===Ve.RoomName&&""===n.state_key)return n.content={name:r.name},r;return r.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:Ve.RoomName,content:{name:r.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),r}(e,t.roomId,n);var o=Ia(i.client,t.roomId,n.required_state),s=Ia(i.client,t.roomId,n.timeline,!1),a=[];if(n.limited||n.initial){var c=new Set;t.getLiveTimeline().getEvents().forEach(e=>{c.add(e.getId())});for(var l=[],d=[],u=!1,h=s.length-1;h>=0;h--){var g=s[h];c.has(g.getId())?u=!0:u?l.push(g):d.unshift(g)}s=d,l.length>0&&t.addEventsToTimeline(l,!0,!1,t.getLiveTimeline(),n.prev_batch)}var p,v=t.hasEncryptionStateEvent();if(null!=n.notification_count&&t.setUnreadNotificationCount(Ci.Total,n.notification_count),null!=n.highlight_count&&(!v||v&&t.getUnreadNotificationCount(Ci.Highlight)<=0)&&t.setUnreadNotificationCount(Ci.Highlight,n.highlight_count),n.bump_stamp&&t.setBumpStamp(n.bump_stamp),Number.isInteger(n.invited_count)&&t.currentState.setInvitedMemberCount(n.invited_count),Number.isInteger(n.joined_count)&&t.currentState.setJoinedMemberCount(n.joined_count),n.invite_state){var m=Ia(i.client,t.roomId,n.invite_state);return yield i.injectRoomEvents(t,m),n.initial&&(t.recalculate(),i.client.store.storeRoom(t),i.client.emit(kd.Room,t)),void m.forEach(e=>{i.client.emit(kd.Event,e)})}n.limited&&t.getLiveTimeline().setPaginationToken(null!==(p=n.prev_batch)&&void 0!==p?p:null,Tr.BACKWARDS);yield i.injectRoomEvents(t,o,s,n.num_live),t.addEphemeralEvents(a),t.updateMyMembership(lt.Join),t.setMSC4186SummaryData(n.heroes,n.joined_count,n.invited_count),t.recalculate(),n.initial&&(e.store.storeRoom(t),e.emit(kd.Room,t)),i.addNotifications(s);var _=function(){var n=r(function*(r){e.emit(kd.Event,r),r.isState()&&r.getType()==Ve.RoomEncryption&&i.syncOpts.cryptoCallbacks&&(yield i.syncOpts.cryptoCallbacks.onCryptoEvent(t,r))});return function(e){return n.apply(this,arguments)}}();yield Q(o,_),yield Q(s,_),a.forEach(function(t){e.emit(kd.Event,t)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var n=arguments,i=this;return r(function*(){var r=n.length>2&&void 0!==n[2]?n[2]:[],o=n.length>3&&void 0!==n[3]?n[3]:0,s=e.getLiveTimeline(),a=0==s.getEvents().length;if(a){for(var c of t)i.client.getPushActionsForEvent(c);s.initialiseState(t)}a||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var l=[];o>0&&(l=r.slice(-1*o),r=r.slice(0,-1*l.length)),yield e.addLiveEvents(r,{fromCache:!0,addToState:!1}),l.length>0&&(yield e.addLiveEvents(l,{fromCache:!1,addToState:!1})),e.recalculate(),i.resolveInvites(e)})()}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(lt.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then(function(t){var n=r.events.member;n.getContent().membership===lt.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})}})}}retryImmediately(){return!0}sync(){var e=this;return r(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(t){if(e.syncOpts.logger.error("Getting push rules failed",t),e.shouldAbortSync(t))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(kd.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function Ia(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=e.getEventMapper({decrypt:n});return r.map(function(e){return e.room_id=t,i(e)})}function ka(e,t,r){var n=Ia(e,t,r),i=e.getRoom(t);i?(i.addEphemeralEvents(n),n.forEach(t=>{e.emit(kd.Event,t)})):xe.warn("got ephemeral events for room but room doesn't exist on client:",t)}var Ta=new w("m.beacon_info","org.matrix.msc3672.beacon_info"),Ca=new w("m.beacon","org.matrix.msc3672.beacon");class Oa{static RETRY_BACKOFF_RATELIMIT(e,t,r){return ii(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===Ve.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Oa.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oa.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,o(this,"queues",{}),o(this,"activeQueues",[]),o(this,"procFn",null),o(this,"processQueue",e=>{var t=this.peekNextEvent(e);t?(this.queues[e].length,Promise.resolve().then(()=>this.procFn(t.event)).then(r=>{this.removeNextEvent(e),t.event.getId(),t.resolvers.resolve(r),this.processQueue(e)},r=>{t.attempts+=1;var n=this.retryAlgorithm(t.event,t.attempts,r);t.attempts,t.event.getId(),-1===n?(xe.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,r)):setTimeout(this.processQueue,n,e)})):this.disableQueue(e)})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map(function(e){return e.event}):null}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return U(this.queues[t],t=>t.event.getId()===e.getId()&&(r=!0,!0)),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:r,attempts:0}),e.getId(),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),xe.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){var r;for(xe.info("clearing queue '%s'",e);r=this.removeNextEvent(e);)r.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}class Ma{constructor(e,t){var n=this;this.client=e,this.logger=t,o(this,"sending",!1),o(this,"running",!0),o(this,"retryTimeout",null),o(this,"retryAttempts",0),o(this,"sendQueue",r(function*(){if(null!==n.retryTimeout&&clearTimeout(n.retryTimeout),n.retryTimeout=null,!n.sending&&n.running){var e;n.logger.debug("Attempting to send queued to-device messages"),n.sending=!0;try{for(;n.running&&null!==(e=yield n.client.store.getOldestToDeviceBatch());)yield n.sendBatch(e),yield n.client.store.removeToDeviceBatch(e.id),n.retryAttempts=0;if(!n.running)return;n.logger.debug("All queued to-device messages sent")}catch(r){++n.retryAttempts;var t=Oa.RETRY_BACKOFF_RATELIMIT(null,n.retryAttempts,r);if(-1===t)return void(4===Math.floor(r.httpStatus/100)?(n.logger.error("Fatal error when sending to-device message - dropping to-device batch!",r),yield n.client.store.removeToDeviceBatch(e.id)):n.logger.info("Automatic retry limit reached for to-device messages."));n.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(t,"ms"),r),n.retryTimeout=setTimeout(n.sendQueue,t)}finally{n.sending=!1}}})),o(this,"onResumedSync",(e,t)=>{e===Bi.Syncing&&t!==Bi.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(kd.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(kd.Sync,this.onResumedSync)}queueBatch(e){var t=this;return r(function*(){for(var r=[],n=0;n<e.batch.length;n+=20){var i={eventType:e.eventType,batch:e.batch.slice(n,n+20),txnId:t.client.makeTxnId()};r.push(i);var o=i.batch.map(e=>"".concat(e.userId,"/").concat(e.deviceId," (msgid ").concat(e.payload[$e],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(i.txnId),o)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return r(function*(){var r=new _e(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}var Pa=new Er.UnstableValue("m.policies","org.matrix.msc3847.policies"),Da=new Er.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),Aa=function(e){return e.Ban="m.ban",e}({}),xa=function(e){return e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server",e}({}),Ua={[xa.User]:Ve.PolicyRuleUser,[xa.Room]:Ve.PolicyRuleRoom,[xa.Server]:Ve.PolicyRuleServer};class La{constructor(e){this.client=e}addRule(e,t,n){var i=this;return r(function*(){var r=yield i.getOrCreateTargetRoom();return(yield i.client.sendStateEvent(r.roomId,Ua[e],{entity:t,reason:n,recommendation:Aa.Ban})).event_id})()}removeRule(e){var t=this;return r(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return r(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(e=>e.roomId);return!r.includes(e)&&(r.push(e),yield t.withIgnoreInvitesPolicies(e=>{e.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return r(function*(){var{sender:r,roomId:n}=e,i=yield t.getOrCreateSourceRooms(),o=r.split(":")[1],s=n.split(":")[1];for(var a of i){var c=a.getUnfilteredTimelineSet().getLiveTimeline().getState(Tr.FORWARDS);for(var{scope:l,entities:d}of[{scope:xa.Room,entities:[n]},{scope:xa.User,entities:[r]},{scope:xa.Server,entities:[o,s]}]){var u=c.getStateEvents(Ua[l]);for(var h of u){var g=h.getContent();if((null==g?void 0:g.recommendation)==Aa.Ban){var p=null==g?void 0:g.entity;if(p){var v=void 0;try{v=new RegExp(G(p))}catch(e){continue}for(var m of d)if(m&&v.test(m))return h}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return r(function*(){var t=e.getIgnoreInvitesPolicies().target;if("string"!=typeof t&&(t=null),t){var r=e.client.getRoom(t);if(r)return r;t=null}return t=(yield e.client.createRoom({name:"Individual Policy Room",preset:Xs.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(e=>{e.target=t}),e.client.getRoom(t)})()}getOrCreateSourceRooms(){var e=this;return r(function*(){var t=e.getIgnoreInvitesPolicies().sources,r=!1;Array.isArray(t)||(r=!0,t=[]);var n=t.filter(e=>"string"==typeof e).map(t=>e.client.getRoom(t)).filter(e=>!!e);(n.length!=t.length&&(r=!0),0==n.length)&&(r=!0,n=[yield e.getOrCreateTargetRoom()]);return r&&(yield e.withIgnoreInvitesPolicies(e=>{e.sources=t})),n})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return r(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[Da.name]=n,yield t.client.setAccountData(Pa.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Pa.name,Pa.altName]){var r;if(t){var n=null===(r=this.client.getAccountData(t))||void 0===r?void 0:r.getContent();if(n){e=n;break}}}var i={},o=!1;for(var s of[Da.name,Da.altName])if(s){var a=e[s];if(a&&"object"==typeof a){i=a,o=!0;break}}return o||(e[Da.name]=i),{policies:e,ignoreInvitesPolicies:i}}}var Na="matrix-js-sdk",Fa=function(e){return e.Change="change",e}({}),ja=function(e){return e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done",e}({}),Ba=function(e){return e.Cancel="cancel",e.ShowSas="show_sas",e.ShowReciprocateQr="show_reciprocate_qr",e}({});var Ka=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");const t=new Uint8Array(256);for(let e=0;e<t.length;e++)t[e]=255;for(let r=0;r<e.length;r++){const n=e.charAt(r),i=n.charCodeAt(0);if(255!==t[i])throw new TypeError(n+" is ambiguous");t[i]=r}const r=e.length,n=e.charAt(0),i=Math.log(r)/Math.log(256),o=Math.log(256)/Math.log(r);function s(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;let o=0,s=0,a=0;for(;e[o]===n;)s++,o++;const c=(e.length-o)*i+1>>>0,l=new Uint8Array(c);for(;o<e.length;){const n=e.charCodeAt(o);if(n>255)return;let i=t[n];if(255===i)return;let s=0;for(let e=c-1;(0!==i||s<a)&&-1!==e;e--,s++)i+=r*l[e]>>>0,l[e]=i%256>>>0,i=i/256>>>0;if(0!==i)throw new Error("Non-zero carry");a=s,o++}let d=c-a;for(;d!==c&&0===l[d];)d++;const u=new Uint8Array(s+(c-d));let h=s;for(;d!==c;)u[h++]=l[d++];return u}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";let i=0,s=0,a=0;const c=t.length;for(;a!==c&&0===t[a];)a++,i++;const l=(c-a)*o+1>>>0,d=new Uint8Array(l);for(;a!==c;){let e=t[a],n=0;for(let t=l-1;(0!==e||n<s)&&-1!==t;t--,n++)e+=256*d[t]>>>0,d[t]=e%r>>>0,e=e/r>>>0;if(0!==e)throw new Error("Non-zero carry");s=n,a++}let u=l-s;for(;u!==l&&0===d[u];)u++;let h=n.repeat(i);for(;u<l;++u)h+=e.charAt(d[u]);return h},decodeUnsafe:s,decode:function(e){const t=s(e);if(t)return t;throw new Error("Non-base"+r+" character")}}}("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),qa=[139,1];function Va(e){var t,r=new Uint8Array(qa.length+e.length+1);r.set(qa,0),r.set(e,qa.length);for(var n=0,i=0;i<r.length-1;++i)n^=r[i];return r[r.length-1]=n,null===(t=Ka.encode(r).match(/.{1,4}/g))||void 0===t?void 0:t.join(" ")}function Wa(e,t,r){return Ga.apply(this,arguments)}function Ga(){return Ga=r(function*(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:256;if(!globalThis.crypto.subtle||!TextEncoder)throw new Error("Password-based backup is not available on this platform");var i=yield globalThis.crypto.subtle.importKey("raw",(new TextEncoder).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),o=yield globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:(new TextEncoder).encode(t),iterations:r,hash:"SHA-512"},i,n);return new Uint8Array(o)}),Ga.apply(this,arguments)}var Ha=function(e){return e.UserTrustStatusChanged="userTrustStatusChanged",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",e.VerificationRequestReceived="crypto.verificationRequestReceived",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged",e.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",e.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",e.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",e.RehydrationStarted="dehydration.RehydrationStarted",e.RehydrationProgress="dehydration.RehydrationProgress",e.RehydrationCompleted="dehydration.RehydrationCompleted",e.RehydrationError="dehydration.RehydrationError",e.DehydrationKeyCached="dehydration.DehydrationKeyCached",e.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",e}({}),za=function(e){return e.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",e.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",e.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",e.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",e.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",e.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",e.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",e.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",e.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",e.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",e.UNKNOWN_ERROR="UNKNOWN_ERROR",e}({}),$a=function(e){return e[e.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",e[e.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",e}({});class Ja{constructor(e){this.errorOnVerifiedUserProblems=e,o(this,"kind",$a.AllDevicesIsolationMode)}}class Ya{constructor(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,o(this,"needsUserApproval",void 0),this.needsUserApproval=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class Qa{constructor(e){var t,r,n,i,s;o(this,"signedByOwner",void 0),o(this,"crossSigningVerified",void 0),o(this,"tofu",void 0),o(this,"localVerified",void 0),o(this,"trustCrossSignedDevices",void 0),this.signedByOwner=null!==(t=e.signedByOwner)&&void 0!==t&&t,this.crossSigningVerified=null!==(r=e.crossSigningVerified)&&void 0!==r&&r,this.tofu=null!==(n=e.tofu)&&void 0!==n&&n,this.localVerified=null!==(i=e.localVerified)&&void 0!==i&&i,this.trustCrossSignedDevices=null!==(s=e.trustCrossSignedDevices)&&void 0!==s&&s}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var Xa=function(e){return e.Fetch="fetch",e.LoadKeys="load_keys",e}({}),Za=function(e){return e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing",e}({}),ec=function(e){return e[e.NONE=0]="NONE",e[e.GREY=1]="GREY",e[e.RED=2]="RED",e}({}),tc=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",e[e.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",e[e.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",e[e.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",e[e.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",e[e.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",e[e.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",e[e.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",e}({}),rc=new Uint8Array(8);function nc(e,t){return ic.apply(this,arguments)}function ic(){return(ic=r(function*(e,t){var r=yield globalThis.crypto.subtle.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:rc,info:(new TextEncoder).encode(t),hash:"SHA-256"},r,512),i=n.slice(0,32),o=n.slice(32),s=globalThis.crypto.subtle.importKey("raw",i,{name:"AES-CTR"},!1,["encrypt","decrypt"]),a=globalThis.crypto.subtle.importKey("raw",o,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,a])})).apply(this,arguments)}function oc(e,t,r,n){return sc.apply(this,arguments)}function sc(){return(sc=r(function*(e,t,r,n){var i;n?i=fo(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var[o,s]=yield nc(t,r),a=(new TextEncoder).encode(e),c=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},o,a),l=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,c);return{iv:vo(i),ciphertext:vo(new Uint8Array(c)),mac:vo(new Uint8Array(l))}})).apply(this,arguments)}function ac(e,t,r){return cc.apply(this,arguments)}function cc(){return(cc=r(function*(e,t,r){var[n,i]=yield nc(t,r),o=fo(e.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},i,fo(e.mac),o)))throw new Error("Error decrypting secret ".concat(r,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:fo(e.iv),length:64},n,o);return(new TextDecoder).decode(new Uint8Array(s))})).apply(this,arguments)}var lc="m.secret_storage.v1.aes-hmac-sha2";class dc{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return r(function*(){var t,r=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return r&&null!==(t=r.key)&&void 0!==t?t:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=r=>{if("m.secret_storage.default_key"===r.getType()){var i=r.getContent();(null===e?0===Object.keys(i).length:i.key===e)&&(this.accountDataAdapter.removeListener(kd.AccountData,n),t())}};this.accountDataAdapter.on(kd.AccountData,n);var i=null===e?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",i).catch(e=>{this.accountDataAdapter.removeListener(kd.AccountData,n),r(e)})})}addKey(e,t,n){var i=this;return r(function*(){if(e!==lc)throw new Error("Unknown key algorithm ".concat(e));var r={algorithm:e};t.name&&(r.name=t.name),t.passphrase&&(r.passphrase=t.passphrase);var{iv:o,mac:s}=yield gc(t.key);if(r.iv=o,r.mac=s,!n)do{n=yo(32)}while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(n)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(n),r),{keyId:n,keyInfo:r}})()}getKey(e){var t=this;return r(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return r?[e,r]:null})()}hasKey(e){var t=this;return r(function*(){var r=yield t.getKey(e);return Boolean(r)})()}checkKey(e,t){return r(function*(){if(t.algorithm===lc){if(t.mac){var{mac:r}=yield gc(e,t.iv);return uc(t.mac)===uc(r)}return!0}throw new Error("Unknown algorithm")})()}store(e,t,n){var i=this;return r(function*(){if(null!==t){var r={};if(!n){var o=yield i.getDefaultKeyId();if(!o)throw new Error("No keys specified and no default key present");n=[o]}if(0===n.length)throw new Error("Zero keys given to encrypt with!");for(var s of n){var a=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(s));if(!a)throw new Error("Unknown key: "+s);if(a.algorithm===lc){var c={[s]:a},[,l]=yield i.getSecretStorageKey(c,e);r[s]=yield l.encrypt(t)}else xe.warn("unknown algorithm for secret storage key "+s+": "+a.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:r})}else yield i.accountDataAdapter.setAccountData(e,{})})()}get(e){var t=this;return r(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i)),s=r.encrypted[i];(null==o?void 0:o.algorithm)===lc&&s.iv&&s.ciphertext&&s.mac&&(n[i]=o)}if(0===Object.keys(n).length)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[a,c]=yield t.getSecretStorageKey(n,e),l=r.encrypted[a];return c.decrypt(l)}})()}isStored(e){var t=this;return r(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(null==r||!r.encrypted)return null;var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i));if(o){var s=r.encrypted[i];o.algorithm===lc&&s.iv&&s.ciphertext&&s.mac&&(n[i]=o)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var n=this;return r(function*(){if(!n.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var r=yield n.callbacks.getSecretStorageKey({keys:e},t);if(!r)throw new Error("getSecretStorageKey callback returned falsey");if(r.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[i,o]=r;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===lc)return[i,{encrypt:function(e){return oc(e,o,t)},decrypt:function(e){return ac(e,o,t)}}];throw new Error("Unknown key type: "+e[i].algorithm)})()}}function uc(e){for(var t=e.length;t>=1&&61==e.charCodeAt(t-1);)t--;return t<e.length?e.substring(0,t):e}var hc="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function gc(e,t){return oc(hc,e,"",t)}var pc=Object.freeze({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:lc,ServerSideSecretStorageImpl:dc,calculateKeyCheck:gc,trimTrailingEquals:uc}),vc=e=>"livekit"===e.type&&"focus_selection"in e,mc=144e5;class _c{static equal(e,t){return F(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,o(this,"membershipData",void 0);var r=[];if(!((e,t)=>{var r,n="Malformed session membership event: ";return"string"!=typeof e.device_id&&t.push(n+"device_id must be string"),"string"!=typeof e.call_id&&t.push(n+"call_id must be string"),"string"!=typeof e.application&&t.push(n+"application must be a string"),"string"!=typeof(null===(r=e.focus_active)||void 0===r?void 0:r.type)&&t.push(n+"focus_active.type must be a string"),Array.isArray(e.foci_preferred)||t.push(n+"foci_preferred must be an array"),void 0!==e.created_ts&&"number"!=typeof e.created_ts&&t.push(n+"created_ts must be number"),void 0!==e.scope&&"string"!=typeof e.scope&&t.push(n+"scope must be string"),void 0!==e["m.call.intent"]&&"string"!=typeof e["m.call.intent"]&&t.push(n+"m.call.intent must be a string"),0===t.length})(t,r))throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(r.join(" & "),") events this could be a legacy membership event: (").concat(t,")"));this.membershipData=t}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get callIntent(){return this.membershipData["m.call.intent"]}get sessionDescription(){return{application:this.membershipData.application,id:this.membershipData.call_id}}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return null!==(e=this.membershipData.created_ts)&&void 0!==e?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+(null!==(e=this.membershipData.expires)&&void 0!==e?e:mc)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(vc(e))return e.focus_selection}}var fc=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({}),yc=function(e){return e.TooNew="TOO_NEW",e}({});class bc extends Error{constructor(e){super("Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again"),this.reason=e,this.name="InvalidCryptoStoreError"}}o(bc,"TOO_NEW",yc.TooNew);class wc extends Error{constructor(e,t){super(e),this.value=t}}class Sc extends Error{constructor(){super("MatrixClient has been stopped")}}class Ec extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}var Rc=function(e){return e.Disconnected="Disconnected",e.Connecting="Connecting",e.ConnectingFailed="ConnectingFailed",e.Connected="Connected",e.Reconnecting="Reconnecting",e.Disconnecting="Disconnecting",e.Stuck="Stuck",e.Unknown="Unknown",e}({}),Ic=(e,t,r)=>e.sender===t&&e.deviceId===r;class kc{constructor(e,t){this.membershipLoopHandler=e,o(this,"logger",void 0),o(this,"running",!1),o(this,"wakeup",e=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),o(this,"_actions",[]),this.logger=(null!=t?t:xe).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return r(function*(){if(e.running)e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");else{e.running=!0,e._actions=[{ts:Date.now(),type:Oc.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((e,t)=>e.ts-t.ts);var t=e._actions[0],r=void 0,n=new Promise(t=>{e.wakeup=e=>{r=e,t()}});t.ts>Date.now()&&(yield Promise.race([n,z(t.ts-Date.now())]));var i={};if(!r){e.logger.debug("Current MembershipManager processing: ".concat(t.type,"\nQueue:"),e._actions,'\nDate.now: "'.concat(Date.now()));try{i=yield e.membershipLoopHandler(t.type)}catch(e){throw Error("The MembershipManager shut down because of the end condition: ".concat(e))}}e._actions.splice(0,1);var o=null!=r?r:i;"replace"in o?e._actions=o.replace:"insert"in o&&e._actions.push(...o.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")}})()}initiateJoin(){var e;null===(e=this.wakeup)||void 0===e||e.call(this,{replace:[{ts:Date.now(),type:Oc.SendDelayedEvent}]})}initiateLeave(){var e;null===(e=this.wakeup)||void 0===e||e.call(this,{replace:[{ts:Date.now(),type:Oc.SendScheduledDelayedLeaveEvent}]})}}var Tc=function(e){return e.StatusChanged="StatusChanged",e.ProbablyLeft="ProbablyLeft",e}({});function Cc(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}var Oc=function(e){return e.SendDelayedEvent="SendDelayedEvent",e.SendJoinEvent="SendJoinEvent",e.RestartDelayedEvent="RestartDelayedEvent",e.UpdateExpiry="UpdateExpiry",e.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",e.SendLeaveEvent="SendLeaveEvent",e}({});class Mc extends qe{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,r){this.scheduler.running?this.logger.error("MembershipManager is already running. Ignoring join request."):(this.fociPreferred=e,this.focusActive=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=Mc.defaultState,this.scheduler.startWithJoin().catch(e=>{this.logger.error("MembershipManager stopped because: ",e),null==r||r(e)}).finally(()=>{var e;(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(Tc.StatusChanged,this.oldStatus,this.status),this.scheduler.running)||(null===(e=this.leavePromiseResolvers)||void 0===e||e.resolve(!0),this.leavePromiseResolvers=void 0)}))}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var e;return null===(e=this.leavePromiseResolvers)||void 0===e?void 0:e.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){if(!this.isActivated())return Promise.resolve();var t=this.client.getUserId(),r=this.client.getDeviceId();if(!t||!r)return this.logger.error("MembershipManager.onRTCSessionMemberUpdate called without user or device id"),Promise.resolve();if(this._ownMembership=e.find(e=>Ic(e,t,r)),!this._ownMembership){var n=[Oc.SendDelayedEvent,Oc.SendJoinEvent];this.logger.warn("Missing own membership: force re-join"),this.state.hasMemberStateEvent=!1,this.scheduler.actions.some(e=>n.includes(e.type))?this.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",this.scheduler.actions):this.scheduler.initiateJoin()}return Promise.resolve()}getActiveFocus(){if(!this.focusActive){var e=this.getOldestMembership();return null==e?void 0:e.getPreferredFoci()[0]}if(vc(this.focusActive)){if("oldest_membership"===this.focusActive.focus_selection){var t=this.getOldestMembership();return null==t?void 0:t.getPreferredFoci()[0]}}else this.logger.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.")}updateCallIntent(e){var t=this;return r(function*(){if(!t.activated||!t.ownMembership)throw Error("You cannot update your intent before joining the call");t.ownMembership.callIntent!==e&&(t.callIntent=e,yield t.sendJoinEvent())})()}constructor(e,t,r,n,i,s){super(),this.joinConfig=e,this.room=t,this.client=r,this.getOldestMembership=n,this.sessionDescription=i,o(this,"activated",!1),o(this,"logger",void 0),o(this,"callIntent",void 0),o(this,"leavePromiseResolvers",void 0),o(this,"_ownMembership",void 0),o(this,"oldStatus",void 0),o(this,"scheduler",void 0),o(this,"state",void 0),o(this,"deviceId",void 0),o(this,"stateKey",void 0),o(this,"fociPreferred",void 0),o(this,"focusActive",void 0),o(this,"delayedLeaveEventDelayMsOverride",void 0),this.logger=(null!=s?s:xe).getChild("[MembershipManager]");var[a,c]=[this.client.getUserId(),this.client.getDeviceId()];if(null===a)throw Error("Missing userId in client");if(null===c)throw Error("Missing deviceId in client");this.deviceId=c,this.stateKey=this.makeMembershipStateKey(a,c),this.state=Mc.defaultState,this.callIntent=null==e?void 0:e.callIntent,this.scheduler=new kc(e=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(Tc.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(e)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1,probablyLeft:!1}}get networkErrorRetryMs(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.networkErrorRetryMs)&&void 0!==e?e:3e3}get membershipEventExpiryMs(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.membershipEventExpiryMs)&&void 0!==e?e:mc}get membershipEventExpiryHeadroomMs(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.membershipEventExpiryHeadroomMs)&&void 0!==e?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+this.membershipEventExpiryMs*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,r;return null!==(e=null!==(t=this.delayedLeaveEventDelayMsOverride)&&void 0!==t?t:null===(r=this.joinConfig)||void 0===r?void 0:r.delayedLeaveEventDelayMs)&&void 0!==e?e:8e3}get delayedLeaveEventRestartMs(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.delayedLeaveEventRestartMs)&&void 0!==e?e:5e3}get maximumRateLimitRetryCount(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.maximumRateLimitRetryCount)&&void 0!==e?e:10}get maximumNetworkErrorRetryCount(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.maximumNetworkErrorRetryCount)&&void 0!==e?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)&&void 0!==e?e:2e3}membershipLoopHandler(e){var t=this;return r(function*(){switch(e){case Oc.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Oc.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):Pc(Oc.SendDelayedEvent);case Oc.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):Pc(Oc.SendLeaveEvent):{replace:[]};case Oc.SendJoinEvent:return t.sendJoinEvent();case Oc.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Oc.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return r(function*(){return yield e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},Ve.GroupCallMemberPrefix,{},e.stateKey).then(t=>(e.state.expectedServerDelayLeaveTs=Date.now()+e.delayedLeaveEventDelayMs,e.setAndEmitProbablyLeft(!1),e.resetRateLimitCounter(Oc.SendDelayedEvent),e.state.delayId=t.delay_id,e.state.hasMemberStateEvent?Pc(Oc.RestartDelayedEvent,e.delayedLeaveEventRestartMs):Pc(Oc.SendJoinEvent))).catch(t=>{var r=Oc.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return Pc(r);var n=e.actionUpdateFromErrors(t,r,"sendDelayedStateEvent");if(n)return n;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),Pc(Oc.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return r(function*(){return yield t.client._unstable_updateDelayedEvent(e,fc.Cancel).then(()=>(t.state.delayId=void 0,t.resetRateLimitCounter(Oc.SendDelayedEvent),Dc(Oc.SendDelayedEvent))).catch(e=>{var r=Oc.SendDelayedEvent,n=t.actionUpdateFromErrors(e,r,"updateDelayedEvent");if(n)return n;if(t.isNotFoundError(e))return t.state.delayId=void 0,Dc(r);if(t.isUnsupportedDelayedEndpoint(e))return Dc(Oc.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}setAndEmitProbablyLeft(e){this.state.probablyLeft!==e&&(this.state.probablyLeft=e,this.emit(Tc.ProbablyLeft,this.state.probablyLeft))}restartDelayedEvent(e){var t=this;return r(function*(){var r=t.state.expectedServerDelayLeaveTs?t.state.expectedServerDelayLeaveTs-Date.now():void 0,n=new Promise((e,n)=>{setTimeout(()=>{n(new v("Restart delayed event timed out before the HS responded"))},void 0===r||t.state.probablyLeft?t.delayedLeaveEventRestartLocalTimeoutMs:Math.min(t.delayedLeaveEventRestartLocalTimeoutMs,r))});return yield Promise.race([t.client._unstable_updateDelayedEvent(e,fc.Restart),n]).then(()=>(t.state.expectedServerDelayLeaveTs=Date.now()+t.delayedLeaveEventDelayMs,t.resetRateLimitCounter(Oc.RestartDelayedEvent),t.setAndEmitProbablyLeft(!1),Pc(Oc.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(e=>{t.state.expectedServerDelayLeaveTs&&t.state.expectedServerDelayLeaveTs<=Date.now()&&t.setAndEmitProbablyLeft(!0);var r=Oc.RestartDelayedEvent;if(t.isNotFoundError(e))return t.state.delayId=void 0,Pc(Oc.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(e))return{};var n=t.actionUpdateFromErrors(e,r,"updateDelayedEvent");if(n)return n;throw Error("Could not restart delayed event, even though delayed events are supported. "+e)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return r(function*(){return yield t.client._unstable_updateDelayedEvent(e,fc.Send).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(Oc.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(e=>{var r=Oc.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(e))return{};if(t.isNotFoundError(e))return t.state.delayId=void 0,Pc(r);var n=t.actionUpdateFromErrors(e,r,"updateDelayedEvent");return n||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",e),Pc(r))})})()}sendJoinEvent(){var e=this;return r(function*(){return yield e.client.sendStateEvent(e.room.roomId,Ve.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs),e.stateKey).then(()=>(e.setAndEmitProbablyLeft(!1),e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Oc.SendJoinEvent),{replace:[...e.scheduler.actions.filter(e=>e.type!==Oc.UpdateExpiry&&e.type!==Oc.SendJoinEvent),{ts:Date.now(),type:Oc.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Oc.UpdateExpiry}]})).catch(t=>{var r=e.actionUpdateFromErrors(t,Oc.SendJoinEvent,"sendStateEvent");if(r)return r;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return r(function*(){var t=e.state.expireUpdateIterations+1;return yield e.client.sendStateEvent(e.room.roomId,Ve.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs*t),e.stateKey).then(()=>(e.resetRateLimitCounter(Oc.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Oc.UpdateExpiry}]})).catch(t=>{var r=e.actionUpdateFromErrors(t,Oc.UpdateExpiry,"sendStateEvent");if(r)return r;throw t})})()}sendFallbackLeaveEvent(){var e=this;return r(function*(){return yield e.client.sendStateEvent(e.room.roomId,Ve.GroupCallMemberPrefix,{},e.stateKey).then(()=>(e.resetRateLimitCounter(Oc.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var r=e.actionUpdateFromErrors(t,Oc.SendLeaveEvent,"sendStateEvent");if(r)return r;throw t})})()}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t,"_").concat(this.sessionDescription.application).concat(this.sessionDescription.id);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}makeMyMembership(e){var t,r,n=!!this.ownMembership;return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Cc(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Cc(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({application:this.sessionDescription.application,call_id:this.sessionDescription.id,scope:"m.room",device_id:this.deviceId,expires:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:null!==(t=this.fociPreferred)&&void 0!==t?t:[],"m.call.intent":this.callIntent},n?{created_ts:null===(r=this.ownMembership)||void 0===r?void 0:r.createdTs()}:void 0)}isNotFoundError(e){return e instanceof Vn&&"M_NOT_FOUND"===e.errcode}manageMaxDelayExceededSituation(e){if(e instanceof Vn&&"M_UNKNOWN"===e.errcode&&"M_MAX_DELAY_EXCEEDED"===e.data["org.matrix.msc4140.errcode"]){var t=e.data["org.matrix.msc4140.max_delay"];return"number"==typeof t&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,r){var n=this.actionUpdateFromRateLimitError(e,r,t);if(n)return n;var i=this.actionUpdateFromNetworkErrorRetry(e,t);return i||void 0}actionUpdateFromRateLimitError(e,t,r){var n;if((e instanceof qn||e instanceof Vn)&&e.isRateLimitError()){var i=null!==(n=this.state.rateLimitRetries.get(r))&&void 0!==n?n:0;if(i<this.maximumRateLimitRetryCount){var o,s=5e3;try{var a;o=null!==(a=e.getRetryAfterMs())&&void 0!==a?a:s,this.logger.info("Rate limited by server, retrying in ".concat(o,"ms"))}catch(e){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(s),e),o=s}return this.state.rateLimitRetries.set(r,i+1),Pc(r,o)}throw Error("Exceeded maximum retries for "+r+" attempts (client."+t+"): "+e)}}actionUpdateFromNetworkErrorRetry(e,t){var r,n=null!==(r=this.state.networkErrorRetries.get(t))&&void 0!==r?r:0,i=this.networkErrorRetryMs/1e3+"s",o="("+n+"/"+this.maximumNetworkErrorRetryCount+")",s=this.networkErrorRetryMs;if(e instanceof Error&&"AbortError"===e.name)s=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+o+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+i+" "+o,e);else if(e instanceof Gn)this.logger.warn("Network connection error while sending event, retrying in "+i+" "+o,e);else{if(!((e instanceof qn||e instanceof Vn)&&"number"==typeof e.httpStatus&&e.httpStatus>=500&&e.httpStatus<600))return;this.logger.warn("Server error while sending event, retrying in "+i+" "+o,e)}if(n<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,n+1),Pc(t,s);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof Ec}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(1===e.length){var{type:t}=e[0];switch(t){case Oc.SendDelayedEvent:case Oc.SendJoinEvent:return Rc.Connecting;case Oc.UpdateExpiry:return Rc.Connected;case Oc.SendScheduledDelayedLeaveEvent:case Oc.SendLeaveEvent:return Rc.Disconnecting}}else if(2===e.length){var r=e.map(e=>e.type);if((r.includes(Oc.RestartDelayedEvent)||r.includes(Oc.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&r.includes(Oc.UpdateExpiry))return Rc.Connected}else if(3===e.length){var n=e.map(e=>e.type);if(2===n.filter(e=>e===Oc.RestartDelayedEvent).length&&n.includes(Oc.UpdateExpiry))return Rc.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Rc.Unknown):Rc.Disconnected}get probablyLeft(){return this.state.probablyLeft}}function Pc(e,t){return{insert:[{ts:Date.now()+(null!=t?t:0),type:e}]}}function Dc(e,t){return{replace:[{ts:Date.now()+0,type:e}]}}var Ac=function(e){return e.ReceivedKeys="received_keys",e.NotSupportedError="not_supported_error",e}({});class xc{constructor(){o(this,"tsBuffer",new Map)}isOutdated(e,t){var r;this.tsBuffer.has(e)||this.tsBuffer.set(e,new Map);var n=null===(r=this.tsBuffer.get(e))||void 0===r?void 0:r.get(t.keyIndex);return!!(n&&n>t.creationTS)||(this.tsBuffer.get(e).set(t.keyIndex,t.creationTS),!1)}}function Uc(e,t){return"".concat(e,":").concat(t)}class Lc extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class Nc extends qe{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,r,n,i,s){super(),this.userId=e,this.deviceId=t,this.roomId=r,this.client=n,this.statistics=i,o(this,"logger",xe),o(this,"onToDeviceEvent",e=>{if(e.getType()===Ve.CallEncryptionKeysPrefix){var t=this.getValidEventContent(e);t&&e.getSender()&&this.receiveCallKeyEvent(e.getSender(),t)}}),this.setParentLogger(null!=s?s:xe)}start(){this.client.on(kd.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(kd.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,n){var i=this;return r(function*(){var r={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.deviceId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},o=n.map(e=>({userId:e.userId,deviceId:e.deviceId})).filter(e=>!(e.userId==i.userId&&e.deviceId==i.deviceId));o.length>0?(yield i.client.encryptAndSendToDevice(Ve.CallEncryptionKeysPrefix,o,r).catch(e=>{var t=e.message;if(t.includes("unknown variant")&&t.includes("send_to_device")||t.includes("not supported"))throw new Lc("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var r=Date.now(),n=r-("number"==typeof t.sent_ts?t.sent_ts:r);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=n,this.emit(Ac.ReceivedKeys,e,t.member.claimed_device_id,t.keys.key,t.keys.index,r)}getValidEventContent(e){var t=e.getContent(),r=t.room_id;if(r)if(r===this.roomId)if(t.keys&&t.keys.key&&"number"==typeof t.keys.index){if(t.member&&t.member.claimed_device_id)return t;this.logger.warn("Malformed Event: Missing claimed_device_id")}else this.logger.warn("Malformed Event: Missing keys field");else this.logger.warn("Malformed Event: Mismatch roomId");else this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId")}}var Fc=function(e){return e.EnabledTransportsChanged="enabled_transports_changed",e}({});class jc extends qe{constructor(e,t,r){var n;super(),n=this,this.toDeviceTransport=e,this.roomKeyTransport=t,o(this,"logger",void 0),o(this,"_enabled",{toDevice:!0,room:!1}),this.logger=(null!=r?r:xe).getChild("[RoomAndToDeviceTransport]"),this.toDeviceTransport.setParentLogger(this.logger),this.roomKeyTransport.setParentLogger(this.logger),this.roomKeyTransport.on(Ac.ReceivedKeys,function(){n._enabled.room||(n.logger.debug("Received room key, enabling room key transport, disabling toDevice transport"),n.setEnabled({toDevice:!1,room:!0}));for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];n.emit(Ac.ReceivedKeys,...t)}),this.toDeviceTransport.on(Ac.ReceivedKeys,function(){if(n._enabled.toDevice){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];n.emit(Ac.ReceivedKeys,...t)}else n.logger.debug("To Device transport is disabled, ignoring received keys")})}setEnabled(e){this.enabled.toDevice===e.toDevice&&this.enabled.room===e.room||(this._enabled=e,this.emit(Fc.EnabledTransportsChanged,e))}get enabled(){return this._enabled}start(){this.roomKeyTransport.start(),this.toDeviceTransport.start()}stop(){this.roomKeyTransport.stop(),this.toDeviceTransport.stop()}sendKey(e,t,n){var i=this;return r(function*(){if(i.logger.debug("Sending key with index ".concat(t," to call members (count=").concat(n.length,") via:")+(i._enabled.room?"room transport":"")+(i._enabled.room&&i._enabled.toDevice?"and":"")+(i._enabled.toDevice?"to device transport":"")),i._enabled.room&&(yield i.roomKeyTransport.sendKey(e,t,n)),i._enabled.toDevice)try{yield i.toDeviceTransport.sendKey(e,t,n)}catch(r){r instanceof Lc&&!i._enabled.room&&(i.logger.warn("To device is not supported enabling room key transport, disabling toDevice transport"),i.setEnabled({toDevice:!1,room:!0}),yield i.sendKey(e,t,n))}})()}}class Bc{get updateEncryptionKeyThrottle(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.updateEncryptionKeyThrottle)&&void 0!==e?e:3e3}get makeKeyDelay(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.makeKeyDelay)&&void 0!==e?e:3e3}get useKeyDelay(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.useKeyDelay)&&void 0!==e?e:5e3}constructor(e,t,n,i,s,a,c){var l=this;this.userId=e,this.deviceId=t,this.getMemberships=n,this.transport=i,this.statistics=s,this.onEncryptionKeysChanged=a,o(this,"manageMediaKeys",!1),o(this,"keysEventUpdateTimeout",void 0),o(this,"makeNewKeyTimeout",void 0),o(this,"setNewKeyTimeouts",new Set),o(this,"encryptionKeys",new Map),o(this,"lastEncryptionKeyUpdateRequest",void 0),o(this,"lastMembershipFingerprints",void 0),o(this,"latestGeneratedKeyIndex",-1),o(this,"joinConfig",void 0),o(this,"logger",void 0),o(this,"joined",!1),o(this,"sendEncryptionKeysEvent",function(){var e=r(function*(e){if(void 0!==l.keysEventUpdateTimeout&&(clearTimeout(l.keysEventUpdateTimeout),l.keysEventUpdateTimeout=void 0),l.lastEncryptionKeyUpdateRequest=Date.now(),l.joined){var t=l.getKeysForParticipant(l.userId,l.deviceId);if(t)if("number"==typeof e||-1!==l.latestGeneratedKeyIndex){var r=null!=e?e:l.latestGeneratedKeyIndex;l.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(r," (method parameter: ").concat(e,")"));var n=t[r];try{l.statistics.counters.roomEventEncryptionKeysSent+=1;var i=l.getMemberships().filter(e=>null!=e.sender).map(e=>({userId:e.sender,deviceId:e.deviceId,membershipTs:e.createdTs()}));yield l.transport.sendKey(mo(n),r,i),l.logger.debug("sendEncryptionKeysEvent participantId=".concat(l.userId,":").concat(l.deviceId," numKeys=").concat(t.length," currentKeyIndex=").concat(l.latestGeneratedKeyIndex," keyIndexToSend=").concat(r))}catch(e){if(void 0===l.keysEventUpdateTimeout){var o=Wn(e,5e3);l.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(o),e),l.keysEventUpdateTimeout=setTimeout(()=>{l.sendEncryptionKeysEvent()},o)}else l.logger.info("Not scheduling key resend as another re-send is already pending")}}else l.logger.warn("Tried to send encryption keys event but no current key index found!");else l.logger.warn("Tried to send encryption keys event but no keys found!")}});return function(t){return e.apply(this,arguments)}}()),o(this,"onTransportChanged",()=>{this.requestSendCurrentKey()}),o(this,"onNewKeyReceived",(e,t,r,n,i)=>{this.logger.debug("Received key over key transport ".concat(e,":").concat(t," at index ").concat(n)),this.setEncryptionKey(e,t,n,r,i)}),o(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var e=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(e)}}),this.logger=(null!=c?c:xe).getChild("[EncryptionManager]")}getEncryptionKeys(){var e=new Map;for(var[t,r]of this.encryptionKeys){var n=r.map((e,t)=>({key:e.key,keyIndex:t}));e.set(t,n)}return e}join(e){var t,r,n;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=null!==(t=null===(r=this.joinConfig)||void 0===r?void 0:r.manageMediaKeys)&&void 0!==t?t:this.manageMediaKeys,this.transport.on(Ac.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof jc&&this.transport.on(Fc.EnabledTransportsChanged,this.onTransportChanged),this.transport.start(),null!==(n=this.joinConfig)&&void 0!==n&&n.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){for(var e of(this.encryptionKeys.set(Uc(this.userId,this.deviceId),[]),this.transport.off(Ac.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0),this.setNewKeyTimeouts))clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(e=>!Ic(e,this.userId,this.deviceId)).map(Kc)),r=new Set(this.getMemberships().filter(e=>!Ic(e,this.userId,this.deviceId)).map(Kc)),n=Array.from(t).some(e=>!r.has(e)),i=Array.from(r).some(e=>!t.has(e)),o=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),n)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(i)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(o){var s=this.lastMembershipFingerprints;(Array.from(o).some(e=>!s.has(e))||Array.from(s).some(e=>!o.has(e)))&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=(e=new Uint8Array(16),globalThis.crypto.getRandomValues(e),_o(e)),n=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+n),this.setEncryptionKey(this.userId,this.deviceId,n,r,Date.now(),t),n}requestSendCurrentKey(){if(this.manageMediaKeys)return this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()?(this.logger.info("Last encryption key event sent too recently: postponing"),void(void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(()=>{this.sendEncryptionKeysEvent()},this.updateEncryptionKeyThrottle)))):void this.sendEncryptionKeysEvent()}getKeysForParticipant(e,t){var r;return null===(r=this.encryptionKeys.get(Uc(e,t)))||void 0===r?void 0:r.map(e=>e.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!Ic(e,this.userId,this.deviceId)).map(e=>"".concat(Kc(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return-1===this.latestGeneratedKeyIndex?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,r,n,i){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this.logger.debug("Setting encryption key for ".concat(e,":").concat(t," at index ").concat(r));var s=fo(n),a=Uc(e,t);this.encryptionKeys.has(a)||this.encryptionKeys.set(a,[]);var c,l,d=this.encryptionKeys.get(a),u=d[r];if(u){if(u.timestamp>i)return void this.logger.info("Ignoring new key at index ".concat(r," for ").concat(a," as it is older than existing known key"));if((c=u.key)===(l=s)||c&&l&&c.length===l.length&&c.every((e,t)=>e===l[t]))return void(u.timestamp=i)}if(e===this.userId&&t===this.deviceId&&(this.latestGeneratedKeyIndex=r),d[r]={key:s,timestamp:i},o){var h=setTimeout(()=>{this.setNewKeyTimeouts.delete(h),this.logger.info("Delayed-emitting key changed event for ".concat(a," index ").concat(r)),this.onEncryptionKeysChanged(s,r,a)},this.useKeyDelay);this.setNewKeyTimeouts.add(h)}else this.onEncryptionKeysChanged(s,r,a)}}var Kc=e=>Uc(e.sender,e.deviceId);class qc extends qe{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,r,n){super(),this.room=e,this.client=t,this.statistics=r,o(this,"logger",xe),this.setParentLogger(null!=n?n:xe)}start(){this.room.on(Oi.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}stop(){this.room.off(Oi.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}consumeCallEncryptionEvent(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]&&t[1];if(yield n.client.decryptEventIfNeeded(e),!e.isDecryptionFailure())return r&&n.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry")),e.getType()!==Ve.CallEncryptionKeysPrefix?Promise.resolve():n.room?void n.onEncryptionEvent(e):(n.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve());r?n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(n.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>{n.consumeCallEncryptionEvent(e,!0)},1e3))})()}sendKey(e,t,n){var i=this;return r(function*(){var r={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,Ve.CallEncryptionKeysPrefix,r)}catch(e){i.logger.error("Failed to send call encryption keys",e);var n=e;throw n.event&&i.client.cancelPendingEvent(n.event),e}})()}onEncryptionEvent(e){var t=e.getSender(),r=e.getContent(),n=r.device_id,i=r.call_id;if(t)if(""===i)if(Array.isArray(r.keys))if(t!==this.client.getUserId()||n!==this.client.getDeviceId()){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var o=Date.now()-("number"==typeof r.sent_ts?r.sent_ts:e.getTs());for(var s of(this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=o,r.keys))if(s){var a=s.key,c=s.index;a&&null!=c&&null!=i&&"string"==typeof n&&"string"==typeof i&&"string"==typeof a&&"number"==typeof c?(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(c," age=").concat(o,"ms")),this.emit(Ac.ReceivedKeys,t,n,a,c,e.getTs())):this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(c," callId=").concat(i))}else this.logger.info("Ignoring false-y key in keys event")}else this.logger.info("Ignoring our own keys event");else this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(i));else this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(i));else this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(i))}}class Vc{constructor(e,t,r,n,i,s,a){this.userId=e,this.deviceId=t,this.getMemberships=r,this.transport=n,this.statistics=i,this.onEncryptionKeysChanged=s,o(this,"manageMediaKeys",!1),o(this,"participantKeyRings",new Map),o(this,"outboundSession",null),o(this,"currentKeyDistributionPromise",null),o(this,"useKeyDelay",5e3),o(this,"keyRotationGracePeriodMs",1e4),o(this,"needToEnsureKeyAgain",!1),o(this,"keyBuffer",new xc),o(this,"logger",void 0),o(this,"onTransportChanged",()=>{var e;null===(e=this.logger)||void 0===e||e.info("Transport change detected, restarting key distribution"),this.currentKeyDistributionPromise?this.currentKeyDistributionPromise.then(()=>{this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}).catch(e=>{var t;null===(t=this.logger)||void 0===t||t.error("Failed to restart key distribution",e)}):this.outboundSession&&(this.outboundSession.sharedWith=[],this.ensureKeyDistribution())}),o(this,"onNewKeyReceived",(e,t,r,n,i)=>{var o;if(this.manageMediaKeys){null===(o=this.logger)||void 0===o||o.debug("Received key over transport ".concat(e,":").concat(t," at index ").concat(n));var s,a=Uc(e,t),c={key:fo(r),participantId:a,keyIndex:n,creationTS:i};if(this.keyBuffer.isOutdated(a,c))null===(s=this.logger)||void 0===s||s.info("Received an out of order key for ".concat(e,":").concat(t,", dropping it"));else this.addKeyToParticipant(c.key,c.keyIndex,c.participantId),this.statistics.counters.roomEventEncryptionKeysReceived+=1}else{var l;null===(l=this.logger)||void 0===l||l.warn("Received key over transport ".concat(e,":").concat(t," at index ").concat(n," but media keys are disabled"))}}),this.logger=null==a?void 0:a.getChild("[EncryptionManager]")}getEncryptionKeys(){return new Map(this.participantKeyRings)}addKeyToParticipant(e,t,r){this.participantKeyRings.has(r)||this.participantKeyRings.set(r,[]),this.participantKeyRings.get(r).push({key:e,keyIndex:t}),this.onEncryptionKeysChanged(e,t,r)}join(e){var t,r,n,i;this.manageMediaKeys=null===(t=null==e?void 0:e.manageMediaKeys)||void 0===t||t,null===(r=this.logger)||void 0===r||r.info("Joining room"),this.useKeyDelay=null!==(n=null==e?void 0:e.useKeyDelay)&&void 0!==n?n:1e3,this.keyRotationGracePeriodMs=null!==(i=null==e?void 0:e.keyRotationGracePeriodMs)&&void 0!==i?i:1e4,this.transport.on(Ac.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof jc&&this.transport.on(Fc.EnabledTransportsChanged,this.onTransportChanged),this.transport.start()}leave(){this.transport.off(Ac.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){var e,t;this.manageMediaKeys&&(null==this.currentKeyDistributionPromise?(null===(e=this.logger)||void 0===e||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var e,t;(null===(e=this.logger)||void 0===e||e.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain)&&(null===(t=this.logger)||void 0===t||t.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution())})):(null===(t=this.logger)||void 0===t||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0))}onMembershipsUpdate(){var e;null===(e=this.logger)||void 0===e||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution()}rolloutOutboundKey(){var e=this;return r(function*(){var t,r;null==e.outboundSession&&(e.outboundSession={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0},e.addKeyToParticipant(e.outboundSession.key,e.outboundSession.keyId,Uc(e.userId,e.deviceId)));var n,i=e.getMemberships().filter(e=>null!=e.sender).map(e=>({userId:e.sender,deviceId:e.deviceId,membershipTs:e.createdTs()})),o=null!==(t=null===(r=e.outboundSession)||void 0===r?void 0:r.sharedWith)&&void 0!==t?t:[],s=(o=o.filter(e=>!i.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs!=t.membershipTs))).filter(e=>!i.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs==t.membershipTs)),a=i.filter(e=>!o.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs==t.membershipTs)),c=[],l=!1;if(s.length>0){var d=e.createNewOutboundSession();l=!0,c=i,n=d}else{if(!(a.length>0))return;var u=Date.now()-e.outboundSession.creationTS;if(u<e.keyRotationGracePeriodMs){var h;null===(h=e.logger)||void 0===h||h.debug("New joiners detected, but the key is recent enough (age:".concat(u,"), keeping it")),c=a,n=e.outboundSession}else{var g;null===(g=e.logger)||void 0===g||g.debug("New joiners detected, rotating the key");var p=e.createNewOutboundSession();l=!0,c=i,n=p}}try{var v,m,_,f;if(null===(v=e.logger)||void 0===v||v.trace("Sending key..."),yield e.transport.sendKey(vo(n.key),n.keyId,c),e.statistics.counters.roomEventEncryptionKeysSent+=1,n.sharedWith.push(...c),null===(m=e.logger)||void 0===m||m.trace("key index:".concat(n.keyId," sent to ").concat(n.sharedWith.map(e=>"".concat(e.userId,":").concat(e.deviceId)).join(","))),l)null===(_=e.logger)||void 0===_||_.trace("Delay Rollout for key:".concat(n.keyId,"...")),yield z(e.useKeyDelay),null===(f=e.logger)||void 0===f||f.trace("...Delayed rollout of index:".concat(n.keyId," ")),e.addKeyToParticipant(n.key,n.keyId,Uc(e.userId,e.deviceId))}catch(t){var y;null===(y=e.logger)||void 0===y||y.error("Failed to rollout key",t)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return null===(e=this.logger)||void 0===e||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}function Wc(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Gc(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Wc(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Wc(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var Hc=function(e){return e.MembershipsChanged="memberships_changed",e.JoinStateChanged="join_state_changed",e.EncryptionKeyChanged="encryption_key_changed",e.MembershipManagerError="membership_manager_error",e.DidSendCallNotification="did_send_call_notification",e}({});class zc extends qe{get membershipStatus(){var e;return null===(e=this.membershipManager)||void 0===e?void 0:e.status}get probablyLeft(){var e;return null===(e=this.membershipManager)||void 0===e?void 0:e.probablyLeft}get callId(){return this._callId}static callMembershipsForRoom(e){return zc.sessionMembershipsForRoom(e,{id:"",application:"m.call"})}static sessionMembershipsForRoom(e,t){var r=xe.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),n=e.getLiveTimeline().getState(Tr.FORWARDS);if(!n)throw r.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var i=n.getStateEvents(Ve.GroupCallMemberPrefix),o=[];for(var s of i){var a=s.getContent(),c=Object.keys(a).length;if(0!==c){var l=[];if(c>1&&"focus_active"in a?l.push(a):1===c&&"memberships"in a&&r.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),0!==l.length)for(var d of l)try{var u,h=new _c(s,d);if(!F(h.sessionDescription,t)){r.info("Ignoring membership of user ".concat(h.sender," for a different session:  ").concat(JSON.stringify(h.sessionDescription)));continue}if(h.isExpired()){r.info("Ignoring expired device membership ".concat(h.sender,"/").concat(h.deviceId));continue}if(!e.hasMembershipState(null!==(u=h.sender)&&void 0!==u?u:"",lt.Join)){r.info("Ignoring membership of user ".concat(h.sender," who is not in the room."));continue}o.push(h)}catch(e){r.warn("Couldn't construct call membership: ",e)}}}return o.sort((e,t)=>e.createdTs()-t.createdTs()),o.length>1&&r.debug("Call memberships in room ".concat(e.roomId,", in order: "),o.map(e=>[e.createdTs(),e.sender])),o}static roomSessionForRoom(e,t){var r=zc.sessionMembershipsForRoom(t,{id:"",application:"m.call"});return new zc(e,t,r,{id:"",application:"m.call"})}static sessionForRoom(e,t,r){var n=zc.sessionMembershipsForRoom(t,r);return new zc(e,t,n,r)}get room(){return this.roomSubset}constructor(e,t,r,n){var i;super(),this.client=e,this.roomSubset=t,this.memberships=r,this.sessionDescription=n,o(this,"membershipManager",void 0),o(this,"encryptionManager",void 0),o(this,"_callId",void 0),o(this,"joinConfig",void 0),o(this,"logger",void 0),o(this,"pendingNotificationToSend",void 0),o(this,"expiryTimeout",void 0),o(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),o(this,"reEmitter",new Nr(this)),o(this,"onRoomMemberUpdate",()=>{this.recalculateSessionMembers()}),o(this,"onRTCSessionMemberUpdate",()=>{this.recalculateSessionMembers()}),o(this,"recalculateSessionMembers",()=>{var e,t,r,n=this.memberships;this.memberships=zc.sessionMembershipsForRoom(this.room,this.sessionDescription),this._callId=null!==(e=this._callId)&&void 0!==e?e:null===(t=this.memberships[0])||void 0===t?void 0:t.sessionDescription.id;var i=n.length!=this.memberships.length||n.some((e,t)=>!_c.equal(e,this.memberships[t]));if(i){var o,s;this.logger.info("Memberships for call in room ".concat(this.roomSubset.roomId," have changed: emitting (").concat(this.memberships.length," members)")),function(e,t,r){var n=Date.now();try{return r()}finally{var i=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(i-n,"ms"))}}(this.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{this.emit(Hc.MembershipsChanged,n,this.memberships)}),null===(o=this.membershipManager)||void 0===o||o.onRTCSessionMemberUpdate(this.memberships);var a,c=null===(s=this.membershipManager)||void 0===s?void 0:s.ownMembership;if(this.pendingNotificationToSend&&c&&0===n.length)c.eventId&&null!==(a=this.joinConfig)&&void 0!==a&&a.notificationType?this.sendCallNotify(c.eventId,this.joinConfig.notificationType,c.callIntent):this.logger.warn("Own membership eventId is undefined, cannot send call notification");this.memberships.length>0&&(this.pendingNotificationToSend=void 0)}null===(r=this.encryptionManager)||void 0===r||r.onMembershipsUpdate(n),this.setExpiryTimer()}),this.logger=xe.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this._callId=null===(i=r[0])||void 0===i?void 0:i.sessionDescription.id;var s=this.roomSubset.getLiveTimeline().getState(Tr.FORWARDS);null==s||s.on(Zd.Members,this.onRoomMemberUpdate),this.setExpiryTimer()}isJoined(){var e,t;return null!==(e=null===(t=this.membershipManager)||void 0===t?void 0:t.isJoined())&&void 0!==e&&e}stop(){var e=this;return r(function*(){var t;yield null===(t=e.membershipManager)||void 0===t?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var r=e.roomSubset.getLiveTimeline().getState(Tr.FORWARDS);null==r||r.off(Zd.Members,e.onRoomMemberUpdate)})()}joinRoomSession(e,t,r){var n;if(this.isJoined())this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));else{var i;if(this.membershipManager=new Mc(r,this.roomSubset,this.client,()=>this.getOldestMembership(),this.sessionDescription,this.logger),this.reEmitter.reEmit(this.membershipManager,[Tc.ProbablyLeft,Tc.StatusChanged]),null!=r&&r.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[o,s]=[this.client.getUserId(),this.client.getDeviceId()],[a,c,l]=[this.roomSubset,this.client,this.statistics],d=new qc(a,c,l),u=new Nc(o,s,a.roomId,c,l);i=new jc(u,d,this.logger),this.reEmitter.reEmit(i,[Fc.EnabledTransportsChanged]),this.encryptionManager=new Vc(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,i,this.statistics,(e,t,r)=>{this.emit(Hc.EncryptionKeyChanged,e,t,r)},this.logger)}else i=new qc(this.roomSubset,this.client,this.statistics),this.encryptionManager=new Bc(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,i,this.statistics,(e,t,r)=>{this.emit(Hc.EncryptionKeyChanged,e,t,r)});this.joinConfig=r,this.pendingNotificationToSend=null===(n=this.joinConfig)||void 0===n?void 0:n.notificationType,this.membershipManager.join(e,t,e=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",e),this.emit(Hc.MembershipManagerError,e),this.emit(Hc.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(r),this.emit(Hc.JoinStateChanged,!0)}}leaveRoomSession(){var e=arguments,t=this;return r(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var n=t.membershipManager.leave(r);return t.emit(Hc.JoinStateChanged,!1),yield n})()}getActiveFocus(){var e;return null===(e=this.membershipManager)||void 0===e?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getConsensusCallIntent(){var e,t=null===(e=this.memberships.find(e=>!!e.callIntent))||void 0===e?void 0:e.callIntent;if(t)return this.memberships.every(e=>!e.callIntent||e.callIntent===t)?t:void 0}updateCallIntent(e){var t=this;return r(function*(){var r,n;if(!(null===(r=t.membershipManager)||void 0===r?void 0:r.ownMembership))throw Error("Not connected yet");yield null===(n=t.membershipManager)||void 0===n?void 0:n.updateCallIntent(e)})()}getFocusInUse(){var e=this.getOldestMembership();if("oldest_membership"===(null==e?void 0:e.getFocusSelection()))return e.getPreferredFoci()[0]}reemitEncryptionKeys(){var e;null===(e=this.encryptionManager)||void 0===e||e.getEncryptionKeys().forEach((e,t)=>{e.forEach(e=>{this.emit(Hc.EncryptionKeyChanged,e.key,e.keyIndex,t)})})}setExpiryTimer(){var e;for(var t of(this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberships)){var r=t.getMsUntilExpiry();void 0!==r&&(void 0===e||r<e)&&(e=r)}null!=e&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}sendCallNotify(e,t,n){var i=this,o=function(){var e=r(function*(){var e={application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:"notification"===t?"notify":t,call_id:i.callId};return{response:yield i.client.sendEvent(i.roomSubset.roomId,Ve.CallNotify,e),content:e}});return function(){return e.apply(this,arguments)}}(),s=function(){var o=r(function*(){var r={"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:We.Reference},sender_ts:Date.now(),lifetime:3e4};return n&&(r["m.call.intent"]=n),{response:yield i.client.sendEvent(i.roomSubset.roomId,Ve.RTCNotification,r),content:r}});return function(){return o.apply(this,arguments)}}();Promise.all([o(),s()]).then(e=>{var[t,r]=e,n=Gc(Gc({},t.response),t.content),i=Gc(Gc({},r.response),r.content);this.emit(Hc.DidSendCallNotification,i,n)}).catch(e=>{var[t,r]=e;return this.logger.error("Failed to send call notification",t,r)})}}var $c=function(e){return e.SessionStarted="session_started",e.SessionEnded="session_ended",e}({});class Jc extends qe{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{id:"",application:"m.call"};super(),this.client=t,this.sessionDescription=r,o(this,"roomSessions",new Map),o(this,"logger",void 0),o(this,"onRoom",e=>{this.refreshRoom(e)}),o(this,"onRoomState",(e,t)=>{var r=this.client.getRoom(e.getRoomId());r?e.getType()==Ve.GroupCallMemberPrefix&&this.refreshRoom(r):this.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!"))}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of null!==(t=this.client.getRooms())&&void 0!==t?t:[]){var t,r=zc.sessionForRoom(this.client,e,this.sessionDescription);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(kd.Room,this.onRoom),this.client.on(Zd.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(kd.Room,this.onRoom),this.client.off(Zd.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,zc.sessionForRoom(this.client,e,this.sessionDescription)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onRTCSessionMemberUpdate();var i=r.memberships.length>0;n&&!i?(this.logger.trace("Session ended for ".concat(e.roomId," (").concat(r.memberships.length," members)")),this.emit($c.SessionEnded,e.roomId,this.roomSessions.get(e.roomId))):!n&&i&&(this.logger.trace("Session started for ".concat(e.roomId," (").concat(r.memberships.length," members)")),this.emit($c.SessionStarted,e.roomId,this.roomSessions.get(e.roomId)))}}function Yc(e){return t=>{var r,n;return(null===(r=t.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r.event_id)!==e||(null===(n=t.content)||void 0===n||null===(n=n["m.relates_to"])||void 0===n?void 0:n.rel_type)===qd.name}}function Qc(e){return Xc.apply(this,arguments)}function Xc(){return(Xc=r(function*(e){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var t=(new TextEncoder).encode(e),r=yield globalThis.crypto.subtle.digest("SHA-256",t);return new Uint8Array(r)})).apply(this,arguments)}class Zc extends Error{}function el(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(e){return decodeURIComponent(atob(e).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}(t)}catch(e){return atob(t)}}function tl(e,t){if("string"!=typeof e)throw new Zc("Invalid token specified: must be a string");t||(t={});const r=!0===t.header?0:1,n=e.split(".")[r];if("string"!=typeof n)throw new Zc(`Invalid token specified: missing part #${r+1}`);let i;try{i=el(n)}catch(e){throw new Zc(`Invalid token specified: invalid base64 for part #${r+1} (${e.message})`)}try{return JSON.parse(i)}catch(e){throw new Zc(`Invalid token specified: invalid json for part #${r+1} (${e.message})`)}}Zc.prototype.name="InvalidTokenError";var rl,nl,il,ol={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},sl=(e=>(e[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e))(sl||{});(il=sl||(sl={})).reset=function(){rl=3,nl=ol},il.setLevel=function(e){if(!(0<=e&&e<=4))throw new Error("Invalid log level");rl=e},il.setLogger=function(e){nl=e};var al=class e{constructor(e){this._name=e}debug(...t){rl>=4&&nl.debug(e._format(this._name,this._method),...t)}info(...t){rl>=3&&nl.info(e._format(this._name,this._method),...t)}warn(...t){rl>=2&&nl.warn(e._format(this._name,this._method),...t)}error(...t){rl>=1&&nl.error(e._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(t,r){const n=new e(`${t}.${r}`);return n.debug("begin"),n}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(t,...r){rl>=4&&nl.debug(e._format(t),...r)}static info(t,...r){rl>=3&&nl.info(e._format(t),...r)}static warn(t,...r){rl>=2&&nl.warn(e._format(t),...r)}static error(t,...r){rl>=1&&nl.error(e._format(t),...r)}};sl.reset();var cl=class{static decode(e){try{return tl(e)}catch(e){throw al.error("JwtUtils.decode",e),e}}static async generateSignedJwt(e,t,r){const n=`${ul.encodeBase64Url((new TextEncoder).encode(JSON.stringify(e)))}.${ul.encodeBase64Url((new TextEncoder).encode(JSON.stringify(t)))}`,i=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},r,(new TextEncoder).encode(n));return`${n}.${ul.encodeBase64Url(new Uint8Array(i))}`}},ll=e=>btoa([...new Uint8Array(e)].map(e=>String.fromCharCode(e)).join("")),dl=class e{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(+t^e._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return e.generateUUIDv4()+e.generateUUIDv4()+e.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return ll(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){throw al.error("CryptoUtils.generateCodeChallenge",e),e}}static generateBasicAuth(e,t){const r=(new TextEncoder).encode([e,t].join(":"));return ll(r)}static async hash(e,t){const r=(new TextEncoder).encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(t){let r;switch(t.kty){case"RSA":r={e:t.e,kty:t.kty,n:t.n};break;case"EC":r={crv:t.crv,kty:t.kty,x:t.x,y:t.y};break;case"OKP":r={crv:t.crv,kty:t.kty,x:t.x};break;case"oct":r={crv:t.k,kty:t.kty};break;default:throw new Error("Unknown jwk type")}const n=await e.hash("SHA-256",JSON.stringify(r));return e.encodeBase64Url(n)}static async generateDPoPProof({url:t,accessToken:r,httpMethod:n,keyPair:i,nonce:o}){let s,a;const c={jti:window.crypto.randomUUID(),htm:null!=n?n:"GET",htu:t,iat:Math.floor(Date.now()/1e3)};r&&(s=await e.hash("SHA-256",r),a=e.encodeBase64Url(s),c.ath=a),o&&(c.nonce=o);try{const e=await crypto.subtle.exportKey("jwk",i.publicKey),t={alg:"ES256",typ:"dpop+jwt",jwk:{crv:e.crv,kty:e.kty,x:e.x,y:e.y}};return await cl.generateSignedJwt(t,c,i.privateKey)}catch(e){throw e instanceof TypeError?new Error(`Error exporting dpop public key: ${e.message}`):e}}static async generateDPoPJkt(t){try{const r=await crypto.subtle.exportKey("jwk",t.publicKey);return await e.customCalculateJwkThumbprint(r)}catch(e){throw e instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${e.message}`):e}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};dl.encodeBase64Url=e=>ll(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var ul=dl,hl=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new al(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},gl=class e extends hl{constructor(){super(...arguments),this._logger=new al(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const t=this._expiration-e.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=e.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){const r=this._logger.create("init");t=Math.max(Math.floor(t),1);const n=e.getEpochTime()+t;if(this.expiration===n&&this._timerHandle)return void r.debug("skipping since already initialized for expiration at",this.expiration);this.cancel(),r.debug("using duration",t),this._expiration=n;const i=Math.min(t,5);this._timerHandle=setInterval(this._callback,1e3*i)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},pl=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");const r=new URL(e,"http://127.0.0.1")["fragment"===t?"hash":"search"];return new URLSearchParams(r.slice(1))}},vl=";",ml=class extends Error{constructor(e,t){var r,n,i;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw al.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=null!=(r=e.error_description)?r:null,this.error_uri=null!=(n=e.error_uri)?n:null,this.state=e.userState,this.session_state=null!=(i=e.session_state)?i:null,this.url_state=e.url_state}},_l=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},fl=class{constructor(){this._logger=new al("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},yl=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},bl=class{constructor(e=[],t=null,r={}){this._jwtHandler=t,this._extraHeaders=r,this._logger=new al("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){const{timeoutInSeconds:r,...n}=t;if(!r)return await fetch(e,n);const i=new AbortController,o=setTimeout(()=>i.abort(),1e3*r);try{return await fetch(e,{...t,signal:i.signal})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw new _l("Network timed out");throw e}finally{clearTimeout(o)}}async getJson(e,{token:t,credentials:r,timeoutInSeconds:n}={}){const i=this._logger.create("getJson"),o={Accept:this._contentTypes.join(", ")};let s;t&&(i.debug("token passed, setting Authorization header"),o.Authorization="Bearer "+t),this._appendExtraHeaders(o);try{i.debug("url:",e),s=await this.fetchWithTimeout(e,{method:"GET",headers:o,timeoutInSeconds:n,credentials:r})}catch(e){throw i.error("Network Error"),e}i.debug("HTTP response received, status",s.status);const a=s.headers.get("Content-Type");if(a&&!this._contentTypes.find(e=>a.startsWith(e))&&i.throw(new Error(`Invalid response Content-Type: ${null!=a?a:"undefined"}, from URL: ${e}`)),s.ok&&this._jwtHandler&&(null==a?void 0:a.startsWith("application/jwt")))return await this._jwtHandler(await s.text());let c;try{c=await s.json()}catch(e){if(i.error("Error parsing JSON response",e),s.ok)throw e;throw new Error(`${s.statusText} (${s.status})`)}if(!s.ok){if(i.error("Error from server:",c),c.error)throw new ml(c);throw new Error(`${s.statusText} (${s.status}): ${JSON.stringify(c)}`)}return c}async postForm(e,{body:t,basicAuth:r,timeoutInSeconds:n,initCredentials:i,extraHeaders:o}){const s=this._logger.create("postForm"),a={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...o};let c;void 0!==r&&(a.Authorization="Basic "+r),this._appendExtraHeaders(a);try{s.debug("url:",e),c=await this.fetchWithTimeout(e,{method:"POST",headers:a,body:t,timeoutInSeconds:n,credentials:i})}catch(e){throw s.error("Network error"),e}s.debug("HTTP response received, status",c.status);const l=c.headers.get("Content-Type");if(l&&!this._contentTypes.find(e=>l.startsWith(e)))throw new Error(`Invalid response Content-Type: ${null!=l?l:"undefined"}, from URL: ${e}`);const d=await c.text();let u={};if(d)try{u=JSON.parse(d)}catch(e){if(s.error("Error parsing JSON response",e),c.ok)throw e;throw new Error(`${c.statusText} (${c.status})`)}if(!c.ok){if(s.error("Error from server:",u),c.headers.has("dpop-nonce")){const e=c.headers.get("dpop-nonce");throw new yl(e,`${JSON.stringify(u)}`)}if(u.error)throw new ml(u,t);throw new Error(`${c.statusText} (${c.status}): ${JSON.stringify(u)}`)}return u}_appendExtraHeaders(e){const t=this._logger.create("appendExtraHeaders"),r=Object.keys(this._extraHeaders),n=["accept","content-type"],i=["authorization"];0!==r.length&&r.forEach(r=>{if(n.includes(r.toLocaleLowerCase()))return void t.warn("Protected header could not be set",r,n);if(i.includes(r.toLocaleLowerCase())&&Object.keys(e).includes(r))return void t.warn("Header could not be overridden",r,i);const o="function"==typeof this._extraHeaders[r]?this._extraHeaders[r]():this._extraHeaders[r];o&&""!==o&&(e[r]=o)})}},wl=class{constructor(e){this._settings=e,this._logger=new al("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new bl(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);const t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},t,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){const r=this._logger.create(`_getMetadataProperty('${e}')`),n=await this.getMetadata();if(r.debug("resolved"),void 0===n[e]){if(!0===t)return void r.warn("Metadata does not contain optional property");r.throw(new Error("Metadata does not contain property "+e))}return n[e]}async getSigningKeys(){const e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;const t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);const r=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",r),!Array.isArray(r.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=r.keys,this._signingKeys}},Sl=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new al("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){this._logger.create(`get('${e}')`),e=this._prefix+e;return await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");const e=await this._store.length,t=[];for(let r=0;r<e;r++){const e=await this._store.key(r);e&&0===e.indexOf(this._prefix)&&t.push(e.substr(this._prefix.length))}return t}},El=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:n,metadataSeed:i,client_id:o,client_secret:s,response_type:a="code",scope:c="openid",redirect_uri:l,post_logout_redirect_uri:d,client_authentication:u="client_secret_post",prompt:h,display:g,max_age:p,ui_locales:v,acr_values:m,resource:_,response_mode:f,filterProtocolClaims:y=!0,loadUserInfo:b=!1,requestTimeoutInSeconds:w,staleStateAgeInSeconds:S=900,mergeClaimsStrategy:E={array:"replace"},disablePKCE:R=!1,stateStore:I,revokeTokenAdditionalContentTypes:k,fetchRequestCredentials:T,refreshTokenAllowedScope:C,extraQueryParams:O={},extraTokenParams:M={},extraHeaders:P={},dpop:D,omitScopeWhenRequesting:A=!1}){var x;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=r,this.metadataSeed=i,this.signingKeys=n,this.client_id=o,this.client_secret=s,this.response_type=a,this.scope=c,this.redirect_uri=l,this.post_logout_redirect_uri=d,this.client_authentication=u,this.prompt=h,this.display=g,this.max_age=p,this.ui_locales=v,this.acr_values=m,this.resource=_,this.response_mode=f,this.filterProtocolClaims=null==y||y,this.loadUserInfo=!!b,this.staleStateAgeInSeconds=S,this.mergeClaimsStrategy=E,this.omitScopeWhenRequesting=A,this.disablePKCE=!!R,this.revokeTokenAdditionalContentTypes=k,this.fetchRequestCredentials=T||"same-origin",this.requestTimeoutInSeconds=w,I)this.stateStore=I;else{const e="undefined"!=typeof window?window.localStorage:new fl;this.stateStore=new Sl({store:e})}if(this.refreshTokenAllowedScope=C,this.extraQueryParams=O,this.extraTokenParams=M,this.extraHeaders=P,this.dpop=D,this.dpop&&!(null==(x=this.dpop)?void 0:x.store))throw new Error("A DPoPStore is required when dpop is enabled")}},Rl=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new al("UserInfoService"),this._getClaimsFromJwt=async e=>{const t=this._logger.create("_getClaimsFromJwt");try{const r=cl.decode(e);return t.debug("JWT decoding successful"),r}catch(e){throw t.error("Error parsing JWT response"),e}},this._jsonService=new bl(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){const t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));const r=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",r);const n=await this._jsonService.getJson(r,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",n),n}},Il=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new al("TokenClient"),this._jsonService=new bl(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:r=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:i,...o}){const s=this._logger.create("exchangeCode");r||s.throw(new Error("A client_id is required")),t||s.throw(new Error("A redirect_uri is required")),o.code||s.throw(new Error("A code is required"));const a=new URLSearchParams({grant_type:e,redirect_uri:t});for(const[e,t]of Object.entries(o))null!=t&&a.set(e,t);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(null==n)throw s.throw(new Error("A client_secret is required")),null;c=ul.generateBasicAuth(r,n);break;case"client_secret_post":a.append("client_id",r),n&&a.append("client_secret",n)}const l=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,scope:n=this._settings.scope,...i}){const o=this._logger.create("exchangeCredentials");t||o.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:e});this._settings.omitScopeWhenRequesting||s.set("scope",n);for(const[e,t]of Object.entries(i))null!=t&&s.set(e,t);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(null==r)throw o.throw(new Error("A client_secret is required")),null;a=ul.generateBasicAuth(t,r);break;case"client_secret_post":s.append("client_id",t),r&&s.append("client_secret",r)}const c=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const l=await this._jsonService.postForm(c,{body:s,basicAuth:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),l}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:i,...o}){const s=this._logger.create("exchangeRefreshToken");t||s.throw(new Error("A client_id is required")),o.refresh_token||s.throw(new Error("A refresh_token is required"));const a=new URLSearchParams({grant_type:e});for(const[e,t]of Object.entries(o))Array.isArray(t)?t.forEach(t=>a.append(e,t)):null!=t&&a.set(e,t);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(null==r)throw s.throw(new Error("A client_secret is required")),null;c=ul.generateBasicAuth(t,r);break;case"client_secret_post":a.append("client_id",t),r&&a.append("client_secret",r)}const l=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async revoke(e){var t;const r=this._logger.create("revoke");e.token||r.throw(new Error("A token is required"));const n=await this._metadataService.getRevocationEndpoint(!1);r.debug(`got revocation endpoint, revoking ${null!=(t=e.token_type_hint)?t:"default token type"}`);const i=new URLSearchParams;for(const[t,r]of Object.entries(e))null!=r&&i.set(t,r);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),r.debug("got response")}},kl=class{constructor(e,t,r){this._settings=e,this._metadataService=t,this._claimsService=r,this._logger=new al("ResponseValidator"),this._userInfoService=new Rl(this._settings,this._metadataService),this._tokenClient=new Il(this._settings,this._metadataService)}async validateSigninResponse(e,t,r){const n=this._logger.create("validateSigninResponse");this._processSigninState(e,t),n.debug("state processed"),await this._processCode(e,t,r),n.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),n.debug("tokens validated"),await this._processClaims(e,null==t?void 0:t.skipUserInfo,e.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(e,t){const r=this._logger.create("validateCredentialsResponse"),n=e.isOpenId&&!!e.id_token;n&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t,n),r.debug("claims processed")}async validateRefreshResponse(e,t){const r=this._logger.create("validateRefreshResponse");e.userState=t.data,null!=e.session_state||(e.session_state=t.session_state),null!=e.scope||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),r.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);const n=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,n),r.debug("claims processed")}validateSignoutResponse(e,t){const r=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&r.throw(new Error("State does not match")),r.debug("state validated"),e.userState=t.data,e.error)throw r.warn("Response was error",e.error),new ml(e)}_processSigninState(e,t){const r=this._logger.create("_processSigninState");if(t.id!==e.state&&r.throw(new Error("State does not match")),t.client_id||r.throw(new Error("No client_id on state")),t.authority||r.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,null!=e.scope||(e.scope=t.scope),e.error)throw r.warn("Response was error",e.error),new ml(e);t.code_verifier&&!e.code&&r.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,r=!0){const n=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token)return void n.debug("not loading user info");n.debug("loading user info");const i=await this._userInfoService.getClaims(e.access_token);n.debug("user info claims received from user info endpoint"),r&&i.sub!==e.profile.sub&&n.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,r){const n=this._logger.create("_processCode");if(e.code){n.debug("Validating code");const i=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:r,...t.extraTokenParams});Object.assign(e,i)}else n.debug("No code to process")}_validateIdTokenAttributes(e,t){var r;const n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");const i=cl.decode(null!=(r=e.id_token)?r:"");if(i.sub||n.throw(new Error("ID Token is missing a subject claim")),t){const e=cl.decode(t);i.sub!==e.sub&&n.throw(new Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==e.auth_time&&n.throw(new Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==e.azp&&n.throw(new Error("azp in id_token does not match original azp")),!i.azp&&e.azp&&n.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=i}},Tl=class e{constructor(e){this.id=e.id||ul.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=gl.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new al("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return al.createStatic("State","fromStorageString"),Promise.resolve(new e(JSON.parse(t)))}static async clearStaleState(t,r){const n=al.createStatic("State","clearStaleState"),i=gl.getEpochTime()-r,o=await t.getAllKeys();n.debug("got keys",o);for(let r=0;r<o.length;r++){const s=o[r],a=await t.get(s);let c=!1;if(a)try{const t=await e.fromStorageString(a);n.debug("got item from key:",s,t.created),t.created<=i&&(c=!0)}catch(e){n.error("Error parsing state for key:",s,e),c=!0}else n.debug("no item in storage for key:",s),c=!0;c&&(n.debug("removed item for key:",s),t.remove(s))}}},Cl=class e extends Tl{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(t){const r=!0===t.code_verifier?ul.generateCodeVerifier():t.code_verifier||void 0,n=r?await ul.generateCodeChallenge(r):void 0;return new e({...t,code_verifier:r,code_challenge:n})}toStorageString(){return new al("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){al.createStatic("SigninState","fromStorageString");const r=JSON.parse(t);return e.create(r)}},Ol=class e{constructor(e){this.url=e.url,this.state=e.state}static async create({url:t,authority:r,client_id:n,redirect_uri:i,response_type:o,scope:s,state_data:a,response_mode:c,request_type:l,client_secret:d,nonce:u,url_state:h,resource:g,skipUserInfo:p,extraQueryParams:v,extraTokenParams:m,disablePKCE:_,dpopJkt:f,omitScopeWhenRequesting:y,...b}){if(!t)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!o)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!r)throw this._logger.error("create: No authority passed"),new Error("authority");const w=await Cl.create({data:a,request_type:l,url_state:h,code_verifier:!_,client_id:n,authority:r,redirect_uri:i,response_mode:c,client_secret:d,scope:s,extraTokenParams:m,skipUserInfo:p}),S=new URL(t);S.searchParams.append("client_id",n),S.searchParams.append("redirect_uri",i),S.searchParams.append("response_type",o),y||S.searchParams.append("scope",s),u&&S.searchParams.append("nonce",u),f&&S.searchParams.append("dpop_jkt",f);let E=w.id;if(h&&(E=`${E}${vl}${h}`),S.searchParams.append("state",E),w.code_challenge&&(S.searchParams.append("code_challenge",w.code_challenge),S.searchParams.append("code_challenge_method","S256")),g){(Array.isArray(g)?g:[g]).forEach(e=>S.searchParams.append("resource",e))}for(const[e,t]of Object.entries({response_mode:c,...b,...v}))null!=t&&S.searchParams.append(e,t.toString());return new e({url:S.href,state:w})}};Ol._logger=new al("SigninRequest");var Ml=Ol,Pl=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(vl);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(vl))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(void 0!==this.expires_at)return this.expires_at-gl.getEpochTime()}set expires_in(e){"string"==typeof e&&(e=Number(e)),void 0!==e&&e>=0&&(this.expires_at=Math.floor(e)+gl.getEpochTime())}get isOpenId(){var e;return(null==(e=this.scope)?void 0:e.split(" ").includes("openid"))||!!this.id_token}},Dl=class{constructor({url:e,state_data:t,id_token_hint:r,post_logout_redirect_uri:n,extraQueryParams:i,request_type:o,client_id:s,url_state:a}){if(this._logger=new al("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");const c=new URL(e);if(r&&c.searchParams.append("id_token_hint",r),s&&c.searchParams.append("client_id",s),n&&(c.searchParams.append("post_logout_redirect_uri",n),t||a)){this.state=new Tl({data:t,request_type:o,url_state:a});let e=this.state.id;a&&(e=`${e}${vl}${a}`),c.searchParams.append("state",e)}for(const[e,t]of Object.entries({...i}))null!=t&&c.searchParams.append(e,t.toString());this.url=c.href}},Al=class{constructor(e){if(this.state=e.get("state"),this.state){const e=decodeURIComponent(this.state).split(vl);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(vl))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},xl=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],Ul=["sub","iss","aud","exp","iat"],Ll=class{constructor(e){this._settings=e,this._logger=new al("ClaimsService")}filterProtocolClaims(e){const t={...e};if(this._settings.filterProtocolClaims){let e;e=Array.isArray(this._settings.filterProtocolClaims)?this._settings.filterProtocolClaims:xl;for(const r of e)Ul.includes(r)||delete t[r]}return t}mergeClaims(e,t){const r={...e};for(const[e,n]of Object.entries(t))if(r[e]!==n)if(Array.isArray(r[e])||Array.isArray(n))if("replace"==this._settings.mergeClaimsStrategy.array)r[e]=n;else{const t=Array.isArray(r[e])?r[e]:[r[e]];for(const e of Array.isArray(n)?n:[n])t.includes(e)||t.push(e);r[e]=t}else"object"==typeof r[e]&&"object"==typeof n?r[e]=this.mergeClaims(r[e],n):r[e]=n;return r}},Nl=class{constructor(e,t){this.keys=e,this.nonce=t}},Fl=class{constructor(e,t){this._logger=new al("OidcClient"),this.settings=e instanceof El?e:new El(e),this.metadataService=null!=t?t:new wl(this.settings),this._claimsService=new Ll(this.settings),this._validator=new kl(this.settings,this.metadataService,this._claimsService),this._tokenClient=new Il(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:r,request_type:n,id_token_hint:i,login_hint:o,skipUserInfo:s,nonce:a,url_state:c,response_type:l=this.settings.response_type,scope:d=this.settings.scope,redirect_uri:u=this.settings.redirect_uri,prompt:h=this.settings.prompt,display:g=this.settings.display,max_age:p=this.settings.max_age,ui_locales:v=this.settings.ui_locales,acr_values:m=this.settings.acr_values,resource:_=this.settings.resource,response_mode:f=this.settings.response_mode,extraQueryParams:y=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams,dpopJkt:w,omitScopeWhenRequesting:S=this.settings.omitScopeWhenRequesting}){const E=this._logger.create("createSigninRequest");if("code"!==l)throw new Error("Only the Authorization Code flow (with PKCE) is supported");const R=await this.metadataService.getAuthorizationEndpoint();E.debug("Received authorization endpoint",R);const I=await Ml.create({url:R,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:u,response_type:l,scope:d,state_data:e,url_state:c,prompt:h,display:g,max_age:p,ui_locales:v,id_token_hint:i,login_hint:o,acr_values:m,dpopJkt:w,resource:_,request:t,request_uri:r,extraQueryParams:y,extraTokenParams:b,request_type:n,response_mode:f,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:a,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:S});await this.clearStaleState();const k=I.state;return await this.settings.stateStore.set(k.id,k.toStorageString()),I}async readSigninResponseState(e,t=!1){const r=this._logger.create("readSigninResponseState"),n=new Pl(pl.readParams(e,this.settings.response_mode));if(!n.state)throw r.throw(new Error("No state in response")),null;const i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(new Error("No matching state found in storage")),null;return{state:await Cl.fromStorageString(i),response:n}}async processSigninResponse(e,t,r=!0){const n=this._logger.create("processSigninResponse"),{state:i,response:o}=await this.readSigninResponseState(e,r);if(n.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const e=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:e}}try{await this._validator.validateSigninResponse(o,i,t)}catch(e){if(!(e instanceof yl&&this.settings.dpop))throw e;{const r=await this.getDpopProof(this.settings.dpop.store,e.nonce);t.DPoP=r,await this._validator.validateSigninResponse(o,i,t)}}return o}async getDpopProof(e,t){let r,n;return(await e.getAllKeys()).includes(this.settings.client_id)?(n=await e.get(this.settings.client_id),n.nonce!==t&&t&&(n.nonce=t,await e.set(this.settings.client_id,n))):(r=await ul.generateDPoPKeys(),n=new Nl(r,t),await e.set(this.settings.client_id,n)),await ul.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:n.keys,nonce:n.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:r=!1,extraTokenParams:n={}}){const i=await this._tokenClient.exchangeCredentials({username:e,password:t,...n}),o=new Pl(new URLSearchParams);return Object.assign(o,i),await this._validator.validateCredentialsResponse(o,r),o}async useRefreshToken({state:e,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,extraTokenParams:o}){var s;const a=this._logger.create("useRefreshToken");let c,l;if(void 0===this.settings.refreshTokenAllowedScope)c=e.scope;else{const t=this.settings.refreshTokenAllowedScope.split(" ");c=((null==(s=e.scope)?void 0:s.split(" "))||[]).filter(e=>t.includes(e)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const e=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:e}}try{l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o})}catch(s){if(!(s instanceof yl&&this.settings.dpop))throw s;i.DPoP=await this.getDpopProof(this.settings.dpop.store,s.nonce),l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o})}const d=new Pl(new URLSearchParams);return Object.assign(d,l),a.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...e,scope:c}),d}async createSignoutRequest({state:e,id_token_hint:t,client_id:r,request_type:n,url_state:i,post_logout_redirect_uri:o=this.settings.post_logout_redirect_uri,extraQueryParams:s=this.settings.extraQueryParams}={}){const a=this._logger.create("createSignoutRequest"),c=await this.metadataService.getEndSessionEndpoint();if(!c)throw a.throw(new Error("No end session endpoint")),null;a.debug("Received end session endpoint",c),r||!o||t||(r=this.settings.client_id);const l=new Dl({url:c,id_token_hint:t,client_id:r,post_logout_redirect_uri:o,state_data:e,extraQueryParams:s,request_type:n,url_state:i});await this.clearStaleState();const d=l.state;return d&&(a.debug("Signout request has state to persist"),await this.settings.stateStore.set(d.id,d.toStorageString())),l}async readSignoutResponseState(e,t=!1){const r=this._logger.create("readSignoutResponseState"),n=new Al(pl.readParams(e,this.settings.response_mode));if(!n.state){if(r.debug("No state in response"),n.error)throw r.warn("Response was error:",n.error),new ml(n);return{state:void 0,response:n}}const i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(new Error("No matching state found in storage")),null;return{state:await Tl.fromStorageString(i),response:n}}async processSignoutResponse(e){const t=this._logger.create("processSignoutResponse"),{state:r,response:n}=await this.readSignoutResponseState(e,!0);return r?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,r)):t.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),Tl.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}},jl=function(e){return e.NotSupported="OIDC authentication not supported",e.Misconfigured="OIDC is misconfigured",e.General="Something went wrong with OIDC discovery",e.OpSupport="Configured OIDC OP does not support required functions",e.DynamicRegistrationNotSupported="Dynamic registration not supported",e.DynamicRegistrationFailed="Dynamic registration failed",e.DynamicRegistrationInvalid="Dynamic registration invalid response",e.CodeExchangeFailed="Failed to exchange code for token",e.InvalidBearerTokenResponse="Invalid bearer token response",e.InvalidIdToken="Invalid ID token",e.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",e}({}),Bl=e=>!!e&&"object"==typeof e&&!Array.isArray(e),Kl=(e,t)=>!(!e[t]||!ql(e,t))||(xe.error("Missing or invalid property: ".concat(t)),!1),ql=(e,t)=>!e[t]||"string"==typeof e[t]||(xe.error("Invalid property: ".concat(t)),!1),Vl=(e,t)=>!!(!e[t]||Array.isArray(e[t])&&e[t].every(e=>"string"==typeof e))||(xe.error("Invalid property: ".concat(t)),!1),Wl=(e,t,r)=>{var n=e[t];return!!(n&&Array.isArray(n)&&n.includes(r))||(xe.error("Invalid property: ".concat(t,". ").concat(r," is required.")),!1)},Gl=e=>{if(!Bl(e))throw xe.error("Issuer configuration not found or malformed"),new Error(jl.OpSupport);if(![Kl(e,"issuer"),Kl(e,"authorization_endpoint"),Kl(e,"token_endpoint"),Kl(e,"revocation_endpoint"),ql(e,"registration_endpoint"),ql(e,"account_management_uri"),ql(e,"device_authorization_endpoint"),Vl(e,"account_management_actions_supported"),Wl(e,"response_types_supported","code"),Wl(e,"grant_types_supported","authorization_code"),Wl(e,"code_challenge_methods_supported","S256"),Vl(e,"prompt_values_supported")].some(e=>!e))return e;throw xe.error("Issuer configuration not valid"),new Error(jl.OpSupport)},Hl=e=>{try{return tl(e)}catch(e){throw xe.error("Could not decode id_token",e),e}},zl=(e,t,r,n)=>{try{if(!e)throw new Error("No ID token");var i=Hl(e);if(i.iss!==t)throw new Error("Invalid issuer");if(!("string"==typeof i.aud?[i.aud]:i.aud).includes(r))throw new Error("Invalid audience");if(void 0!==n&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>1e3*i.exp)throw new Error("Invalid expiry")}catch(e){throw xe.error("Invalid ID token",e),new Error(jl.InvalidIdToken)}};function $l(e){if(!Bl(e))throw xe.error("Stored user state not found"),new Error(jl.MissingOrInvalidStoredState);if([Kl(e,"homeserverUrl"),Kl(e,"nonce"),ql(e,"identityServerUrl")].some(e=>!e))throw new Error(jl.MissingOrInvalidStoredState)}function Jl(e){if(!(e=>Bl(e)&&Kl(e,"token_type")&&"bearer"===e.token_type.toLowerCase()&&Kl(e,"access_token")&&Kl(e,"refresh_token")&&(!("expires_in"in e)||"number"==typeof e.expires_in))(e))throw new Error(jl.InvalidBearerTokenResponse)}function Yl(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ql(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Yl(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Yl(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var Xl=e=>{var t=null!=e?e:yo(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(t)},Zl=function(){var e=r(function*(e){return globalThis.crypto.subtle?_o(yield Qc(e)):(xe.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e)});return function(t){return e.apply(this,arguments)}}(),ed=e=>{var{redirectUri:t}=e;return{scope:Xl(),redirectUri:t,state:yo(8),nonce:yo(8),codeVerifier:yo(64)}},td=function(){var e=r(function*(e,t,r){var{scope:n,redirectUri:i,state:o,nonce:s,codeVerifier:a}=r,c=new URL(e);return c.searchParams.append("response_mode","query"),c.searchParams.append("response_type","code"),c.searchParams.append("redirect_uri",i),c.searchParams.append("client_id",t),c.searchParams.append("state",o),c.searchParams.append("scope",n),c.searchParams.append("nonce",s),c.searchParams.append("code_challenge_method","S256"),c.searchParams.append("code_challenge",yield Zl(a)),c.toString()});return function(t,r,n){return e.apply(this,arguments)}}(),rd=function(){var e=r(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:i,identityServerUrl:o,nonce:s,prompt:a,urlState:c,loginHint:l}=e,d=Xl(),u=new Fl(Ql(Ql({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:d,stateStore:new Sl({prefix:"mx_oidc_",store:window.sessionStorage})})),h={homeserverUrl:i,nonce:s,identityServerUrl:o};return(yield u.createSigninRequest({state:h,nonce:s,prompt:a,url_state:c,login_hint:l})).url});return function(t){return e.apply(this,arguments)}}(),nd=function(){var e=r(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),sl.setLogger(xe);try{var n=new Pl(r.searchParams),i=new Sl({prefix:"mx_oidc_",store:window.sessionStorage}),o=yield i.get(n.state);if(!o)throw new Error(jl.MissingOrInvalidStoredState);var s=yield Cl.fromStorageString(o),a=new Fl(Ql(Ql({},s),{},{stateStore:i})),c=yield a.processSigninResponse(r.href),l=c.userState;$l(l),Jl(c),zl(c.id_token,a.settings.authority,a.settings.client_id,l.nonce);var d=(e=>({id_token:e.id_token,scope:e.scope,expires_at:e.expires_at,refresh_token:e.refresh_token,access_token:e.access_token,token_type:"Bearer"}))(c);return{oidcClientSettings:{clientId:a.settings.client_id,issuer:a.settings.authority},tokenResponse:d,homeserverUrl:l.homeserverUrl,identityServerUrl:l.identityServerUrl,idTokenClaims:c.profile}}catch(e){xe.error("Oidc login failed",e);var u=e.message;if(Object.values(jl).includes(u))throw e;throw new Error(jl.CodeExchangeFailed)}});return function(t,r){return e.apply(this,arguments)}}();function id(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function od(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?id(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):id(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var sd=function(){var e=r(function*(e){var t=new URL(".well-known/openid-configuration",e),r=yield fetch(t,{method:jn.Get,signal:Xn(5e3)}),n=yield r.json();return ad(n)});return function(t){return e.apply(this,arguments)}}(),ad=function(){var e=r(function*(e){var t=Gl(e),r=new El({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),n=new wl(r);return od(od({},t),{},{signingKeys:yield n.getSigningKeys()})});return function(t){return e.apply(this,arguments)}}(),cd="urn:ietf:params:oauth:grant-type:device_code",ld=(e,t)=>{if(!t)return!1;var r=new URL(t);return r.protocol===e.protocol&&!(r.hostname!==e.hostname&&!r.hostname.endsWith(".".concat(e.hostname)))},dd=function(){var e=r(function*(e,t){if(!e.registration_endpoint)throw new Error(jl.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some(t=>!e.grant_types_supported.includes(t)))throw new Error(jl.DynamicRegistrationNotSupported);var n=new URL(t.clientUri),i={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:ld(n,t.logoUri)?t.logoUri:void 0,policy_uri:ld(n,t.policyUri)?t.policyUri:void 0,tos_uri:ld(n,t.tosUri)?t.tosUri:void 0};try{var o=yield fetch(e.registration_endpoint,{method:jn.Post,headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i)});if(o.status>=400)throw new Error(jl.DynamicRegistrationFailed);var s=(yield o.json()).client_id;if(!s||"string"!=typeof s)throw new Error(jl.DynamicRegistrationInvalid);return s}catch(e){throw Object.values(jl).includes(e.message)?e:(xe.error("Dynamic registration request failed",e),new Error(jl.DynamicRegistrationFailed))}});return function(t,r){return e.apply(this,arguments)}}();class ud{constructor(e,t,r,n,i){this.idTokenClaims=i,o(this,"oidcClientReady",void 0),o(this,"oidcClient",void 0),o(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,n,r)}initialiseOidcClient(e,t,n,i){var o=this;return r(function*(){try{var r,s=yield sd(e),a=Xl(n);o.oidcClient=new Fl({metadata:s,signingKeys:null!==(r=s.signingKeys)&&void 0!==r?r:void 0,client_id:t,scope:a,redirect_uri:i,authority:s.issuer,stateStore:new Sl({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(e){throw xe.error("Failed to initialise OIDC client.",e),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return r(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{return yield t.inflightRefreshRequest}catch(e){if(e instanceof ml)throw new zn(e);throw e}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return r(function*(){})()}getNewTokens(e){var t=this;return r(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=Date.now(),i=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),o={accessToken:i.access_token,refreshToken:i.refresh_token,expiry:i.expires_in?new Date(n+1e3*i.expires_in):void 0};return yield t.persistTokens(o),o})()}}var hd=["server","limit","since"];function gd(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function pd(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?gd(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):gd(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var vd=6e5,md=new w("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),_d=function(e){return e.Chronological="chronological",e.Detached="detached",e}({}),fd=new y("m.get_login_token","org.matrix.msc3882.get_login_token"),yd="uk.half-shot.msc2666",bd="uk.half-shot.msc2666.mutual_rooms",wd="uk.half-shot.msc2666.query_mutual_rooms",Sd="org.matrix.msc4140",Ed="uk.tcpip.msc4133",Rd="uk.tcpip.msc4133.stable",Id="$",kd=function(e){return e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.ReceivedToDeviceMessage="receivedToDeviceMessage",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.ReceivedVoipEvent="received_voip_event",e.TurnServers="turnServers",e.TurnServersError="turnServers.error",e}({}),Td=new w("action","org.matrix.msc3824.action");class Cd extends qe{constructor(e){var t,n,i,s,a;super(),i=this,o(this,"logger",void 0),o(this,"reEmitter",new Nr(this)),o(this,"olmVersion",null),o(this,"usingExternalCrypto",!1),o(this,"_store",void 0),o(this,"deviceId",void 0),o(this,"credentials",void 0),o(this,"legacyPickleKey",void 0),o(this,"scheduler",void 0),o(this,"clientRunning",!1),o(this,"timelineSupport",!1),o(this,"urlPreviewCache",{}),o(this,"identityServer",void 0),o(this,"http",void 0),o(this,"cryptoBackend",void 0),o(this,"enableEncryptedStateEvents",void 0),o(this,"cryptoCallbacks",void 0),o(this,"callEventHandler",void 0),o(this,"groupCallEventHandler",void 0),o(this,"supportsCallTransfer",!1),o(this,"forceTURN",!1),o(this,"iceCandidatePoolSize",0),o(this,"idBaseUrl",void 0),o(this,"baseUrl",void 0),o(this,"isVoipWithNoMediaAllowed",void 0),o(this,"useLivekitForGroupCalls",void 0),o(this,"canSupportVoip",!1),o(this,"peekSync",null),o(this,"isGuestAccount",!1),o(this,"ongoingScrollbacks",{}),o(this,"notifTimelineSet",null),o(this,"legacyCryptoStore",void 0),o(this,"verificationMethods",void 0),o(this,"fallbackICEServerAllowed",!1),o(this,"syncApi",void 0),o(this,"roomNameGenerator",void 0),o(this,"pushRules",void 0),o(this,"syncLeftRoomsPromise",void 0),o(this,"syncedLeftRooms",!1),o(this,"clientOpts",void 0),o(this,"clientWellKnownIntervalID",void 0),o(this,"canResetTimelineCallback",void 0),o(this,"canSupport",new Map),o(this,"pushProcessor",new Ks(this)),o(this,"serverVersionsPromise",void 0),o(this,"clientWellKnown",void 0),o(this,"clientWellKnownPromise",void 0),o(this,"turnServers",[]),o(this,"turnServersExpiry",0),o(this,"checkTurnServersIntervalID",void 0),o(this,"txnCtr",0),o(this,"mediaHandler",new va(this)),o(this,"sessionId",void 0),o(this,"eventsBeingEncrypted",new Set),o(this,"useE2eForGroupCall",!0),o(this,"toDeviceMessageQueue",void 0),o(this,"livekitServiceURL",void 0),o(this,"_secretStorage",void 0),o(this,"ignoredInvites",void 0),o(this,"matrixRTC",void 0),o(this,"serverCapabilitiesService",void 0),o(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(Es()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(kd.Sync,this.startCallEventHandler))}),o(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(kd.Sync,this.startMatrixRTC))}),o(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var e,t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter(e=>e.getUnreadNotificationCount(Ci.Total)>0);for(var r of t){var n=this.getSafeUserId();r.fixupNotifications(n)}this.off(kd.Sync,this.fixupRoomNotifications)}}),this.logger=null!==(t=e.logger)&&void 0!==t?t:xe,e.baseUrl=H(e.baseUrl),e.idBaseUrl=H(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(n=e.usingExternalCrypto)&&void 0!==n&&n,this.store=e.store||new Ji,this.deviceId=e.deviceId||null,this.sessionId=yo(10);var c=e.userId||null;this.credentials={userId:c},this.http=new wi(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:ui.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=Boolean(e.useLivekitForGroupCalls),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var e=r(function*(e){var t=i.getRoom(e.getRoomId());e.status!==xr.SENDING&&i.updatePendingEventStatus(t,e,xr.SENDING);var r=yield i.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,xr.SENT,r.event_id),r});return function(t){return e.apply(this,arguments)}}()),Es()&&(this.callEventHandler=new To(this),this.groupCallEventHandler=new Oo(this),this.canSupportVoip=!0,this.on(kd.Sync,this.startCallEventHandler)),this.matrixRTC=new Jc(this.logger,this),this.serverCapabilitiesService=new Ei(this.logger,this.http),this.on(kd.Sync,this.fixupRoomNotifications),this.timelineSupport=Boolean(e.timelineSupport),this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.enableEncryptedStateEvents=null!==(s=e.enableEncryptedStateEvents)&&void 0!==s&&s,this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new Ma(this,this.logger),this.on(zd.Decrypted,e=>{Md(this,e)}),this.ignoredInvites=new La(this),this._secretStorage=new dc(this,null!==(a=e.cryptoCallbacks)&&void 0!==a?a:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(e=>Ir.createUser(e,this))}get store(){return this._store}startClient(e){var t=this;return r(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(kd.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new Ir(r)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},vd),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:i,fwdPagination:o}=yield t.doesServerSupportThread();Fd.setServerSideSupport(n),Fd.setServerSideListSupport(i),Fd.setServerSideFwdPaginationSupport(o)}catch(e){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}t.clientOpts=null!=e?e:{},t.clientOpts.slidingSync?t.syncApi=new Ra(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new Hi(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(e=>t.logger.info("Sync startup aborted with an error:",e)),void 0!==t.clientOpts.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),logger:this.logger.getChild("sync")}}stopClient(){var e,t,r,n,i;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.off(kd.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(r=this.peekSync)||void 0===r||r.stopPeeking(),null===(n=this.callEventHandler)||void 0===n||n.stop(),null===(i=this.groupCallEventHandler)||void 0===i||i.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var n=[];n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData());var i=function(){var n=r(function*(){var r;try{if(!(r=globalThis.indexedDB))return}catch(e){return}var n=function*(t){var n=new Promise((n,i)=>{e.logger.info("Removing IndexedDB instance ".concat(t));var o=r.deleteDatabase(t);o.onsuccess=r=>{e.logger.info("Removed IndexedDB instance ".concat(t)),n(0)},o.onerror=r=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(t,":"),r),n(0)},o.onblocked=r=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(t))}});yield n};for(var i of["".concat(null!==(o=t.cryptoDatabasePrefix)&&void 0!==o?o:Na,"::matrix-sdk-crypto"),"".concat(null!==(s=t.cryptoDatabasePrefix)&&void 0!==s?s:Na,"::matrix-sdk-crypto-meta")]){var o,s;yield*n(i)}});return function(){return n.apply(this,arguments)}}();return n.push(i()),Promise.all(n).then()}getUserId(){var e,t;return null!==(e=null===(t=this.credentials)||void 0===t?void 0:t.userId)&&void 0!==e?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return null!==(e=this.credentials)&&void 0!==e&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return null!==(e=null===(t=this.credentials)||void 0===t||null===(t=t.userId)||void 0===t?void 0:t.split(":")[0].substring(1))&&void 0!==e?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return Rs(this,e)}createGroupCall(e,t,n,i,o,s){var a=this;return r(function*(){if(a.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var r=a.getRoom(e);if(!r)throw new Error("Cannot find room ".concat(e));return new as(a,r,t,n,i,void 0,o||a.isVoipWithNoMediaAllowed,s,a.isVoipWithNoMediaAllowed,a.useLivekitForGroupCalls,a.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return!!e&&(e===Bi.Prepared||e===Bi.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return r(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return r(function*(){var r,n,i=e.length>0&&void 0!==e[0]?e[0]:{};if(t.cryptoBackend)t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");else{var o=t.getUserId();if(null===o)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var s=t.getDeviceId();if(null===s)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var a=yield Promise.resolve().then(function(){return ty}),c=yield a.initRustCrypto({logger:t.logger,http:t.http,userId:o,deviceId:s,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:!1===i.useIndexedDB?null:null!==(r=i.cryptoDatabasePrefix)&&void 0!==r?r:Na,storeKey:i.storageKey,storePassphrase:i.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:null!==(n=t.legacyPickleKey)&&void 0!==n?n:"DEFAULT_KEY",legacyMigrationProgressListener:(e,r)=>{t.emit(Ha.LegacyCryptoStoreMigrationProgress,e,r)},enableEncryptedStateEvents:t.enableEncryptedStateEvents});c.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=c,t.on(dt.Membership,c.onRoomMembership.bind(c)),t.on(kd.Event,e=>{c.onLiveEventFromSync(e)}),t.reEmitter.reEmit(c,[Ha.VerificationRequestReceived,Ha.UserTrustStatusChanged,Ha.KeyBackupStatus,Ha.KeyBackupSessionsRemaining,Ha.KeyBackupFailed,Ha.KeyBackupDecryptionKeyCached,Ha.KeysChanged,Ha.DevicesUpdated,Ha.WillUpdateDevices,Ha.DehydratedDeviceCreated,Ha.DehydratedDeviceUploaded,Ha.RehydrationStarted,Ha.RehydrationProgress,Ha.RehydrationCompleted,Ha.RehydrationError,Ha.DehydrationKeyCached,Ha.DehydratedDeviceRotationError])}})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return!!t&&t.hasEncryptionStateEvent()}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,r){return{path:void 0!==t?x("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?x("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}}deleteKeysFromBackup(e,t,n){var i=this;return r(function*(){var r=i.makeKeyBackupPath(e,t,n);yield i.http.authedRequest(jn.Delete,r.path,r.queryData,void 0,{prefix:ui.V3})})()}getMediaConfig(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=e?"/media/config":"/config";return this.http.authedRequest(jn.Get,t,void 0,void 0,{prefix:e?ui.V1:gi.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.store.getRooms(),r=new Set(t);for(var n of r){var i=this.findPredecessorRooms(n,!0,e);for(var o of i)r.delete(o)}return Array.from(r)}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var n=this;return r(function*(){if(!n.clientRunning)return n.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield ri(5,()=>n.setAccountDataRaw(e,t));var r=n.store.getAccountData(e);if(r&&F(r.event.content,t))return{};var i=Promise.withResolvers();function o(t){t.getType()===e&&i.resolve()}n.addListener(kd.AccountData,o);try{var s=yield ri(5,()=>n.setAccountDataRaw(e,t));return yield i.promise,s}finally{n.removeListener(kd.AccountData,o)}})()}setAccountDataRaw(e,t){var r=x("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(jn.Put,r,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return r(function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=x("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(jn.Get,n)}catch(e){var i;if("M_NOT_FOUND"===(null===(i=e.data)||void 0===i?void 0:i.errcode))return null;throw e}})()}deleteAccountData(e){var t=this;return r(function*(){var r=t.canSupport.get(Ui.AccountDataDeletion);if(r!==xi.Unsupported){var n=x("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),i=r===xi.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(jn.Delete,n,void 0,void 0,i)}yield t.setAccountData(e,{})})()}getIgnoredUsers(){var e=this.getAccountData(Ve.IgnoredUserList);return null!=e&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(e=>{t.ignored_users[e]={}}),this.setAccountData(Ve.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,n=this;return r(function*(){var r,i,o=t.length>1&&void 0!==t[1]?t[1]:{},s=n.getRoom(e),a=null==s?void 0:s.getMember(n.getSafeUserId()),c=null==a?void 0:a.membership,l=c==lt.Invite&&null!==(r=null==a||null===(i=a.events.member)||void 0===i?void 0:i.getSender())&&void 0!==r?r:null;if(n.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(c,", inviter=").concat(l,", opts=").concat(JSON.stringify(o))),c==lt.Join)return s;var d=Promise.resolve();if(o.inviteSignUrl){var u=new URL(o.inviteSignUrl);u.searchParams.set("mxid",n.credentials.userId),d=n.http.requestOtherUrl(jn.Post,u)}var h={};o.viaServers&&(h.server_name=o.viaServers,h.via=o.viaServers);var g={},p=yield d;p&&(g.third_party_signed=p);var v=x("/join/$roomid",{$roomid:e}),m=(yield n.http.authedRequest(jn.Post,v,h,g)).room_id;o.acceptSharedHistory&&l&&n.cryptoBackend&&(yield n.cryptoBackend.maybeAcceptKeyBundle(m,l));var _=n.getRoom(m);return null!=_&&_.hasMembershipState(n.credentials.userId,lt.Join)?_:new Hi(n,n.clientOpts,n.buildSyncApiOptions()).createRoom(m)})()}knockRoom(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getRoom(e);if(null!=r&&r.hasMembershipState(this.credentials.userId,lt.Knock))return Promise.resolve({room_id:r.roomId});var n=x("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),i={};t.viaServers&&(i.server_name=t.viaServers,i.via=t.viaServers);var o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(jn.Post,n,i,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,xr.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![xr.QUEUED,xr.NOT_SENT,xr.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===xr.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===xr.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,xr.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,Ve.RoomName,{name:t})}setRoomTopic(e,t,r){var n=an(t,r);return this.sendStateEvent(e,Ve.RoomTopic,n)}getRoomTags(e){var t=x("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(jn.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=x("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(jn.Put,n,void 0,r)}deleteRoomTag(e,t){var r=x("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(jn.Delete,r)}setRoomAccountData(e,t,r){var n=x("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(jn.Put,n,void 0,r)}setPowerLevel(e,t,n){var i=this;return r(function*(){var r,o,s;i.clientRunning&&i.isInitialSyncComplete()&&(o=null===(s=i.getRoom(e))||void 0===s||null===(s=s.currentState)||void 0===s||null===(s=s.getStateEvents(Ve.RoomPowerLevels,""))||void 0===s?void 0:s.getContent());if(!o)try{o=yield i.getStateEvent(e,Ve.RoomPowerLevels,"")}catch(e){if(!(e instanceof Vn&&"M_NOT_FOUND"===e.errcode))throw e;o={}}null!==(r=o=N(o))&&void 0!==r&&r.users||(o.users={});var a=Array.isArray(t)?t:[t];for(var c of a)null==n?delete o.users[c]:o.users[c]=n;return i.sendStateEvent(e,Ve.RoomPowerLevels,o,"")})()}unstable_createLiveBeacon(e,t){var n=this;return r(function*(){return n.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var n=this;return r(function*(){return n.sendStateEvent(e,Ta.name,t,n.getUserId())})()}sendEvent(e,t,r,n,i){var o,s,a,c;return null!=t&&t.startsWith(Id)||null===t?(c=i,a=n,s=r,o=t):(c=n,a=r,s=t,o=null),this.addThreadRelationIfNeeded(a,o,e),this.sendCompleteEvent(e,o,{type:s,content:a},c)}addThreadRelationIfNeeded(e,t,r){var n;if(t&&(null===(n=e["m.relates_to"])||void 0===n||!n.rel_type)){var i,o,s=!(null===(i=e["m.relates_to"])||void 0===i||!i["m.in_reply_to"]);e["m.relates_to"]=pd(pd({},e["m.relates_to"]),{},{rel_type:qd.name,event_id:t,is_falling_back:!s});var a,c,l=null===(o=this.getRoom(r))||void 0===o?void 0:o.getThread(t);if(l&&!s)e["m.relates_to"]["m.in_reply_to"]={event_id:null!==(a=null===(c=l.lastReply(e=>e.isRelation(qd.name)&&!e.status))||void 0===c?void 0:c.getId())&&void 0!==a?a:t}}}sendCompleteEvent(e,t,r,n,i){var o,s;"string"==typeof n?s=n:(o=n,s=i),s||(s=this.makeTxnId());var a=new $d(Object.assign(r,{event_id:"~"+e+":"+s,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),c=this.getRoom(e),l=t?null==c?void 0:c.getThread(t):void 0;l&&a.setThread(l),o||(this.reEmitter.reEmit(a,[zd.Replaced,zd.VisibilityChange]),null==c||c.reEmitter.reEmit(a,[zd.BeforeRedaction]));var d=a.getAssociatedId();if(null!=d&&d.startsWith("~")){var u=null==c?void 0:c.getPendingEvents().find(e=>e.getId()===d);null==u||u.once(zd.LocalEventIdReplaced,()=>{a.updateAssociatedId(u.getId())})}var h=a.getType();return this.logger.debug("sendEvent of type ".concat(h," in ").concat(e," with txnId ").concat(s).concat(o?" (delayed event)":"")),a.setTxnId(s),a.setStatus(xr.SENDING),o?this.encryptAndSendEvent(c,a,o):(null==c||c.addPendingEvent(a,s),a.status===xr.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(c,a))}encryptAndSendEvent(e,t,n){var i=this;return r(function*(){if(n)return i.sendEventHttpRequest(t,n);try{var r;i.eventsBeingEncrypted.add(t.getId());try{yield i.encryptEventIfNeeded(t,null!=e?e:void 0)}finally{r=!i.eventsBeingEncrypted.delete(t.getId())}if(r)return{};t.status===xr.ENCRYPTING&&i.updatePendingEventStatus(e,t,xr.SENDING);var o=null;return i.scheduler&&(o=i.scheduler.queueEvent(t))&&i.scheduler.getQueueForEvent(t).length>1&&i.updatePendingEventStatus(e,t,xr.QUEUED),o||(o=i.sendEventHttpRequest(t),e&&(o=o.then(r=>(e.updatePendingEvent(t,xr.SENT,r.event_id),r)))),yield o}catch(r){i.logger.error("Error sending event",r);try{t.error=r,i.updatePendingEventStatus(e,t,xr.NOT_SENT)}catch(e){i.logger.error("Exception in error handler!",e)}throw r instanceof Vn&&(r.event=t),r}})()}encryptEventIfNeeded(e,t){var n=this;return r(function*(){if(t&&(yield n.shouldEncryptEventForRoom(e,t))&&(n.cryptoBackend||!n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");n.updatePendingEventStatus(t,e,xr.ENCRYPTING),yield n.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var n=this;return r(function*(){var r;return!e.isEncrypted()&&(e.getType()!==Ve.Reaction&&(!e.isRedaction()&&(!!t.hasEncryptionStateEvent()||!!(yield null===(r=n.cryptoBackend)||void 0===r?void 0:r.isEncryptionEnabledInRoom(t.roomId)))))})()}getEncryptedIfNeededEventType(e,t){var r;return t===Ve.Reaction?t:null!==(r=this.getRoom(e))&&void 0!==r&&r.hasEncryptionStateEvent()?Ve.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t){var r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));var n,i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r};if(e.isState()){var o="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),n=x(o,i)}else if(e.isRedaction()&&e.event.redacts){n=x("/rooms/$roomId/redact/$redactsEventId/$txnId",pd({$redactsEventId:e.event.redacts},i))}else n=x("/rooms/$roomId/send/$eventType/$txnId",i);var s=e.getWireContent();return t?this.http.authedRequest(jn.Put,n,Od(t),s):this.http.authedRequest(jn.Put,n,void 0,s).then(t=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(t.event_id)),t))}redactEvent(e,t,r,n,i){var o,s,a;null!==(o=r)&&void 0!==o&&o.startsWith(Id)||(i=n,n=r,r=t,t=null);var c={reason:null===(s=i)||void 0===s?void 0:s.reason};if(void 0!==(null===(a=i)||void 0===a?void 0:a.with_rel_types)){if(this.canSupport.get(Ui.RelationBasedRedactions)===xi.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));c[this.canSupport.get(Ui.RelationBasedRedactions)===xi.Stable?tt.stable:tt.unstable]=i.with_rel_types}return this.sendCompleteEvent(e,t,{type:Ve.RoomRedaction,content:c,redacts:r},n)}sendMessage(e,t,r,n){"string"!=typeof t&&null!==t&&(n=r,r=t,t=null);var i=Ve.RoomMessage,o=r;return this.sendEvent(e,t,i,o,n)}sendTextMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=tn(r);return this.sendMessage(e,t,o,n)}sendNotice(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=rn(r);return this.sendMessage(e,t,o,n)}sendEmoteMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=nn(r);return this.sendMessage(e,t,o,n)}sendImageMessage(e,t,r,n){var i,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image";null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(o=n||"Image",n=r,r=t,t=null);var s={msgtype:Ge.Image,url:r,info:n,body:o};return this.sendMessage(e,t,s)}sendStickerMessage(e,t,r,n){var i,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker";null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(o=n||"Sticker",n=r,r=t,t=null);var s={url:r,info:n,body:o};return this.sendEvent(e,t,Ve.Sticker,s)}sendHtmlMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=Xr(r,n);return this.sendMessage(e,t,o)}sendHtmlNotice(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=Zr(r,n);return this.sendMessage(e,t,o)}sendHtmlEmote(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(Id)||null===t||(n=r,r=t,t=null);var o=en(r,n);return this.sendMessage(e,t,o)}_unstable_sendDelayedEvent(e,t,n,i,o,s){var a=this;return r(function*(){if(!(yield a.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","sendDelayedEvent");return a.addThreadRelationIfNeeded(o,n,e),a.sendCompleteEvent(e,n,{type:i,content:o},t,s)})()}_unstable_sendDelayedStateEvent(e,t,n,i){var o=arguments,s=this;return r(function*(){var r=o.length>4&&void 0!==o[4]?o[4]:"",a=o.length>5&&void 0!==o[5]?o[5]:{};if(!(yield s.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","sendDelayedStateEvent");var c={$roomId:e,$eventType:n,$stateKey:r},l=x("/rooms/$roomId/state/$eventType",c);return void 0!==r&&(l=x(l+"/$stateKey",c)),s.http.authedRequest(jn.Put,l,Od(t),i,a)})()}_unstable_getDelayedEvents(e){var t=this;return r(function*(){if(!(yield t.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","getDelayedEvents");var r=e?{from:e}:void 0;return yield t.http.authedRequest(jn.Get,"/delayed_events",r,void 0,{prefix:"".concat(ui.Unstable,"/").concat(Sd)})})()}_unstable_updateDelayedEvent(e,t){var n=arguments,i=this;return r(function*(){var r=n.length>2&&void 0!==n[2]?n[2]:{};if(!(yield i.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","updateDelayedEvent");var o=x("/delayed_events/$delayId",{$delayId:e}),s={action:t};return yield i.http.authedRequest(jn.Post,o,void 0,s,pd(pd({},r),{},{prefix:"".concat(ui.Unstable,"/").concat(Sd)}))})()}sendReceipt(e,t,n){var i=arguments,o=this;return r(function*(){var r=i.length>3&&void 0!==i[3]&&i[3];if(o.isGuest())return Promise.resolve({});var s=x("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),a=!r&&o.supportsThreads()?pd(pd({},n),{},{thread_id:Pd(e)}):n,c=o.http.authedRequest(jn.Post,s,void 0,a||{}),l=o.getRoom(e.getRoomId());return l&&o.credentials.userId&&l.addLocalEchoReceipt(o.credentials.userId,e,t,r),c})()}sendReadReceipt(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]?t[1]:k.Read,i=t.length>2&&void 0!==t[2]&&t[2];if(e){var o=e.getId(),s=n.getRoom(e.getRoomId());if(null!=s&&s.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));return n.sendReceipt(e,r,{},i)}})()}setRoomReadMarkers(e,t,n,i){var o=this;return r(function*(){var r,s,a=o.getRoom(e);if(null!=a&&a.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));if(n){if(r=n.getId(),null!=a&&a.hasPendingEvent(r))throw new Error("Cannot set read receipt to a pending event (".concat(r,")"));null==a||a.addLocalEchoReceipt(o.credentials.userId,n,k.Read)}if(i){if(s=i.getId(),null!=a&&a.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));null==a||a.addLocalEchoReceipt(o.credentials.userId,i,k.ReadPrivate)}return yield o.setRoomReadMarkersHttpRequest(e,t,r,s)})()}sendRtcDecline(e,t){return this.sendEvent(e,Ve.RTCDecline,{"m.relates_to":{event_id:t,rel_type:We.Reference}})}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);var r=new URL(e);r.hash="";var n=t+"_"+(e=r.toString());if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var i=this.http.authedRequest(jn.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:gi.V3,priority:"low"});return this.urlPreviewCache[n]=i,i}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=x("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),i={typing:t};return t&&(i.timeout=r||2e4),this.http.authedRequest(jn.Put,n,void 0,i)}getRoomUpgradeHistory(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getRoom(e);return n?[...this.findPredecessorRooms(n,t,r),n,...this.findSuccessorRooms(n,t,r)]:[]}findPredecessorRooms(e,t,r){for(var n,i=[],o=new Set([e.roomId]),s=null===(n=e.findPredecessor(r))||void 0===n?void 0:n.roomId;null!==s;){var a;if(s){if(o.has(s))break;o.add(s)}var c=this.getRoom(s);if(null===c)break;if(t){var l=c.currentState.getStateEvents(Ve.RoomTombstone,"");if(!l||l.getContent().replacement_room!==e.roomId)break}i.splice(0,0,c),s=null===(a=(e=c).findPredecessor(r))||void 0===a?void 0:a.roomId}return i}findSuccessorRooms(e,t,r){for(var n=[],i=e.currentState.getStateEvents(Ve.RoomTombstone,"");i;){var o=this.getRoom(i.getContent().replacement_room);if(!o)break;if(o.roomId===e.roomId)break;if(t){var s,a=null===(s=o.findPredecessor(r))||void 0===s?void 0:s.roomId;if(!a||a!==e.roomId)break}if(n.push(o),new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);i=(e=o).currentState.getStateEvents(Ve.RoomTombstone,"")}return n}invite(e,t){var n=arguments,i=this;return r(function*(){var r,o=n.length>2&&void 0!==n[2]?n[2]:{};("object"!=typeof o&&(o={reason:o}),o.shareEncryptedHistory)&&(yield null===(r=i.cryptoBackend)||void 0===r?void 0:r.shareRoomHistoryWithUser(e,t));return yield i.membershipChange(e,t,lt.Invite,o.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,n){var i=this;return r(function*(){var r,o=x("/rooms/$roomId/invite",{$roomId:e}),s=i.getIdentityServerUrl(!0);if(!s)return Promise.reject(new Vn({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var a={id_server:s,medium:t,address:n};if(null!==(r=i.identityServer)&&void 0!==r&&r.getAccessToken){var c=yield i.identityServer.getAccessToken();c&&(a.id_access_token=c)}return i.http.authedRequest(jn.Post,o,void 0,a)})()}leave(e){return this.membershipChange(e,void 0,lt.Leave)}leaveRoomChain(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this.getRoomUpgradeHistory(e,!0),n=r;if(!t)for(var i of(n=[],r))if(n.push(i),i.roomId===e)break;var o={},s=[],a=e=>this.leave(e).then(()=>{delete o[e]}).catch(t=>{o[e]=t});for(var c of n)s.push(a(c.roomId));return Promise.all(s).then(()=>o)}ban(e,t,r){return this.membershipChange(e,t,lt.Ban,r)}forget(e){var t=arguments,n=this;return r(function*(){var r=!(t.length>1&&void 0!==t[1])||t[1],i=x("/rooms/$room_id/forget",{$room_id:e}),o=yield n.http.authedRequest(jn.Post,i);return r&&(n.store.removeRoom(e),n.emit(kd.DeleteRoom,e)),o})()}unban(e,t){var r=x("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(jn.Post,r,void 0,n)}kick(e,t,r){var n=x("/rooms/$roomId/kick",{$roomId:e}),i={user_id:t,reason:r};return this.http.authedRequest(jn.Post,n,void 0,i)}membershipChange(e,t,r,n){var i=x("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(jn.Post,i,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=x("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(jn.Put,r,void 0,t)}setDisplayName(e){var t=this;return r(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(Rr.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return r(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(Rr.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,i,o,s){return Ce(this.baseUrl,e,t,r,n,i,o,s)}setSyncPresence(e){var t=this;return r(function*(){var r;null===(r=t.syncApi)||void 0===r||r.setPresence(e)})()}setPresence(e){var t=this;return r(function*(){var r=x("/presence/$userId/status",{$userId:t.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(jn.Put,r,void 0,e)})()}getPresence(e){var t=x("/presence/$userId/status",{$userId:e});return this.http.authedRequest(jn.Get,t)}scrollback(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var i=Date.now()-n.errorTs;r=Math.max(3e3-i,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);var o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;var s=new Promise((n,i)=>{z(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,kr.Backward)).then(t=>{var r,i,o=t.chunk.map(this.getEventMapper());if(t.state){var s=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(s)}var[a,c,l]=e.partitionThreadedEvents(o);this.processAggregatedTimelineEvents(e,a),e.addEventsToTimeline(a,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,c,!0),l.forEach(t=>e.relations.aggregateChildEvent(t)),e.oldState.paginationToken=null!==(r=t.end)&&void 0!==r?r:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,null!==(i=t.end)&&void 0!==i?i:null,!0),delete this.ongoingScrollbacks[e.roomId],n(e)}).catch(t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},i(t)})});return n={promise:s},this.ongoingScrollbacks[e.roomId]=n,s}getEventMapper(e){return function(e,t){var r=Boolean(t.preventReEmit),n=!1!==t.decrypt;return function t(i){var o,s=e.getRoom(i.room_id);s&&void 0===i.state_key&&(o=s.findEventById(i.event_id)),!o||o.status?o=new $d(i):(o.setUnsigned(ia(ia({},o.getUnsigned()),i.unsigned)),r=!0);var a=o.getServerAggregatedRelation(We.Replace);if(null!=a&&a.content){var c=t(a);o.makeReplaced(c)}var l=null==s?void 0:s.findThreadForEvent(o);return l&&o.setThread(l),o.isEncrypted()&&(r||e.reEmitter.reEmit(o,[zd.Decrypted]),n&&e.decryptEventIfNeeded(o)),r||(e.reEmitter.reEmit(o,[zd.Replaced,zd.VisibilityChange]),null==s||s.reEmitter.reEmit(o,[zd.BeforeRedaction])),o}}(this,e||{})}getEventTimeline(e,t){var n=this;return r(function*(){var r,i,o,s;if(!n.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(null==e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&n.supportsThreads())return n.getThreadTimeline(e,t);var a=x("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),c=void 0;null!==(r=n.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(c={filter:JSON.stringify(Vr.LAZY_LOADING_MESSAGES_FILTER)});var l=yield n.http.authedRequest(jn.Get,a,c);if(!l.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var d=n.getEventMapper(),u=d(l.event);if(!u.isRelation(qd.name)){var h=[...l.events_after.reverse().map(d),u,...l.events_before.map(d)],g=e.getTimelineForEvent(h[0].getId());g?g.getState(Tr.BACKWARDS).setUnknownStateEvents(l.state.map(d)):((g=e.addTimeline()).initialiseState(l.state.map(d)),g.getState(Tr.FORWARDS).paginationToken=l.end);var[p,v,m]=e.room.partitionThreadedEvents(h);return e.addEventsToTimeline(p,!0,!1,g,l.start),n.processThreadEvents(e.room,v,!0),n.processAggregatedTimelineEvents(e.room,p),m.forEach(t=>e.relations.aggregateChildEvent(t)),null!==(i=null!==(o=e.getTimelineForEvent(t))&&void 0!==o?o:null===(s=e.room.findThreadForEvent(u))||void 0===s?void 0:s.liveTimeline)&&void 0!==i?i:g}n.logger.warn("Tried loading a regular timeline at the position of a thread event")})()}getThreadTimeline(e,t){var n=this;return r(function*(){var r;if(!n.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var i=x("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),o={limit:"0"};null!==(r=n.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(o.filter=JSON.stringify(Vr.LAZY_LOADING_MESSAGES_FILTER));var s=yield n.http.authedRequest(jn.Get,i,o),a=n.getEventMapper(),c=a(s.event);if(e.canContain(c)){var l=n.canSupport.get(Ui.RelationsRecursion)!==xi.Unsupported;if(Fd.hasServerSideSupport){if(Fd.hasServerSideFwdPaginationSupport){var d,u,h;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var g=e.thread,p=yield n.fetchRelations(e.room.roomId,g.id,null,null,{dir:kr.Backward,from:s.start,recurse:l||void 0}),v=yield n.fetchRelations(e.room.roomId,g.id,null,null,{dir:kr.Forward,from:s.end,recurse:l||void 0}),m=[...v.chunk.reverse().filter(Yc(g.id)).map(a),c,...p.chunk.filter(Yc(g.id)).map(a)];for(var _ of m){var f;yield null===(f=e.thread)||void 0===f?void 0:f.processEvent(_)}var y=e.getTimelineForEvent(c.getId());if(y?y.getState(Tr.BACKWARDS).setUnknownStateEvents(s.state.map(a)):(y=e.addTimeline()).initialiseState(s.state.map(a)),e.addEventsToTimeline(m,!0,!1,y,v.next_batch),!p.next_batch){var b=yield n.fetchRoomEvent(e.room.roomId,g.id);e.addEventsToTimeline([a(b)],!0,!1,y,null)}return y.setPaginationToken(null!==(d=p.next_batch)&&void 0!==d?d:null,kr.Backward),y.setPaginationToken(null!==(u=v.next_batch)&&void 0!==u?u:null,kr.Forward),n.processAggregatedTimelineEvents(e.room,m),null!==(h=e.getTimelineForEvent(t))&&void 0!==h?h:y}for(var w,S=e.thread,E=yield n.fetchRelations(e.room.roomId,S.id,qd.name,null,{dir:kr.Backward,from:s.start,recurse:l||void 0}),R=[],I=s.end;I;){var k,T=yield n.fetchRelations(e.room.roomId,S.id,qd.name,null,{dir:kr.Forward,from:I,recurse:l||void 0});I=null!==(k=T.next_batch)&&void 0!==k?k:null,R.push(...T.chunk)}var C=[...R.reverse().map(a),c,...E.chunk.map(a)];for(var O of C){var M;yield null===(M=e.thread)||void 0===M?void 0:M.processEvent(O)}var P=e.getLiveTimeline();if(P.getState(Tr.BACKWARDS).setUnknownStateEvents(s.state.map(a)),e.addEventsToTimeline(C,!0,!1,P,null),!E.next_batch){var D=yield n.fetchRoomEvent(e.room.roomId,S.id);e.addEventsToTimeline([a(D)],!0,!1,P,null)}return P.setPaginationToken(null!==(w=E.next_batch)&&void 0!==w?w:null,kr.Backward),P.setPaginationToken(null,kr.Forward),n.processAggregatedTimelineEvents(e.room,C),P}}})()}getLatestTimeline(e){var t=this;return r(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r,n;if(null!==e.threadListType)r=null===(n=(yield t.createThreadListMessagesRequest(e.room.roomId,null,1,kr.Backward,e.threadListType,e.getFilter())).chunk)||void 0===n?void 0:n[0];else if(e.thread&&Fd.hasServerSideSupport){var i,o=t.canSupport.get(Ui.RelationsRecursion)!==xi.Unsupported;r=null===(i=(yield t.fetchRelations(e.room.roomId,e.thread.id,qd.name,null,{dir:kr.Backward,limit:1,recurse:o||void 0})).chunk)||void 0===i?void 0:i[0]}else{var s,a,c=x("/rooms/$roomId/messages",{$roomId:e.room.roomId}),l={dir:"b"};null!==(s=t.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(l.filter=JSON.stringify(Vr.LAZY_LOADING_MESSAGES_FILTER)),r=null===(a=(yield t.http.authedRequest(jn.Get,c,l)).chunk)||void 0===a?void 0:a[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,s=x("/rooms/$roomId/messages",{$roomId:e}),a={limit:n.toString(),dir:i};t&&(a.from=t);var c,l=null;(null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(l=Object.assign({},Vr.LAZY_LOADING_MESSAGES_FILTER)),o)&&(l=l||{},Object.assign(l,null===(c=o.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return l&&(a.filter=JSON.stringify(l)),this.http.authedRequest(jn.Get,s,a)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:kr.Backward,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Vd.All,s=arguments.length>5?arguments[5]:void 0,a=x("/rooms/$roomId/threads",{$roomId:e}),c={limit:n.toString(),dir:i,include:Wd(o)};t&&(c.from=t);var l,d={};(null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(d=pd({},Vr.LAZY_LOADING_MESSAGES_FILTER)),s)&&(d=pd(pd({},d),null===(l=s.getRoomTimelineFilterComponent())||void 0===l?void 0:l.toJSON()));Object.keys(d).length&&(c.filter=JSON.stringify(d));var u={prefix:Fd.hasServerSideListSupport===Ld.Stable?ui.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(jn.Get,a,c,void 0,u).then(e=>{var t;return pd(pd({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})})}paginateEventTimeline(e,t){var n=this,i=e.getTimelineSet()===this.notifTimelineSet,o=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,a=e.getTimelineSet().thread,c=(t=t||{}).backwards||!1;if(i&&!c)throw new Error("paginateNotifTimeline can only paginate backwards");var l,d,u,h=c?Tr.BACKWARDS:Tr.FORWARDS,g=e.getPaginationToken(h),p=e.paginationRequests[h];if(p)return p;if(i)l={limit:(null!==(u=t.limit)&&void 0!==u?u:30).toString(),only:"highlight"},g&&"end"!==g&&(l.from=g),d=this.http.authedRequest(jn.Get,"/notifications",l).then(function(){var t=r(function*(t){var r=t.next_token,i=[];t.notifications=t.notifications.filter(me);for(var o=0;o<t.notifications.length;o++){var s=t.notifications[o],a=n.getEventMapper()(s.event);n.getPushDetailsForEvent(a,!0),a.event.room_id=s.room_id,i[o]=a}var l=e.getTimelineSet();return l.addEventsToTimeline(i,c,!1,e,r),n.processAggregatedTimelineEvents(l.room,i),c&&!t.next_token&&e.setPaginationToken(null,h),Boolean(t.next_token)});return function(e){return t.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=d;else if(null!==s){if(!o)throw new Error("Unknown room "+e.getRoomId());if(!Fd.hasServerSideFwdPaginationSupport&&h===kr.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");d=this.createThreadListMessagesRequest(e.getRoomId(),g,t.limit,h,s,e.getFilter()).then(t=>{if(t.state){var r=e.getState(h),n=t.state.filter(me).map(this.getEventMapper());r.setUnknownStateEvents(n)}var i=t.end,s=t.chunk.filter(me).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(s,c,!1,e,i),this.processAggregatedTimelineEvents(o,s),this.processThreadRoots(o,s,c),c&&t.end==t.start&&e.setPaginationToken(null,h),t.end!==t.start}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=d}else if(a){var v,m,_=this.getRoom(null!==(v=e.getRoomId())&&void 0!==v?v:void 0);if(!_)throw new Error("Unknown room "+e.getRoomId());var f=this.canSupport.get(Ui.RelationsRecursion)!==xi.Unsupported;d=this.fetchRelations(null!==(m=e.getRoomId())&&void 0!==m?m:"",a.id,null,null,{dir:h,limit:t.limit,from:null!=g?g:void 0,recurse:f||void 0}).then(function(){var t=r(function*(t){var r=n.getEventMapper(),i=t.chunk.filter(me).filter(Yc(a.id)).map(r);for(var o of i.slice().reverse()){yield null==a?void 0:a.processEvent(o);var s=o.getSender();c&&null!==(null==a?void 0:a.getEventReadUpTo(s))||_.addLocalEchoReceipt(s,o,k.Read)}var l=t.next_batch,d=e.getTimelineSet();if(d.addEventsToTimeline(i,c,!1,e,null!=l?l:null),!l&&c){var u,g,p=null!==(u=a.rootEvent)&&void 0!==u?u:r(yield n.fetchRoomEvent(null!==(g=e.getRoomId())&&void 0!==g?g:"",a.id));d.addEventsToTimeline([p],!0,!1,e,null)}return n.processAggregatedTimelineEvents(d.room,i),c&&!l&&e.setPaginationToken(null,h),Boolean(l)});return function(e){return t.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=d}else{if(!o)throw new Error("Unknown room "+e.getRoomId());d=this.createMessagesRequest(e.getRoomId(),g,t.limit,h,e.getFilter()).then(t=>{if(t.state){var r=e.getState(h),n=t.state.filter(me).map(this.getEventMapper());r.setUnknownStateEvents(n)}var i=t.end,s=t.chunk.filter(me).map(this.getEventMapper()),a=e.getTimelineSet(),[l,,d]=o.partitionThreadedEvents(s);a.addEventsToTimeline(l,c,!1,e,i),this.processAggregatedTimelineEvents(o,l),this.processThreadRoots(o,l.filter(e=>e.getServerAggregatedRelation(qd.name)),!1),d.forEach(e=>o.relations.aggregateChildEvent(e));var u=void 0===t.end||t.end===t.start;return c&&u&&e.setPaginationToken(null,h),!u}).finally(()=>{e.paginationRequests[h]=null}),e.paginationRequests[h]=d}return d}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new Hi(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,Ve.RoomGuestAccess,{guest_access:t.allowJoin?ta.CanJoin:ta.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,Ve.RoomHistoryVisibility,{history_visibility:ra.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestTokenFromEndpoint(e,t){var n=this;return r(function*(){var r=Object.assign({},t);return n.http.request(jn.Post,e,void 0,r)})()}getRoomPushRule(e,t){var r;if(this.pushRules)return null===(r=this.pushRules[e])||void 0===r||null===(r=r.room)||void 0===r?void 0:r.find(e=>e.rule_id===t);throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,i=!1,o=this.getRoomPushRule(e,t);if(null!=o&&o.actions.includes(Is.DontNotify)&&(i=!0),r)if(o){if(!i){var s=Promise.withResolvers();this.deletePushRule(e,Ms.RoomSpecific,o.rule_id).then(()=>{this.addPushRule(e,Ms.RoomSpecific,t,{actions:[Is.DontNotify]}).then(()=>{s.resolve()}).catch(e=>{s.reject(e)})}).catch(e=>{s.reject(e)}),n=s.promise}}else n=this.addPushRule(e,Ms.RoomSpecific,t,{actions:[Is.DontNotify]});else i&&(n=this.deletePushRule(e,Ms.RoomSpecific,o.rule_id));if(n)return new Promise((e,t)=>{n.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(r=>{this.pushRules=r,t(e)}).catch(r=>{t(e)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:ga.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(r,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;var o=new Set(i.highlights);e.highlights.forEach(e=>{o.add(e)}),e.highlights=Array.from(o);for(var s=this.getEventMapper(),a=null!==(r=null===(n=i.results)||void 0===n?void 0:n.length)&&void 0!==r?r:0,c=0;c<a;c++){var l=Ys.fromJson(i.results[c],s),d=this.getRoom(l.context.getEvent().getRoomId());if(d)for(var u of l.context.getTimeline())u.setMetadata(d.currentState,!1);e.results.push(l)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new Hi(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=x("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(jn.Post,t,void 0,e).then(t=>{var r=Vr.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var i=x("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(jn.Get,i).then(r=>{var n=Vr.fromJson(e,t,r);return this.store.storeFilter(n),n})}getOrCreateFilter(e,t){var n=this;return r(function*(){var r,i=n.store.getFilterIdByName(e);if(i){try{var o=yield n.getFilter(n.credentials.userId,i,!0);if(o)F(o.getDefinition(),t.getDefinition())&&(r=i)}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}r||n.store.setFilterIdByName(e,void 0)}if(r)return r;var s=yield n.createFilter(t.getDefinition());return n.store.setFilterIdByName(e,s.filterId),s.filterId})()}getOpenIdToken(){var e=x("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(jn.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(jn.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}checkTurnServers(){var e=this;return r(function*(){if(e.canSupportVoip){var t=!1,r=e.turnServersExpiry-Date.now();if(r>vd)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var i={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[i],e.turnServersExpiry=Date.now()+1e3*n.ttl,t=!0,e.emit(kd.TurnServers,e.turnServers)}}catch(t){e.logger.error("Failed to get TURN URIs",t),403===t.httpStatus?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==e.checkTurnServersIntervalID&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(kd.TurnServersError,t,!0)):e.emit(kd.TurnServersError,t,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=x("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(jn.Get,e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){var t=x("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(jn.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=x("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(jn.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return r(function*(){var t;e.clientWellKnownPromise=zs.getRawClientConfig(null!==(t=e.getDomain())&&void 0!==t?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(kd.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(t=>{var[r,n]=t;return e.includes(typeof n)}).reduce((e,t)=>{var[r,n]=t;return e[r]=n,e},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return r(function*(){var r,n,i=yield t.doesServerSupportUnstableFeature(yd),o=yield t.doesServerSupportUnstableFeature(bd),s=yield t.doesServerSupportUnstableFeature(wd);if(!i&&!o&&!s)throw Error("Server does not support the Mutual Rooms API");s?(r="/uk.half-shot.msc2666/user/mutual_rooms",n={user_id:e}):(r=x("/uk.half-shot.msc2666/user/".concat(o?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),n={});var a=[],c=null;do{var l={};null!=c&&s&&(l.batch_token=c);var d=yield t.http.authedRequest(jn.Get,r,pd(pd({},n),l),void 0,{prefix:ui.Unstable});a.push(...d.joined),c=void 0!==d.next_batch_token?d.next_batch_token:null}while(null!=c);return a})()}getVersions(){var e=this;return r(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(jn.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(t=>{throw e.serverVersionsPromise=void 0,t});var t=yield e.serverVersionsPromise;return e.canSupport=yield function(e){return Ni.apply(this,arguments)}(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return r(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return r(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return r(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(i)]})()}doesServerSupportThread(){var e=this;return r(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:Ld.Stable,list:Ld.Stable,fwdPagination:Ld.Stable};try{var[t,r,n,i,o,s]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Nd(r,t),list:Nd(i,n),fwdPagination:Nd(s,o)}}catch(e){return{threads:Ld.None,list:Ld.None,fwdPagination:Ld.None}}})()}hasLazyLoadMembersEnabled(){var e;return!(null===(e=this.clientOpts)||void 0===e||!e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,n,i){var o=arguments,s=this;return r(function*(){var r,a,c=o.length>4&&void 0!==o[4]?o[4]:{dir:kr.Backward},l=i?s.getEncryptedIfNeededEventType(e,i):null,[d,u]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,n,l,c)]),h=s.getEventMapper(),g=d?h(d):void 0,p=u.chunk.map(h);if(l===Ve.RoomMessageEncrypted){var v=g?p.concat(g):p;yield Promise.all(v.map(e=>s.decryptEventIfNeeded(e))),null!==i&&(p=p.filter(e=>e.getType()===i))}return g&&n===We.Replace&&(p=p.filter(e=>e.getSender()===g.getSender())),{originalEvent:null!=g?g:null,events:p,nextBatch:null!==(r=u.next_batch)&&void 0!==r?r:null,prevBatch:null!==(a=u.prev_batch)&&void 0!==a?a:null}})()}generateClientSecret(){return yo(32)}decryptEventIfNeeded(e,t){return e.isState()&&!this.enableEncryptedStateEvents?Promise.resolve():(e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve())}termsUrlForService(e,t){switch(e){case $s.IS:return this.http.getUrl("/terms",void 0,hi.V2,t);case $s.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(null!==(e=this.idBaseUrl)&&void 0!==e&&e.startsWith("http://")||null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=H(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!==(e=this.http.opts.refreshToken)&&void 0!==e?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(jn.Get,"/register/available",{username:e}).then(e=>e.available).catch(e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e))}register(e,t,r,n,i,o,s){r&&(n.session=r);var a={auth:n,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),null!=o&&(a.guest_access_token=o),null!=s&&(a.inhibit_login=s),this.registerRequest(a)}registerGuest(){var{body:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(jn.Post,"/register",r,e)}refreshToken(e){var t=t=>this.http.authedRequest(jn.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(ui.V3).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return t(ui.V1);throw e})}loginFlows(){return this.http.request(jn.Get,"/login")}login(e,t){return this.loginRequest(pd(pd({},t),{},{type:e})).then(e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,n="/login/"+(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso")+"/redirect";t&&(n+="/"+t);var i={redirectUrl:e,[Td.unstable]:r};return this.http.getUrl(n,i).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return r(function*(){return yield t.http.authedRequest(jn.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return r(function*(){return e.length>0&&void 0!==e[0]&&e[0]&&(t.stopClient(),t.http.abort()),t.http.authedRequest(jn.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(jn.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return r(function*(){var r={auth:e};return t.http.authedRequest(jn.Post,"/login/get_token",void 0,r,{prefix:ui.V1})})()}getFallbackAuthUrl(e,t){var r=x("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return r(function*(){var r,n=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(n.length>0&&null!==(r=t.identityServer)&&void 0!==r&&r.getAccessToken){var i=yield t.identityServer.getAccessToken();if(i)for(var o of n)o.id_access_token=i}return t.http.authedRequest(jn.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:kr.Backward};Fd.hasServerSideFwdPaginationSupport===Ld.Experimental&&(i=A("dir","org.matrix.msc3715.dir",i)),this.canSupport.get(Ui.RelationsRecursion)===xi.Unstable&&(i=A("recurse","org.matrix.msc3981.recurse",i));var o=D(i),s="/rooms/$roomId/relations/$eventId";null!==r?(s+="/$relationType",null!==n&&(s+="/$eventType")):null!==n&&(this.logger.warn("eventType: ".concat(n," ignored when fetching\n            relations as relationType is null")),n=null);var a=x(s+"?"+o,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(jn.Get,a,void 0,void 0,{prefix:ui.V1})}roomState(e){var t=x("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(jn.Get,t)}fetchRoomEvent(e,t){var r=x("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(jn.Get,r)}members(e,t,r,n){var i={};t&&(i.membership=t),r&&(i.not_membership=r),n&&(i.at=n);var o=x("/rooms/$roomId/members?"+D(i),{$roomId:e});return this.http.authedRequest(jn.Get,o)}upgradeRoom(e,t){var r=x("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(jn.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},i=x("/rooms/$roomId/state/$eventType",n);return void 0!==r&&(i=x(i+"/$stateKey",n)),this.http.authedRequest(jn.Get,i)}sendStateEvent(e,t,n){var i=arguments,o=this;return r(function*(){var r=i.length>3&&void 0!==i[3]?i[3]:"",s=i.length>4&&void 0!==i[4]?i[4]:{},a=o.getRoom(e),c=new $d({room_id:e,type:t,state_key:r,content:n});yield o.encryptStateEventIfNeeded(c,null!=a?a:void 0);var l={$roomId:e,$eventType:c.getWireType(),$stateKey:c.getWireStateKey()},d=x("/rooms/$roomId/state/$eventType",l);return void 0!==r&&(d=x(d+"/$stateKey",l)),o.http.authedRequest(jn.Put,d,void 0,c.getWireContent(),s)})()}encryptStateEventIfNeeded(e,t){var n=this;return r(function*(){if(n.enableEncryptedStateEvents&&t&&(n.cryptoBackend||!n.usingExternalCrypto)){if(!n.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");(yield n.shouldEncryptEventForRoom(e,t))&&(yield n.cryptoBackend.isStateEncryptionEnabledInRoom(t.roomId))&&(["m.room.create","m.room.member","m.room.join_rules","m.room.power_levels","m.room.third_party_invite","m.room.history_visibility","m.room.guest_access","m.room.encryption"].includes(e.getType())||(yield n.cryptoBackend.encryptEvent(e,t)))}})()}roomInitialSync(e,t){var r,n=x("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(jn.Get,n,{limit:null!==(r=null==t?void 0:t.toString())&&void 0!==r?r:"30"})}setRoomReadMarkersHttpRequest(e,t,n,i){var o=this;return r(function*(){var r=x("/rooms/$roomId/read_markers",{$roomId:e}),s={[k.FullyRead]:t,[k.Read]:n};return((yield o.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield o.isVersionSupported("v1.4")))&&(s[k.ReadPrivate]=i),o.http.authedRequest(jn.Post,r,void 0,s)})()}getJoinedRooms(){var e=x("/joined_rooms",{});return this.http.authedRequest(jn.Get,e)}getJoinedRoomMembers(e){var t=x("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(jn.Get,t)}publicRooms(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{server:t,limit:r,since:n}=e,i=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],-1===t.indexOf(r)&&{}.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(e,hd);if(0===Object.keys(i).length){var o={server:t,limit:r,since:n};return this.http.authedRequest(jn.Get,"/publicRooms",o)}var s={server:t},a=pd({limit:r,since:n},i);return this.http.authedRequest(jn.Post,"/publicRooms",s,a)}createAlias(e,t){var r=x("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(jn.Put,r,void 0,n)}deleteAlias(e){var t=x("/directory/room/$alias",{$alias:e});return this.http.authedRequest(jn.Delete,t)}getLocalAliases(e){var t=x("/rooms/$roomId/aliases",{$roomId:e}),r=ui.V3;return this.http.authedRequest(jn.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=x("/directory/room/$alias",{$alias:e});return this.http.authedRequest(jn.Get,t)}getRoomDirectoryVisibility(e){var t=x("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(jn.Get,t)}setRoomDirectoryVisibility(e,t){var r=x("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(jn.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return void 0!==r&&(n.limit=r),this.http.authedRequest(jn.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?x("/profile/$userId/$info",{$userId:e,$info:t}):x("/profile/$userId",{$userId:e});return this.http.authedRequest(jn.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return r(function*(){return(yield e.doesServerSupportUnstableFeature(Ed))||(yield e.doesServerSupportUnstableFeature(Rd))})()}getExtendedProfileRequestPrefix(){var e=this;return r(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?ui.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return r(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(jn.Get,x("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var n=this;return r(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return(yield n.http.authedRequest(jn.Get,x("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield n.getExtendedProfileRequestPrefix()}))[t]})()}setExtendedProfileProperty(e,t){var n=this;return r(function*(){if(!(yield n.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=n.getUserId();yield n.http.authedRequest(jn.Put,x("/profile/$userId/$key",{$userId:r,$key:e}),void 0,{[e]:t},{prefix:yield n.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return r(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(jn.Delete,x("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return r(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(jn.Patch,x("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return r(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(jn.Put,x("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(jn.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return r(function*(){return t.http.authedRequest(jn.Post,"/account/3pid/add",void 0,e)})()}bindThreePid(e){var t=this;return r(function*(){return t.http.authedRequest(jn.Post,"/account/3pid/bind",void 0,e)})()}unbindThreePid(e,t){var n=this;return r(function*(){var r={medium:e,address:t,id_server:n.getIdentityServerUrl(!0)};return n.http.authedRequest(jn.Post,"/account/3pid/unbind",void 0,r)})()}deleteThreePid(e,t){return this.http.authedRequest(jn.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,r){var n={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(jn.Post,"/account/password",void 0,n)}getDevices(){return this.http.authedRequest(jn.Get,"/devices")}getDevice(e){var t=x("/devices/$device_id",{$device_id:e});return this.http.authedRequest(jn.Get,t)}setDeviceDetails(e,t){var r=x("/devices/$device_id",{$device_id:e});return this.http.authedRequest(jn.Put,r,void 0,t)}deleteDevice(e,t){var r=x("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(jn.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);return this.http.authedRequest(jn.Post,"/delete_devices",void 0,r)}getPushers(){var e=this;return r(function*(){var t=yield e.http.authedRequest(jn.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(e=>(e.hasOwnProperty(it.name)||(e[it.name]=!0),e))),t})()}setPusher(e){return this.http.authedRequest(jn.Post,"/pushers/set",void 0,e)}removePusher(e,t){var r={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(jn.Post,"/pushers/set",void 0,r)}setLocalNotificationSettings(e,t){var r="".concat(st.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(jn.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Ks.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var i=x("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(jn.Put,i,void 0,n)}deletePushRule(e,t,r){var n=x("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(jn.Delete,n)}setPushRuleEnabled(e,t,r,n){var i=x("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(jn.Put,i,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var i=x("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(jn.Put,i,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,i={};return n&&(i.next_batch=n),this.http.authedRequest(jn.Post,"/search",i,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(jn.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(jn.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={device_keys:{}};return void 0!==t&&(r.token=t),e.forEach(e=>{r.device_keys[e]=[]}),this.http.authedRequest(jn.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};for(var[i,o]of(void 0===t&&(t="signed_curve25519"),e)){var s=n[i]||{};ve(n,i,s),ve(s,o,t)}var a={one_time_keys:n};r&&(a.timeout=r);return this.http.authedRequest(jn.Post,"/keys/claim",void 0,a)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(jn.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(jn.Post,"/keys/device_signing/upload",void 0,r,{prefix:ui.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,hi.V2,this.idBaseUrl);return this.http.requestOtherUrl(jn.Post,t,e)}requestEmailToken(e,t,r,n,i){var o={client_secret:t,email:e,send_attempt:null==r?void 0:r.toString()};return n&&(o.next_link=n),this.http.idServerRequest(jn.Post,"/validate/email/requestToken",o,hi.V2,i)}requestMsisdnToken(e,t,r,n,i,o){var s={client_secret:r,country:e,phone_number:t,send_attempt:null==n?void 0:n.toString()};return i&&(s.next_link=i),this.http.idServerRequest(jn.Post,"/validate/msisdn/requestToken",s,hi.V2,o)}submitMsisdnToken(e,t,r,n){var i={sid:e,client_secret:t,token:r};return this.http.idServerRequest(jn.Post,"/validate/msisdn/submitToken",i,hi.V2,null!=n?n:void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var i={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(jn.Post,e,i)}getIdentityHashDetails(e){return this.http.idServerRequest(jn.Get,"/hash_details",void 0,hi.V2,e)}identityHashedLookup(e,t){var n=this;return r(function*(){var i={},o=yield n.getIdentityHashDetails(t);if(!o||!o.lookup_pepper||!o.algorithms)throw new Error("Unsupported identity server: bad response");i.pepper=o.lookup_pepper;var s={};if(o.algorithms.includes("sha256"))i.addresses=yield Promise.all(e.map(function(){var e=r(function*(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n=_o(yield Qc("".concat(t," ").concat(r," ").concat(i.pepper)));return s[n]=e[0],n});return function(t){return e.apply(this,arguments)}}())),i.algorithm="sha256";else{if(!o.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");i.addresses=e.map(e=>{var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n="".concat(t," ").concat(r);return s[n]=e[0],n}),i.algorithm="none"}var a=yield n.http.idServerRequest(jn.Post,"/lookup",i,hi.V2,t);if(null==a||!a.mappings)return[];var c=[];for(var l of Object.keys(a.mappings)){var d=a.mappings[l],u=s[l];if(!u)throw new Error("Identity server returned more results than expected");c.push({address:u,mxid:d})}return c})()}lookupThreePid(e,t,n){var i=this;return r(function*(){var r=(yield i.identityHashedLookup([[t,e]],n)).find(e=>e.address===t);return r?{address:t,medium:e,mxid:r.mxid}:{}})()}bulkLookupThreePids(e,t){var n=this;return r(function*(){var r=yield n.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),i=[],o=function*(t){var r=e.find(e=>e[1]===t.address);if(!r)throw new Error("Identity sever returned unexpected results");i.push([r[0],t.address,t.mxid])};for(var s of r)yield*o(s);return{threepids:i}})()}getIdentityAccount(e){return this.http.idServerRequest(jn.Get,"/account",void 0,hi.V2,e)}sendToDevice(e,t,r){var n=x("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),i={messages:ge(t)},o=new Map;for(var[s,a]of t)o.set(s,Array.from(a.keys()));return this.logger.debug("PUT ".concat(n),o),this.http.authedRequest(jn.Put,n,void 0,i)}encryptAndSendToDevice(e,t,n){var i=this;return r(function*(){if(!i.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var r=yield i.cryptoBackend.encryptToDeviceMessages(e,t,n);yield i.queueToDevice(r)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(jn.Get,"/thirdparty/protocols").then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=x("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(jn.Get,r,t)}getThirdpartyUser(e,t){var r=x("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(jn.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(jn.Get,r)}agreeToTerms(e,t,r,n){var i=this.termsUrlForService(e,t),o={Authorization:"Bearer "+r};return this.http.requestOtherUrl(jn.Post,i,{user_accepts:n},{headers:o})}reportEvent(e,t,r,n){var i=x("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(jn.Post,i,void 0,{score:r,reason:n})}reportRoom(e,t){var r=x("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(jn.Post,r,void 0,{reason:t})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0,o=x("/rooms/$roomId/hierarchy",{$roomId:e}),s={suggested_only:String(n),max_depth:null==r?void 0:r.toString(),from:i,limit:null==t?void 0:t.toString()};return this.http.authedRequest(jn.Get,o,s,void 0,{prefix:ui.V1}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(jn.Get,o,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e})}unstableCreateFileTree(e){var t=this;return r(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:Xs.PrivateChat,power_level_content_override:pd(pd({},da),{},{users:{[t.getUserId()]:100}}),creation_content:{[He]:ze.Space},initial_state:[{type:Je.name,state_key:Qe.name,content:{[Ye.name]:!0}},{type:Ve.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new ha(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if((null==n?void 0:n.getMyMembership())!==lt.Join)return null;var i=n.currentState.getStateEvents(Ve.RoomCreate,""),o=n.currentState.getStateEvents(Je.name,Qe.name);if(!i)throw new Error("Expected single room create event");return null!=o&&null!==(t=o.getContent())&&void 0!==t&&t[Ye.name]?(null===(r=i.getContent())||void 0===r?void 0:r[He])!==ze.Space?null:new ha(this,e):null}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var i=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(jn.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:i,abortSignal:r})}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(Ui.IntentionalMentions)!==xi.Unsupported}getRoomSummary(e,t){var n=this;return r(function*(){var r={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var i=x("/summary/$roomid",{$roomid:e});return yield n.http.authedRequest(jn.Get,i,{via:t},void 0,r)}catch(i){if(i instanceof Vn&&"M_UNRECOGNIZED"===i.errcode){var o=x("/rooms/$roomid/summary",{$roomid:e});return yield n.http.authedRequest(jn.Get,o,{via:t},void 0,r)}throw i}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return r(function*(){return e.http.authedRequest(jn.Get,"/account/whoami")})()}timestampToEvent(e,t,n){var i=this;return r(function*(){var r=x("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:n};try{return yield i.http.authedRequest(jn.Get,r,o,void 0,{prefix:ui.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return yield i.http.authedRequest(jn.Get,r,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}})()}getAuthMetadata(){var e=this;return r(function*(){var t;try{t=yield e.http.request(jn.Get,"/auth_metadata",void 0,void 0,{prefix:ui.Unstable+"/org.matrix.msc2965"})}catch(t){if(t instanceof Vn&&"M_UNRECOGNIZED"===t.errcode){var{issuer:r}=yield e.http.request(jn.Get,"/auth_issuer",void 0,void 0,{prefix:ui.Unstable+"/org.matrix.msc2965"});return sd(r)}throw t}return ad(t)})()}}function Od(e){return Object.fromEntries(Object.entries(e).map(e=>{var[t,r]=e;return["".concat(Sd,".").concat(t),r]}))}function Md(e,t){var r,n=e.getUserId(),i=t.getId(),o=e.getRoom(t.getRoomId());if(o&&n&&i)if(o.findEventById(i)){var s,a=!!t.threadRootId&&!t.isThreadRoot;if(a){var c=o.getThread(t.threadRootId);s=!c||c.hasUserReadEvent(n,i)}else s=o.hasUserReadEvent(n,i);if(!s){var l=e.getPushActionsForEvent(t,!0);if(!(null==l||null===(r=l.tweaks)||void 0===r||!r.highlight)){var d=o.getUnreadCountForEventContext(Ci.Highlight,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,Ci.Highlight,d):o.setUnreadNotificationCount(Ci.Highlight,d)}if(!(null==l||!l.notify)){var u=o.getUnreadCountForEventContext(Ci.Total,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,Ci.Total,u):o.setUnreadNotificationCount(Ci.Total,u)}}}else xe.info("Decrypted event ".concat(t.getId()," is not in room ").concat(o.roomId,": ignoring"))}function Pd(e){return Dd(e)?T:e.threadRootId}function Dd(e){return!e.threadRootId||(!!e.isThreadRoot||(e.isRelation()?!e.isRelation(qd.name)&&e.relationEventId===e.threadRootId:(xe.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(e.getId())),!0)))}function Ad(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function xd(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ad(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ad(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}o(Cd,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");var Ud=function(e){return e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e}({}),Ld=function(e){return e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e}({});function Nd(e,t){return e?Ld.Stable:t?Ld.Experimental:Ld.None}class Fd extends fn{constructor(e,t,n){var i,s;if(super(),i=this,this.id=e,this.rootEvent=t,o(this,"timelineSet",void 0),o(this,"_currentUserParticipated",!1),o(this,"reEmitter",void 0),o(this,"lastEvent",void 0),o(this,"replyCount",0),o(this,"lastPendingEvent",void 0),o(this,"pendingReplyCount",0),o(this,"room",void 0),o(this,"client",void 0),o(this,"pendingEventOrdering",void 0),o(this,"processRootEventPromise",void 0),o(this,"initialEventsFetched",!Fd.hasServerSideSupport),o(this,"initalEventFetchProm",void 0),o(this,"replayEvents",[]),o(this,"onTimelineReset",r(function*(){yield i.processRootEventPromise,i.processRootEventPromise=void 0})),o(this,"onBeforeRedaction",(e,t)=>{null!=e&&e.isRelation(qd.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(Ud.Update,this))}),o(this,"onRedaction",function(){var e=r(function*(e,t,r){if(r===i.id)if(i.replyCount<=0){for(var n of i.timeline)i.clearEventMetadata(n);i.lastEvent=i.rootEvent,i._currentUserParticipated=!1,i.emit(Ud.Delete,i)}else{var o;(null===(o=i.lastEvent)||void 0===o?void 0:o.getId())===e.getAssociatedId()&&(yield i.processRootEventPromise,i.processRootEventPromise=void 0),yield i.updateThreadMetadata()}});return function(t,r,n){return e.apply(this,arguments)}}()),o(this,"onTimelineEvent",(e,t,r)=>{if(!r){var n=e.getSender();n&&t&&this.shouldSendLocalEchoReceipt(n,e)&&t.addLocalEchoReceipt(n,e,k.Read),e.getId()!==this.id&&e.isRelation(qd.name)&&this.replyCount++}this.onEcho(e,null!=r&&r)}),o(this,"onLocalEcho",e=>{this.onEcho(e,!1)}),o(this,"onEcho",function(){var e=r(function*(e,t){e.threadRootId===i.id&&i.lastEvent!==e&&(yield i.updateThreadMetadata(),e.isRelation(qd.name)&&(t||(i.lastEvent=void 0,i.emit(Ud.NewReply,i,e))))});return function(t,r){return e.apply(this,arguments)}}()),this.setMaxListeners(1e3),null==n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=null!==(s=n.pendingEventOrdering)&&void 0!==s?s:_d.Chronological,this.timelineSet=new Ar(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Nr(this),this.reEmitter.reEmit(this.timelineSet,[Oi.Timeline,Oi.TimelineReset]),this.room.on(zd.BeforeRedaction,this.onBeforeRedaction),this.room.on(Oi.Redaction,this.onRedaction),this.room.on(Oi.LocalEchoUpdated,this.onLocalEcho),this.room.on(Oi.TimelineReset,this.onTimelineReset),this.timelineSet.on(Oi.Timeline,this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return r(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(e){xe.error("Failed to fetch thread root to construct thread with",e)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){Fd.hasServerSideSupport=e,e!==Ld.Stable&&(Bd.setPreferUnstable(!0),Kd.setPreferUnstable(!0),qd.setPreferUnstable(!0))}static setServerSideListSupport(e){Fd.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){Fd.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r;if((null!==(r=this.client.canSupport.get(Ui.RelationsRecursion))&&void 0!==r?r:xi.Unsupported)===xi.Unsupported){var n,i=null===(n=this.getReadReceiptForUserId(e))||void 0===n?void 0:n.eventId;if(i){var o=this.findEventById(i);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(Tr.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(e=>this.addEvent(e,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setEventMetadata(e);var n=this.lastReply(),i=!n||e.localTimestamp>=n.localTimestamp;if(Fd.hasServerSideSupport){if(e.isRelation(We.Annotation)||e.isRelation(We.Replace))return void this.addRelatedThreadEvent(e,t);!t&&i?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(qd.name)&&!t&&i&&(this.lastEvent=void 0),r&&(this.emit(Ud.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n,i;this.initialEventsFetched?(null!==(r=this.client.canSupport.get(Ui.RelationsRecursion))&&void 0!==r?r:xi.Unsupported)===xi.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t):(null===(n=this.replayEvents)||void 0===n||n.push(e),e.isRelation(We.Annotation)&&(null===(i=this.timelineSet.relations)||void 0===i||i.aggregateChildEvent(e,this.timelineSet)))}processEvent(e){var t=this;return r(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:i,synthetic:o}of e)this.addReceiptToStructure(t,r,n,i,o)}getRootEventBundledRelationship(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null==e?void 0:e.getServerAggregatedRelation(qd.name)}processRootEvent(){var e=this;return r(function*(){var t=e.getRootEventBundledRelationship();if(Fd.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(xd(xd({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=(this.pendingEventOrdering===_d.Detached?this.room.getPendingEvents():this.events).filter(e=>{var t;return e.threadRootId===this.id&&e.isRelation(qd.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())});this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}resetLiveTimeline(e,t){var n=this;return r(function*(){var r=n.liveTimeline;n.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);var i,o,s=n.liveTimeline;e&&(i=(yield n.client.createMessagesRequest(n.roomId,e,1,kr.Forward)).end);t&&(o=(yield n.client.createMessagesRequest(n.roomId,t,1,kr.Backward)).start);t&&r.getPaginationToken(kr.Forward)===t&&r.setPaginationToken(null!=o?o:null,kr.Forward),e&&s.getPaginationToken(kr.Backward)===e&&s.setPaginationToken(null!=i?i:null,kr.Backward)})()}updateThreadFromRootEvent(){var e=this;return r(function*(){Fd.hasServerSideSupport&&(e.initialEventsFetched||e.lastEvent||(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return r(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{for(var t of(e.timelineSet.resetLiveTimeline(),0===e.replyCount&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,kr.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0,e.replayEvents))e.addEvent(t,!1);e.replayEvents=null,e.emit(Oi.TimelineReset,e.room,e.timelineSet,!0)}catch(t){xe.error("Failed to load start of newly created thread: ",t),e.initialEventsFetched=!1}e.emit(Ud.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return r(function*(){var n;if((null!==(n=t.client.canSupport.get(Ui.RelationsRecursion))&&void 0!==n?n:xi.Unsupported)===xi.Unsupported){for(var i=e.length,o=new Array(i),s=0;s<i;s++)o[s]=e[s];return Promise.all(o.filter(jd).map(function(){var e=r(function*(e){try{var r=yield t.client.relations(t.roomId,e.getId(),We.Replace,e.getType(),{limit:1});if(r.events.length){var n=r.events[0];e.makeReplaced(n),t.insertEventIntoTimeline(n)}}catch(e){xe.error("Failed to load edits for encrypted thread event",e)}});return function(t){return e.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(Tr.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t;e&&(e.setThread(void 0),null===(t=e.event)||void 0===t||null===(t=t.unsigned)||void 0===t||null===(t=t["m.relations"])||void 0===t||delete t[qd.name])}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e=>e.isRelation(qd.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof $d}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var i=n.getTs()<this.room.getOldestThreadedReceiptTs(),o=n.getId();if(i&&o)return o}var s=super.getEventReadUpTo(e,t);if(n){var a=this.room.getLastUnthreadedReceiptFor(e);if(!a)return s;for(var c=(null===(l=this.timeline)||void 0===l?void 0:l.length)-1;c>=0;--c){var l,d,u=this.timeline[c];if(u.getId()===s)return s;if(u.getTs()<a.ts)return null!==(d=u.getId())&&void 0!==d?d:s}}return s}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,i,o,s,a,c=(null!==(r=null===(n=this.lastReply())||void 0===n?void 0:n.getTs())&&void 0!==r?r:0)<this.room.getOldestThreadedReceiptTs(),l=null!==(i=null===(o=this.room.getLastUnthreadedReceiptFor(e))||void 0===o?void 0:o.ts)&&void 0!==i?i:0,d=(null!==(s=null==this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==s?s:0)<l;if(c||d)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}function jd(e){return e.isEncrypted()&&(e.isRelation(qd.name)||e.isThreadRoot)}o(Fd,"hasServerSideSupport",Ld.None),o(Fd,"hasServerSideListSupport",Ld.None),o(Fd,"hasServerSideFwdPaginationSupport",Ld.None);var Bd=new b("related_by_senders","io.element.relation_senders"),Kd=new b("related_by_rel_types","io.element.relation_types"),qd=new b("m.thread","io.element.thread"),Vd=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});function Wd(e){return e===Vd.My?"participated":"all"}class Gd extends Error{constructor(e,t,r){super(t),this.code=e,o(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=function(e,t){var r=e.name+"[msg: "+e.message;t&&(r+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return r+="]"}(this,r)}}var Hd=Object.freeze({visible:!0}),zd=function(e){return e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e.SentinelUpdated="Event.sentinelUpdated",e}({});class $d extends qe{setMetadata(e,t){var r,n,i=this.isState()&&this.getType()===Ve.RoomMember&&this.getSender()===this.getStateKey(),o=!1;if(i||null===(r=this.sender)||void 0===r||null===(r=r.events)||void 0===r||!r.member){var s=e.getSentinelMember(this.getSender());s!==this.sender&&(o=!0),this.sender=s}if(i||(null===(n=this.target)||void 0===n||null===(n=n.events)||void 0===n||!n.member)&&this.getType()===Ve.RoomMember){var a=e.getSentinelMember(this.getStateKey());a!==this.target&&(o=!0),this.target=a}this.isState()&&t&&(this.forwardLooking=!1),o&&this.emit(zd.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.event=t,o(this,"pushDetails",{}),o(this,"_replacingEvent",null),o(this,"_localRedactionEvent",null),o(this,"_isCancelled",!1),o(this,"clearEvent",void 0),o(this,"visibility",Hd),o(this,"_hasCachedExtEv",!1),o(this,"_cachedExtEv",void 0),o(this,"_decryptionFailureReason",null),o(this,"senderCurve25519Key",null),o(this,"claimedEd25519Key",null),o(this,"forwardingCurve25519KeyChain",[]),o(this,"untrusted",null),o(this,"decryptionPromise",null),o(this,"retryDecryption",!1),o(this,"txnId",void 0),o(this,"thread",void 0),o(this,"threadId",void 0),o(this,"localTimestamp",void 0),o(this,"sender",null),o(this,"target",null),o(this,"status",null),o(this,"error",null),o(this,"forwardLooking",!0),o(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(e=>{"string"==typeof t[e]&&(t[e]=P(t[e]))}),["membership","avatar_url","displayname"].forEach(e=>{var r;"string"==typeof(null===(r=t.content)||void 0===r?void 0:r[e])&&(t.content[e]=P(t.content[e]))}),["rel_type"].forEach(e=>{var r;"string"==typeof(null===(r=t.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r[e])&&(t.content["m.relates_to"][e]=P(t.content["m.relates_to"][e]))}),this.txnId=t.txn_id;var r=this.getAge();this.localTimestamp=void 0!==r?Date.now()-r:null!==(e=this.getTs())&&void 0!==e?e:Date.now(),this.reEmitter=new Nr(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=Er.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===Ve.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e,t=this.getRoomId();if(t)return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(t," ts=").concat(null===(e=this.getDate())||void 0===e?void 0:e.toISOString());var r=this.getContent()[$e];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}getOriginalContent(){var e,t;return this._localRedactionEvent?{}:this.clearEvent?null!==(t=this.clearEvent.content)&&void 0!==t?t:{}:null!==(e=this.event.content)&&void 0!==e?e:{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?null!==(e=this._replacingEvent.getContent()["m.new_content"])&&void 0!==e?e:{}:this.getOriginalContent();var e}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===qd.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;var r=this.getUnsigned();return"string"==typeof r[at.name]?r[at.name]:void 0}}get isThreadRoot(){return!this.isState()&&(!!this.getServerAggregatedRelation(qd.name)||this.threadRootId===this.getId())}get replyEventId(){var e;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(e=e["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e;return null===(e=this.getWireContent())||void 0===e||null===(e=e["m.relates_to"])||void 0===e?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.clearEvent?this.clearEvent.state_key:this.event.state_key}getWireStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getMembershipAtEvent(){var e=this.getUnsigned();return ct.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content,state_key:this.event.state_key},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n,this.isState()&&(this.event.state_key="".concat(this.clearEvent.type,":").concat(this.clearEvent.state_key))}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return null!==this._decryptionFailureReason}get decryptionFailureReason(){return this._decryptionFailureReason}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}attemptDecryption(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]?t[1]:{};if(!n.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var i=n.clearEvent&&!n.isDecryptionFailure(),o=r.forceRedecryptIfUntrusted&&n.isKeySourceUntrusted();if(i&&!o)throw new Error("Attempt to decrypt event which has already been decrypted");return n.decryptionPromise?(xe.log("Event ".concat(n.getId()," already being decrypted; queueing a retry")),n.retryDecryption=!0,n.decryptionPromise):(n.decryptionPromise=n.decryptionLoop(e,r),n.decryptionPromise)})()}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}decryptionLoop(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]?t[1]:{};for(yield Promise.resolve();;){n.retryDecryption=!1;var i=void 0;try{var o=yield e.decryptEvent(n);!0===r.isRetry&&xe.info("Decrypted event on retry (".concat(n.getDetails(),")")),n.setClearData(o),n._decryptionFailureReason=null}catch(e){var s=e instanceof Gd?e.detailedString:String(e);if(i=e,n.retryDecryption){xe.log("Error decrypting event (".concat(n.getDetails(),"), but retrying: ").concat(s));continue}xe.warn("Error decrypting event (".concat(n.getDetails(),"): ").concat(s)),n.setClearDataForDecryptionFailure(String(e)),n._decryptionFailureReason=e instanceof Gd?e.code:za.UNKNOWN_ERROR}return n.decryptionPromise=null,n.retryDecryption=!1,n.setPushDetails(),void(!1!==r.emit&&n.emit(zd.Decrypted,n,i))}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(r=e.claimedEd25519Key)&&void 0!==r?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:Ve.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return this.event.type===Ve.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(zd.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=null===(t=null==e?void 0:e.visible)||void 0===t||t,i=null!==(r=null==e?void 0:e.reason)&&void 0!==r?r:null,o=!1;this.visibility.visible!==n?o=!0:this.visibility.visible||this.visibility.reason===i||(o=!0),o&&(this.visibility=n?Hd:Object.freeze({visible:!1,reason:i}),this.emit(zd.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");for(var r in this._localRedactionEvent=null,this.emit(zd.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(r)&&!Jd.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in Yd?Yd[this.getType()]:{},i=this.getContent();for(var o in i)i.hasOwnProperty(o)&&!n[o]&&delete i[o];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;(null===(n=r.getRelation())||void 0===n?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;null===(t=this.thread)||void 0===t||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(Tr.FORWARDS),!1)}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===Ve.RoomRedaction}asVisibilityChange(){if(!nt.matches(this.getType()))return null;var e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,i=r.reason;return i&&"string"!=typeof i?null:{visible:n,reason:i,eventId:t}}isVisibilityEvent(){return nt.matches(this.getType())}getRedactionEvent(){var e,t,r,n;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(r=null===(n=this.clearEvent)||void 0===n?void 0:n.unsigned.redacted_because)&&void 0!==r?r:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,r=this.getUnsigned(),n=this.getId();this.event=e,r.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=r.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(zd.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-(null!==(t=this.getAge())&&void 0!==t?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(zd.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(zd.LocalEventIdReplaced,this)}isRelation(e){var t,r=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return!(this.isState()&&null!=r&&r.rel_type&&[We.Replace,We.Thread].includes(r.rel_type))&&!(null==r||!r.rel_type||!r.event_id||e&&r.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit(zd.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(We.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(We.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return null!==(r=this._replacingEvent.getDate())&&void 0!==r?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new $d(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))"event"!==t&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=j(this.event),r=j(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[Ud.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[Ud.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var Jd=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),Yd={[Ve.RoomMember]:{membership:1},[Ve.RoomJoinRules]:{join_rule:1},[Ve.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},Qd=["1","2","3","4","5","6","7","8","9","10","11"];var Xd=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished",e}(Xd||{}),Zd=function(e){return e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker",e}({});class eu extends qe{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:Xd.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,o(this,"reEmitter",new Nr(this)),o(this,"sentinels",{}),o(this,"displayNameToUserIds",new Map),o(this,"userIdsToDisplayNames",{}),o(this,"tokenToInvite",{}),o(this,"joinedMemberCount",null),o(this,"summaryJoinedMemberCount",null),o(this,"invitedMemberCount",null),o(this,"summaryInvitedMemberCount",null),o(this,"modified",-1),o(this,"members",{}),o(this,"events",new Map),o(this,"paginationToken",null),o(this,"beacons",new Map),o(this,"_liveBeaconIds",[]),o(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(Ve.RoomCreate,"");return t?null!==(e=t.getContent().room_version)&&void 0!==e?e:"1":(this.getVersionWarning||(xe.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===lt.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===lt.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(void 0===t){t=new ut(this.roomId,e);var r=this.members[e];null!=r&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new eu(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=Xd.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==Xd.Finished&&this.getMembers().forEach(t=>{var r;t.isOutOfBand()&&(null===(r=e.getMember(t.userId))||void 0===r||r.markOutOfBand())}),e}setUnknownStateEvents(e){var t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState()){Ta.matches(e.getType())&&this.setBeacon(e);var t,r=this.getStateEventMatching(e);if(this.setStateEvent(e),e.getType()===Ve.RoomMember)this.updateDisplayNameCache(e.getStateKey(),null!==(t=e.getContent().displayname)&&void 0!==t?t:""),this.updateThirdPartyTokenCache(e);this.emit(Zd.Events,e,this,r)}}),this.onBeaconLivenessChange(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===Ve.RoomMember){var r=e.getStateKey();e.getContent().membership!==lt.Leave&&e.getContent().membership!==lt.Ban||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=this.getOrCreateMember(r,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(Zd.Members,e,this,n)}else if(e.getType()===Ve.RoomPowerLevels){if(""!==e.getStateKey())return;var i=Object.values(this.members),o=this.getStateEvents(Ve.RoomCreate,""),s=tu(this.getRoomVersion(),o);i.forEach(t=>{var r=t.getLastModifiedTime();if(o){var n=ru(t.userId,e,s);t.setPowerLevel(n,e)}r!==t.getLastModifiedTime()&&this.emit(Zd.Members,e,this,t)}),this.sentinels={}}else et.matches(e.getType())&&this.emit(Zd.Marker,e,t)}),this.emit(Zd.Update,this)}processBeaconEvents(e,t){var n=this;return r(function*(){if(e.length&&n.beacons.size){var i,o=[...n.beacons.values()].reduce((e,t)=>(e[t.beaconInfoId]=t,e),{}),s=(e,t)=>{if(Ca.matches(t.getType())){var r=o[e];r&&r.addLocations([t])}},a=function*(e){var n,i=null===(n=e.getRelation())||void 0===n?void 0:n.event_id;if(!i||!o[i])return{v:void 0};if(!Ca.matches(e.getType())&&!e.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(e),s(i,e)}catch(t){e.isDecryptionFailure()&&e.once(zd.Decrypted,r(function*(){s(i,e)}))}};for(var c of e)if(i=yield*a(c))return i.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new ut(this.roomId,e),this.members[e]=r,this.emit(Zd.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=gn(e);if(this.beacons.has(t)){var r,n=this.beacons.get(t);return e.isRedacted()?void(n.beaconInfoId===(null===(r=e.getRedactionEvent())||void 0===r?void 0:r.redacts)&&(n.destroy(),this.beacons.delete(t))):n.update(e)}if(!e.isRedacted()){var i=new pn(e);this.reEmitter.reEmit(i,[un.New,un.Update,un.Destroy,un.LivenessChange]),this.emit(un.New,e,i),i.on(un.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(un.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(Zd.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return null!==(t=null===(r=this.events.get(e.getType()))||void 0===r?void 0:r.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){var t=this.getStateEvents(Ve.RoomCreate,""),r=this.getStateEvents(Ve.RoomPowerLevels,"");if(r&&t){var n=ru(e.userId,r,tu(this.getRoomVersion(),t));e.setPowerLevel(n,r)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===Xd.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===Xd.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===Xd.NotStarted&&(this.oobMemberFlags.status=Xd.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===Xd.InProgress&&(this.oobMemberFlags.status=Xd.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),xe.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=Xd.NotStarted}setOutOfBandMembers(e){xe.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===Xd.InProgress&&(xe.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=Xd.Finished,e.forEach(e=>this.setOutOfBandMember(e)),this.emit(Zd.Update,this))}setOutOfBandMember(e){if(e.getType()===Ve.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(Zd.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get(K(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);return!(!r||r.membership===lt.Leave)&&(!e.status&&!e.isRedacted()&&(!!this.maySendEvent(Ve.RoomRedaction,t)&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",r.powerLevel))))}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(Ve.RoomPowerLevels,""),n={};r&&(n=r.getContent());var i=50;return B(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(Ve.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!(t.isGuest()||!t.credentials.userId)&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n,i,o=this.getStateEvents(Ve.RoomPowerLevels,""),s={},a=0,c=0;o&&(s=(i=o.getContent()).events||{},a=Number.isSafeInteger(i.state_default)?i.state_default:50,Number.isSafeInteger(i.events_default)&&(c=i.events_default));var l=r?a:c;Number.isSafeInteger(s[e])&&(l=s[e]);var d=this.getMember(t);return(null!==(n=null==d?void 0:d.powerLevel)&&void 0!==n?n:0)>=l}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(Ve.RoomPowerLevels,""),i=50;return n&&n.getContent()&&n.getContent().notifications&&B(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i}getJoinRule(){var e,t=this.getStateEvents(Ve.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||Zs.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(Ve.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||ra.Shared}getGuestAccess(){var e,t=this.getStateEvents(Ve.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||ta.Forbidden}findPredecessor(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]){var e=this.getStateEvents(Ve.RoomPredecessor,"");if(e){var t=e.getContent(),r=t.predecessor_room_id,n=t.last_known_event_id;"string"!=typeof n&&(n=void 0);var i=t.via_servers;if(Array.isArray(i)||(i=void 0),"string"==typeof r)return{roomId:r,eventId:n,viaServers:i}}}var o=this.getStateEvents(Ve.RoomCreate,"");if(o){var s=o.getContent().predecessor;if(s){var a=s.room_id;if("string"==typeof a){var c=s.event_id;return"string"==typeof c&&""!==c||(c=void 0),{roomId:a,eventId:c}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t)this.getStateEvents(Ve.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=K(r),i=this.displayNameToUserIds.get(n);if(i){var o=i.filter(t=>t!==e);this.displayNameToUserIds.set(n,o)}}this.userIdsToDisplayNames[e]=t;var s=t&&K(t);if(s){var a,c=null!==(a=this.displayNameToUserIds.get(s))&&void 0!==a?a:[];c.push(e),this.displayNameToUserIds.set(s,c)}}}function tu(e,t){var r=new Set;if(function(e){return!Qd.includes(e)}(e)&&t){var n=t.getSender();n&&r.add(n);var i=t.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(e=>r.add(e))}return r}function ru(e,t,r){if(r.has(e))return 1/0;var n=t.getDirectionalContent(),i=n.users||{};return void 0!==i[e]&&Number.isInteger(i[e])?i[e]:void 0!==n.users_default?n.users_default:0}function nu(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class iu{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,"rooms",{}),o(this,"users",{}),o(this,"syncToken",null),o(this,"filters",new _e(()=>new Map)),o(this,"accountData",new Map),o(this,"localStorage",void 0),o(this,"oobMembers",new Map),o(this,"pendingEvents",{}),o(this,"clientOptions",void 0),o(this,"pendingToDeviceBatches",[]),o(this,"nextToDeviceBatchId",0),o(this,"createUser",void 0),o(this,"onRoomMember",(e,t,r)=>{var n;if(r.membership!==lt.Invite){var i=this.users[r.userId]||(null===(n=this.createUser)||void 0===n?void 0:n.call(this,r.userId));r.name&&(i.setDisplayName(r.name),r.events.member&&i.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&i.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[i.userId]=i}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(Zd.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(Zd.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){null!=e&&e.userId&&null!=e&&e.filterId&&this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return(null===(r=this.filters.get(e))||void 0===r?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(nu(r))return r}catch(e){}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{nu(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(e){}}}storeAccountDataEvents(e){e.forEach(e=>{!Object.keys(e.getContent()).length?this.accountData.delete(e.getType()):this.accountData.set(e.getType(),e)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new _e(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return r(function*(){var r;return null!==(r=t.pendingEvents[e])&&void 0!==r?r:[]})()}setPendingEvents(e,t){var n=this;return r(function*(){n.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return r(function*(){return 0===e.pendingToDeviceBatches.length?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return r(function*(){})()}}var ou,su={},au={},cu={};function lu(){if(ou)return cu;ou=1,Object.defineProperty(cu,"__esModule",{value:!0}),cu.WidgetApiDirection=void 0,cu.invertedDirection=function(t){if(t===e.ToWidget)return e.FromWidget;if(t===e.FromWidget)return e.ToWidget;throw new Error("Invalid direction")};var e=function(e){return e.ToWidget="toWidget",e.FromWidget="fromWidget",e}({});return cu.WidgetApiDirection=e,cu}var du,uu={};function hu(){if(du)return uu;du=1,Object.defineProperty(uu,"__esModule",{value:!0}),uu.UnstableApiVersion=uu.MatrixApiVersion=uu.CurrentApiVersions=void 0;var e=function(e){return e.Prerelease1="0.0.1",e.Prerelease2="0.0.2",e}({});uu.MatrixApiVersion=e;var t=function(e){return e.MSC2762="org.matrix.msc2762",e.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",e.MSC2871="org.matrix.msc2871",e.MSC2873="org.matrix.msc2873",e.MSC2931="org.matrix.msc2931",e.MSC2974="org.matrix.msc2974",e.MSC2876="org.matrix.msc2876",e.MSC3819="org.matrix.msc3819",e.MSC3846="town.robin.msc3846",e.MSC3869="org.matrix.msc3869",e.MSC3973="org.matrix.msc3973",e.MSC4039="org.matrix.msc4039",e}({});uu.UnstableApiVersion=t;var r=[e.Prerelease1,e.Prerelease2,t.MSC2762,t.MSC2762_UPDATE_STATE,t.MSC2871,t.MSC2873,t.MSC2931,t.MSC2974,t.MSC2876,t.MSC3819,t.MSC3846,t.MSC3869,t.MSC3973,t.MSC4039];return uu.CurrentApiVersions=r,uu}var gu,pu={};function vu(){if(gu)return pu;gu=1,Object.defineProperty(pu,"__esModule",{value:!0}),pu.PostmessageTransport=void 0;var e=je(),t=fh(),r=["message"];function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){h(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function a(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,g(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var r,i=u(e);if(t){var o=u(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}(this,r)}}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function h(e,t,r){return(t=g(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function g(e){var t=function(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t);if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===n(t)?t:String(t)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(o,e);var n=l(o);function o(e,t,r,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(s=n.call(this)).sendDirection=e,s.initialWidgetId=t,s.transportWindow=r,s.inboundWindow=i,h(d(s),"strictOriginCheck",!1),h(d(s),"targetOrigin","*"),h(d(s),"timeoutSeconds",10),h(d(s),"_ready",!1),h(d(s),"_widgetId",null),h(d(s),"outboundRequests",new Map),h(d(s),"stopController",new AbortController),s._widgetId=t,s}return a(o,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var e="widgetapi-".concat(Date.now()),t=0,r=e;this.outboundRequests.has(r);)r="".concat(e,"-").concat(t++);return this.outboundRequests.set(r,null),r}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(s(s({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then(function(e){return e.response})}},{key:"sendComplete",value:function(e,r){var n=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var i={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:r};return e===t.WidgetApiToWidgetAction.UpdateVisibility&&(i.visible=r.visible),new Promise(function(e,t){var r=function(e){a(),t(e)},o=setTimeout(function(){return r(new Error("Request timed out"))},1e3*(n.timeoutSeconds||1)),s=function(){return r(new Error("Transport stopped"))};n.stopController.signal.addEventListener("abort",s);var a=function(){n.outboundRequests.delete(i.requestId),clearTimeout(o),n.stopController.signal.removeEventListener("abort",s)};n.outboundRequests.set(i.requestId,{request:i,resolve:function(t){a(),e(t)},reject:r}),n.sendInternal(i)})}},{key:"start",value:function(){var e=this;this.inboundWindow.addEventListener("message",function(t){e.handleMessage(t)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(e){if(!this.stopController.signal.aborted&&e.data&&(!this.strictOriginCheck||e.origin===window.origin)){var r=e.data;if(r.action&&r.requestId&&r.widgetId)if(r.response){if(r.api!==this.sendDirection)return;this.handleResponse(r)}else{var n=r;if(n.api!==(0,t.invertedDirection)(this.sendDirection))return;this.handleRequest(n)}}}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var n=this.outboundRequests.get(e.requestId);if(n)if((0,t.isErrorResponse)(e.response)){var o=e.response.error,s=o.message,a=i(o,r);n.reject(new t.WidgetApiResponseError(s,a))}else n.resolve(e)}}}]),o}(e.EventEmitter);return pu.PostmessageTransport=p,pu}var mu,_u={};function fu(){if(mu)return _u;mu=1,Object.defineProperty(_u,"__esModule",{value:!0}),_u.WidgetApiToWidgetAction=_u.WidgetApiFromWidgetAction=void 0;var e=function(e){return e.SupportedApiVersions="supported_api_versions",e.Capabilities="capabilities",e.NotifyCapabilities="notify_capabilities",e.ThemeChange="theme_change",e.LanguageChange="language_change",e.TakeScreenshot="screenshot",e.UpdateVisibility="visibility",e.OpenIDCredentials="openid_credentials",e.WidgetConfig="widget_config",e.CloseModalWidget="close_modal",e.ButtonClicked="button_clicked",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.UpdateState="update_state",e.UpdateTurnServers="update_turn_servers",e}({});_u.WidgetApiToWidgetAction=e;var t=function(e){return e.SupportedApiVersions="supported_api_versions",e.ContentLoaded="content_loaded",e.SendSticker="m.sticker",e.UpdateAlwaysOnScreen="set_always_on_screen",e.GetOpenIDCredentials="get_openid",e.CloseModalWidget="close_modal",e.OpenModalWidget="open_modal",e.SetModalButtonEnabled="set_button_enabled",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.WatchTurnServers="watch_turn_servers",e.UnwatchTurnServers="unwatch_turn_servers",e.BeeperReadRoomAccountData="com.beeper.read_room_account_data",e.MSC2876ReadEvents="org.matrix.msc2876.read_events",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",e.MSC3869ReadRelations="org.matrix.msc3869.read_relations",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",e.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",e.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e}({});return _u.WidgetApiFromWidgetAction=t,_u}var yu,bu={};function wu(){if(yu)return bu;yu=1,Object.defineProperty(bu,"__esModule",{value:!0}),bu.OpenIDRequestState=void 0;var e=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});return bu.OpenIDRequestState=e,bu}var Su,Eu={};function Ru(){if(Su)return Eu;Su=1,Object.defineProperty(Eu,"__esModule",{value:!0}),Eu.MatrixWidgetType=void 0;var e=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});return Eu.MatrixWidgetType=e,Eu}var Iu,ku={};function Tu(){if(Iu)return ku;Iu=1,Object.defineProperty(ku,"__esModule",{value:!0}),ku.BuiltInModalButtonID=void 0;var e=function(e){return e.Close="m.close",e}({});return ku.BuiltInModalButtonID=e,ku}var Cu,Ou={};function Mu(){if(Cu)return Ou;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}(e))||t){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw s}}}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}function i(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,r);if("object"!==e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"===e(r)?r:String(r)}Cu=1,Object.defineProperty(Ou,"__esModule",{value:!0}),Ou.WidgetEventCapability=Ou.EventKind=Ou.EventDirection=void 0;var o=function(e){return e.Event="event",e.State="state_event",e.ToDevice="to_device",e.RoomAccount="room_account",e}({});Ou.EventKind=o;var s=function(e){return e.Send="send",e.Receive="receive",e}({});Ou.EventDirection=s;var a=function(){function e(t,r,n,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.direction=t,this.eventType=r,this.kind=n,this.keyStr=i,this.raw=o}var r,i,a;return r=e,i=[{key:"matchesAsStateEvent",value:function(e,t,r){return this.kind===o.State&&this.direction===e&&this.eventType===t&&(null===this.keyStr||this.keyStr===r)}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===o.ToDevice&&this.direction===e&&this.eventType===t}},{key:"matchesAsRoomEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===o.Event&&this.direction===e&&this.eventType===t&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===r)}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===o.RoomAccount&&this.direction===e&&this.eventType===t}}],a=[{key:"forStateEvent",value:function(t,r,n){r=r.replace(/#/g,"\\#"),n=null!=n?"#".concat(n):"";var i="org.matrix.msc2762.".concat(t,".state_event:").concat(r).concat(n);return e.findEventCapabilities([i])[0]}},{key:"forToDeviceEvent",value:function(t,r){var n="org.matrix.msc3819.".concat(t,".to_device:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(t,r){var n="org.matrix.msc2762.".concat(t,".event:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(t,r){r=null==r?"":r;var n="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(t,r){var n="com.beeper.capabilities.".concat(t,".room_account_data:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(r){var n,i=[],a=t(r);try{for(a.s();!(n=a.n()).done;){var c=n.value,l=null,d=void 0,u=null;if(c.startsWith("org.matrix.msc2762.send.event:")?(l=s.Send,u=o.Event,d=c.substring(30)):c.startsWith("org.matrix.msc2762.send.state_event:")?(l=s.Send,u=o.State,d=c.substring(36)):c.startsWith("org.matrix.msc3819.send.to_device:")?(l=s.Send,u=o.ToDevice,d=c.substring(34)):c.startsWith("org.matrix.msc2762.receive.event:")?(l=s.Receive,u=o.Event,d=c.substring(33)):c.startsWith("org.matrix.msc2762.receive.state_event:")?(l=s.Receive,u=o.State,d=c.substring(39)):c.startsWith("org.matrix.msc3819.receive.to_device:")?(l=s.Receive,u=o.ToDevice,d=c.substring(37)):c.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(l=s.Receive,u=o.RoomAccount,d=c.substring(50)),null!==l&&null!==u&&void 0!==d){var h=d.startsWith("m.room.message#")||u===o.State,g=null;if(d.includes("#")&&h){var p=d.split("#"),v=p.findIndex(function(e){return!e.endsWith("\\")});d=p.slice(0,v+1).map(function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e}).join("#"),g=p.slice(v+1).join("#")}i.push(new e(l,d,u,g,c))}}}catch(e){a.e(e)}finally{a.f()}return i}}],i&&n(r.prototype,i),a&&n(r,a),Object.defineProperty(r,"prototype",{writable:!1}),e}();return Ou.WidgetEventCapability=a,Ou}var Pu,Du,Au={};function xu(){if(Pu)return Au;Pu=1,Object.defineProperty(Au,"__esModule",{value:!0}),Au.Symbols=void 0;var e=function(e){return e.AnyRoom="*",e}({});return Au.Symbols=e,Au}function Uu(){if(Du)return au;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}Du=1,Object.defineProperty(au,"__esModule",{value:!0}),au.WidgetApiResponseError=au.WidgetApi=void 0;var t=je(),r=lu(),n=hu(),i=vu(),o=fu(),s=wu(),a=Ru(),c=Tu(),l=Mu(),d=xu();function u(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */u=function(){return t};var t={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof p?t:p,s=Object.create(o.prototype),a=new T(n||[]);return i(s,"_invoke",{value:E(e,r,a)}),s}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var g={};function p(){}function v(){}function m(){}var _={};l(_,s,function(){return this});var f=Object.getPrototypeOf,y=f&&f(f(C([])));y&&y!==r&&n.call(y,s)&&(_=y);var b=m.prototype=p.prototype=Object.create(_);function w(e){["next","throw","return"].forEach(function(t){l(e,t,function(e){return this._invoke(t,e)})})}function S(t,r){function o(i,s,a,c){var l=h(t[i],t,s);if("throw"!==l.type){var d=l.arg,u=d.value;return u&&"object"==e(u)&&n.call(u,"__await")?r.resolve(u.__await).then(function(e){o("next",e,a,c)},function(e){o("throw",e,a,c)}):r.resolve(u).then(function(e){d.value=e,a(d)},function(e){return o("throw",e,a,c)})}c(l.arg)}var s;i(this,"_invoke",{value:function(e,t){function n(){return new r(function(r,n){o(e,t,r,n)})}return s=s?s.then(n,n):n()}})}function E(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=R(s,r);if(a){if(a===g)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=h(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function R(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,R(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=h(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,g;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,g):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function C(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,i=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:O}}function O(){return{value:void 0,done:!0}}return v.prototype=m,i(b,"constructor",{value:m,configurable:!0}),i(m,"constructor",{value:v,configurable:!0}),v.displayName=l(m,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,l(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},w(S.prototype),l(S.prototype,a,function(){return this}),t.AsyncIterator=S,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var s=new S(d(e,r,n,i),o);return t.isGeneratorFunction(r)?s:s.next().then(function(e){return e.done?e.value:s.next()})},w(b),l(b,c,"Generator"),l(b,s,function(){return this}),l(b,"toString",function(){return"[object Generator]"}),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=C,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var a=n.call(o,"catchLoc"),c=n.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;k(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),g}},t}function h(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function g(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function s(e){h(o,n,i,s,a,"next",e)}function a(e){h(o,n,i,s,a,"throw",e)}s(void 0)})}}function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach(function(t){m(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function m(e,t,r){return(t=f(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,f(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function f(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,r);if("object"!==e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function w(t){var r=I();return function(){var n,i=T(t);if(r){var o=T(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return function(t,r){if(r&&("object"===e(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return S(t)}(this,n)}}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function E(e){var t="function"==typeof Map?new Map:void 0;return E=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return R(e,arguments,T(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),k(n,e)},E(e)}function R(e,t,r){return R=I()?Reflect.construct.bind():function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&k(i,r.prototype),i},R.apply(null,arguments)}function I(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function T(e){return T=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},T(e)}function C(e){return new M(e,0)}function O(e){var t,r;function n(t,r){try{var o=e[t](r),s=o.value,a=s instanceof M;Promise.resolve(a?s.v:s).then(function(r){if(a){var c="return"===t?"return":"next";if(!s.k||r.done)return n(c,r);r=e[c](r).value}i(o.done?"return":"normal",r)},function(e){n("throw",e)})}catch(e){i("throw",e)}}function i(e,i){switch(e){case"return":t.resolve({value:i,done:!0});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:!1})}(t=t.next)?n(t.key,t.arg):r=null}this._invoke=function(e,i){return new Promise(function(o,s){var a={key:e,arg:i,resolve:o,reject:s,next:null};r?r=r.next=a:(t=r=a,n(e,i))})},"function"!=typeof e.return&&(this.return=void 0)}function M(e,t){this.v=e,this.k=t}O.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},O.prototype.next=function(e){return this._invoke("next",e)},O.prototype.throw=function(e){return this._invoke("throw",e)},O.prototype.return=function(e){return this._invoke("return",e)};var P=function(e){b(r,e);var t=w(r);function r(e,n){var i;return y(this,r),(i=t.call(this,e)).data=n,i}return _(r)}(E(Error));au.WidgetApiResponseError=P,P.prototype.name=P.name;var D=function(e){b(I,e);var t,h,p,f,E,R=w(I);function I(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(y(this,I),(e=R.call(this)).clientOrigin=n,m(S(e),"transport",void 0),m(S(e),"capabilitiesFinished",!1),m(S(e),"supportsMSC2974Renegotiate",!1),m(S(e),"requestedCapabilities",[]),m(S(e),"approvedCapabilities",void 0),m(S(e),"cachedClientVersions",void 0),m(S(e),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new i.PostmessageTransport(r.WidgetApiDirection.FromWidget,t,window.parent,window),e.transport.targetOrigin=n,e.transport.on("message",e.handleMessage.bind(S(e))),e}return _(I,[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t=this;e.forEach(function(e){return t.requestCapability(e)})}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(l.WidgetEventCapability.forStateEvent(l.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(l.WidgetEventCapability.forStateEvent(l.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(l.WidgetEventCapability.forToDeviceEvent(l.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(l.WidgetEventCapability.forToDeviceEvent(l.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(l.WidgetEventCapability.forRoomEvent(l.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(l.WidgetEventCapability.forRoomEvent(l.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(l.WidgetEventCapability.forRoomMessageEvent(l.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(l.WidgetEventCapability.forRoomMessageEvent(l.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(l.WidgetEventCapability.forRoomAccountData(l.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise(function(t,r){e.transport.sendComplete(o.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(n){var i=n.response;if(i.state===s.OpenIDRequestState.Allowed)t(i);else if(i.state===s.OpenIDRequestState.Blocked)r(new Error("User declined to verify their identity"));else if(i.state===s.OpenIDRequestState.PendingUserConfirmation){e.on("action:".concat(o.WidgetApiToWidgetAction.OpenIDCredentials),function a(c){c.preventDefault();var l=c.detail;l.data.original_request_id===n.requestId&&(l.data.state===s.OpenIDRequestState.Allowed?(t(l.data),e.transport.reply(l,{})):l.data.state===s.OpenIDRequestState.Blocked?(r(new Error("User declined to verify their identity")),e.transport.reply(l,{})):(r(new Error("Invalid state on reply: "+i.state)),e.transport.reply(l,{error:{message:"Invalid state"}})),e.off("action:".concat(o.WidgetApiToWidgetAction.OpenIDCredentials),a))})}else r(new Error("Invalid state: "+i.state))}).catch(r)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(o.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(o.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(o.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(o.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then(function(e){return e.success})}},{key:"openModalWidget",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:a.MatrixWidgetType.Custom;return this.transport.send(o.WidgetApiFromWidgetAction.OpenModalWidget,{type:i,url:e,name:t,buttons:r,data:n}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(o.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,r,n,i){return this.sendEvent(e,void 0,t,r,n,i)}},{key:"sendStateEvent",value:function(e,t,r,n,i,o){return this.sendEvent(e,t,r,n,i,o)}},{key:"sendEvent",value:function(e,t,r,n,i,s){return this.transport.send(o.WidgetApiFromWidgetAction.SendEvent,v(v(v(v({type:e,content:r},void 0!==t&&{state_key:t}),void 0!==n&&{room_id:n}),void 0!==i&&{delay:i}),void 0!==s&&{parent_delay_id:s}))}},{key:"updateDelayedEvent",value:function(e,t){return this.transport.send(o.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:t})}},{key:"sendToDevice",value:function(e,t,r){return this.transport.send(o.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:r})}},{key:"readRoomAccountData",value:function(e,t){var r={type:e};return t&&(t.includes(d.Symbols.AnyRoom)?r.room_ids=d.Symbols.AnyRoom:r.room_ids=t),this.transport.send(o.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,r).then(function(e){return e.events})}},{key:"readRoomEvents",value:function(e,t,r,n,i){var s={type:e,msgtype:r};return void 0!==t&&(s.limit=t),n&&(n.includes(d.Symbols.AnyRoom)?s.room_ids=d.Symbols.AnyRoom:s.room_ids=n),i&&(s.since=i),this.transport.send(o.WidgetApiFromWidgetAction.MSC2876ReadEvents,s).then(function(e){return e.events})}},{key:"readEventRelations",value:(E=g(u().mark(function e(t,r,i,s,a,c,l,d){var h;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(n.UnstableApiVersion.MSC3869)){e.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return h={event_id:t,rel_type:i,event_type:s,room_id:r,to:l,from:c,limit:a,direction:d},e.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC3869ReadRelations,h));case 7:case"end":return e.stop()}},e,this)})),function(e,t,r,n,i,o,s,a){return E.apply(this,arguments)})},{key:"readStateEvents",value:function(e,t,r,n){var i={type:e,state_key:void 0===r||r};return void 0!==t&&(i.limit=t),n&&(n.includes(d.Symbols.AnyRoom)?i.room_ids=d.Symbols.AnyRoom:i.room_ids=n),this.transport.send(o.WidgetApiFromWidgetAction.MSC2876ReadEvents,i).then(function(e){return e.events})}},{key:"setModalButtonEnabled",value:function(e,t){if(e===c.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(o.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(o.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e,t=this;return(e=u().mark(function e(){var r,n;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=function(){var e=g(u().mark(function e(n){return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n.preventDefault(),r(n.detail.data),e.next=4,t.transport.reply(n.detail,{});case 4:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),t.on("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),n),0!==t.turnServerWatchers){e.next=12;break}return e.prev=3,e.next=6,C(t.transport.send(o.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(3),t.off("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),n),e.t0;case 12:t.turnServerWatchers++,e.prev=13;case 14:return e.next=17,C(new Promise(function(e){return r=e}));case 17:return e.next=19,e.sent;case 19:e.next=14;break;case 21:if(e.prev=21,t.off("action:".concat(o.WidgetApiToWidgetAction.UpdateTurnServers),n),t.turnServerWatchers--,0!==t.turnServerWatchers){e.next=27;break}return e.next=27,C(t.transport.send(o.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return e.finish(21);case 28:case"end":return e.stop()}},e,null,[[3,8],[13,,21,28]])}),function(){return new O(e.apply(this,arguments))})()}},{key:"searchUserDirectory",value:(f=g(u().mark(function e(t,r){var i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(n.UnstableApiVersion.MSC3973)){e.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return i={search_term:t,limit:r},e.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,i));case 7:case"end":return e.stop()}},e,this)})),function(e,t){return f.apply(this,arguments)})},{key:"getMediaConfig",value:(p=g(u().mark(function e(){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(n.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return t={},e.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,t));case 7:case"end":return e.stop()}},e,this)})),function(){return p.apply(this,arguments)})},{key:"uploadFile",value:(h=g(u().mark(function e(t){var r;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(n.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return r={file:t},e.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039UploadFileAction,r));case 7:case"end":return e.stop()}},e,this)})),function(e){return h.apply(this,arguments)})},{key:"downloadFile",value:(t=g(u().mark(function e(t){var r;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(n.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return r={content_uri:t},e.abrupt("return",this.transport.send(o.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,r));case 7:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then(function(t){t.includes(n.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case o.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case o.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case o.WidgetApiToWidgetAction.UpdateVisibility:case o.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:n.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(o.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions}).catch(function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]})}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(r){return r.includes(n.UnstableApiVersion.MSC2871)?t.once("action:".concat(o.WidgetApiToWidgetAction.NotifyCapabilities),function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")}):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})})}}]),I}(t.EventEmitter);return au.WidgetApi=D,au}var Lu,Nu={},Fu={};function ju(){if(Lu)return Fu;Lu=1,Object.defineProperty(Fu,"__esModule",{value:!0}),Fu.VideoConferenceCapabilities=Fu.StickerpickerCapabilities=Fu.MatrixCapabilities=void 0,Fu.getTimelineRoomIDFromCapability=function(e){return e.substring(e.indexOf(":")+1)},Fu.isTimelineCapability=function(e){return null==e?void 0:e.startsWith("org.matrix.msc2762.timeline:")},Fu.isTimelineCapabilityFor=function(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)};var e=function(e){return e.Screenshots="m.capability.screenshot",e.StickerSending="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.RequiresClient="io.element.requires_client",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC3846TurnServers="town.robin.msc3846.turn_servers",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039UploadFile="org.matrix.msc4039.upload_file",e.MSC4039DownloadFile="org.matrix.msc4039.download_file",e.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e}({});Fu.MatrixCapabilities=e;var t=[e.StickerSending];Fu.StickerpickerCapabilities=t;var r=[e.AlwaysOnScreen];return Fu.VideoConferenceCapabilities=r,Fu}var Bu,Ku={};function qu(){if(Bu)return Ku;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}(e))||t){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw s}}}}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function n(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,r);if("object"!==e(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}Bu=1,Object.defineProperty(Ku,"__esModule",{value:!0}),Ku.SimpleObservable=void 0;var o=function(){function e(t){var r,n,o;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r=this,o=[],(n=i(n="listeners"))in r?Object.defineProperty(r,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[n]=o,t&&this.listeners.push(t)}return n(e,[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var r,n=t(this.listeners);try{for(n.s();!(r=n.n()).done;){(0,r.value)(e)}}catch(e){n.e(e)}finally{n.f()}}},{key:"close",value:function(){this.listeners=[]}}]),e}();return Ku.SimpleObservable=o,Ku}var Vu,Wu,Gu={};function Hu(){if(Vu)return Gu;Vu=1,Object.defineProperty(Gu,"__esModule",{value:!0}),Gu.UpdateDelayedEventAction=void 0;var e=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({});return Gu.UpdateDelayedEventAction=e,Gu}function zu(){if(Wu)return Nu;Wu=1,Object.defineProperty(Nu,"__esModule",{value:!0}),Nu.ClientWidgetApi=void 0;var e=je(),t=vu(),r=lu(),n=fu(),i=ju(),o=hu(),s=Mu(),a=wu(),c=qu(),l=xu(),d=Hu();function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach(function(t){k(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function p(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=m(e))||t){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function v(e){return function(e){if(Array.isArray(e))return _(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||m(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e,t){if(e){if("string"==typeof e)return _(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_(e,t):void 0}}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function f(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */f=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function l(e,t,r,i){var o=t&&t.prototype instanceof g?t:g,s=Object.create(o.prototype),a=new T(i||[]);return n(s,"_invoke",{value:E(e,r,a)}),s}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=l;var h={};function g(){}function p(){}function v(){}var m={};c(m,o,function(){return this});var _=Object.getPrototypeOf,y=_&&_(_(C([])));y&&y!==t&&r.call(y,o)&&(m=y);var b=v.prototype=g.prototype=Object.create(m);function w(e){["next","throw","return"].forEach(function(t){c(e,t,function(e){return this._invoke(t,e)})})}function S(e,t){function i(n,o,s,a){var c=d(e[n],e,o);if("throw"!==c.type){var l=c.arg,h=l.value;return h&&"object"==u(h)&&r.call(h,"__await")?t.resolve(h.__await).then(function(e){i("next",e,s,a)},function(e){i("throw",e,s,a)}):t.resolve(h).then(function(e){l.value=e,s(l)},function(e){return i("throw",e,s,a)})}a(c.arg)}var o;n(this,"_invoke",{value:function(e,r){function n(){return new t(function(t,n){i(e,r,t,n)})}return o=o?o.then(n,n):n()}})}function E(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=R(s,r);if(a){if(a===h)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=d(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function R(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,R(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var i=d(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function C(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:O}}function O(){return{value:void 0,done:!0}}return p.prototype=v,n(b,"constructor",{value:v,configurable:!0}),n(v,"constructor",{value:p,configurable:!0}),p.displayName=c(v,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,c(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(S.prototype),c(S.prototype,s,function(){return this}),e.AsyncIterator=S,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new S(l(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then(function(e){return e.done?e.value:s.next()})},w(b),c(b,a,"Generator"),c(b,o,function(){return this}),c(b,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=C,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;k(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:C(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},e}function y(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function b(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function s(e){y(o,n,i,s,a,"next",e)}function a(e){y(o,n,i,s,a,"throw",e)}s(void 0)})}}function w(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,T(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function S(e,t){return S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},S(e,t)}function E(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var r,n=I(e);if(t){var i=I(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return function(e,t){if(t&&("object"===u(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return R(e)}(this,r)}}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function I(e){return I=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},I(e)}function k(e,t,r){return(t=T(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function T(e){var t=function(e,t){if("object"!==u(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!==u(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===u(t)?t:String(t)}function C(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new O(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function O(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return O=function(e){this.s=e,this.n=e.next},O.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new O(e)}var M=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&S(e,t)}(j,e);var u,h,m,_,y,I,T,O,M,P,D,A,x,U,L,N,F=E(j);function j(e,n,i){var o;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,j),(o=F.call(this)).widget=e,o.iframe=n,o.driver=i,k(R(o),"transport",void 0),k(R(o),"cachedWidgetVersions",null),k(R(o),"contentLoadedActionSent",!1),k(R(o),"allowedCapabilities",new Set),k(R(o),"allowedEvents",[]),k(R(o),"isStopped",!1),k(R(o),"turnServers",null),k(R(o),"contentLoadedWaitTimer",void 0),k(R(o),"pushRoomStateTasks",new Set),k(R(o),"pushRoomStateResult",new Map),k(R(o),"flushRoomStateTask",null),k(R(o),"viewedRoomId",null),null==n||!n.contentWindow)throw new Error("No iframe supplied");if(!e)throw new Error("Invalid widget");if(!i)throw new Error("Invalid driver");return o.transport=new t.PostmessageTransport(r.WidgetApiDirection.ToWidget,e.id,n.contentWindow,window),o.transport.targetOrigin=e.origin,o.transport.on("message",o.handleMessage.bind(R(o))),n.addEventListener("load",o.onIframeLoad.bind(R(o))),o.transport.start(),o}return w(j,[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(l.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(s.EventDirection.Send,e,t)})}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(s.EventDirection.Send,e,t)})}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(s.EventDirection.Send,e)})}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(s.EventDirection.Receive,e,t)})}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(s.EventDirection.Receive,e,t)})}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(s.EventDirection.Receive,e)})}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsRoomAccountData(s.EventDirection.Receive,e)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:(N=b(f().mark(function e(){var t;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){e.next=2;break}return e.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return e.prev=2,e.next=5,this.transport.send(n.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return t=e.sent,this.cachedWidgetVersions=t.supported_versions,e.abrupt("return",t.supported_versions);case 10:return e.prev=10,e.t0=e.catch(2),console.warn("non-fatal error getting supported widget versions: ",e.t0),e.abrupt("return",[]);case 14:case"end":return e.stop()}},e,this,[[2,10]])})),function(){return N.apply(this,arguments)})},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(n.WidgetApiToWidgetAction.Capabilities,{}).then(function(r){return e=r.capabilities,t.driver.validateCapabilities(new Set(r.capabilities))}).then(function(r){t.allowCapabilities(v(r),e),t.emit("ready")}).catch(function(e){t.emit("error:preparing",e)})}},{key:"allowCapabilities",value:function(e,t){var r,o=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),e);var a,c=p(e);try{for(c.s();!(a=c.n()).done;){var d=a.value;this.allowedCapabilities.add(d)}}catch(e){c.e(e)}finally{c.f()}var u=s.WidgetEventCapability.findEventCapabilities(e);(r=this.allowedEvents).push.apply(r,v(u)),this.transport.send(n.WidgetApiToWidgetAction.NotifyCapabilities,{requested:t,approved:Array.from(this.allowedCapabilities)}).catch(function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)}).then(function(){o.emit("capabilitiesNotified")});var h,g=p(e);try{for(g.s();!(h=g.n()).done;){var m=h.value;if((0,i.isTimelineCapability)(m)){var _=(0,i.getTimelineRoomIDFromCapability)(m);if(_===l.Symbols.AnyRoom){var f,y=p(this.driver.getKnownRooms());try{for(y.s();!(f=y.n()).done;){var b=f.value;this.pushRoomState(b)}}catch(e){y.e(e)}finally{y.f()}}else this.pushRoomState(_)}}}catch(e){g.e(e)}finally{g.f()}u.length>0&&null!==this.viewedRoomId&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:o.CurrentApiVersions})}},{key:"supportsUpdateState",value:(L=b(f().mark(function e(){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWidgetVersions();case 2:return e.abrupt("return",e.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return e.stop()}},e,this)})),function(){return L.apply(this,arguments)})},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,r=this;this.transport.reply(e,{});var n=(null===(t=e.data)||void 0===t?void 0:t.capabilities)||[],i=new Set(n.filter(function(e){return!r.hasCapability(e)}));0===i.size&&this.allowCapabilities([],[]),this.driver.validateCapabilities(i).then(function(e){return r.allowCapabilities(v(e),v(i))})}},{key:"handleNavigate",value:function(e){var t,r,n=this;if(!this.hasCapability(i.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(null===(t=e.data)||void 0===t||!t.uri||null===(r=e.data)||void 0===r||!r.uri.toString().startsWith("https://matrix.to/#"))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var o=function(t){console.error("[ClientWidgetApi] Failed to handle navigation: ",t),n.handleDriverError(t,e,"Error handling navigation")};try{this.driver.navigate(e.data.uri.toString()).catch(function(e){return o(e)}).then(function(){return n.transport.reply(e,{})})}catch(e){return o(e)}}},{key:"handleOIDC",value:function(e){var t=this,r=1,i=function(i,o){return o=o||{},r>1?t.transport.send(n.WidgetApiToWidgetAction.OpenIDCredentials,g({state:i,original_request_id:e.requestId},o)):t.transport.reply(e,g({state:i},o))},o=function(n){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",n),r>1?i(a.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:n}})},s=new c.SimpleObservable(function(e){return e.state===a.OpenIDRequestState.PendingUserConfirmation&&r>1?(s.close(),o("client provided out-of-phase response to OIDC flow")):e.state===a.OpenIDRequestState.PendingUserConfirmation?(i(e.state),void r++):e.state!==a.OpenIDRequestState.Allowed||e.token?(e.state===a.OpenIDRequestState.Blocked&&(e.token=void 0),s.close(),i(e.state,e.token)):o("client provided invalid OIDC token for an allowed request")});this.driver.askOpenID(s)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,r=Promise.resolve([]);return r=this.driver.readRoomAccountData(e.data.type),this.canReceiveRoomAccountData(e.data.type)?r.then(function(r){t.transport.reply(e,{events:r})}):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:(U=b(f().mark(function e(t){var r,n,i,o,s,a,c,d,u,h,g=this;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event type"}}));case 2:if(void 0===t.data.limit||t.data.limit&&!(t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0!==t.data.room_ids){e.next=8;break}r=null===this.viewedRoomId?[]:[this.viewedRoomId],e.next=30;break;case 8:if(t.data.room_ids!==l.Symbols.AnyRoom){e.next=12;break}r=this.driver.getKnownRooms().filter(function(e){return g.canUseRoomTimeline(e)}),e.next=30;break;case 12:r=t.data.room_ids,n=p(r),e.prev=14,n.s();case 16:if((i=n.n()).done){e.next=22;break}if(o=i.value,this.canUseRoomTimeline(o)){e.next=20;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(o)}}));case 20:e.next=16;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(14),n.e(e.t0);case 27:return e.prev=27,n.f(),e.finish(27);case 30:if(s=t.data.limit||0,a=t.data.since,c=void 0,d=void 0,void 0===t.data.state_key){e.next=40;break}if(c=!0===t.data.state_key?void 0:t.data.state_key.toString(),this.canReceiveStateEvent(t.data.type,null!==(u=c)&&void 0!==u?u:null)){e.next=38;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read state events of this type"}}));case 38:e.next=43;break;case 40:if(d=t.data.msgtype,this.canReceiveRoomEvent(t.data.type,d)){e.next=43;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read room events of this type"}}));case 43:if(void 0!==t.data.room_ids||0!==r.length){e.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),e.next=47,void 0===t.data.state_key?this.driver.readRoomEvents(t.data.type,d,s,null,a):this.driver.readStateEvents(t.data.type,c,s,null);case 47:h=e.sent,e.next=68;break;case 50:return e.next=52,this.supportsUpdateState();case 52:if(!e.sent){e.next=58;break}return e.next=55,Promise.all(r.map(function(e){return g.driver.readRoomTimeline(e,t.data.type,d,c,s,a)}));case 55:h=e.sent.flat(1),e.next=68;break;case 58:if(void 0!==t.data.state_key){e.next=64;break}return e.next=61,Promise.all(r.map(function(e){return g.driver.readRoomTimeline(e,t.data.type,d,c,s,a)}));case 61:e.t1=e.sent,e.next=67;break;case 64:return e.next=66,Promise.all(r.map(function(e){return g.driver.readRoomState(e,t.data.type,c)}));case 66:e.t1=e.sent;case 67:h=e.t1.flat(1);case 68:this.transport.reply(t,{events:h});case 69:case"end":return e.stop()}},e,this,[[14,24,27,30]])})),function(e){return U.apply(this,arguments)})},{key:"handleSendEvent",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});var r,n=void 0!==e.data.delay||void 0!==e.data.parent_delay_id;if(n&&!this.hasCapability(i.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});if(void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});var o,s;if(n)r=this.driver.sendDelayedEvent(null!==(o=e.data.delay)&&void 0!==o?o:null,null!==(s=e.data.parent_delay_id)&&void 0!==s?s:null,e.data.type,e.data.content||{},e.data.state_key,e.data.room_id);else r=this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var a,c,l=e.data.content||{},d=l.msgtype;if(!this.canSendRoomEvent(e.data.type,d))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});if(n)r=this.driver.sendDelayedEvent(null!==(a=e.data.delay)&&void 0!==a?a:null,null!==(c=e.data.parent_delay_id)&&void 0!==c?c:null,e.data.type,l,null,e.data.room_id);else r=this.driver.sendEvent(e.data.type,l,null,e.data.room_id)}r.then(function(r){return t.transport.reply(e,g({room_id:r.roomId},"eventId"in r?{event_id:r.eventId}:{delay_id:r.delayId}))}).catch(function(r){console.error("error sending event: ",r),t.handleDriverError(r,e,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(e){var t=this;if(!e.data.delay_id)return this.transport.reply(e,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(i.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});switch(e.data.action){case d.UpdateDelayedEventAction.Cancel:case d.UpdateDelayedEventAction.Restart:case d.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(e.data.delay_id,e.data.action).then(function(){return t.transport.reply(e,{})}).catch(function(r){console.error("error updating delayed event: ",r),t.handleDriverError(r,e,"Error updating delayed event")});break;default:return this.transport.reply(e,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:(x=b(f().mark(function e(t){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Invalid request - missing event type"}});case 3:e.next=31;break;case 5:if(t.data.messages){e.next=10;break}return e.next=8,this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}});case 8:e.next=31;break;case 10:if("boolean"==typeof t.data.encrypted){e.next=15;break}return e.next=13,this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}});case 13:e.next=31;break;case 15:if(this.canSendToDeviceEvent(t.data.type)){e.next=20;break}return e.next=18,this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}});case 18:e.next=31;break;case 20:return e.prev=20,e.next=23,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 23:return e.next=25,this.transport.reply(t,{});case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(20),console.error("error sending to-device event",e.t0),this.handleDriverError(e.t0,t,"Error sending event");case 31:case"end":return e.stop()}},e,this,[[20,27]])})),function(e){return x.apply(this,arguments)})},{key:"pollTurnServers",value:(A=b(f().mark(function e(t,r){var i,o,s,a,c,l;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,r);case 3:i=!1,o=!1,e.prev=5,a=C(t);case 7:return e.next=9,a.next();case 9:if(!(i=!(c=e.sent).done)){e.next=16;break}return l=c.value,e.next=13,this.transport.send(n.WidgetApiToWidgetAction.UpdateTurnServers,l);case 13:i=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),o=!0,s=e.t0;case 22:if(e.prev=22,e.prev=23,!i||null==a.return){e.next=27;break}return e.next=27,a.return();case 27:if(e.prev=27,!o){e.next=30;break}throw s;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e.catch(0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}},e,this,[[0,34],[5,18,22,32],[23,,27,31]])})),function(e,t){return A.apply(this,arguments)})},{key:"handleWatchTurnServers",value:(D=b(f().mark(function e(t){var r,n,o,s;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=30;break;case 5:if(!this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.prev=10,r=this.driver.getTurnServers(),e.next=14,r.next();case 14:if(n=e.sent,o=n.done,s=n.value,!o){e.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return e.next=21,this.transport.reply(t,{});case 21:this.pollTurnServers(r,s),this.turnServers=r,e.next=30;break;case 25:return e.prev=25,e.t0=e.catch(10),console.error("error getting first TURN server results",e.t0),e.next=30,this.transport.reply(t,{error:{message:"TURN servers not available"}});case 30:case"end":return e.stop()}},e,this,[[10,25]])})),function(e){return D.apply(this,arguments)})},{key:"handleUnwatchTurnServers",value:(P=b(f().mark(function e(t){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=15;break;case 5:if(this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,e.next=15,this.transport.reply(t,{});case 15:case"end":return e.stop()}},e,this)})),function(e){return P.apply(this,arguments)})},{key:"handleReadRelations",value:(M=b(f().mark(function e(t){var r,n,i=this;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0===t.data.room_id||this.canUseRoomTimeline(t.data.room_id)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return r=e.sent,n=r.chunk.filter(function(e){return void 0!==e.state_key?i.canReceiveStateEvent(e.type,e.state_key):i.canReceiveRoomEvent(e.type,e.content.msgtype)}),e.abrupt("return",this.transport.reply(t,{chunk:n,prev_batch:r.prevBatch,next_batch:r.nextBatch}));case 14:e.prev=14,e.t0=e.catch(6),console.error("error getting the relations",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while reading relations");case 18:case"end":return e.stop()}},e,this,[[6,14]])})),function(e){return M.apply(this,arguments)})},{key:"handleUserDirectorySearch",value:(O=b(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if("string"==typeof t.data.search_term){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return r=e.sent,e.abrupt("return",this.transport.reply(t,{limited:r.limited,results:r.results.map(function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}})}));case 13:e.prev=13,e.t0=e.catch(6),console.error("error searching in the user directory",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while searching in the user directory");case 17:case"end":return e.stop()}},e,this,[[6,13]])})),function(e){return O.apply(this,arguments)})},{key:"handleGetMediaConfig",value:(T=b(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,r));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while getting the media configuration",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while getting the media configuration");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return T.apply(this,arguments)})},{key:"handleUploadFile",value:(I=b(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:r.contentUri}));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while uploading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while uploading a file");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return I.apply(this,arguments)})},{key:"handleDownloadFile",value:(y=b(f().mark(function e(t){var r;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(i.MatrixCapabilities.MSC4039DownloadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.downloadFile(t.data.content_uri);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{file:r.file}));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while downloading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while downloading a file");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return y.apply(this,arguments)})},{key:"handleDriverError",value:function(e,t,r){var n=this.driver.processError(e);this.transport.reply(t,{error:g({message:r},n)})}},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case n.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case n.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case n.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case n.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case n.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case n.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case n.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case n.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case n.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case n.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case n.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case n.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case n.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case n.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case n.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);case n.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(e.detail);case n.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}}},{key:"updateTheme",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.ThemeChange,e)}},{key:"updateLanguage",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.LanguageChange,{lang:e})}},{key:"takeScreenshot",value:function(){return this.transport.send(n.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(n.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:(_=b(f().mark(function e(t,r){var i;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==r&&this.setViewedRoomId(r),t.room_id===this.viewedRoomId||this.canUseRoomTimeline(t.room_id)){e.next=3;break}return e.abrupt("return");case 3:if(void 0===t.state_key||null===t.state_key){e.next=8;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=6;break}return e.abrupt("return");case 6:e.next=10;break;case 8:if(this.canReceiveRoomEvent(t.type,null===(i=t.content)||void 0===i?void 0:i.msgtype)){e.next=10;break}return e.abrupt("return");case 10:return e.next=12,this.transport.send(n.WidgetApiToWidgetAction.SendEvent,t);case 12:case"end":return e.stop()}},e,this)})),function(e,t){return _.apply(this,arguments)})},{key:"feedToDevice",value:(m=b(f().mark(function e(t,r){return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(n.WidgetApiToWidgetAction.SendToDevice,g(g({},t),{},{encrypted:r}));case 3:case"end":return e.stop()}},e,this)})),function(e,t){return m.apply(this,arguments)})},{key:"setViewedRoomId",value:function(e){this.viewedRoomId=e,null===e||this.canUseRoomTimeline(e)||this.pushRoomState(e)}},{key:"flushRoomState",value:(h=b(f().mark(function e(){var t,r,i,s,a,c,l;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0;case 1:return e.next=3,Promise.all(v(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){e.next=1;break}case 4:t=[],r=p(this.pushRoomStateResult.values());try{for(r.s();!(i=r.n()).done;){s=i.value,a=p(s.values());try{for(a.s();!(c=a.n()).done;)l=c.value,t.push.apply(t,v(l.values()))}catch(e){a.e(e)}finally{a.f()}}}catch(e){r.e(e)}finally{r.f()}return e.next=9,this.getWidgetVersions();case 9:if(!e.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=12;break}return e.next=12,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:t});case 12:return e.prev=12,this.flushRoomStateTask=null,e.finish(12);case 15:case"end":return e.stop()}},e,this,[[0,,12,15]])})),function(){return h.apply(this,arguments)})},{key:"pushRoomState",value:function(e){var t,r=this,n=p(this.allowedEvents);try{var i=function(){var n=t.value;if(n.kind===s.EventKind.State&&n.direction===s.EventDirection.Receive){var i,o,a=r.driver.readRoomState(e,n.eventType,null!==(i=n.keyStr)&&void 0!==i?i:void 0).then(function(t){var i,o=p(t);try{for(o.s();!(i=o.n()).done;){var s=i.value,a=r.pushRoomStateResult.get(e);void 0===a&&(a=new Map,r.pushRoomStateResult.set(e,a));var c=a.get(n.eventType);void 0===c&&(c=new Map,a.set(n.eventType,c)),c.has(s.state_key)||c.set(s.state_key,s)}}catch(e){o.e(e)}finally{o.f()}},function(t){return console.error("Failed to read room state for ".concat(e," (").concat(n.eventType,", ").concat(n.keyStr,")"),t)}).then(function(){r.pushRoomStateTasks.delete(a)});r.pushRoomStateTasks.add(a),null!==(o=r.flushRoomStateTask)&&void 0!==o||(r.flushRoomStateTask=r.flushRoomState()),r.flushRoomStateTask.catch(function(e){return console.error("Failed to push room state",e)})}};for(n.s();!(t=n.n()).done;)i()}catch(e){n.e(e)}finally{n.f()}}},{key:"feedStateUpdate",value:(u=b(f().mark(function e(t){var r,i;return f().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==t.state_key){e.next=2;break}throw new Error("Not a state event");case 2:if(t.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(t.room_id)||!this.canReceiveStateEvent(t.type,t.state_key)){e.next=21;break}if(0!==this.pushRoomStateTasks.size){e.next=11;break}return e.next=6,this.getWidgetVersions();case 6:if(!e.sent.includes(o.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=9;break}return e.next=9,this.transport.send(n.WidgetApiToWidgetAction.UpdateState,{state:[t]});case 9:e.next=21;break;case 11:void 0===(r=this.pushRoomStateResult.get(t.room_id))&&(r=new Map,this.pushRoomStateResult.set(t.room_id,r)),void 0===(i=r.get(t.type))&&(i=new Map,r.set(t.type,i)),i.has(t.type)||i.set(t.state_key,t);case 16:return e.next=18,Promise.all(v(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){e.next=16;break}case 19:return e.next=21,this.flushRoomStateTask;case 21:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})}]),j}(e.EventEmitter);return Nu.ClientWidgetApi=M,Nu}var $u,Ju={};var Yu,Qu={};var Xu,Zu={};var eh,th={};function rh(){if(eh)return th;return eh=1,Object.defineProperty(th,"__esModule",{value:!0}),th.isValidUrl=function(e){if(!e)return!1;try{var t=new URL(e);return"http"===t.protocol||"https"===t.protocol}catch(e){if(e instanceof TypeError)return!1;throw e}},th}var nh,ih={};function oh(){if(nh)return ih;return nh=1,Object.defineProperty(ih,"__esModule",{value:!0}),ih.assertPresent=function(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))},ih}var sh,ah={};function ch(){if(sh)return ah;sh=1,Object.defineProperty(ah,"__esModule",{value:!0}),ah.Widget=void 0;var e=oh(),t=fh();function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!==r(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"===r(t)?t:String(t)}var o=function(){function r(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),this.definition=t,!this.definition)throw new Error("Definition is required");(0,e.assertPresent)(t,"id"),(0,e.assertPresent)(t,"creatorUserId"),(0,e.assertPresent)(t,"type"),(0,e.assertPresent)(t,"url")}return n(r,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,t.runTemplate)(this.templateUrl,this.definition,e)}}]),r}();return ah.Widget=o,ah}var lh,dh={};function uh(){if(lh)return dh;lh=1,Object.defineProperty(dh,"__esModule",{value:!0}),dh.WidgetParser=void 0;var e=ch(),t=rh();function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return i(e,t)}(e))||t){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(c)throw s}}}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function o(e,t,r){return r&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,s(n.key),n)}}(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!==r(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"===r(t)?t:String(t)}var a=function(){function r(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r)}return o(r,0,[{key:"parseAccountData",value:function(e){if(!e)return[];for(var t=[],n=0,i=Object.keys(e);n<i.length;n++){var o=i[n],s=e[o];if(s)if("m.widget"===s.type||"im.vector.modular.widgets"===s.type)if(s.sender)if((s.state_key||s.id)===o){var a={content:s.content,sender:s.sender,type:"m.widget",state_key:o,event_id:"$example",room_id:"!example",origin_server_ts:1},c=r.parseRoomWidget(a);c&&t.push(c)}}return t}},{key:"parseWidgetsFromRoomState",value:function(e){if(!e)return[];var t,i=[],o=n(e);try{for(o.s();!(t=o.n()).done;){var s=t.value,a=r.parseRoomWidget(s);a&&i.push(a)}}catch(e){o.e(e)}finally{o.f()}return i}},{key:"parseRoomWidget",value:function(e){if(!e)return null;if("m.widget"!==e.type&&"im.vector.modular.widgets"!==e.type)return null;var t=e.content||{},n={id:e.state_key,creatorUserId:t.creatorUserId||e.sender,name:t.name,type:t.type,url:t.url,waitForIframeLoad:t.waitForIframeLoad,data:t.data};return r.processEstimatedWidget(n)}},{key:"processEstimatedWidget",value:function(r){return r.id&&r.creatorUserId&&r.type&&(0,t.isValidUrl)(r.url)?new e.Widget(r):null}}]),r}();return dh.WidgetParser=a,dh}var hh,gh={};var ph,vh,mh={};function _h(){if(ph)return mh;ph=1,Object.defineProperty(mh,"__esModule",{value:!0}),mh.WidgetDriver=void 0;var e=fh();function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function r(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,n(i.key),i)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(e){var r=function(e,r){if("object"!==t(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,r);if("object"!==t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"===t(r)?r:String(r)}var i=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t)}return r(t,[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(e,t,r,n){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,r){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(e,t,r,n,i,o){return void 0===n?this.readRoomEvents(t,r,i,[e],o):this.readStateEvents(t,n,i,[e])}},{key:"readRoomState",value:function(e,t,r){return this.readStateEvents(t,r,Number.MAX_SAFE_INTEGER,[e])}},{key:"readEventRelations",value:function(e,t,r,n,i,o,s,a){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(t){t.update({state:e.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(e){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(e){}}]),t}();return mh.WidgetDriver=i,mh}function fh(){return vh||(vh=1,function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=Uu();Object.keys(t).forEach(function(r){"default"!==r&&"__esModule"!==r&&(r in e&&e[r]===t[r]||Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[r]}}))});var r=zu();Object.keys(r).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===r[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[t]}}))});var n=xu();Object.keys(n).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===n[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return n[t]}}))});var i=vu();Object.keys(i).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===i[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return i[t]}}))});var o=Ru();Object.keys(o).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===o[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}}))});var s=function(){if($u)return Ju;function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}return $u=1,Object.defineProperty(Ju,"__esModule",{value:!0}),Ju.isErrorResponse=function(t){var r=t.error;return"object"===e(r)&&null!==r&&"message"in r&&"string"==typeof r.message},Ju}();Object.keys(s).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===s[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return s[t]}}))});var a=fu();Object.keys(a).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===a[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return a[t]}}))});var c=lu();Object.keys(c).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===c[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return c[t]}}))});var l=hu();Object.keys(l).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===l[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return l[t]}}))});var d=ju();Object.keys(d).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===d[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return d[t]}}))});var u=wu();Object.keys(u).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===u[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return u[t]}}))});var h=function(){if(Yu)return Qu;Yu=1,Object.defineProperty(Qu,"__esModule",{value:!0}),Qu.WidgetKind=void 0;var e=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});return Qu.WidgetKind=e,Qu}();Object.keys(h).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===h[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return h[t]}}))});var g=function(){if(Xu)return Zu;Xu=1,Object.defineProperty(Zu,"__esModule",{value:!0}),Zu.ModalButtonKind=void 0;var e=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});return Zu.ModalButtonKind=e,Zu}();Object.keys(g).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===g[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return g[t]}}))});var p=Tu();Object.keys(p).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===p[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return p[t]}}))});var v=Hu();Object.keys(v).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===v[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return v[t]}}))});var m=Mu();Object.keys(m).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===m[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return m[t]}}))});var _=rh();Object.keys(_).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===_[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return _[t]}}))});var f=oh();Object.keys(f).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===f[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return f[t]}}))});var y=ch();Object.keys(y).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===y[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return y[t]}}))});var b=uh();Object.keys(b).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===b[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return b[t]}}))});var w=function(){if(hh)return gh;function e(e){return null==e?"".concat(e):String(e)}return hh=1,Object.defineProperty(gh,"__esModule",{value:!0}),gh.runTemplate=function(t,r,n){for(var i=Object.assign({},r.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:r.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),o=t,s=0,a=Object.keys(i);s<a.length;s++){var c=a[s],l="$".concat(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(l,"g");o=o.replace(d,encodeURIComponent(e(i[c])))}return o},gh.toString=e,gh}();Object.keys(w).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===w[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return w[t]}}))});var S=qu();Object.keys(S).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===S[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return S[t]}}))});var E=_h();Object.keys(E).forEach(function(t){"default"!==t&&"__esModule"!==t&&(t in e&&e[t]===E[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return E[t]}}))})}(su)),su}var yh=fh();function bh(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function wh(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?bh(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):bh(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function Sh(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return Sh=function(e){this.s=e,this.n=e.next},Sh.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new Sh(e)}var Eh=function(e){return e.PendingEventsChanged="PendingEvent.pendingEventsChanged",e}({});class Rh extends Cd{constructor(e,t,n,i,s){var a,c,l,d,u,h,g,p,v,m,_,f,y,b;super(i),a=this,this.widgetApi=e,this.capabilities=t,this.roomId=n,o(this,"room",void 0),o(this,"widgetApiReady",void 0),o(this,"roomStateSynced",void 0),o(this,"lifecycle",void 0),o(this,"syncState",null),o(this,"pendingSendingEventsTxId",[]),o(this,"eventEmitter",new qe),o(this,"updateTxId",function(){var e=r(function*(e){if(e.getSender()===a.getUserId()&&a.pendingSendingEventsTxId.some(t=>e.getType()===t.type)){for(var t,r=null===(t=a.pendingSendingEventsTxId.find(t=>t.id===e.getId()))||void 0===t?void 0:t.txId;!r&&a.pendingSendingEventsTxId.length>0;){var n;yield new Promise(e=>a.eventEmitter.once(Eh.PendingEventsChanged,()=>e())),r=null===(n=a.pendingSendingEventsTxId.find(t=>t.id===e.getId()))||void 0===n?void 0:n.txId}r&&(e.setTxnId(r),e.setUnsigned(wh(wh({},e.getUnsigned()),{},{transaction_id:r}))),a.pendingSendingEventsTxId=a.pendingSendingEventsTxId.filter(t=>t.id!==e.getId()),0===a.pendingSendingEventsTxId.length&&a.eventEmitter.emit(Eh.PendingEventsChanged)}});return function(t){return e.apply(this,arguments)}}()),o(this,"onEvent",function(){var e=r(function*(e){if(e.preventDefault(),e.detail.data.room_id===a.roomId){var t=new $d(e.detail.data);yield a.updateTxId(t),a.syncApi instanceof Hi?(yield a.supportUpdateState())?yield a.syncApi.injectRoomEvents(a.room,void 0,[],[t]):yield a.syncApi.injectRoomEvents(a.room,[],void 0,[t]):(yield a.supportUpdateState())?yield a.syncApi.injectRoomEvents(a.room,[],[t]):xe.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),a.emit(kd.Event,t),a.setSyncState(Bi.Syncing),xe.info("Received event ".concat(t.getId()," ").concat(t.getType()))}else{var{event_id:r,room_id:n}=e.detail.data;xe.info("Received event ".concat(r," for a different room ").concat(n,"; discarding"))}yield a.ack(e)});return function(t){return e.apply(this,arguments)}}()),o(this,"onToDevice",function(){var e=r(function*(e){e.preventDefault();var t=new $d({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(Ve.RoomMessageEncrypted,{},"",""),a.emit(kd.ToDeviceEvent,t),a.setSyncState(Bi.Syncing),yield a.ack(e)});return function(t){return e.apply(this,arguments)}}()),o(this,"onStateUpdate",function(){var e=r(function*(e){for(var t of(e.preventDefault(),(yield a.supportUpdateState())||xe.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'"),e.detail.data.state))if(t.room_id===a.roomId){var r=new $d(t);a.syncApi instanceof Hi?yield a.syncApi.injectRoomEvents(a.room,void 0,[r]):yield a.syncApi.injectRoomEvents(a.room,[r]),xe.info("Updated state entry ".concat(r.getType()," ").concat(r.getStateKey()," to ").concat(r.getId()))}else{var{event_id:n,room_id:i}=e.detail.data;xe.info("Received state entry ".concat(n," for a different room ").concat(i,"; discarding"))}yield a.ack(e)});return function(t){return e.apply(this,arguments)}}());var w=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var e=r(function*(e,t){try{return yield w(e,t)}catch(e){Ih(e)}});return function(t,r){return e.apply(this,arguments)}}();var S=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var e=r(function*(e,t){try{return yield S(e,t)}catch(e){Ih(e)}});return function(t,r){return e.apply(this,arguments)}}(),this.widgetApiReady=new Promise(e=>this.widgetApi.once("ready",e)),this.roomStateSynced=null!==(c=t.receiveState)&&void 0!==c&&c.length?new Promise(e=>this.widgetApi.once("action:".concat(yh.WidgetApiToWidgetAction.UpdateState),e)):Promise.resolve(),(null!==(l=t.sendEvent)&&void 0!==l&&l.length||null!==(d=t.receiveEvent)&&void 0!==d&&d.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||!0===t.receiveMessage||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||null!==(u=t.sendState)&&void 0!==u&&u.length||null!==(h=t.receiveState)&&void 0!==h&&h.length)&&e.requestCapabilityForRoomTimeline(n),null===(g=t.sendEvent)||void 0===g||g.forEach(t=>e.requestCapabilityToSendEvent(t)),null===(p=t.receiveEvent)||void 0===p||p.forEach(t=>e.requestCapabilityToReceiveEvent(t)),!0===t.sendMessage?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(t=>e.requestCapabilityToSendMessage(t)),!0===t.receiveMessage?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(t=>e.requestCapabilityToReceiveMessage(t)),null===(v=t.sendState)||void 0===v||v.forEach(t=>{var{eventType:r,stateKey:n}=t;return e.requestCapabilityToSendState(r,n)}),null===(m=t.receiveState)||void 0===m||m.forEach(t=>{var{eventType:r,stateKey:n}=t;return e.requestCapabilityToReceiveState(r,n)}),null===(_=t.sendToDevice)||void 0===_||_.forEach(t=>e.requestCapabilityToSendToDevice(t)),null===(f=t.receiveToDevice)||void 0===f||f.forEach(t=>e.requestCapabilityToReceiveToDevice(t)),t.sendDelayedEvents&&(null!==(y=t.sendEvent)&&void 0!==y&&y.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||null!==(b=t.sendState)&&void 0!==b&&b.length)&&e.requestCapability(yh.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(yh.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(yh.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(yh.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(yh.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(yh.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),s&&e.sendContentLoaded()}supportUpdateState(){var e=this;return r(function*(){return(yield e.widgetApi.getClientVersions()).includes(yh.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return r(function*(){var n=e.length>0&&void 0!==e[0]?e[0]:{};t.lifecycle=new AbortController;var i,o,s=t.getUserId();(s&&t.store.storeUser(new Ir(s)),n.slidingSync?t.syncApi=new Ra(n.slidingSync,t,n,t.buildSyncApiOptions()):t.syncApi=new Hi(t,n,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())?yield t.roomStateSynced:yield Promise.all(null!==(i=null===(o=t.capabilities.receiveState)||void 0===o?void 0:o.map(function(){var e=r(function*(e){var{eventType:r,stateKey:n}=e,i=(yield t.widgetApi.readStateEvents(r,void 0,n,[t.roomId])).map(e=>new $d(e));t.syncApi instanceof Hi?yield t.syncApi.injectRoomEvents(t.room,void 0,i):yield t.syncApi.injectRoomEvents(t.room,i),i.forEach(e=>{t.emit(kd.Event,e),xe.info("Backfilled event ".concat(e.getId()," ").concat(e.getType()," ").concat(e.getStateKey()))})});return function(t){return e.apply(this,arguments)}}()))&&void 0!==i?i:[]);void 0!==n.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*n.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(Bi.Syncing),xe.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(yh.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(yh.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(yh.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return r(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,n){var i=this;return r(function*(){var r=t.event.redacts?wh(wh({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(n){var o=yield i.widgetApi.sendRoomEvent(t.getType(),r,e.roomId,"delay"in n?n.delay:void 0,"parent_delay_id"in n?n.parent_delay_id:void 0).catch(kh);return i.validateSendDelayedEventResponse(o)}var s,a=t.getTxnId();a&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:a});try{s=yield i.widgetApi.sendRoomEvent(t.getType(),r,e.roomId).catch(kh)}catch(r){throw i.updatePendingEventStatus(e,t,xr.NOT_SENT),r}return e.updatePendingEvent(t,xr.SENT,s.event_id),i.pendingSendingEventsTxId.forEach(e=>{e.txId===a&&(e.id=s.event_id)}),i.eventEmitter.emit(Eh.PendingEventsChanged),{event_id:s.event_id}})()}sendStateEvent(e,t,n){var i=arguments,o=this;return r(function*(){var r=i.length>3&&void 0!==i[3]?i[3]:"",s=yield o.widgetApi.sendStateEvent(t,r,n,e).catch(kh);if(void 0===s.event_id)throw new Error("'event_id' absent from response to an event request");return{event_id:s.event_id}})()}_unstable_sendDelayedStateEvent(e,t,n,i){var o=arguments,s=this;return r(function*(){var r=o.length>4&&void 0!==o[4]?o[4]:"";if(!(yield s.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","sendDelayedStateEvent");var a=yield s.widgetApi.sendStateEvent(n,r,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(kh);return s.validateSendDelayedEventResponse(a)})()}validateSendDelayedEventResponse(e){if(void 0===e.delay_id)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var n=this;return r(function*(){if(!(yield n.doesServerSupportUnstableFeature(Sd)))throw new Ec("Server does not support the delayed events API","updateDelayedEvent");return yield n.widgetApi.updateDelayedEvent(e,t).catch(kh),{}})()}encryptAndSendToDevice(e,t,n){var i=this;return r(function*(){var r=new _e(()=>new Map);for(var{userId:o,deviceId:s}of t)r.getOrCreate(o).set(s,n);yield i.widgetApi.sendToDevice(e,!0,ge(r)).catch(kh)})()}sendToDevice(e,t){var n=this;return r(function*(){return yield n.widgetApi.sendToDevice(e,!1,ge(t)).catch(kh),{}})()}getOpenIdToken(){var e=this;return r(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(kh);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return r(function*(){var{eventType:r,batch:n}=e,i=new _e(()=>new Map);for(var{userId:o,deviceId:s,payload:a}of n)i.getOrCreate(o).set(s,a);yield t.widgetApi.sendToDevice(r,!1,ge(i)).catch(kh)})()}sendToDeviceViaWidgetApi(e,t,n){var i=this;return r(function*(){yield i.widgetApi.sendToDevice(e,t,ge(n)).catch(kh)})()}checkTurnServers(){var e=this;return r(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(kd.Sync,e,t)}ack(e){var t=this;return r(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return r(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n,i=!1,o=!1;try{for(var s,a=function(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new Sh(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}(t);i=!(s=yield a.next()).done;i=!1){var c=s.value;e.turnServers=[{urls:c.uris,username:c.username,credential:c.password}],e.emit(kd.TurnServers,e.turnServers),xe.log("Received TURN server: ".concat(c.uris))}}catch(e){o=!0,n=e}finally{try{i&&null!=a.return&&(yield a.return())}finally{if(o)throw n}}}catch(e){xe.warn("Error watching TURN servers",e)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}function Ih(e){throw e instanceof yh.WidgetApiResponseError&&e.data.matrix_api_error?Vn.fromWidgetApiErrorData(e.data.matrix_api_error):e}function kh(e){if(e instanceof Error&&"Request timed out"===e.message)throw new Gn("widget api timeout");throw e}class Th{constructor(){o(this,"unthreadedReadReceipts",new Map),o(this,"threadedReadReceipts",new _e(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach(e=>{e.type===Ve.Receipt&&e.content&&Object.keys(e.content).forEach(t=>{Object.entries(e.content[t]).forEach(r=>{var[n,i]=r;if(de(n))for(var o of Object.keys(i)){var s=e.content[t][n][o],a={data:e.content[t][n][o],type:n,eventId:t};s.thread_id?this.setThreaded(s.thread_id,o,a):this.setUnthreaded(o,a)}})})})}buildAccumulatedReceiptEvent(e){var t={type:Ve.Receipt,room_id:e,content:{}},r=new _e(()=>new _e(()=>new Map));for(var[n,i]of this.allUnthreaded())r.getOrCreate(i.eventId).getOrCreate(i.type).set(n,i.data);for(var[o,s]of this.allThreaded())r.getOrCreate(s.eventId).getOrCreate(s.type).set(o,s.data);return t.content=ge(r),r.size>0?t:null}}var Ch=function(e){return e.Invite="invite",e.Leave="leave",e.Join="join",e.Knock="knock",e}({});class Oh{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.opts=e,o(this,"accountData",{}),o(this,"inviteRooms",{}),o(this,"knockRooms",{}),o(this,"joinRooms",{}),o(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}accumulateRooms(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,Ch.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,Ch.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,Ch.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,Ch.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case Ch.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case Ch.Knock:this.accumulateKnockState(e,r);break;case Ch.Join:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case Ch.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:xe.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(t.invite_state&&t.invite_state.events)if(this.inviteRooms[e]){var r=this.inviteRooms[e];t.invite_state.events.forEach(e=>{for(var t=!1,n=0;n<r.invite_state.events.length;n++){var i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)})}else this.inviteRooms[e]={invite_state:t.invite_state}}accumulateKnockState(e,t){if(t.knock_state&&t.knock_state.events)if(this.knockRooms[e]){var r=this.knockRooms[e];t.knock_state.events.forEach(e=>{for(var t=!1,n=0;n<r.knock_state.events.length;n++){var i=r.knock_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.knock_state.events[n]=e,t=!0)}t||r.knock_state.events.push(e)})}else this.knockRooms[e]={knock_state:t.knock_state}}accumulateJoinState(e,t){var r,n,i,o,s,a,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new Th});var l=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{l._accountData[e.type]=e}),t.unread_notifications&&(l._unreadNotifications=t.unread_notifications),l._unreadThreadNotifications=null!==(r=null!==(n=t[Fr.stable])&&void 0!==n?n:t[Fr.unstable])&&void 0!==r?r:void 0,t.summary){var d,u,h,g="m.heroes",p="m.invited_member_count",v="m.joined_member_count",m=l._summary,_=t.summary;m[g]=null!==(d=_[g])&&void 0!==d?d:m[g],m[v]=null!==(u=_[v])&&void 0!==u?u:m[v],m[p]=null!==(h=_[p])&&void 0!==h?h:m[p]}if(l._receipts.consumeEphemeralEvents(null===(i=t.ephemeral)||void 0===i?void 0:i.events),t.timeline&&t.timeline.limited&&(l._timeline=[]),null===(o=t.state)||void 0===o||null===(o=o.events)||void 0===o||o.forEach(e=>{Mh(l._currentState,e)}),null===(s=t["org.matrix.msc4222.state_after"])||void 0===s||null===(s=s.events)||void 0===s||s.forEach(e=>{Mh(l._currentState,e)}),null===(a=t.timeline)||void 0===a||null===(a=a.events)||void 0===a||a.forEach((e,r)=>{var n,i;if(t["org.matrix.msc4222.state_after"]||Mh(l._currentState,e),c)i=e;else{var o;void 0!==(i=Object.assign({},e)).unsigned&&(i.unsigned=Object.assign({},i.unsigned));var s=null===(o=e.unsigned)||void 0===o?void 0:o.age;void 0!==s&&(i._localTs=Date.now()-s)}l._timeline.push({event:i,token:0===r&&null!==(n=t.timeline.prev_batch)&&void 0!==n?n:null})}),l._timeline.length>this.opts.maxTimelineEntries)for(var f=l._timeline.length-this.opts.maxTimelineEntries;f<l._timeline.length;f++)if(l._timeline[f].token){l._timeline=l._timeline.slice(f,l._timeline.length);break}}getJSON(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.knockRooms).forEach(e=>{t.knock[e]=this.knockRooms[e]}),Object.keys(this.joinRooms).forEach(r=>{var n=this.joinRooms[r],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,unread_thread_notifications:n._unreadThreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach(e=>{i.account_data.events.push(n._accountData[e])});var o=n._receipts.buildAccumulatedReceiptEvent(r);o&&i.ephemeral.events.push(o),n._timeline.forEach(t=>{if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}var r,n;!e&&("_localTs"in(n=t.event)&&void 0!==n._localTs)?(void 0!==(r=Object.assign({},t.event)).unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,i.timeline.events.push(r)});for(var s=Object.create(null),a=i.timeline.events.length-1;a>=0;a--){var c=i.timeline.events[a];if(null!==c.state_key&&void 0!==c.state_key){var l=N(c);l.unsigned&&(l.unsigned.prev_content&&(l.content=l.unsigned.prev_content),l.unsigned.prev_sender&&(l.sender=l.unsigned.prev_sender)),Mh(s,l)}}Object.keys(n._currentState).forEach(e=>{Object.keys(n._currentState[e]).forEach(t=>{var r=n._currentState[e][t];i["org.matrix.msc4222.state_after"].events.push(r),s[e]&&s[e][t]&&(r=s[e][t]),i.state.events.push(r)})}),t.join[r]=i});var r=[];return Object.keys(this.accountData).forEach(e=>{r.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function Mh(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}var Ph=function(e){return e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e}({});let Dh=class{constructor(e){o(this,"deviceId",void 0),o(this,"userId",void 0),o(this,"algorithms",void 0),o(this,"keys",void 0),o(this,"verified",void 0),o(this,"signatures",void 0),o(this,"displayName",void 0),o(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||Ph.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}};var Ah=function(){};class xh{constructor(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.client=e,this.timelineSet=t,o(this,"windowLimit",void 0),o(this,"start",void 0),o(this,"end",void 0),o(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,null===(r=t.room)||void 0===r||r.on(Oi.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=r=>{if(!r)throw new Error("No timeline given to initFields");var n,i=r.getEvents();if(e){if((n=i.findIndex(t=>t.getId()===e))<0)throw new Error("getEventTimeline result didn't include requested event")}else n=i.length;var o=Math.min(i.length,n+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new Uh(r,s-r.getBaseIndex()),this.end=new Uh(r,o-r.getBaseIndex()),this.eventCount=o-s};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,r;if(e==Tr.BACKWARDS)return null!==(t=this.start)&&void 0!==t?t:null;if(e==Tr.FORWARDS)return null!==(r=this.end)&&void 0!==r?r:null;throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return!1;var n=e==Tr.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,this.eventCount;var i=this.eventCount-this.windowLimit;return i>0&&this.unpaginate(i,e!=Tr.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==Tr.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return Boolean(r)||Boolean(n)}paginate(e,t){var n=arguments,i=this;return r(function*(){var r=!(n.length>2&&void 0!==n[2])||n[2],o=n.length>3&&void 0!==n[3]?n[3]:10,s=i.getTimelineIndex(e);if(!s)return!1;if(s.pendingPaginate)return s.pendingPaginate;if(i.extend(e,t))return!0;if(!r||0===o)return!1;if(!s.timeline.getPaginationToken(e))return!1;var a=i.client.paginateEventTimeline(s.timeline,{backwards:e==Tr.BACKWARDS,limit:t}).finally(function(){s.pendingPaginate=void 0}).then(r=>r?i.paginate(e,t,!0,o-1):i.paginate(e,t,!1,0));return s.pendingPaginate=a,a})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,Ah(this.eventCount)}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,i=t.getEvents(),o=0,s=i.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===(null===(r=this.end)||void 0===r?void 0:r.timeline)&&(s=this.end.index+t.getBaseIndex());for(var a=o;a<s;a++)e.push(i[a]);if(t===(null===(n=this.end)||void 0===n?void 0:n.timeline))break;t=t.getNeighbouringTimeline(Tr.FORWARDS)}return e}}class Uh{constructor(e,t){this.timeline=e,this.index=t,o(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?Tr.BACKWARDS:Tr.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}var Lh="m.login.email.identity",Nh="m.login.msisdn",Fh=function(e){return e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",e}({});class jh extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,o(this,"name","NoAuthFlowFoundError")}}class Bh{constructor(e){var t=this;o(this,"matrixClient",void 0),o(this,"inputs",void 0),o(this,"clientSecret",void 0),o(this,"requestCallback",void 0),o(this,"busyChangedCallback",void 0),o(this,"stateUpdatedCallback",void 0),o(this,"requestEmailTokenCallback",void 0),o(this,"supportedStages",void 0),o(this,"data",void 0),o(this,"emailSid",void 0),o(this,"requestingEmailToken",!1),o(this,"attemptAuthDeferred",null),o(this,"chosenFlow",null),o(this,"currentStage",null),o(this,"emailAttempt",1),o(this,"submitPromise",null),o(this,"requestEmailToken",r(function*(){if(t.requestingEmailToken)xe.warn("Could not request email token: Already requesting");else{xe.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var e=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=e.sid,xe.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,void 0!==e.supportedStages&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return r(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var r=e.attemptAuthDeferred.promise;if(null!==(t=e.data)&&void 0!==t&&null!==(t=t.flows)&&void 0!==t&&t.length)e.startNextAuthStage();else{var n;null===(n=e.busyChangedCallback)||void 0===n||n.call(e,!0);var i=e.data.session?{session:e.data.session}:null;e.doRequest(i).finally(()=>{var t;null===(t=e.busyChangedCallback)||void 0===t||t.call(e,!1)})}return r})()}poll(){var e=this;return r(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==Lh&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:Lh,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data)||void 0===t||null===(t=t.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,n=this;return r(function*(){var r,i,o,s=t.length>1&&void 0!==t[1]&&t[1];if(!n.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");s||(null===(i=n.busyChangedCallback)||void 0===i||i.call(n,!0));for(;n.submitPromise;)try{yield n.submitPromise}catch(e){}o=null!==(r=n.data)&&void 0!==r&&r.session?Object.assign({session:n.data.session},e):e;try{n.submitPromise=n.doRequest(o,s),yield n.submitPromise}finally{var a;if(n.submitPromise=null,!s)null===(a=n.busyChangedCallback)||void 0===a||a.call(n,!1)}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]&&t[1];try{var i=yield n.requestCallback(e,r);n.attemptAuthDeferred.resolve(i),n.attemptAuthDeferred=null}catch(e){var o,s,a,c,l,d=e instanceof Vn?e:null,u=null!==(o=null==d||null===(s=d.data)||void 0===s?void 0:s.flows)&&void 0!==o?o:null,h=(null===(a=n.data)||void 0===a?void 0:a.flows)||Boolean(u);if(!d||401!==d.httpStatus||!d.data||!h)if(r)xe.log("Background poll request failed doing UI auth: ignoring",e);else null===(l=n.attemptAuthDeferred)||void 0===l||l.reject(e);d&&!d.data&&(d.data={}),!d||d.data.flows||d.data.completed||d.data.session||(d.data.flows=n.data.flows,d.data.completed=n.data.completed,d.data.session=n.data.session),d&&(n.data=d.data);try{n.startNextAuthStage()}catch(e){return n.attemptAuthDeferred.reject(e),void(n.attemptAuthDeferred=null)}if(!n.emailSid&&null!==(c=n.chosenFlow)&&void 0!==c&&c.stages.includes(Fh.Email))try{yield n.requestEmailToken()}catch(e){n.attemptAuthDeferred.reject(e),n.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r,n,i=this.chooseStage();if(!i)throw new Error("No incomplete flows from the server");(this.currentStage=i,i!==Fh.Dummy)?null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error?this.stateUpdatedCallback(i,{errcode:(null===(r=this.data)||void 0===r?void 0:r.errcode)||"",error:(null===(n=this.data)||void 0===n?void 0:n.error)||""}):this.stateUpdatedCallback(i,i===Lh?{emailSid:this.emailSid}:{}):this.submitAuthDict({type:"m.login.dummy"})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),xe.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return xe.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return void 0!==this.supportedStages&&(t+=10*e.stages.filter(e=>!this.supportedStages.has(e)).length),t}chooseFlow(){var e,t=(null===(e=this.data)||void 0===e?void 0:e.flows)||[],r=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(var i of(t.sort((e,t)=>this.scoreFlow(e)-this.scoreFlow(t)),t)){var o=!1,s=!1;for(var a of i.stages)a===Lh?o=!0:a==Nh&&(s=!0);if(o==r&&s==n)return i}var c=[];throw r&&c.push(Lh),n&&c.push(Nh),new jh("No appropriate authentication flow found",c,t)}firstUncompletedStage(e){var t,r=(null===(t=this.data)||void 0===t?void 0:t.completed)||[];return e.stages.find(e=>!r.includes(e))}}function Kh(e,t){return new Promise((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),r(i)},o.onerror=()=>n(o.error)})}var qh=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],Vh=qh.length;function Wh(e,t,r){var n=e.openCursor(t);return new Promise((e,t)=>{var i=[];n.onerror=()=>{var e;t(new Error("Query failed: "+(null===(e=n.error)||void 0===e?void 0:e.name)))},n.onsuccess=()=>{var t=n.result;t?(i.push(r(t)),t.continue()):e(i)}})}function Gh(e){return new Promise((t,r)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){r(e.error)}})}function Hh(e){return new Promise((t,r)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){r(e.error)}})}function zh(e){return Hh(e).then(t=>e.result)}class $h{static exists(e,t){return Kh(e,t="matrix-js-sdk:"+(t||"default"))}constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";this.indexedDB=e,o(this,"dbName",void 0),o(this,"syncAccumulator",void 0),o(this,"db",void 0),o(this,"disconnected",!0),o(this,"_isNewlyCreated",!1),o(this,"syncToDatabasePromise",void 0),o(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new Oh}connect(e){var t=this;if(!this.disconnected)return xe.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,xe.log("LocalIndexedDBStoreBackend.connect: connecting...");var n=this.indexedDB.open(this.dbName,Vh);return n.onupgradeneeded=e=>{var t=n.result,r=e.oldVersion;xe.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(r)),r<1&&(this._isNewlyCreated=!0),qh.forEach((e,n)=>{r<=n&&e(t)})},n.onblocked=()=>{xe.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},xe.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),Hh(n).then(r(function*(){xe.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=n.result,t.db.onversionchange=()=>{var e;null===(e=t.db)||void 0===e||e.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,null==e||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;xe.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=n.openCursor(i),s=[],a=!1;o.onsuccess=()=>{var e=o.result;if(!e)return s.length||a?t(s):t(null);var r=e.value;r.oob_written?a=!0:s.push(r),e.continue()},o.onerror=e=>{r(e)}}).then(t=>(xe.log("LL: got ".concat(null==t?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var n=this;return r(function*(){xe.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var r=n.db.transaction(["oob_membership_events"],"readwrite"),i=r.objectStore("oob_membership_events");t.forEach(e=>{i.put(e)});var o={room_id:e,oob_written:!0,state_key:0};i.put(o),yield Gh(r),xe.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return r(function*(){var r,n=t.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=zh(n.openKeyCursor(i,"next")).then(e=>(null==e?void 0:e.primaryKey)[1]),s=zh(n.openKeyCursor(i,"prev")).then(e=>(null==e?void 0:e.primaryKey)[1]),[a,c]=yield Promise.all([o,s]),l=t.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),d=IDBKeyRange.bound([e,a],[e,c]);xe.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,a],[e,c]),yield(r=l.delete(d),new Promise((e,t)=>{r.onsuccess=()=>e(r),r.onerror=e=>t(e)}))})()}clearDatabase(){return new Promise(e=>{var t;xe.log("Removing indexeddb instance: ".concat(this.dbName)),null===(t=this.db)||void 0===t||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{xe.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{var t;xe.warn("unable to delete js-sdk store indexeddb: ".concat(null===(t=r.error)||void 0===t?void 0:t.name)),e()},r.onsuccess=()=>{xe.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(N(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return r(function*(){return t.syncToDatabasePromise?(xe.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return r(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return xe.log("Persisting sync data up to",e),Z(()=>{var r=this.db.transaction(["sync"],"readwrite");return r.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),Gh(r).then(()=>{xe.log("Persisted sync data up to",e)})})}persistAccountData(e){return Z(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return Gh(t).then()})}persistUserPresenceEvents(e){return Z(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return Gh(t).then()})}getUserPresenceEvents(){return Z(()=>Wh(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))}loadAccountData(){return xe.log("LocalIndexedDBStoreBackend: loading account data..."),Z(()=>Wh(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(xe.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}loadSyncData(){return xe.log("LocalIndexedDBStoreBackend: loading sync data..."),Z(()=>Wh(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(xe.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&xe.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}getClientOptions(){return Promise.resolve().then(()=>Wh(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options}).then(e=>e[0]))}storeClientOptions(e){var t=this;return r(function*(){var r=t.db.transaction(["client_options"],"readwrite");r.objectStore("client_options").put({clobber:"-",options:e}),yield Gh(r)})()}saveToDeviceBatches(e){var t=this;return r(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var i of e)n.add(i);yield Gh(r)})()}getOldestToDeviceBatch(){var e=this;return r(function*(){var t=e.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),r=yield zh(t.openCursor());if(!r)return null;var n=r.value;return{id:r.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}})()}removeToDeviceBatch(e){var t=this;return r(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite");r.objectStore("to_device_queue").delete(e),yield Gh(r)})()}destroy(){var e=this;return r(function*(){var t;null===(t=e.db)||void 0===t||t.close()})()}}class Jh{constructor(e,t){this.workerFactory=e,this.dbName=t,o(this,"worker",void 0),o(this,"nextSeq",0),o(this,"inFlight",{}),o(this,"startPromise",void 0),o(this,"onWorkerMessage",e=>{var t,r=e.data;if("closed"==r.command)null===(t=this.onClose)||void 0===t||t.call(this);else if("cmd_success"==r.command||"cmd_fail"==r.command){if(void 0===r.seq)return void xe.error("Got reply from worker with no seq");var n=this.inFlight[r.seq];if(void 0===n)return void xe.error("Got reply for unknown seq "+r.seq);if(delete this.inFlight[r.seq],"cmd_success"==r.command)n.resolve(r.result);else{var i=new Error(r.error.message);i.name=r.error.name,n.reject(i)}}else xe.warn("Unrecognised message from worker: ",r)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return r(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return r(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return r(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{xe.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,i=Promise.withResolvers();return this.inFlight[n]=i,null===(r=this.worker)||void 0===r||r.postMessage({command:e,seq:n,args:t}),i.promise})}destroy(){var e=this;return r(function*(){var t;null===(t=e.worker)||void 0===t||t.terminate()})()}}class Yh extends iu{static exists(e,t){return $h.exists(e,t)}constructor(e){if(super(e),o(this,"backend",void 0),o(this,"startedUp",!1),o(this,"syncTs",0),o(this,"userModifiedMap",{}),o(this,"emitter",new qe),o(this,"onClose",()=>{this.emitter.emit("closed")}),o(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),o(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),o(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),o(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{xe.log("Deleted indexeddb data.")},e=>{throw xe.error("Failed to delete indexeddb data: ".concat(e)),e})),null)),o(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var e=[];for(var t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)},null)),o(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),o(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),o(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),o(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),o(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),o(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Jh(e.workerFactory,e.dbName):this.backend=new $h(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(xe.log("IndexedDBStore.startup: already started"),Promise.resolve()):(xe.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(xe.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{xe.log("IndexedDBStore.startup: processing presence events"),e.forEach(e=>{var[t,r]=e;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var n=this.createUser(t);r&&n.setPresenceEvent(new $d(r)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){return Date.now()-this.syncTs>3e5}save(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var n=this,i=t?super[t]:null;return r(function*(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];try{return yield e.call(n,...r)}catch(e){xe.error("IndexedDBStore failure, degrading to MemoryStore",e),n.emitter.emit("degraded",e);try{xe.log("IndexedDBStore trying to delete degraded data"),yield n.backend.clearDatabase(),xe.log("IndexedDBStore delete after degrading succeeded")}catch(e){xe.warn("IndexedDBStore delete after degrading failed",e)}if(i)return i.call(n,...r)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,n=this;return r(function*(){if(!n.localStorage)return t().call(n,e);var r=n.localStorage.getItem(Qh(e));if(r)try{return JSON.parse(r)}catch(e){xe.error("Could not parse persisted pending events",e)}return[]})()}setPendingEvents(e,t){var n=()=>super.setPendingEvents,i=this;return r(function*(){if(!i.localStorage)return n().call(i,e,t);t.length>0?i.localStorage.setItem(Qh(e),JSON.stringify(t)):i.localStorage.removeItem(Qh(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function Qh(e){return"mx_pending_events_".concat(e)}var Xh="crypto.",Zh=Xh+"migration",eg=Xh+"account",tg=Xh+"cross_signing_keys",rg=Xh+"inboundgroupsessions/",ng=Xh+"inboundgroupsessions.withheld/",ig=Xh+"rooms/",og=Xh+"sessionsneedingbackup";function sg(e){return Xh+"sessions/"+e}function ag(e,t){return rg+e+"/"+t}class cg extends Ie{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if(null!==(n=e.key(r))&&void 0!==n&&n.startsWith(Xh))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return r(function*(){return cg.exists(e.store)})()}getMigrationState(){var e=this;return r(function*(){var t;return null!==(t=lg(e.store,Zh))&&void 0!==t?t:ye.NOT_STARTED})()}setMigrationState(e){var t=this;return r(function*(){dg(t.store,Zh,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var i=this.store.key(n);if(null!=i&&i.startsWith(sg(""))){var o=lg(this.store,i);r+=Object.keys(null!=o?o:{}).length}}t(r)}_getEndToEndSessions(e){var t=lg(this.store,sg(e)),r={};for(var[n,i]of Object.entries(t||{}))r[n]="string"==typeof i?{session:i}:i;return r}getEndToEndSession(e,t,r,n){var i;n(null!==(i=this._getEndToEndSessions(e)[t])&&void 0!==i?i:{})}getEndToEndSessions(e,t,r){var n;r(null!==(n=this._getEndToEndSessions(e))&&void 0!==n?n:{})}storeEndToEndSession(e,t,r,n){var i=this._getEndToEndSessions(e)||{};i[t]=r,dg(this.store,sg(e),i)}getEndToEndSessionsBatch(){var e=this;return r(function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if(null!==(n=e.store.key(r))&&void 0!==n&&n.startsWith(sg(""))){var i=e.store.key(r).split("/")[1];for(var o of Object.values(e._getEndToEndSessions(i)))if(t.push(o),t.length>=be)return t}}return 0===t.length?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return r(function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t._getEndToEndSessions(r)||{};delete i[n],0===Object.keys(i).length?t.store.removeItem(sg(r)):dg(t.store,sg(r),i)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(lg(this.store,ag(e,t)),lg(this.store,function(e,t){return ng+e+"/"+t}(e,t)))}storeEndToEndInboundGroupSession(e,t,r,n){dg(this.store,ag(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return r(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);null!=n&&n.startsWith(rg)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return r(function*(){for(var t=lg(e.store,og)||{},r=[],n=0;n<e.store.length;++n){var i=e.store.key(n);if(null!=i&&i.startsWith(rg)){var o=i.slice(28);if(r.push({senderKey:o.slice(0,43),sessionId:o.slice(44),sessionData:lg(e.store,i),needsBackup:o in t}),r.length>=be)return r}}return 0===r.length?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return r(function*(){for(var{senderKey:r,sessionId:n}of e){var i=ag(r,n);t.store.removeItem(i)}})()}getEndToEndRooms(e,t){for(var r={},n=function(e){return ig+e}(""),i=0;i<this.store.length;++i){var o=this.store.key(i);if(null!=o&&o.startsWith(n))r[o.slice(n.length)]=lg(this.store,o)}t(r)}markSessionsNeedingBackup(e){var t=lg(this.store,og)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return dg(this.store,og,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(eg),Promise.resolve()}getAccount(e,t){t(lg(this.store,eg))}storeAccount(e,t){dg(this.store,eg,t)}getCrossSigningKeys(e,t){t(lg(this.store,tg))}getSecretStorePrivateKey(e,t,r){t(lg(this.store,Xh+"ssss_cache.".concat(r)))}storeSecretStorePrivateKey(e,t,r){dg(this.store,Xh+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function lg(e,t){try{return JSON.parse(e.getItem(t))}catch(e){xe.log("Error: Failed to get key %s: %s",t,e.message),xe.log(e.stack)}return null}function dg(e,t,r){e.setItem(t,JSON.stringify(r))}class ug{constructor(e){this.db=e,o(this,"nextTxnId",0),e.onversionchange=()=>{xe.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return r(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return r(function*(){return e})()}deleteAllData(){return r(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return r(function*(){var t=ye.NOT_STARTED;return yield e.doTxn("readonly",[vg.STORE_ACCOUNT],e=>{var r=e.objectStore(vg.STORE_ACCOUNT).get(fe);r.onsuccess=()=>{var e;t=null!==(e=r.result)&&void 0!==e?e:ye.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return r(function*(){yield t.doTxn("readwrite",[vg.STORE_ACCOUNT],t=>{t.objectStore(vg.STORE_ACCOUNT).put(e,fe)})})()}getAccount(e,t){var r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){pg(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){pg(e,t)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account").get("ssss_cache:".concat(r));n.onsuccess=function(){try{t(n.result||null)}catch(t){pg(e,t)}}}storeSecretStorePrivateKey(e,t,r){e.objectStore("account").put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions").count();r.onsuccess=function(){try{t(r.result)}catch(t){pg(e,t)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){var e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(i)}catch(e){pg(t,e)}}}getEndToEndSession(e,t,r,n){var i=r.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){pg(r,e)}}}storeEndToEndSession(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return r(function*(){var t=[];return yield e.doTxn("readonly",[vg.STORE_SESSIONS],e=>{var r=e.objectStore(vg.STORE_SESSIONS).openCursor();r.onsuccess=function(){try{var n=r.result;n&&(t.push(n.value),t.length<be&&n.continue())}catch(t){pg(e,t)}}}),0===t.length?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return r(function*(){yield t.doTxn("readwrite",[vg.STORE_SESSIONS],function(){var t=r(function*(t){try{var r=t.objectStore(vg.STORE_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise(t=>{e.onsuccess=t})};for(var{deviceKey:i,sessionId:o}of e)yield*n()}catch(e){pg(t,e)}});return function(e){return t.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,r,n){var i=!1,o=!1,s=r.objectStore("inbound_group_sessions").get([e,t]);s.onsuccess=function(){try{i=s.result?s.result.session:null,!1!==o&&n(i,o)}catch(e){pg(r,e)}};var a=r.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(i,o)}catch(e){pg(r,e)}}}storeEndToEndInboundGroupSession(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return r(function*(){var t=0;return yield e.doTxn("readonly",[vg.STORE_INBOUND_GROUP_SESSIONS],e=>{var r=e.objectStore(vg.STORE_INBOUND_GROUP_SESSIONS).count();r.onsuccess=()=>{t=r.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return r(function*(){var t=[];return yield e.doTxn("readonly",[vg.STORE_INBOUND_GROUP_SESSIONS,vg.STORE_BACKUP],e=>{var r=e.objectStore(vg.STORE_INBOUND_GROUP_SESSIONS),n=e.objectStore(vg.STORE_BACKUP),i=r.openCursor();i.onsuccess=function(){try{var r=i.result;if(r){var o=n.get(r.key);o.onsuccess=()=>{t.push({senderKey:r.value.senderCurve25519Key,sessionId:r.value.sessionId,sessionData:r.value.session,needsBackup:void 0!==o.result}),t.length<be&&r.continue()}}}catch(t){pg(e,t)}}}),0===t.length?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return r(function*(){yield t.doTxn("readwrite",[vg.STORE_INBOUND_GROUP_SESSIONS],function(){var t=r(function*(t){try{var r=t.objectStore(vg.STORE_INBOUND_GROUP_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise(t=>{e.onsuccess=t})};for(var{senderKey:i,sessionId:o}of e)yield*n()}catch(e){pg(t,e)}});return function(e){return t.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){pg(e,t)}}}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){var i=n.result;if(i)r[i.key]=i.value,i.continue();else try{t(r)}catch(t){pg(e,t)}}}markSessionsNeedingBackup(e,t){var n=this;return r(function*(){t||(t=n.db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(e=>new Promise((t,n)=>{var i=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n})))})()}doTxn(e,t,r){var n=this.db.transaction(t,e),i=function(e){return new Promise((t,r)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&r(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(xe.log("Error performing indexeddb txn",t),r(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(xe.log("Error performing indexeddb txn",t),r(e.error))}})}(n),o=r(n);return i.then(()=>o)}}var hg=[e=>{!function(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],gg=hg.length;function pg(e,t){e._mx_abortexception=t;try{e.abort()}catch(e){}}class vg{static exists(e,t){return Kh(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var s=o.result;if(i){var a=s.transaction([vg.STORE_ACCOUNT],"readonly").objectStore(vg.STORE_ACCOUNT).get(fe);a.onsuccess=()=>{var e,t=null!==(e=a.result)&&void 0!==e?e:ye.NOT_STARTED;r(t===ye.NOT_STARTED)},a.onerror=()=>{n(a.error)},s.close()}else s.close(),e.deleteDatabase(t),r(!1)},o.onerror=()=>n(o.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,o(this,"backendPromise",void 0),o(this,"backend",void 0)}containsData(){var e=this;return r(function*(){return vg.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise||(this.backendPromise=new Promise((e,t)=>{if(this.indexedDB){xe.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,gg);r.onupgradeneeded=e=>{!function(e,t){xe.log("Upgrading IndexedDBCryptoStore from version ".concat(t)+" to ".concat(gg)),hg.forEach((r,n)=>{t<=n&&r(e)})}(r.result,e.oldVersion)},r.onblocked=()=>{xe.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{xe.log("Error connecting to indexeddb",e),t(r.error)},r.onsuccess=()=>{var t=r.result;xe.log("connected to indexeddb ".concat(this.dbName)),e(new ug(t))}}else t(new Error("no indexeddb support available"))}).then(e=>e.doTxn("readonly",[vg.STORE_INBOUND_GROUP_SESSIONS,vg.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if("VersionError"===e.name)throw xe.warn("Crypto DB is too new for us to use!",e),new bc(yc.TooNew);xe.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new cg(globalThis.localStorage)}catch(e){return xe.warn("Unable to open localStorage: falling back to in-memory store: ".concat(e)),new Ie}}).then(e=>(this.backend=e,e))),this.backendPromise}deleteAllData(){return new Promise((e,t)=>{if(this.indexedDB){xe.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{xe.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{xe.log("Error deleting data from indexeddb",e),t(r.error)},r.onsuccess=()=>{xe.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}else t(new Error("no indexeddb support available"))}).catch(e=>{xe.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}o(vg,"STORE_ACCOUNT","account"),o(vg,"STORE_SESSIONS","sessions"),o(vg,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),o(vg,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),o(vg,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),o(vg,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),o(vg,"STORE_DEVICE_DATA","device_data"),o(vg,"STORE_ROOMS","rooms"),o(vg,"STORE_BACKUP","sessions_needing_backup");var mg=function(e){return e.Email="email",e.Phone="msisdn",e}({}),_g=new w("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),fg=function(e){return e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter",e}({}),yg=function(e){return e.LOGIN="login",e.REGISTER="register",e}({}),bg="us.cloke.msc4175.tz";class wg{constructor(e){o(this,"relations",void 0),this.relations=e.filter(e=>!!e)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(r=>r.on(e,t))}off(e,t){this.relations.forEach(r=>r.off(e,t))}}var Sg=function(e){return e.Global="Global",e.SetItemError="setItem",e.GetItemError="getItem",e.RemoveItemError="removeItem",e.ClearError="clear",e.QuotaExceededError="QuotaExceededError",e}({});var Eg=new class extends qe{},Rg=()=>new Ie;function Ig(e){Rg=e}function kg(e){var t,r,n;return e.store=null!==(t=e.store)&&void 0!==t?t:new iu({localStorage:globalThis.localStorage}),e.scheduler=null!==(r=e.scheduler)&&void 0!==r?r:new Oa,e.cryptoStore=null!==(n=e.cryptoStore)&&void 0!==n?n:Rg(),e}function Tg(e){return new Cd(kg(e))}function Cg(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return new Rh(e,t,r,kg(n),i)}var Og,Mg=Object.freeze({__proto__:null,AuthType:Fh,AutoDiscovery:zs,AutoDiscoveryAction:Gs,AutoDiscoveryError:Hs,Beacon:pn,BeaconEvent:un,CallEvent:ps,CallFeedEvent:Ro,Category:Ch,ClientEvent:kd,ClientPrefix:ui,ClientStoppedError:Sc,ConditionKind:Os,ConditionOperator:Ts,ConnectionError:Gn,ContentHelpers:dn,DELEGATED_OIDC_COMPATIBILITY:_g,DEVICE_CODE_SCOPE:cd,DMMemberCountCondition:"2",DebugLogger:Le,Device:Dh,DeviceVerification:Ph,Direction:kr,DuplicateStrategy:Dr,EVENT_VISIBILITY_CHANGE_TYPE:nt,EventEmitterEvents:Ke,EventStatus:xr,EventTimeline:Tr,EventTimelineSet:Ar,EventType:Ve,FILTER_RELATED_BY_REL_TYPES:Kd,FILTER_RELATED_BY_SENDERS:Bd,FeatureSupport:Ld,Filter:Vr,GET_LOGIN_TOKEN_CAPABILITY:fd,GroupCall:as,GroupCallEvent:Zo,GroupCallIntent:Yo,GroupCallState:is,GroupCallStatsReportEvent:es,GroupCallType:Qo,GuestAccess:ta,HTTPError:qn,HistoryVisibility:ra,HttpApiEvent:Jn,IdentityPrefix:hi,IdentityProviderBrand:fg,IndexedDBCryptoStore:vg,IndexedDBStore:Yh,InteractiveAuth:Bh,InvalidCryptoStoreError:bc,InvalidCryptoStoreState:yc,JoinRule:Zs,KNOWN_SAFE_ROOM_VERSION:ki,KeySignatureUploadError:wc,KnownMembership:lt,LOCAL_NOTIFICATION_SETTINGS_PREFIX:st,LocalStorageCryptoStore:cg,LocalStorageErrors:Sg,LocationAssetType:S,MAIN_ROOM_TIMELINE:T,MAXIMUM_MATRIX_VERSION:Ws,MINIMUM_MATRIX_VERSION:Vs,MSC3912_RELATION_BASED_REDACTIONS_PROP:tt,M_ASSET:E,M_BEACON:Ca,M_BEACON_INFO:Ta,M_HTML:zr,M_LOCATION:I,M_MESSAGE:Gr,M_POLL_END:En,M_POLL_KIND_DISCLOSED:yn,M_POLL_KIND_UNDISCLOSED:bn,M_POLL_RESPONSE:Sn,M_POLL_START:wn,M_TEXT:Hr,M_TIMESTAMP:R,M_TOPIC:Yr,MatrixClient:Cd,MatrixError:Vn,MatrixEvent:$d,MatrixEventEvent:zd,MatrixHttpApi:wi,MatrixScheduler:Oa,MediaHandlerEvent:pa,MediaPrefix:gi,MemoryCryptoStore:Ie,MemoryStore:iu,Method:jn,MsgType:Ge,NoAuthFlowFoundError:jh,NotificationCountType:Ci,OidcError:jl,OidcTokenRefresher:ud,PUSHER_DEVICE_ID:ot,PUSHER_ENABLED:it,PendingEventOrdering:_d,Poll:kn,PollEvent:Rn,Preset:Xs,ProfileKeyMSC4175Timezone:bg,PushRuleActionName:Is,PushRuleKind:Ms,REFERENCE_RELATION:$r,ReceiptType:k,RelatedRelations:wg,RelationType:We,Relations:Mr,RelationsEvent:Or,RestrictedAllowType:ea,Room:Mi,RoomCreateTypeField:He,RoomEvent:Oi,RoomMember:ut,RoomMemberEvent:dt,RoomNameType:Di,RoomState:eu,RoomStateEvent:Zd,RoomSummary:Ur,RoomType:ze,RoomVersionStability:Si,RoomWidgetClient:Rh,RoomWidgetClientEvent:Eh,RuleId:Ps,SERVICE_TYPES:$s,SSOAction:yg,STABLE_MSC4133_EXTENDED_PROFILES:Rd,SUPPORTED_MATRIX_VERSIONS:qs,SearchOrderBy:ga,SearchResult:Ys,SecretStorage:pc,ServerCapabilities:Ei,SetPresence:Vi,SlidingSyncEvent:fa,StatsReport:Wo,SyncAccumulator:Oh,SyncState:Bi,THREAD_RELATION_TYPE:qd,Thread:Fd,ThreadEvent:Ud,ThreadFilterType:Vd,ThreepidMedium:mg,TimelineIndex:Uh,TimelineWindow:xh,ToDeviceMessageId:$e,TokenRefreshError:Hn,TokenRefreshLogoutError:zn,TweakName:ks,TypedEventEmitter:qe,UNSIGNED_MEMBERSHIP_FIELD:ct,UNSIGNED_THREAD_ID_FIELD:at,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:rt,UNSTABLE_MSC2666_MUTUAL_ROOMS:bd,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:wd,UNSTABLE_MSC2666_SHARED_ROOMS:yd,UNSTABLE_MSC2716_MARKER:et,UNSTABLE_MSC3088_ENABLED:Ye,UNSTABLE_MSC3088_PURPOSE:Je,UNSTABLE_MSC3089_BRANCH:Ze,UNSTABLE_MSC3089_LEAF:Xe,UNSTABLE_MSC3089_TREE_SUBTYPE:Qe,UNSTABLE_MSC3852_LAST_SEEN_UA:md,UNSTABLE_MSC4133_EXTENDED_PROFILES:Ed,UNSTABLE_MSC4140_DELAYED_EVENTS:Sd,UnsupportedDelayedEventsEndpointError:Ec,UpdateDelayedEventAction:fc,User:Ir,UserEvent:Rr,Visibility:Qs,anySignal:Zn,calculateRetryBackoff:ii,completeAuthorizationCodeGrant:nd,createClient:Tg,createNewMatrixCall:Rs,createRoomWidgetClient:Cg,decodeBase64:fo,decodeIdToken:Hl,determineFeatureSupport:Nd,discoverAndValidateOIDCIssuerWellKnown:sd,encodeBase64:vo,encodeUnpaddedBase64:mo,encodeUnpaddedBase64Url:_o,fixNotificationCountOnDecryption:Md,generateAuthorizationParams:ed,generateAuthorizationUrl:td,generateOidcAuthorizationUrl:rd,generateScope:Xl,getBeaconInfoIdentifier:gn,getHttpUriForMxc:Ce,inMainTimelineForReceipt:Dd,isDmMemberCountCondition:Cs,isEventTypeSame:Jr,isPollEvent:Tn,isTimestampInDuration:hn,localStorageErrorsEventsEmitter:Eg,parseErrorResponse:ei,registerOidcClient:dd,retryNetworkOperation:ri,safeGetRetryAfterMs:Wn,setCryptoStoreFactory:Ig,threadFilterTypeToFilter:Wd,threadIdForReceipt:Pd,timeoutSignal:Xn,validateAuthMetadata:Gl,validateAuthMetadataAndKeys:ad,validateBearerTokenResponse:Jl,validateIdToken:zl,validateStoredUserState:$l});if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;try{Og=globalThis.indexedDB}catch(e){}Og&&Ig(()=>new vg(Og,"matrix-js-sdk:crypto")),globalThis.matrixcs=Mg;var Pg=Object.freeze({__proto__:null,AuthType:Fh,AutoDiscovery:zs,AutoDiscoveryAction:Gs,AutoDiscoveryError:Hs,Beacon:pn,BeaconEvent:un,CallEvent:ps,CallFeedEvent:Ro,Category:Ch,ClientEvent:kd,ClientPrefix:ui,ClientStoppedError:Sc,ConditionKind:Os,ConditionOperator:Ts,ConnectionError:Gn,ContentHelpers:dn,DELEGATED_OIDC_COMPATIBILITY:_g,DEVICE_CODE_SCOPE:cd,DMMemberCountCondition:"2",DebugLogger:Le,Device:Dh,DeviceVerification:Ph,Direction:kr,DuplicateStrategy:Dr,EVENT_VISIBILITY_CHANGE_TYPE:nt,EventEmitterEvents:Ke,EventStatus:xr,EventTimeline:Tr,EventTimelineSet:Ar,EventType:Ve,FILTER_RELATED_BY_REL_TYPES:Kd,FILTER_RELATED_BY_SENDERS:Bd,FeatureSupport:Ld,Filter:Vr,GET_LOGIN_TOKEN_CAPABILITY:fd,GroupCall:as,GroupCallEvent:Zo,GroupCallIntent:Yo,GroupCallState:is,GroupCallStatsReportEvent:es,GroupCallType:Qo,GuestAccess:ta,HTTPError:qn,HistoryVisibility:ra,HttpApiEvent:Jn,IdentityPrefix:hi,IdentityProviderBrand:fg,IndexedDBCryptoStore:vg,IndexedDBStore:Yh,InteractiveAuth:Bh,InvalidCryptoStoreError:bc,InvalidCryptoStoreState:yc,JoinRule:Zs,KNOWN_SAFE_ROOM_VERSION:ki,KeySignatureUploadError:wc,KnownMembership:lt,LOCAL_NOTIFICATION_SETTINGS_PREFIX:st,LocalStorageCryptoStore:cg,LocalStorageErrors:Sg,LocationAssetType:S,MAIN_ROOM_TIMELINE:T,MAXIMUM_MATRIX_VERSION:Ws,MINIMUM_MATRIX_VERSION:Vs,MSC3912_RELATION_BASED_REDACTIONS_PROP:tt,M_ASSET:E,M_BEACON:Ca,M_BEACON_INFO:Ta,M_HTML:zr,M_LOCATION:I,M_MESSAGE:Gr,M_POLL_END:En,M_POLL_KIND_DISCLOSED:yn,M_POLL_KIND_UNDISCLOSED:bn,M_POLL_RESPONSE:Sn,M_POLL_START:wn,M_TEXT:Hr,M_TIMESTAMP:R,M_TOPIC:Yr,MatrixClient:Cd,MatrixError:Vn,MatrixEvent:$d,MatrixEventEvent:zd,MatrixHttpApi:wi,MatrixScheduler:Oa,MediaHandlerEvent:pa,MediaPrefix:gi,MemoryCryptoStore:Ie,MemoryStore:iu,Method:jn,MsgType:Ge,NoAuthFlowFoundError:jh,NotificationCountType:Ci,OidcError:jl,OidcTokenRefresher:ud,PUSHER_DEVICE_ID:ot,PUSHER_ENABLED:it,PendingEventOrdering:_d,Poll:kn,PollEvent:Rn,Preset:Xs,ProfileKeyMSC4175Timezone:bg,PushRuleActionName:Is,PushRuleKind:Ms,REFERENCE_RELATION:$r,ReceiptType:k,RelatedRelations:wg,RelationType:We,Relations:Mr,RelationsEvent:Or,RestrictedAllowType:ea,Room:Mi,RoomCreateTypeField:He,RoomEvent:Oi,RoomMember:ut,RoomMemberEvent:dt,RoomNameType:Di,RoomState:eu,RoomStateEvent:Zd,RoomSummary:Ur,RoomType:ze,RoomVersionStability:Si,RoomWidgetClient:Rh,RoomWidgetClientEvent:Eh,RuleId:Ps,SERVICE_TYPES:$s,SSOAction:yg,STABLE_MSC4133_EXTENDED_PROFILES:Rd,SUPPORTED_MATRIX_VERSIONS:qs,SearchOrderBy:ga,SearchResult:Ys,SecretStorage:pc,ServerCapabilities:Ei,SetPresence:Vi,SlidingSyncEvent:fa,StatsReport:Wo,SyncAccumulator:Oh,SyncState:Bi,THREAD_RELATION_TYPE:qd,Thread:Fd,ThreadEvent:Ud,ThreadFilterType:Vd,ThreepidMedium:mg,TimelineIndex:Uh,TimelineWindow:xh,ToDeviceMessageId:$e,TokenRefreshError:Hn,TokenRefreshLogoutError:zn,TweakName:ks,TypedEventEmitter:qe,UNSIGNED_MEMBERSHIP_FIELD:ct,UNSIGNED_THREAD_ID_FIELD:at,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:rt,UNSTABLE_MSC2666_MUTUAL_ROOMS:bd,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:wd,UNSTABLE_MSC2666_SHARED_ROOMS:yd,UNSTABLE_MSC2716_MARKER:et,UNSTABLE_MSC3088_ENABLED:Ye,UNSTABLE_MSC3088_PURPOSE:Je,UNSTABLE_MSC3089_BRANCH:Ze,UNSTABLE_MSC3089_LEAF:Xe,UNSTABLE_MSC3089_TREE_SUBTYPE:Qe,UNSTABLE_MSC3852_LAST_SEEN_UA:md,UNSTABLE_MSC4133_EXTENDED_PROFILES:Ed,UNSTABLE_MSC4140_DELAYED_EVENTS:Sd,UnsupportedDelayedEventsEndpointError:Ec,UpdateDelayedEventAction:fc,User:Ir,UserEvent:Rr,Visibility:Qs,anySignal:Zn,calculateRetryBackoff:ii,completeAuthorizationCodeGrant:nd,createClient:Tg,createNewMatrixCall:Rs,createRoomWidgetClient:Cg,decodeBase64:fo,decodeIdToken:Hl,determineFeatureSupport:Nd,discoverAndValidateOIDCIssuerWellKnown:sd,encodeBase64:vo,encodeUnpaddedBase64:mo,encodeUnpaddedBase64Url:_o,fixNotificationCountOnDecryption:Md,generateAuthorizationParams:ed,generateAuthorizationUrl:td,generateOidcAuthorizationUrl:rd,generateScope:Xl,getBeaconInfoIdentifier:gn,getHttpUriForMxc:Ce,inMainTimelineForReceipt:Dd,isDmMemberCountCondition:Cs,isEventTypeSame:Jr,isPollEvent:Tn,isTimestampInDuration:hn,localStorageErrorsEventsEmitter:Eg,parseErrorResponse:ei,registerOidcClient:dd,retryNetworkOperation:ri,safeGetRetryAfterMs:Wn,setCryptoStoreFactory:Ig,threadFilterTypeToFilter:Wd,threadIdForReceipt:Pd,timeoutSignal:Xn,validateAuthMetadata:Gl,validateAuthMetadataAndKeys:ad,validateBearerTokenResponse:Jl,validateIdToken:zl,validateStoredUserState:$l});let Dg;function Ag(e){Dg=e}let xg=null;function Ug(){return null!==xg&&0!==xg.byteLength||(xg=new Uint8Array(Dg.memory.buffer)),xg}const Lg="undefined"==typeof TextDecoder?(0,module.require)("util").TextDecoder:TextDecoder;let Ng=new Lg("utf-8",{ignoreBOM:!0,fatal:!0});Ng.decode();let Fg=0;function jg(e,t){return function(e,t){return Fg+=t,Fg>=2146435072&&(Ng=new Lg("utf-8",{ignoreBOM:!0,fatal:!0}),Ng.decode(),Fg=t),Ng.decode(Ug().subarray(e,e+t))}(e>>>=0,t)}let Bg=0;const Kg=new("undefined"==typeof TextEncoder?(0,module.require)("util").TextEncoder:TextEncoder)("utf-8"),qg="function"==typeof Kg.encodeInto?function(e,t){return Kg.encodeInto(e,t)}:function(e,t){const r=Kg.encode(e);return t.set(r),{read:e.length,written:r.length}};function Vg(e,t,r){if(void 0===r){const r=Kg.encode(e),n=t(r.length,1)>>>0;return Ug().subarray(n,n+r.length).set(r),Bg=r.length,n}let n=e.length,i=t(n,1)>>>0;const o=Ug();let s=0;for(;s<n;s++){const t=e.charCodeAt(s);if(t>127)break;o[i+s]=t}if(s!==n){0!==s&&(e=e.slice(s)),i=r(i,n,n=s+3*e.length,1)>>>0;const t=Ug().subarray(i+s,i+n);s+=qg(e,t).written,i=r(i,n,s,1)>>>0}return Bg=s,i}let Wg=null;function Gg(){return(null===Wg||!0===Wg.buffer.detached||void 0===Wg.buffer.detached&&Wg.buffer!==Dg.memory.buffer)&&(Wg=new DataView(Dg.memory.buffer)),Wg}function Hg(e){const t=Dg.__externref_table_alloc();return Dg.__wbindgen_export_4.set(t,e),t}function zg(e,t){try{return e.apply(this,t)}catch(e){const t=Hg(e);Dg.__wbindgen_exn_store(t)}}function $g(e){return null==e}function Jg(e,t){return e>>>=0,Ug().subarray(e/1,e/1+t)}const Yg="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>{Dg.__wbindgen_export_6.get(e.dtor)(e.a,e.b)});function Qg(e,t,r,n){const i={a:e,b:t,cnt:1,dtor:r},o=(...e)=>{i.cnt++;const t=i.a;i.a=0;try{return n(t,i.b,...e)}finally{0===--i.cnt?(Dg.__wbindgen_export_6.get(i.dtor)(t,i.b),Yg.unregister(i)):i.a=t}};return o.original=i,Yg.register(o,i,i),o}function Xg(e,t,r,n){const i={a:e,b:t,cnt:1,dtor:r},o=(...e)=>{i.cnt++;try{return n(i.a,i.b,...e)}finally{0===--i.cnt&&(Dg.__wbindgen_export_6.get(i.dtor)(i.a,i.b),i.a=0,Yg.unregister(i))}};return o.original=i,Yg.register(o,i,i),o}function Zg(e){const t=typeof e;if("number"==t||"boolean"==t||null==e)return`${e}`;if("string"==t)return`"${e}"`;if("symbol"==t){const t=e.description;return null==t?"Symbol":`Symbol(${t})`}if("function"==t){const t=e.name;return"string"==typeof t&&t.length>0?`Function(${t})`:"Function"}if(Array.isArray(e)){const t=e.length;let r="[";t>0&&(r+=Zg(e[0]));for(let n=1;n<t;n++)r+=", "+Zg(e[n]);return r+="]",r}const r=/\[object ([^\]]+)\]/.exec(toString.call(e));let n;if(!(r&&r.length>1))return toString.call(e);if(n=r[1],"Object"==n)try{return"Object("+JSON.stringify(e)+")"}catch(e){return"Object"}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:n}function ep(e,t){const r=t(1*e.length,1)>>>0;return Ug().set(e,r/1),Bg=e.length,r}function tp(e){const t=Dg.__wbindgen_export_4.get(e);return Dg.__externref_table_dealloc(e),t}function rp(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`)}function np(e,t){const r=t(4*e.length,4)>>>0;for(let t=0;t<e.length;t++){const n=Hg(e[t]);Gg().setUint32(r+4*t,n,!0)}return Bg=e.length,r}function ip(e,t){e>>>=0;const r=Gg(),n=[];for(let i=e;i<e+4*t;i+=4)n.push(Dg.__wbindgen_export_4.get(r.getUint32(i,!0)));return Dg.__externref_drop_slice(e,t),n}let op=null;function sp(e,t){return e>>>=0,(null!==op&&0!==op.byteLength||(op=new Uint16Array(Dg.memory.buffer)),op).subarray(e/2,e/2+t)}function ap(){const e=Dg.getVersions();return z_.__wrap(e)}function cp(e,t,r){const n=Dg.closure41_externref_shim_multivalue_shim(e,t,r);if(n[1])throw tp(n[0])}function lp(e,t){Dg.wasm_bindgen__convert__closures_____invoke__h8861d869601ff522(e,t)}function dp(e,t,r){Dg.closure756_externref_shim(e,t,r)}function up(e,t,r){Dg.closure438_externref_shim(e,t,r)}function hp(e,t){Dg.wasm_bindgen__convert__closures_____invoke__hce61fd14ea1a6ce1(e,t)}const gp=Object.freeze({MissingRoomKey:0,0:"MissingRoomKey",UnknownMessageIndex:1,1:"UnknownMessageIndex",MismatchedIdentityKeys:2,2:"MismatchedIdentityKeys",UnknownSenderDevice:3,3:"UnknownSenderDevice",UnsignedSenderDevice:4,4:"UnsignedSenderDevice",SenderIdentityVerificationViolation:5,5:"SenderIdentityVerificationViolation",UnableToDecrypt:6,6:"UnableToDecrypt",MismatchedSender:7,7:"MismatchedSender"}),pp=Object.freeze({Ed25519:0,0:"Ed25519",Curve25519:1,1:"Curve25519",Unknown:3,3:"Unknown"}),vp=Object.freeze({Curve25519:0,0:"Curve25519",Ed25519:1,1:"Ed25519",Unknown:2,2:"Unknown"}),mp=Object.freeze({OlmV1Curve25519AesSha2:0,0:"OlmV1Curve25519AesSha2",MegolmV1AesSha2:1,1:"MegolmV1AesSha2",Unknown:2,2:"Unknown"}),_p=Object.freeze({Invited:0,0:"Invited",Joined:1,1:"Joined",Shared:2,2:"Shared",WorldReadable:3,3:"WorldReadable"}),fp=Object.freeze({Verified:0,0:"Verified",BlackListed:1,1:"BlackListed",Ignored:2,2:"Ignored",Unset:3,3:"Unset"}),yp=Object.freeze({Trace:0,0:"Trace",Debug:1,1:"Debug",Info:2,2:"Info",Warn:3,3:"Warn",Error:4,4:"Error"}),bp=Object.freeze({Decrypted:0,0:"Decrypted",UnableToDecrypt:1,1:"UnableToDecrypt",PlainText:2,2:"PlainText",Invalid:3,3:"Invalid"}),wp=Object.freeze({Login:0,0:"Login",Reciprocate:1,1:"Reciprocate"}),Sp=Object.freeze({Created:0,0:"Created",Scanned:1,1:"Scanned",Confirmed:2,2:"Confirmed",Reciprocated:3,3:"Reciprocated",Done:4,4:"Done",Cancelled:5,5:"Cancelled"}),Ep=Object.freeze({KeysUpload:0,0:"KeysUpload",KeysQuery:1,1:"KeysQuery",KeysClaim:2,2:"KeysClaim",ToDevice:3,3:"ToDevice",SignatureUpload:4,4:"SignatureUpload",RoomMessage:5,5:"RoomMessage",KeysBackup:6,6:"KeysBackup"}),Rp=Object.freeze({Red:0,0:"Red",Grey:1,1:"Grey",None:2,2:"None"}),Ip=Object.freeze({AuthenticityNotGuaranteed:0,0:"AuthenticityNotGuaranteed",UnknownDevice:1,1:"UnknownDevice",UnsignedDevice:2,2:"UnsignedDevice",UnverifiedIdentity:3,3:"UnverifiedIdentity",SentInClear:4,4:"SentInClear",VerificationViolation:5,5:"VerificationViolation",MismatchedSender:6,6:"MismatchedSender"}),kp=Object.freeze({Missing:0,0:"Missing",Invalid:1,1:"Invalid",ValidButNotTrusted:2,2:"ValidButNotTrusted",ValidAndTrusted:3,3:"ValidAndTrusted"}),Tp=Object.freeze({DecryptionFailure:0,0:"DecryptionFailure",UnverifiedSenderDevice:1,1:"UnverifiedSenderDevice",NoOlmMachine:2,2:"NoOlmMachine",EncryptionIsDisabled:3,3:"EncryptionIsDisabled"}),Cp=Object.freeze({Untrusted:0,0:"Untrusted",CrossSignedOrLegacy:1,1:"CrossSignedOrLegacy",CrossSigned:2,2:"CrossSigned"}),Op=Object.freeze({SasV1:0,0:"SasV1",QrCodeScanV1:1,1:"QrCodeScanV1",QrCodeShowV1:2,2:"QrCodeShowV1",ReciprocateV1:3,3:"ReciprocateV1"}),Mp=Object.freeze({Created:0,0:"Created",Requested:1,1:"Requested",Ready:2,2:"Ready",Transitioned:3,3:"Transitioned",Done:4,4:"Done",Cancelled:5,5:"Cancelled"}),Pp=["pending","done"],Dp=["readonly","readwrite","versionchange","readwriteflush","cleanup"],Ap="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_attachment_free(e>>>0,1));const xp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_backupdecryptionkey_free(e>>>0,1));class Up{static __wrap(e){e>>>=0;const t=Object.create(Up.prototype);return t.__wbg_ptr=e,xp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,xp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_backupdecryptionkey_free(e,0)}static createRandomKey(){const e=Dg.backupdecryptionkey_createRandomKey();return Up.__wrap(e)}static fromBase64(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.backupdecryptionkey_fromBase64(t,r);if(n[2])throw tp(n[1]);return Up.__wrap(n[0])}toBase64(){return Dg.backupdecryptionkey_toBase64(this.__wbg_ptr)}get megolmV1PublicKey(){const e=Dg.backupdecryptionkey_megolmV1PublicKey(this.__wbg_ptr);return pm.__wrap(e)}decryptV1(e,t,r){let n,i;try{const a=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg,l=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),d=Bg,u=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),h=Bg,g=Dg.backupdecryptionkey_decryptV1(this.__wbg_ptr,a,c,l,d,u,h);var o=g[0],s=g[1];if(g[3])throw o=0,s=0,tp(g[2]);return n=o,i=s,jg(o,s)}finally{Dg.__wbindgen_free(n,i,1)}}}const Lp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_backupkeys_free(e>>>0,1));class Np{static __wrap(e){e>>>=0;const t=Object.create(Np.prototype);return t.__wbg_ptr=e,Lp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Lp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_backupkeys_free(e,0)}get decryptionKey(){const e=Dg.__wbg_get_backupkeys_decryptionKey(this.__wbg_ptr);return 0===e?void 0:Up.__wrap(e)}set decryptionKey(e){let t=0;$g(e)||(rp(e,Up),t=e.__destroy_into_raw()),Dg.__wbg_set_backupkeys_decryptionKey(this.__wbg_ptr,t)}get backupVersion(){const e=Dg.__wbg_get_backupkeys_backupVersion(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set backupVersion(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupkeys_backupVersion(this.__wbg_ptr,t,r)}get decryptionKeyBase64(){return Dg.backupkeys_decryptionKeyBase64(this.__wbg_ptr)}}const Fp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_backupsecretsbundle_free(e>>>0,1));class jp{static __wrap(e){e>>>=0;const t=Object.create(jp.prototype);return t.__wbg_ptr=e,Fp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Fp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_backupsecretsbundle_free(e,0)}get key(){let e,t;try{const r=Dg.__wbg_get_backupsecretsbundle_key(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set key(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get backup_version(){let e,t;try{const r=Dg.__wbg_get_backupsecretsbundle_backup_version(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set backup_version(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_backup_version(this.__wbg_ptr,t,r)}}const Bp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_base64encodedpkmessage_free(e>>>0,1));class Kp{static __wrap(e){e>>>=0;const t=Object.create(Kp.prototype);return t.__wbg_ptr=e,Bp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Bp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_base64encodedpkmessage_free(e,0)}get ciphertext(){let e,t;try{const r=Dg.__wbg_get_base64encodedpkmessage_ciphertext(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set ciphertext(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get mac(){let e,t;try{const r=Dg.__wbg_get_base64encodedpkmessage_mac(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set mac(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_backup_version(this.__wbg_ptr,t,r)}get ephemeralKey(){let e,t;try{const r=Dg.__wbg_get_base64encodedpkmessage_ephemeralKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set ephemeralKey(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_base64encodedpkmessage_ephemeralKey(this.__wbg_ptr,t,r)}constructor(e,t,r){const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg,l=Dg.base64encodedpkmessage_new(n,i,o,s,a,c);return this.__wbg_ptr=l>>>0,Bp.register(this,this.__wbg_ptr,this),this}}const qp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_basemigrationdata_free(e>>>0,1));class Vp{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,qp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_basemigrationdata_free(e,0)}get userId(){const e=Dg.__wbg_get_basemigrationdata_userId(this.__wbg_ptr);return 0===e?void 0:V_.__wrap(e)}set userId(e){let t=0;$g(e)||(rp(e,V_),t=e.__destroy_into_raw()),Dg.__wbg_set_basemigrationdata_userId(this.__wbg_ptr,t)}get deviceId(){const e=Dg.__wbg_get_basemigrationdata_deviceId(this.__wbg_ptr);return 0===e?void 0:wv.__wrap(e)}set deviceId(e){let t=0;$g(e)||(rp(e,wv),t=e.__destroy_into_raw()),Dg.__wbg_set_basemigrationdata_deviceId(this.__wbg_ptr,t)}get pickledAccount(){let e,t;try{const r=Dg.__wbg_get_basemigrationdata_pickledAccount(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set pickledAccount(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get backupVersion(){const e=Dg.__wbg_get_basemigrationdata_backupVersion(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set backupVersion(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_backupVersion(this.__wbg_ptr,t,r)}get backupRecoveryKey(){const e=Dg.__wbg_get_basemigrationdata_backupRecoveryKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set backupRecoveryKey(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_backupRecoveryKey(this.__wbg_ptr,t,r)}get privateCrossSigningMasterKey(){const e=Dg.__wbg_get_basemigrationdata_privateCrossSigningMasterKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set privateCrossSigningMasterKey(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_privateCrossSigningMasterKey(this.__wbg_ptr,t,r)}get privateCrossSigningSelfSigningKey(){const e=Dg.__wbg_get_basemigrationdata_privateCrossSigningSelfSigningKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set privateCrossSigningSelfSigningKey(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_privateCrossSigningSelfSigningKey(this.__wbg_ptr,t,r)}get privateCrossSigningUserSigningKey(){const e=Dg.__wbg_get_basemigrationdata_privateCrossSigningUserSigningKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set privateCrossSigningUserSigningKey(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_privateCrossSigningUserSigningKey(this.__wbg_ptr,t,r)}constructor(){const e=Dg.basemigrationdata_new();return this.__wbg_ptr=e>>>0,qp.register(this,this.__wbg_ptr,this),this}}const Wp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_cancelinfo_free(e>>>0,1));class Gp{static __wrap(e){e>>>=0;const t=Object.create(Gp.prototype);return t.__wbg_ptr=e,Wp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Wp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_cancelinfo_free(e,0)}reason(){return Dg.cancelinfo_reason(this.__wbg_ptr)}cancelCode(){let e,t;try{const r=Dg.cancelinfo_cancelCode(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}cancelledbyUs(){return 0!==Dg.cancelinfo_cancelledbyUs(this.__wbg_ptr)}}const Hp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_checkcode_free(e>>>0,1));class zp{static __wrap(e){e>>>=0;const t=Object.create(zp.prototype);return t.__wbg_ptr=e,Hp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Hp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_checkcode_free(e,0)}as_bytes(){const e=Dg.checkcode_as_bytes(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}to_digit(){return Dg.checkcode_to_digit(this.__wbg_ptr)}}const $p="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_collectstrategy_free(e>>>0,1));class Jp{static __wrap(e){e>>>=0;const t=Object.create(Jp.prototype);return t.__wbg_ptr=e,$p.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,$p.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_collectstrategy_free(e,0)}eq(e){rp(e,Jp);return 0!==Dg.collectstrategy_eq(this.__wbg_ptr,e.__wbg_ptr)}static deviceBasedStrategy(e,t){const r=Dg.collectstrategy_deviceBasedStrategy(e,t);return Jp.__wrap(r)}static allDevices(){const e=Dg.collectstrategy_allDevices();return Jp.__wrap(e)}static errorOnUnverifiedUserProblem(){const e=Dg.collectstrategy_errorOnUnverifiedUserProblem();return Jp.__wrap(e)}static identityBasedStrategy(){const e=Dg.collectstrategy_identityBasedStrategy();return Jp.__wrap(e)}static onlyTrustedDevices(){const e=Dg.collectstrategy_onlyTrustedDevices();return Jp.__wrap(e)}}const Yp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_crosssigningbootstraprequests_free(e>>>0,1));class Qp{static __wrap(e){e>>>=0;const t=Object.create(Qp.prototype);return t.__wbg_ptr=e,Yp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Yp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_crosssigningbootstraprequests_free(e,0)}get uploadKeysRequest(){return Dg.__wbg_get_crosssigningbootstraprequests_uploadKeysRequest(this.__wbg_ptr)}get uploadSigningKeysRequest(){const e=Dg.__wbg_get_crosssigningbootstraprequests_uploadSigningKeysRequest(this.__wbg_ptr);return j_.__wrap(e)}get uploadSignaturesRequest(){const e=Dg.__wbg_get_crosssigningbootstraprequests_uploadSignaturesRequest(this.__wbg_ptr);return b_.__wrap(e)}}const Xp="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_crosssigningkeyexport_free(e>>>0,1));class Zp{static __wrap(e){e>>>=0;const t=Object.create(Zp.prototype);return t.__wbg_ptr=e,Xp.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Xp.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_crosssigningkeyexport_free(e,0)}get masterKey(){const e=Dg.crosssigningkeyexport_masterKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}get self_signing_key(){const e=Dg.crosssigningkeyexport_self_signing_key(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}get userSigningKey(){const e=Dg.crosssigningkeyexport_userSigningKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}}const ev="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_crosssigningstatus_free(e>>>0,1));class tv{static __wrap(e){e>>>=0;const t=Object.create(tv.prototype);return t.__wbg_ptr=e,ev.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ev.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_crosssigningstatus_free(e,0)}get hasMaster(){return 0!==Dg.crosssigningstatus_hasMaster(this.__wbg_ptr)}get hasSelfSigning(){return 0!==Dg.crosssigningstatus_hasSelfSigning(this.__wbg_ptr)}get hasUserSigning(){return 0!==Dg.crosssigningstatus_hasUserSigning(this.__wbg_ptr)}}const rv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_curve25519publickey_free(e>>>0,1));class nv{static __wrap(e){e>>>=0;const t=Object.create(nv.prototype);return t.__wbg_ptr=e,rv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,rv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_curve25519publickey_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.curve25519publickey_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,rv.register(this,this.__wbg_ptr,this),this}get length(){return Dg.curve25519publickey_length(this.__wbg_ptr)>>>0}toBase64(){let e,t;try{const r=Dg.curve25519publickey_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const iv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_curve25519secretkey_free(e>>>0,1));class ov{static __wrap(e){e>>>=0;const t=Object.create(ov.prototype);return t.__wbg_ptr=e,iv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,iv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_curve25519secretkey_free(e,0)}static new(){const e=Dg.curve25519secretkey_new();return ov.__wrap(e)}static fromBase64(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.curve25519secretkey_fromBase64(t,r);if(n[2])throw tp(n[1]);return ov.__wrap(n[0])}toBase64(){let e,t;try{const r=Dg.curve25519secretkey_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}toUint8Array(){const e=Dg.curve25519secretkey_toUint8Array(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}static fromUint8Array(e){const t=ep(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.curve25519secretkey_fromUint8Array(t,r);if(n[2])throw tp(n[1]);return ov.__wrap(n[0])}}const sv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_decryptedroomevent_free(e>>>0,1));class av{static __wrap(e){e>>>=0;const t=Object.create(av.prototype);return t.__wbg_ptr=e,sv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,sv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_decryptedroomevent_free(e,0)}get event(){return Dg.__wbg_get_decryptedroomevent_event(this.__wbg_ptr)}get sender(){const e=Dg.decryptedroomevent_sender(this.__wbg_ptr);return V_.__wrap(e)}get senderDevice(){const e=Dg.decryptedroomevent_senderDevice(this.__wbg_ptr);return 0===e?void 0:wv.__wrap(e)}get senderCurve25519Key(){let e,t;try{const r=Dg.decryptedroomevent_senderCurve25519Key(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get senderClaimedEd25519Key(){return Dg.decryptedroomevent_senderClaimedEd25519Key(this.__wbg_ptr)}get forwardingCurve25519KeyChain(){return Dg.decryptedroomevent_forwardingCurve25519KeyChain(this.__wbg_ptr)}shieldState(e){const t=Dg.decryptedroomevent_shieldState(this.__wbg_ptr,e);return m_.__wrap(t)}}const cv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_decryptedtodeviceevent_free(e>>>0,1));class lv{static __wrap(e){e>>>=0;const t=Object.create(lv.prototype);return t.__wbg_ptr=e,cv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,cv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_decryptedtodeviceevent_free(e,0)}get rawEvent(){return Dg.__wbg_get_decryptedtodeviceevent_rawEvent(this.__wbg_ptr)}get encryptionInfo(){const e=Dg.__wbg_get_decryptedtodeviceevent_encryptionInfo(this.__wbg_ptr);return M_.__wrap(e)}get type(){return Dg.decryptedtodeviceevent_type(this.__wbg_ptr)}}const dv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_decryptionsettings_free(e>>>0,1));class uv{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,dv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_decryptionsettings_free(e,0)}get sender_device_trust_requirement(){return Dg.__wbg_get_decryptionsettings_sender_device_trust_requirement(this.__wbg_ptr)}set sender_device_trust_requirement(e){Dg.__wbg_set_decryptionsettings_sender_device_trust_requirement(this.__wbg_ptr,e)}constructor(e){const t=Dg.decryptionsettings_new(e);return this.__wbg_ptr=t>>>0,dv.register(this,this.__wbg_ptr,this),this}}const hv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_dehydrateddevice_free(e>>>0,1));class gv{static __wrap(e){e>>>=0;const t=Object.create(gv.prototype);return t.__wbg_ptr=e,hv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,hv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_dehydrateddevice_free(e,0)}keysForUpload(e,t){rp(t,vv);return Dg.dehydrateddevice_keysForUpload(this.__wbg_ptr,e,t.__wbg_ptr)}}const pv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_dehydrateddevicekey_free(e>>>0,1));class vv{static __wrap(e){e>>>=0;const t=Object.create(vv.prototype);return t.__wbg_ptr=e,pv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,pv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_dehydrateddevicekey_free(e,0)}static createRandomKey(){const e=Dg.dehydrateddevicekey_createRandomKey();if(e[2])throw tp(e[1]);return vv.__wrap(e[0])}static createKeyFromArray(e){const t=Dg.dehydrateddevicekey_createKeyFromArray(e);if(t[2])throw tp(t[1]);return vv.__wrap(t[0])}toBase64(){return Dg.dehydrateddevicekey_toBase64(this.__wbg_ptr)}}const mv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_dehydrateddevices_free(e>>>0,1));class _v{static __wrap(e){e>>>=0;const t=Object.create(_v.prototype);return t.__wbg_ptr=e,mv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,mv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_dehydrateddevices_free(e,0)}create(){return Dg.dehydrateddevices_create(this.__wbg_ptr)}rehydrate(e,t,r){rp(e,vv),rp(t,wv);const n=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg;return Dg.dehydrateddevices_rehydrate(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr,n,i)}getDehydratedDeviceKey(){return Dg.dehydrateddevices_getDehydratedDeviceKey(this.__wbg_ptr)}saveDehydratedDeviceKey(e){rp(e,vv);return Dg.dehydrateddevices_saveDehydratedDeviceKey(this.__wbg_ptr,e.__wbg_ptr)}deleteDehydratedDeviceKey(){return Dg.dehydrateddevices_deleteDehydratedDeviceKey(this.__wbg_ptr)}}const fv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_device_free(e>>>0,1));class yv{static __wrap(e){e>>>=0;const t=Object.create(yv.prototype);return t.__wbg_ptr=e,fv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,fv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_device_free(e,0)}requestVerification(e){var t=$g(e)?0:np(e,Dg.__wbindgen_malloc),r=Bg;const n=Dg.device_requestVerification(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return tp(n[0])}encryptToDeviceEvent(e,t,r){const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg;let o=0;$g(r)||(rp(r,Jp),o=r.__destroy_into_raw());return Dg.device_encryptToDeviceEvent(this.__wbg_ptr,n,i,t,o)}isVerified(){return 0!==Dg.device_isVerified(this.__wbg_ptr)}isCrossSigningTrusted(){return 0!==Dg.device_isCrossSigningTrusted(this.__wbg_ptr)}isCrossSignedByOwner(){return 0!==Dg.device_isCrossSignedByOwner(this.__wbg_ptr)}setLocalTrust(e){return Dg.device_setLocalTrust(this.__wbg_ptr,e)}get userId(){const e=Dg.device_userId(this.__wbg_ptr);return V_.__wrap(e)}get deviceId(){const e=Dg.device_deviceId(this.__wbg_ptr);return wv.__wrap(e)}get displayName(){const e=Dg.device_displayName(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}getKey(e){const t=Dg.device_getKey(this.__wbg_ptr,e);if(t[2])throw tp(t[1]);return 0===t[0]?void 0:Ev.__wrap(t[0])}get curve25519Key(){const e=Dg.device_curve25519Key(this.__wbg_ptr);return 0===e?void 0:nv.__wrap(e)}get ed25519Key(){const e=Dg.device_ed25519Key(this.__wbg_ptr);return 0===e?void 0:Dv.__wrap(e)}get keys(){return Dg.device_keys(this.__wbg_ptr)}get algorithms(){return Dg.device_algorithms(this.__wbg_ptr)}get signatures(){const e=Dg.device_signatures(this.__wbg_ptr);return R_.__wrap(e)}get localTrustState(){return Dg.device_localTrustState(this.__wbg_ptr)}isLocallyTrusted(){return 0!==Dg.device_isLocallyTrusted(this.__wbg_ptr)}isBlacklisted(){return 0!==Dg.device_isBlacklisted(this.__wbg_ptr)}isDeleted(){return 0!==Dg.device_isDeleted(this.__wbg_ptr)}firstTimeSeen(){const e=Dg.device_firstTimeSeen(this.__wbg_ptr);return BigInt.asUintN(64,e)}verify(){return Dg.device_verify(this.__wbg_ptr)}get isDehydrated(){return 0!==Dg.device_isDehydrated(this.__wbg_ptr)}}const bv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_deviceid_free(e>>>0,1));class wv{static __wrap(e){e>>>=0;const t=Object.create(wv.prototype);return t.__wbg_ptr=e,bv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,bv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_deviceid_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.deviceid_new(t,r);return this.__wbg_ptr=n>>>0,bv.register(this,this.__wbg_ptr,this),this}toString(){let e,t;try{const r=Dg.deviceid_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Sv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_devicekey_free(e>>>0,1));class Ev{static __wrap(e){e>>>=0;const t=Object.create(Ev.prototype);return t.__wbg_ptr=e,Sv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Sv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_devicekey_free(e,0)}get name(){return Dg.devicekey_name(this.__wbg_ptr)}get curve25519(){const e=Dg.devicekey_curve25519(this.__wbg_ptr);return 0===e?void 0:nv.__wrap(e)}get ed25519(){const e=Dg.devicekey_ed25519(this.__wbg_ptr);return 0===e?void 0:Dv.__wrap(e)}get unknown(){const e=Dg.devicekey_unknown(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}toBase64(){let e,t;try{const r=Dg.devicekey_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Rv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_devicekeyalgorithm_free(e>>>0,1));class Iv{static __wrap(e){e>>>=0;const t=Object.create(Iv.prototype);return t.__wbg_ptr=e,Rv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Rv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_devicekeyalgorithm_free(e,0)}get name(){return Dg.devicekeyalgorithm_name(this.__wbg_ptr)}toString(){let e,t;try{const r=Dg.devicekeyalgorithm_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const kv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_devicekeyid_free(e>>>0,1));class Tv{static __wrap(e){e>>>=0;const t=Object.create(Tv.prototype);return t.__wbg_ptr=e,kv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,kv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_devicekeyid_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.devicekeyid_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,kv.register(this,this.__wbg_ptr,this),this}get algorithm(){const e=Dg.devicekeyid_algorithm(this.__wbg_ptr);return Iv.__wrap(e)}get deviceId(){const e=Dg.devicekeyid_deviceId(this.__wbg_ptr);return wv.__wrap(e)}toString(){let e,t;try{const r=Dg.devicekeyid_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Cv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_devicelists_free(e>>>0,1));class Ov{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Cv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_devicelists_free(e,0)}constructor(e,t){var r=$g(e)?0:np(e,Dg.__wbindgen_malloc),n=Bg,i=$g(t)?0:np(t,Dg.__wbindgen_malloc),o=Bg;const s=Dg.devicelists_new(r,n,i,o);if(s[2])throw tp(s[1]);return this.__wbg_ptr=s[0]>>>0,Cv.register(this,this.__wbg_ptr,this),this}isEmpty(){return 0!==Dg.devicelists_isEmpty(this.__wbg_ptr)}get changed(){const e=Dg.devicelists_changed(this.__wbg_ptr);var t=ip(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],4*e[1],4),t}get left(){const e=Dg.devicelists_left(this.__wbg_ptr);var t=ip(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],4*e[1],4),t}}const Mv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_ecies_free(e>>>0,1));const Pv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_ed25519publickey_free(e>>>0,1));class Dv{static __wrap(e){e>>>=0;const t=Object.create(Dv.prototype);return t.__wbg_ptr=e,Pv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Pv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_ed25519publickey_free(e,0)}get length(){return Dg.ed25519publickey_length(this.__wbg_ptr)>>>0}toBase64(){let e,t;try{const r=Dg.ed25519publickey_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Av="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_ed25519signature_free(e>>>0,1));class xv{static __wrap(e){e>>>=0;const t=Object.create(xv.prototype);return t.__wbg_ptr=e,Av.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Av.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_ed25519signature_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.ed25519signature_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,Av.register(this,this.__wbg_ptr,this),this}toBase64(){let e,t;try{const r=Dg.ed25519signature_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Uv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_emoji_free(e>>>0,1));class Lv{static __wrap(e){e>>>=0;const t=Object.create(Lv.prototype);return t.__wbg_ptr=e,Uv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Uv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_emoji_free(e,0)}get symbol(){return Dg.emoji_symbol(this.__wbg_ptr)}get description(){return Dg.emoji_description(this.__wbg_ptr)}}const Nv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_encryptedattachment_free(e>>>0,1));class Fv{static __wrap(e){e>>>=0;const t=Object.create(Fv.prototype);return t.__wbg_ptr=e,Nv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Nv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_encryptedattachment_free(e,0)}constructor(e,t){const r=ep(e,Dg.__wbindgen_malloc),n=Bg,i=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),o=Bg,s=Dg.encryptedattachment_new(r,n,i,o);if(s[2])throw tp(s[1]);return this.__wbg_ptr=s[0]>>>0,Nv.register(this,this.__wbg_ptr,this),this}get encryptedData(){const e=Dg.encryptedattachment_encryptedData(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}get mediaEncryptionInfo(){const e=Dg.encryptedattachment_mediaEncryptionInfo(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}get hasMediaEncryptionInfoBeenConsumed(){return 0!==Dg.encryptedattachment_hasMediaEncryptionInfoBeenConsumed(this.__wbg_ptr)}}const jv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_encryptioninfo_free(e>>>0,1));class Bv{static __wrap(e){e>>>=0;const t=Object.create(Bv.prototype);return t.__wbg_ptr=e,jv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,jv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_encryptioninfo_free(e,0)}get sender(){const e=Dg.__wbg_get_encryptioninfo_sender(this.__wbg_ptr);return V_.__wrap(e)}set sender(e){rp(e,V_);var t=e.__destroy_into_raw();Dg.__wbg_set_encryptioninfo_sender(this.__wbg_ptr,t)}get senderDevice(){const e=Dg.__wbg_get_encryptioninfo_senderDevice(this.__wbg_ptr);return 0===e?void 0:wv.__wrap(e)}set senderDevice(e){let t=0;$g(e)||(rp(e,wv),t=e.__destroy_into_raw()),Dg.__wbg_set_encryptioninfo_senderDevice(this.__wbg_ptr,t)}get senderCurve25519Key(){let e,t;try{const r=Dg.__wbg_get_encryptioninfo_senderCurve25519Key(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set senderCurve25519Key(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get senderClaimedEd25519Key(){const e=Dg.__wbg_get_encryptioninfo_senderClaimedEd25519Key(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set senderClaimedEd25519Key(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_backupVersion(this.__wbg_ptr,t,r)}shieldState(e){const t=Dg.encryptioninfo_shieldState(this.__wbg_ptr,e);return m_.__wrap(t)}}const Kv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_encryptionsettings_free(e>>>0,1));class qv{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Kv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_encryptionsettings_free(e,0)}get algorithm(){return Dg.__wbg_get_encryptionsettings_algorithm(this.__wbg_ptr)}set algorithm(e){Dg.__wbg_set_encryptionsettings_algorithm(this.__wbg_ptr,e)}get encryptStateEvents(){return 0!==Dg.__wbg_get_encryptionsettings_encryptStateEvents(this.__wbg_ptr)}set encryptStateEvents(e){Dg.__wbg_set_encryptionsettings_encryptStateEvents(this.__wbg_ptr,e)}get rotationPeriod(){const e=Dg.__wbg_get_encryptionsettings_rotationPeriod(this.__wbg_ptr);return BigInt.asUintN(64,e)}set rotationPeriod(e){Dg.__wbg_set_encryptionsettings_rotationPeriod(this.__wbg_ptr,e)}get rotationPeriodMessages(){const e=Dg.__wbg_get_encryptionsettings_rotationPeriodMessages(this.__wbg_ptr);return BigInt.asUintN(64,e)}set rotationPeriodMessages(e){Dg.__wbg_set_encryptionsettings_rotationPeriodMessages(this.__wbg_ptr,e)}get historyVisibility(){return Dg.__wbg_get_encryptionsettings_historyVisibility(this.__wbg_ptr)}set historyVisibility(e){Dg.__wbg_set_encryptionsettings_historyVisibility(this.__wbg_ptr,e)}get sharingStrategy(){const e=Dg.__wbg_get_encryptionsettings_sharingStrategy(this.__wbg_ptr);return Jp.__wrap(e)}set sharingStrategy(e){rp(e,Jp);var t=e.__destroy_into_raw();Dg.__wbg_set_encryptionsettings_sharingStrategy(this.__wbg_ptr,t)}constructor(){const e=Dg.encryptionsettings_new();return this.__wbg_ptr=e>>>0,Kv.register(this,this.__wbg_ptr,this),this}}const Vv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_establishedecies_free(e>>>0,1));class Wv{static __wrap(e){e>>>=0;const t=Object.create(Wv.prototype);return t.__wbg_ptr=e,Vv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Vv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_establishedecies_free(e,0)}public_key(){const e=Dg.establishedecies_public_key(this.__wbg_ptr);return nv.__wrap(e)}encrypt(e){let t,r;try{const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=Dg.establishedecies_encrypt(this.__wbg_ptr,n,i);return t=o[0],r=o[1],jg(o[0],o[1])}finally{Dg.__wbindgen_free(t,r,1)}}decrypt(e){let t,r;try{const o=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=Dg.establishedecies_decrypt(this.__wbg_ptr,o,s);var n=a[0],i=a[1];if(a[3])throw n=0,i=0,tp(a[2]);return t=n,r=i,jg(n,i)}finally{Dg.__wbindgen_free(t,r,1)}}check_code(){const e=Dg.establishedecies_check_code(this.__wbg_ptr);return zp.__wrap(e)}}const Gv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_eventid_free(e>>>0,1));class Hv{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Gv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_eventid_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.eventid_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,Gv.register(this,this.__wbg_ptr,this),this}get localpart(){let e,t;try{const r=Dg.eventid_localpart(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get serverName(){const e=Dg.eventid_serverName(this.__wbg_ptr);return 0===e?void 0:p_.__wrap(e)}toString(){let e,t;try{const r=Dg.eventid_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const zv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_identitykeys_free(e>>>0,1));class $v{static __wrap(e){e>>>=0;const t=Object.create($v.prototype);return t.__wbg_ptr=e,zv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,zv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_identitykeys_free(e,0)}get ed25519(){const e=Dg.__wbg_get_identitykeys_ed25519(this.__wbg_ptr);return Dv.__wrap(e)}set ed25519(e){rp(e,Dv);var t=e.__destroy_into_raw();Dg.__wbg_set_identitykeys_ed25519(this.__wbg_ptr,t)}get curve25519(){const e=Dg.__wbg_get_identitykeys_curve25519(this.__wbg_ptr);return nv.__wrap(e)}set curve25519(e){rp(e,nv);var t=e.__destroy_into_raw();Dg.__wbg_set_identitykeys_curve25519(this.__wbg_ptr,t)}}const Jv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_inboundcreationresult_free(e>>>0,1));class Yv{static __wrap(e){e>>>=0;const t=Object.create(Yv.prototype);return t.__wbg_ptr=e,Jv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Jv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_inboundcreationresult_free(e,0)}get channel(){const e=Dg.__wbg_get_inboundcreationresult_channel(this.__wbg_ptr);return Wv.__wrap(e)}set channel(e){rp(e,Wv);var t=e.__destroy_into_raw();Dg.__wbg_set_inboundcreationresult_channel(this.__wbg_ptr,t)}get message(){let e,t;try{const r=Dg.__wbg_get_inboundcreationresult_message(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set message(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}}const Qv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_inboundgroupsession_free(e>>>0,1));class Xv{static __wrap(e){e>>>=0;const t=Object.create(Xv.prototype);return t.__wbg_ptr=e,Qv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Qv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_inboundgroupsession_free(e,0)}get roomId(){const e=Dg.inboundgroupsession_roomId(this.__wbg_ptr);return Ym.__wrap(e)}get senderKey(){const e=Dg.inboundgroupsession_senderKey(this.__wbg_ptr);return nv.__wrap(e)}get sessionId(){let e,t;try{const r=Dg.inboundgroupsession_sessionId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}hasBeenImported(){return 0!==Dg.inboundgroupsession_hasBeenImported(this.__wbg_ptr)}}const Zv="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_invalidtodeviceevent_free(e>>>0,1));class em{static __wrap(e){e>>>=0;const t=Object.create(em.prototype);return t.__wbg_ptr=e,Zv.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Zv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_invalidtodeviceevent_free(e,0)}get rawEvent(){return Dg.__wbg_get_invalidtodeviceevent_rawEvent(this.__wbg_ptr)}get type(){return Dg.invalidtodeviceevent_type(this.__wbg_ptr)}}const tm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_keysbackuprequest_free(e>>>0,1));class rm{static __wrap(e){e>>>=0;const t=Object.create(rm.prototype);return t.__wbg_ptr=e,tm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,tm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_keysbackuprequest_free(e,0)}get id(){return Dg.__wbg_get_keysbackuprequest_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_keysbackuprequest_body(this.__wbg_ptr)}get version(){return Dg.__wbg_get_keysbackuprequest_version(this.__wbg_ptr)}constructor(e,t,r){const n=Dg.keysbackuprequest_new(e,t,r);return this.__wbg_ptr=n>>>0,tm.register(this,this.__wbg_ptr,this),this}get type(){return Dg.keysbackuprequest_type(this.__wbg_ptr)}}const nm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_keysclaimrequest_free(e>>>0,1));class im{static __wrap(e){e>>>=0;const t=Object.create(im.prototype);return t.__wbg_ptr=e,nm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,nm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_keysclaimrequest_free(e,0)}get id(){return Dg.__wbg_get_keysclaimrequest_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_keysclaimrequest_body(this.__wbg_ptr)}constructor(e,t){const r=Dg.keysclaimrequest_new(e,t);return this.__wbg_ptr=r>>>0,nm.register(this,this.__wbg_ptr,this),this}get type(){return Dg.keysclaimrequest_type(this.__wbg_ptr)}}const om="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_keysqueryrequest_free(e>>>0,1));class sm{static __wrap(e){e>>>=0;const t=Object.create(sm.prototype);return t.__wbg_ptr=e,om.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,om.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_keysqueryrequest_free(e,0)}get id(){return Dg.__wbg_get_keysqueryrequest_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_keysqueryrequest_body(this.__wbg_ptr)}constructor(e,t){const r=Dg.keysqueryrequest_new(e,t);return this.__wbg_ptr=r>>>0,om.register(this,this.__wbg_ptr,this),this}get type(){return Dg.keysqueryrequest_type(this.__wbg_ptr)}}const am="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_keysuploadrequest_free(e>>>0,1));class cm{static __wrap(e){e>>>=0;const t=Object.create(cm.prototype);return t.__wbg_ptr=e,am.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,am.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_keysuploadrequest_free(e,0)}get id(){return Dg.__wbg_get_keysuploadrequest_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_keysuploadrequest_body(this.__wbg_ptr)}constructor(e,t){const r=Dg.keysuploadrequest_new(e,t);return this.__wbg_ptr=r>>>0,am.register(this,this.__wbg_ptr,this),this}get type(){return Dg.keysuploadrequest_type(this.__wbg_ptr)}}const lm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_maybesignature_free(e>>>0,1));class dm{static __wrap(e){e>>>=0;const t=Object.create(dm.prototype);return t.__wbg_ptr=e,lm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,lm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_maybesignature_free(e,0)}isValid(){return 0!==Dg.maybesignature_isValid(this.__wbg_ptr)}isInvalid(){return 0!==Dg.maybesignature_isInvalid(this.__wbg_ptr)}get signature(){const e=Dg.maybesignature_signature(this.__wbg_ptr);return 0===e?void 0:f_.__wrap(e)}get invalidSignatureSource(){const e=Dg.maybesignature_invalidSignatureSource(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}}const um="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_megolmdecryptionerror_free(e>>>0,1));class hm{static __wrap(e){e>>>=0;const t=Object.create(hm.prototype);return t.__wbg_ptr=e,um.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,um.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_megolmdecryptionerror_free(e,0)}get code(){return Dg.__wbg_get_megolmdecryptionerror_code(this.__wbg_ptr)}get description(){return Dg.__wbg_get_megolmdecryptionerror_description(this.__wbg_ptr)}get maybe_withheld(){return Dg.__wbg_get_megolmdecryptionerror_maybe_withheld(this.__wbg_ptr)}}const gm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_megolmv1backupkey_free(e>>>0,1));class pm{static __wrap(e){e>>>=0;const t=Object.create(pm.prototype);return t.__wbg_ptr=e,gm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,gm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_megolmv1backupkey_free(e,0)}get publicKeyBase64(){return Dg.megolmv1backupkey_publicKeyBase64(this.__wbg_ptr)}get algorithm(){return Dg.megolmv1backupkey_algorithm(this.__wbg_ptr)}}const vm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_migration_free(e>>>0,1));class mm{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,vm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_migration_free(e,0)}static migrateBaseData(e,t,r,n){rp(e,Vp),rp(r,k_);return Dg.migration_migrateBaseData(e.__wbg_ptr,t,r.__wbg_ptr,$g(n)?0:Hg(n))}static migrateOlmSessions(e,t,r,n){const i=np(e,Dg.__wbindgen_malloc),o=Bg;rp(r,k_);const s=Dg.migration_migrateOlmSessions(i,o,t,r.__wbg_ptr,$g(n)?0:Hg(n));if(s[2])throw tp(s[1]);return tp(s[0])}static migrateMegolmSessions(e,t,r,n){const i=np(e,Dg.__wbindgen_malloc),o=Bg;rp(r,k_);const s=Dg.migration_migrateMegolmSessions(i,o,t,r.__wbg_ptr,$g(n)?0:Hg(n));if(s[2])throw tp(s[1]);return tp(s[0])}}const _m="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_olmmachine_free(e>>>0,1));class fm{static __wrap(e){e>>>=0;const t=Object.create(fm.prototype);return t.__wbg_ptr=e,_m.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,_m.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_olmmachine_free(e,0)}constructor(){const e=Dg.olmmachine_new();if(e[2])throw tp(e[1]);return this.__wbg_ptr=e[0]>>>0,_m.register(this,this.__wbg_ptr,this),this}static initialize(e,t,r,n,i){rp(e,V_),rp(t,wv);var o=$g(r)?0:Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=$g(n)?0:Vg(n,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg;return Dg.olmmachine_initialize(e.__wbg_ptr,t.__wbg_ptr,o,s,a,c,$g(i)?0:Hg(i))}static initFromStore(e,t,r,n){rp(e,V_),rp(t,wv),rp(r,k_);return Dg.olmmachine_initFromStore(e.__wbg_ptr,t.__wbg_ptr,r.__wbg_ptr,$g(n)?0:Hg(n))}get userId(){const e=Dg.olmmachine_userId(this.__wbg_ptr);return V_.__wrap(e)}get deviceId(){const e=Dg.olmmachine_deviceId(this.__wbg_ptr);return wv.__wrap(e)}get deviceCreationTimeMs(){return Dg.olmmachine_deviceCreationTimeMs(this.__wbg_ptr)}get identityKeys(){const e=Dg.olmmachine_identityKeys(this.__wbg_ptr);return $v.__wrap(e)}get displayName(){return Dg.olmmachine_displayName(this.__wbg_ptr)}get roomKeyRequestsEnabled(){return 0!==Dg.olmmachine_roomKeyRequestsEnabled(this.__wbg_ptr)}set roomKeyRequestsEnabled(e){Dg.olmmachine_set_roomKeyRequestsEnabled(this.__wbg_ptr,e)}get roomKeyForwardingEnabled(){return 0!==Dg.olmmachine_roomKeyForwardingEnabled(this.__wbg_ptr)}set roomKeyForwardingEnabled(e){Dg.olmmachine_set_roomKeyForwardingEnabled(this.__wbg_ptr,e)}trackedUsers(){const e=Dg.olmmachine_trackedUsers(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}updateTrackedUsers(e){const t=np(e,Dg.__wbindgen_malloc),r=Bg;return Dg.olmmachine_updateTrackedUsers(this.__wbg_ptr,t,r)}markAllTrackedUsersAsDirty(){return Dg.olmmachine_markAllTrackedUsersAsDirty(this.__wbg_ptr)}receiveSyncChanges(e,t,r,n,i){const o=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg;rp(t,Ov);let a=0;$g(i)||(rp(i,uv),a=i.__destroy_into_raw());const c=Dg.olmmachine_receiveSyncChanges(this.__wbg_ptr,o,s,t.__wbg_ptr,r,$g(n)?0:Hg(n),a);if(c[2])throw tp(c[1]);return tp(c[0])}outgoingRequests(){return Dg.olmmachine_outgoingRequests(this.__wbg_ptr)}markRequestAsSent(e,t,r){const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=Dg.olmmachine_markRequestAsSent(this.__wbg_ptr,n,i,t,o,s);if(a[2])throw tp(a[1]);return tp(a[0])}encryptRoomEvent(e,t,r){rp(e,Ym);const n=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=Dg.olmmachine_encryptRoomEvent(this.__wbg_ptr,e.__wbg_ptr,n,i,o,s);if(a[2])throw tp(a[1]);return tp(a[0])}encryptStateEvent(e,t,r,n){rp(e,Ym);const i=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),o=Bg,s=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),a=Bg,c=Vg(n,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),l=Bg,d=Dg.olmmachine_encryptStateEvent(this.__wbg_ptr,e.__wbg_ptr,i,o,s,a,c,l);if(d[2])throw tp(d[1]);return tp(d[0])}decryptRoomEvent(e,t,r){const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg;rp(t,Ym),rp(r,uv);const o=Dg.olmmachine_decryptRoomEvent(this.__wbg_ptr,n,i,t.__wbg_ptr,r.__wbg_ptr);if(o[2])throw tp(o[1]);return tp(o[0])}getRoomEventEncryptionInfo(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;rp(t,Ym);const i=Dg.olmmachine_getRoomEventEncryptionInfo(this.__wbg_ptr,r,n,t.__wbg_ptr);if(i[2])throw tp(i[1]);return tp(i[0])}crossSigningStatus(){return Dg.olmmachine_crossSigningStatus(this.__wbg_ptr)}exportSecretsBundle(){return Dg.olmmachine_exportSecretsBundle(this.__wbg_ptr)}importSecretsBundle(e){rp(e,h_);var t=e.__destroy_into_raw();return Dg.olmmachine_importSecretsBundle(this.__wbg_ptr,t)}exportCrossSigningKeys(){return Dg.olmmachine_exportCrossSigningKeys(this.__wbg_ptr)}importCrossSigningKeys(e,t,r){var n=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=$g(t)?0:Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg,a=$g(r)?0:Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg;return Dg.olmmachine_importCrossSigningKeys(this.__wbg_ptr,n,i,o,s,a,c)}bootstrapCrossSigning(e){return Dg.olmmachine_bootstrapCrossSigning(this.__wbg_ptr,e)}getIdentity(e){rp(e,V_);return Dg.olmmachine_getIdentity(this.__wbg_ptr,e.__wbg_ptr)}sign(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;return Dg.olmmachine_sign(this.__wbg_ptr,t,r)}invalidateGroupSession(e){rp(e,Ym);return Dg.olmmachine_invalidateGroupSession(this.__wbg_ptr,e.__wbg_ptr)}shareRoomKey(e,t,r){rp(e,Ym);const n=np(t,Dg.__wbindgen_malloc),i=Bg;rp(r,qv);return Dg.olmmachine_shareRoomKey(this.__wbg_ptr,e.__wbg_ptr,n,i,r.__wbg_ptr)}queryKeysForUsers(e){const t=np(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.olmmachine_queryKeysForUsers(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return sm.__wrap(n[0])}getMissingSessions(e){const t=np(e,Dg.__wbindgen_malloc),r=Bg;return Dg.olmmachine_getMissingSessions(this.__wbg_ptr,t,r)}getUserDevices(e,t){rp(e,V_);return Dg.olmmachine_getUserDevices(this.__wbg_ptr,e.__wbg_ptr,!$g(t),$g(t)?0:t)}getDevice(e,t,r){rp(e,V_),rp(t,wv);return Dg.olmmachine_getDevice(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr,!$g(r),$g(r)?0:r)}getVerification(e,t){rp(e,V_);const r=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Dg.olmmachine_getVerification(this.__wbg_ptr,e.__wbg_ptr,r,n);if(i[2])throw tp(i[1]);return tp(i[0])}getVerificationRequest(e,t){rp(e,V_);const r=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Dg.olmmachine_getVerificationRequest(this.__wbg_ptr,e.__wbg_ptr,r,n);return 0===i?void 0:G_.__wrap(i)}getVerificationRequests(e){rp(e,V_);return Dg.olmmachine_getVerificationRequests(this.__wbg_ptr,e.__wbg_ptr)}receiveVerificationEvent(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;rp(t,Ym);const i=Dg.olmmachine_receiveVerificationEvent(this.__wbg_ptr,r,n,t.__wbg_ptr);if(i[2])throw tp(i[1]);return tp(i[0])}exportRoomKeys(e){return Dg.olmmachine_exportRoomKeys(this.__wbg_ptr,e)}importRoomKeys(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Dg.olmmachine_importRoomKeys(this.__wbg_ptr,r,n,t);if(i[2])throw tp(i[1]);return tp(i[0])}importExportedRoomKeys(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Dg.olmmachine_importExportedRoomKeys(this.__wbg_ptr,r,n,t);if(i[2])throw tp(i[1]);return tp(i[0])}importBackedUpRoomKeys(e,t,r){const n=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=Dg.olmmachine_importBackedUpRoomKeys(this.__wbg_ptr,e,$g(t)?0:Hg(t),n,i);if(o[2])throw tp(o[1]);return tp(o[0])}saveBackupDecryptionKey(e,t){rp(e,Up);const r=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;return Dg.olmmachine_saveBackupDecryptionKey(this.__wbg_ptr,e.__wbg_ptr,r,n)}getBackupKeys(){return Dg.olmmachine_getBackupKeys(this.__wbg_ptr)}verifyBackup(e){const t=Dg.olmmachine_verifyBackup(this.__wbg_ptr,e);if(t[2])throw tp(t[1]);return tp(t[0])}enableBackupV1(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),o=Bg,s=Dg.olmmachine_enableBackupV1(this.__wbg_ptr,r,n,i,o);if(s[2])throw tp(s[1]);return tp(s[0])}isBackupEnabled(){return Dg.olmmachine_isBackupEnabled(this.__wbg_ptr)}disableBackup(){return Dg.olmmachine_disableBackup(this.__wbg_ptr)}backupRoomKeys(){return Dg.olmmachine_backupRoomKeys(this.__wbg_ptr)}roomKeyCounts(){return Dg.olmmachine_roomKeyCounts(this.__wbg_ptr)}static encryptExportedRoomKeys(e,t,r){let n,i;try{const a=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg,l=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),d=Bg,u=Dg.olmmachine_encryptExportedRoomKeys(a,c,l,d,r);var o=u[0],s=u[1];if(u[3])throw o=0,s=0,tp(u[2]);return n=o,i=s,jg(o,s)}finally{Dg.__wbindgen_free(n,i,1)}}static decryptExportedRoomKeys(e,t){let r,n;try{const s=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),a=Bg,c=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),l=Bg,d=Dg.olmmachine_decryptExportedRoomKeys(s,a,c,l);var i=d[0],o=d[1];if(d[3])throw i=0,o=0,tp(d[2]);return r=i,n=o,jg(i,o)}finally{Dg.__wbindgen_free(r,n,1)}}registerRoomKeyUpdatedCallback(e){Dg.olmmachine_registerRoomKeyUpdatedCallback(this.__wbg_ptr,e)}registerRoomKeysWithheldCallback(e){Dg.olmmachine_registerRoomKeysWithheldCallback(this.__wbg_ptr,e)}registerUserIdentityUpdatedCallback(e){Dg.olmmachine_registerUserIdentityUpdatedCallback(this.__wbg_ptr,e)}registerDevicesUpdatedCallback(e){Dg.olmmachine_registerDevicesUpdatedCallback(this.__wbg_ptr,e)}registerReceiveSecretCallback(e){Dg.olmmachine_registerReceiveSecretCallback(this.__wbg_ptr,e)}getSecretsFromInbox(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;return Dg.olmmachine_getSecretsFromInbox(this.__wbg_ptr,t,r)}deleteSecretsFromInbox(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;return Dg.olmmachine_deleteSecretsFromInbox(this.__wbg_ptr,t,r)}requestMissingSecretsIfNeeded(){return Dg.olmmachine_requestMissingSecretsIfNeeded(this.__wbg_ptr)}getRoomSettings(e){rp(e,Ym);return Dg.olmmachine_getRoomSettings(this.__wbg_ptr,e.__wbg_ptr)}setRoomSettings(e,t){rp(e,Ym),rp(t,c_);return Dg.olmmachine_setRoomSettings(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr)}dehydratedDevices(){const e=Dg.olmmachine_dehydratedDevices(this.__wbg_ptr);return _v.__wrap(e)}buildRoomKeyBundle(e){rp(e,Ym);return Dg.olmmachine_buildRoomKeyBundle(this.__wbg_ptr,e.__wbg_ptr)}shareRoomKeyBundleData(e,t,r,n,i){rp(e,V_),rp(t,Ym);const o=Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg;var a=$g(n)?0:Vg(n,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),c=Bg;rp(i,Jp);var l=i.__destroy_into_raw();const d=Dg.olmmachine_shareRoomKeyBundleData(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr,o,s,a,c,l);if(d[2])throw tp(d[1]);return tp(d[0])}getReceivedRoomKeyBundleData(e,t){rp(e,Ym),rp(t,V_);return Dg.olmmachine_getReceivedRoomKeyBundleData(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr)}receiveRoomKeyBundle(e,t){rp(e,C_);var r=e.__destroy_into_raw();const n=ep(t,Dg.__wbindgen_malloc),i=Bg,o=Dg.olmmachine_receiveRoomKeyBundle(this.__wbg_ptr,r,n,i);if(o[2])throw tp(o[1]);return tp(o[0])}close(){const e=this.__destroy_into_raw();Dg.olmmachine_close(e)}}const ym="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_otheruseridentity_free(e>>>0,1));class bm{static __wrap(e){e>>>=0;const t=Object.create(bm.prototype);return t.__wbg_ptr=e,ym.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ym.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_otheruseridentity_free(e,0)}isVerified(){return 0!==Dg.otheruseridentity_isVerified(this.__wbg_ptr)}verify(){return Dg.otheruseridentity_verify(this.__wbg_ptr)}requestVerification(e,t,r){rp(e,Ym),rp(t,Hv);var n=$g(r)?0:np(r,Dg.__wbindgen_malloc),i=Bg;const o=Dg.otheruseridentity_requestVerification(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr,n,i);if(o[2])throw tp(o[1]);return G_.__wrap(o[0])}verificationRequestContent(e){let t,r;try{var n=$g(e)?0:np(e,Dg.__wbindgen_malloc),i=Bg;const a=Dg.otheruseridentity_verificationRequestContent(this.__wbg_ptr,n,i);var o=a[0],s=a[1];if(a[3])throw o=0,s=0,tp(a[2]);return t=o,r=s,jg(o,s)}finally{Dg.__wbindgen_free(t,r,1)}}get masterKey(){let e,t;try{const i=Dg.otheruseridentity_masterKey(this.__wbg_ptr);var r=i[0],n=i[1];if(i[3])throw r=0,n=0,tp(i[2]);return e=r,t=n,jg(r,n)}finally{Dg.__wbindgen_free(e,t,1)}}get selfSigningKey(){let e,t;try{const i=Dg.otheruseridentity_selfSigningKey(this.__wbg_ptr);var r=i[0],n=i[1];if(i[3])throw r=0,n=0,tp(i[2]);return e=r,t=n,jg(r,n)}finally{Dg.__wbindgen_free(e,t,1)}}pinCurrentMasterKey(){return Dg.otheruseridentity_pinCurrentMasterKey(this.__wbg_ptr)}identityNeedsUserApproval(){return 0!==Dg.otheruseridentity_identityNeedsUserApproval(this.__wbg_ptr)}wasPreviouslyVerified(){return 0!==Dg.otheruseridentity_wasPreviouslyVerified(this.__wbg_ptr)}withdrawVerification(){return Dg.otheruseridentity_withdrawVerification(this.__wbg_ptr)}hasVerificationViolation(){return 0!==Dg.otheruseridentity_hasVerificationViolation(this.__wbg_ptr)}}const wm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_outboundcreationresult_free(e>>>0,1));class Sm{static __wrap(e){e>>>=0;const t=Object.create(Sm.prototype);return t.__wbg_ptr=e,wm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,wm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_outboundcreationresult_free(e,0)}get channel(){const e=Dg.__wbg_get_inboundcreationresult_channel(this.__wbg_ptr);return Wv.__wrap(e)}set channel(e){rp(e,Wv);var t=e.__destroy_into_raw();Dg.__wbg_set_inboundcreationresult_channel(this.__wbg_ptr,t)}get initial_message(){let e,t;try{const r=Dg.__wbg_get_outboundcreationresult_initial_message(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set initial_message(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}}const Em="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_ownuseridentity_free(e>>>0,1));class Rm{static __wrap(e){e>>>=0;const t=Object.create(Rm.prototype);return t.__wbg_ptr=e,Em.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Em.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_ownuseridentity_free(e,0)}isVerified(){return 0!==Dg.ownuseridentity_isVerified(this.__wbg_ptr)}verify(){return Dg.ownuseridentity_verify(this.__wbg_ptr)}requestVerification(e){var t=$g(e)?0:np(e,Dg.__wbindgen_malloc),r=Bg;const n=Dg.ownuseridentity_requestVerification(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return tp(n[0])}trustsOurOwnDevice(){return Dg.ownuseridentity_trustsOurOwnDevice(this.__wbg_ptr)}get masterKey(){let e,t;try{const i=Dg.ownuseridentity_masterKey(this.__wbg_ptr);var r=i[0],n=i[1];if(i[3])throw r=0,n=0,tp(i[2]);return e=r,t=n,jg(r,n)}finally{Dg.__wbindgen_free(e,t,1)}}get selfSigningKey(){let e,t;try{const i=Dg.ownuseridentity_selfSigningKey(this.__wbg_ptr);var r=i[0],n=i[1];if(i[3])throw r=0,n=0,tp(i[2]);return e=r,t=n,jg(r,n)}finally{Dg.__wbindgen_free(e,t,1)}}get userSigningKey(){let e,t;try{const i=Dg.ownuseridentity_userSigningKey(this.__wbg_ptr);var r=i[0],n=i[1];if(i[3])throw r=0,n=0,tp(i[2]);return e=r,t=n,jg(r,n)}finally{Dg.__wbindgen_free(e,t,1)}}wasPreviouslyVerified(){return 0!==Dg.ownuseridentity_wasPreviouslyVerified(this.__wbg_ptr)}withdrawVerification(){return Dg.ownuseridentity_withdrawVerification(this.__wbg_ptr)}hasVerificationViolation(){return 0!==Dg.ownuseridentity_hasVerificationViolation(this.__wbg_ptr)}}const Im="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_pickledinboundgroupsession_free(e>>>0,1));class km{static __unwrap(e){return e instanceof km?e.__destroy_into_raw():0}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Im.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_pickledinboundgroupsession_free(e,0)}get pickle(){let e,t;try{const r=Dg.__wbg_get_pickledinboundgroupsession_pickle(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set pickle(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get senderKey(){let e,t;try{const r=Dg.__wbg_get_pickledinboundgroupsession_senderKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set senderKey(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_backup_version(this.__wbg_ptr,t,r)}get senderSigningKey(){const e=Dg.__wbg_get_pickledinboundgroupsession_senderSigningKey(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}set senderSigningKey(e){var t=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_basemigrationdata_backupRecoveryKey(this.__wbg_ptr,t,r)}get roomId(){const e=Dg.__wbg_get_pickledinboundgroupsession_roomId(this.__wbg_ptr);return 0===e?void 0:Ym.__wrap(e)}set roomId(e){let t=0;$g(e)||(rp(e,Ym),t=e.__destroy_into_raw()),Dg.__wbg_set_pickledinboundgroupsession_roomId(this.__wbg_ptr,t)}get imported(){return 0!==Dg.__wbg_get_pickledinboundgroupsession_imported(this.__wbg_ptr)}set imported(e){Dg.__wbg_set_pickledinboundgroupsession_imported(this.__wbg_ptr,e)}get backedUp(){return 0!==Dg.__wbg_get_pickledinboundgroupsession_backedUp(this.__wbg_ptr)}set backedUp(e){Dg.__wbg_set_pickledinboundgroupsession_backedUp(this.__wbg_ptr,e)}constructor(){const e=Dg.pickledinboundgroupsession_new();return this.__wbg_ptr=e>>>0,Im.register(this,this.__wbg_ptr,this),this}}const Tm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_pickledsession_free(e>>>0,1));class Cm{static __unwrap(e){return e instanceof Cm?e.__destroy_into_raw():0}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Tm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_pickledsession_free(e,0)}get pickle(){let e,t;try{const r=Dg.__wbg_get_pickledsession_pickle(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set pickle(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get senderKey(){let e,t;try{const r=Dg.__wbg_get_pickledsession_senderKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set senderKey(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_backup_version(this.__wbg_ptr,t,r)}get createdUsingFallbackKey(){return 0!==Dg.__wbg_get_pickledsession_createdUsingFallbackKey(this.__wbg_ptr)}set createdUsingFallbackKey(e){Dg.__wbg_set_pickledsession_createdUsingFallbackKey(this.__wbg_ptr,e)}get creationTime(){return Dg.__wbg_get_pickledsession_creationTime(this.__wbg_ptr)}set creationTime(e){Dg.__wbg_set_pickledsession_creationTime(this.__wbg_ptr,e)}get lastUseTime(){return Dg.__wbg_get_pickledsession_lastUseTime(this.__wbg_ptr)}set lastUseTime(e){Dg.__wbg_set_pickledsession_lastUseTime(this.__wbg_ptr,e)}constructor(){const e=Dg.pickledsession_new();return this.__wbg_ptr=e>>>0,Tm.register(this,this.__wbg_ptr,this),this}}const Om="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_pkdecryption_free(e>>>0,1));class Mm{static __wrap(e){e>>>=0;const t=Object.create(Mm.prototype);return t.__wbg_ptr=e,Om.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Om.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_pkdecryption_free(e,0)}constructor(){const e=Dg.pkdecryption_new();return this.__wbg_ptr=e>>>0,Om.register(this,this.__wbg_ptr,this),this}static fromKey(e){rp(e,ov);const t=Dg.pkdecryption_fromKey(e.__wbg_ptr);return Mm.__wrap(t)}secretKey(){const e=Dg.pkdecryption_secretKey(this.__wbg_ptr);return ov.__wrap(e)}publicKey(){const e=Dg.pkdecryption_publicKey(this.__wbg_ptr);return nv.__wrap(e)}decryptString(e){let t,r;try{rp(e,xm);const o=Dg.pkdecryption_decryptString(this.__wbg_ptr,e.__wbg_ptr);var n=o[0],i=o[1];if(o[3])throw n=0,i=0,tp(o[2]);return t=n,r=i,jg(n,i)}finally{Dg.__wbindgen_free(t,r,1)}}decrypt(e){rp(e,xm);const t=Dg.pkdecryption_decrypt(this.__wbg_ptr,e.__wbg_ptr);if(t[3])throw tp(t[2]);var r=Jg(t[0],t[1]).slice();return Dg.__wbindgen_free(t[0],1*t[1],1),r}}const Pm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_pkencryption_free(e>>>0,1));class Dm{static __wrap(e){e>>>=0;const t=Object.create(Dm.prototype);return t.__wbg_ptr=e,Pm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Pm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_pkencryption_free(e,0)}static fromKey(e){rp(e,nv);const t=Dg.pkencryption_fromKey(e.__wbg_ptr);return Dm.__wrap(t)}encrypt(e){const t=ep(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.pkencryption_encrypt(this.__wbg_ptr,t,r);return xm.__wrap(n)}encryptString(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.pkencryption_encrypt(this.__wbg_ptr,t,r);return xm.__wrap(n)}}const Am="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_pkmessage_free(e>>>0,1));class xm{static __wrap(e){e>>>=0;const t=Object.create(xm.prototype);return t.__wbg_ptr=e,Am.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Am.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_pkmessage_free(e,0)}ciphertext(){const e=Dg.pkmessage_ciphertext(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}mac(){const e=Dg.pkmessage_mac(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}ephemeralKey(){const e=Dg.pkmessage_ephemeralKey(this.__wbg_ptr);return nv.__wrap(e)}static fromParts(e,t,r){const n=ep(e,Dg.__wbindgen_malloc),i=Bg,o=ep(t,Dg.__wbindgen_malloc),s=Bg;rp(r,nv);const a=Dg.pkmessage_fromParts(n,i,o,s,r.__wbg_ptr);return xm.__wrap(a)}static fromBase64(e){rp(e,Kp);const t=Dg.pkmessage_fromBase64(e.__wbg_ptr);if(t[2])throw tp(t[1]);return xm.__wrap(t[0])}toBase64(){const e=Dg.pkmessage_toBase64(this.__wbg_ptr);return Kp.__wrap(e)}}const Um="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_plaintexttodeviceevent_free(e>>>0,1));class Lm{static __wrap(e){e>>>=0;const t=Object.create(Lm.prototype);return t.__wbg_ptr=e,Um.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Um.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_plaintexttodeviceevent_free(e,0)}get rawEvent(){return Dg.__wbg_get_plaintexttodeviceevent_rawEvent(this.__wbg_ptr)}get type(){return Dg.plaintexttodeviceevent_type(this.__wbg_ptr)}}const Nm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_putdehydrateddevicerequest_free(e>>>0,1));class Fm{static __wrap(e){e>>>=0;const t=Object.create(Fm.prototype);return t.__wbg_ptr=e,Nm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Nm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_putdehydrateddevicerequest_free(e,0)}get body(){return Dg.__wbg_get_putdehydrateddevicerequest_body(this.__wbg_ptr)}constructor(e){const t=Dg.putdehydrateddevicerequest_new(e);return this.__wbg_ptr=t>>>0,Nm.register(this,this.__wbg_ptr,this),this}}const jm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_qr_free(e>>>0,1));class Bm{static __wrap(e){e>>>=0;const t=Object.create(Bm.prototype);return t.__wbg_ptr=e,jm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,jm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_qr_free(e,0)}state(){return Dg.qr_state(this.__wbg_ptr)}hasBeenScanned(){return 0!==Dg.qr_hasBeenScanned(this.__wbg_ptr)}hasBeenConfirmed(){return 0!==Dg.qr_hasBeenConfirmed(this.__wbg_ptr)}get userId(){const e=Dg.qr_userId(this.__wbg_ptr);return V_.__wrap(e)}get otherUserId(){const e=Dg.qr_otherUserId(this.__wbg_ptr);return V_.__wrap(e)}get otherDeviceId(){const e=Dg.qr_otherDeviceId(this.__wbg_ptr);return wv.__wrap(e)}weStarted(){return 0!==Dg.qr_weStarted(this.__wbg_ptr)}cancelInfo(){const e=Dg.qr_cancelInfo(this.__wbg_ptr);return 0===e?void 0:Gp.__wrap(e)}isDone(){return 0!==Dg.qr_isDone(this.__wbg_ptr)}isCancelled(){return 0!==Dg.qr_isCancelled(this.__wbg_ptr)}isSelfVerification(){return 0!==Dg.qr_isSelfVerification(this.__wbg_ptr)}reciprocated(){return 0!==Dg.qr_reciprocated(this.__wbg_ptr)}get flowId(){let e,t;try{const r=Dg.qr_flowId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get roomId(){const e=Dg.qr_roomId(this.__wbg_ptr);return 0===e?void 0:Ym.__wrap(e)}toQrCode(){const e=Dg.qr_toQrCode(this.__wbg_ptr);if(e[2])throw tp(e[1]);return qm.__wrap(e[0])}toBytes(){const e=Dg.qr_toBytes(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}reciprocate(){const e=Dg.qr_reciprocate(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}confirmScanning(){const e=Dg.qr_confirmScanning(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}cancel(){const e=Dg.qr_cancel(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}cancelWithCode(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.qr_cancelWithCode(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return tp(n[0])}registerChangesCallback(e){Dg.qr_registerChangesCallback(this.__wbg_ptr,e)}}const Km="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_qrcode_free(e>>>0,1));class qm{static __wrap(e){e>>>=0;const t=Object.create(qm.prototype);return t.__wbg_ptr=e,Km.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Km.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_qrcode_free(e,0)}renderIntoBuffer(){const e=Dg.qrcode_renderIntoBuffer(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}}const Vm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_qrcodedata_free(e>>>0,1));class Wm{static __wrap(e){e>>>=0;const t=Object.create(Wm.prototype);return t.__wbg_ptr=e,Vm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Vm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_qrcodedata_free(e,0)}constructor(e,t,r){rp(e,nv);var n=e.__destroy_into_raw();const i=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),o=Bg;var s=$g(r)?0:Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),a=Bg;const c=Dg.qrcodedata_new(n,i,o,s,a);if(c[2])throw tp(c[1]);return this.__wbg_ptr=c[0]>>>0,Vm.register(this,this.__wbg_ptr,this),this}static fromBytes(e){const t=ep(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.qrcodedata_fromBytes(t,r);if(n[2])throw tp(n[1]);return Wm.__wrap(n[0])}toBytes(){const e=Dg.qrcodedata_toBytes(this.__wbg_ptr);var t=Jg(e[0],e[1]).slice();return Dg.__wbindgen_free(e[0],1*e[1],1),t}static fromBase64(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.qrcodedata_fromBase64(t,r);if(n[2])throw tp(n[1]);return Wm.__wrap(n[0])}toBase64(){let e,t;try{const r=Dg.qrcodedata_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get publicKey(){const e=Dg.qrcodedata_publicKey(this.__wbg_ptr);return nv.__wrap(e)}get rendezvousUrl(){let e,t;try{const r=Dg.qrcodedata_rendezvousUrl(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get serverName(){const e=Dg.qrcodedata_serverName(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}get mode(){return Dg.qrcodedata_mode(this.__wbg_ptr)}}const Gm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_qrcodescan_free(e>>>0,1));class Hm{static __wrap(e){e>>>=0;const t=Object.create(Hm.prototype);return t.__wbg_ptr=e,Gm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Gm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_qrcodescan_free(e,0)}static fromBytes(e){const t=Dg.qrcodescan_fromBytes(e);if(t[2])throw tp(t[1]);return Hm.__wrap(t[0])}}const zm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_rehydrateddevice_free(e>>>0,1));class $m{static __wrap(e){e>>>=0;const t=Object.create($m.prototype);return t.__wbg_ptr=e,zm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,zm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_rehydrateddevice_free(e,0)}receiveEvents(e,t){const r=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;let i=0;$g(t)||(rp(t,uv),i=t.__destroy_into_raw());return Dg.rehydrateddevice_receiveEvents(this.__wbg_ptr,r,n,i)}}const Jm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomid_free(e>>>0,1));class Ym{static __wrap(e){e>>>=0;const t=Object.create(Ym.prototype);return t.__wbg_ptr=e,Jm.register(t,t.__wbg_ptr,t),t}static __unwrap(e){return e instanceof Ym?e.__destroy_into_raw():0}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Jm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomid_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.roomid_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,Jm.register(this,this.__wbg_ptr,this),this}toString(){let e,t;try{const r=Dg.roomid_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const Qm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomkeycounts_free(e>>>0,1));class Xm{static __wrap(e){e>>>=0;const t=Object.create(Xm.prototype);return t.__wbg_ptr=e,Qm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Qm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomkeycounts_free(e,0)}get total(){return Dg.__wbg_get_roomkeycounts_total(this.__wbg_ptr)}set total(e){Dg.__wbg_set_roomkeycounts_total(this.__wbg_ptr,e)}get backedUp(){return Dg.__wbg_get_roomkeycounts_backedUp(this.__wbg_ptr)}set backedUp(e){Dg.__wbg_set_roomkeycounts_backedUp(this.__wbg_ptr,e)}}const Zm="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomkeyimportresult_free(e>>>0,1));class e_{static __wrap(e){e>>>=0;const t=Object.create(e_.prototype);return t.__wbg_ptr=e,Zm.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Zm.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomkeyimportresult_free(e,0)}get importedCount(){return Dg.__wbg_get_roomkeyimportresult_importedCount(this.__wbg_ptr)>>>0}get totalCount(){return Dg.__wbg_get_roomkeyimportresult_totalCount(this.__wbg_ptr)>>>0}keys(){return Dg.roomkeyimportresult_keys(this.__wbg_ptr)}}const t_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomkeyinfo_free(e>>>0,1));class r_{static __wrap(e){e>>>=0;const t=Object.create(r_.prototype);return t.__wbg_ptr=e,t_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,t_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomkeyinfo_free(e,0)}get algorithm(){return Dg.roomkeyinfo_algorithm(this.__wbg_ptr)}get roomId(){const e=Dg.roomkeyinfo_roomId(this.__wbg_ptr);return Ym.__wrap(e)}get senderKey(){const e=Dg.roomkeyinfo_senderKey(this.__wbg_ptr);return nv.__wrap(e)}get sessionId(){let e,t;try{const r=Dg.roomkeyinfo_sessionId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const n_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomkeywithheldinfo_free(e>>>0,1));class i_{static __wrap(e){e>>>=0;const t=Object.create(i_.prototype);return t.__wbg_ptr=e,n_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,n_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomkeywithheldinfo_free(e,0)}get sender(){const e=Dg.roomkeywithheldinfo_sender(this.__wbg_ptr);return V_.__wrap(e)}get algorithm(){return Dg.roomkeywithheldinfo_algorithm(this.__wbg_ptr)}get withheldCode(){let e,t;try{const r=Dg.roomkeywithheldinfo_withheldCode(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get roomId(){const e=Dg.roomkeywithheldinfo_roomId(this.__wbg_ptr);return Ym.__wrap(e)}get sessionId(){let e,t;try{const r=Dg.roomkeywithheldinfo_sessionId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const o_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roommessagerequest_free(e>>>0,1));class s_{static __wrap(e){e>>>=0;const t=Object.create(s_.prototype);return t.__wbg_ptr=e,o_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,o_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roommessagerequest_free(e,0)}get id(){return Dg.__wbg_get_roommessagerequest_id(this.__wbg_ptr)}get room_id(){return Dg.__wbg_get_roommessagerequest_room_id(this.__wbg_ptr)}get txn_id(){return Dg.__wbg_get_roommessagerequest_txn_id(this.__wbg_ptr)}get event_type(){return Dg.__wbg_get_roommessagerequest_event_type(this.__wbg_ptr)}get body(){return Dg.__wbg_get_roommessagerequest_body(this.__wbg_ptr)}constructor(e,t,r,n,i){const o=Dg.roommessagerequest_new(e,t,r,n,i);return this.__wbg_ptr=o>>>0,o_.register(this,this.__wbg_ptr,this),this}get type(){return Dg.roommessagerequest_type(this.__wbg_ptr)}}const a_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_roomsettings_free(e>>>0,1));class c_{static __wrap(e){e>>>=0;const t=Object.create(c_.prototype);return t.__wbg_ptr=e,a_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,a_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_roomsettings_free(e,0)}get algorithm(){return Dg.__wbg_get_roomsettings_algorithm(this.__wbg_ptr)}set algorithm(e){Dg.__wbg_set_roomsettings_algorithm(this.__wbg_ptr,e)}get encryptStateEvents(){return 0!==Dg.__wbg_get_roomsettings_encryptStateEvents(this.__wbg_ptr)}set encryptStateEvents(e){Dg.__wbg_set_roomsettings_encryptStateEvents(this.__wbg_ptr,e)}get onlyAllowTrustedDevices(){return 0!==Dg.__wbg_get_roomsettings_onlyAllowTrustedDevices(this.__wbg_ptr)}set onlyAllowTrustedDevices(e){Dg.__wbg_set_roomsettings_onlyAllowTrustedDevices(this.__wbg_ptr,e)}get sessionRotationPeriodMs(){const e=Dg.__wbg_get_roomsettings_sessionRotationPeriodMs(this.__wbg_ptr);return 0===e[0]?void 0:e[1]}set sessionRotationPeriodMs(e){Dg.__wbg_set_roomsettings_sessionRotationPeriodMs(this.__wbg_ptr,!$g(e),$g(e)?0:e)}get sessionRotationPeriodMessages(){const e=Dg.__wbg_get_roomsettings_sessionRotationPeriodMessages(this.__wbg_ptr);return 0===e[0]?void 0:e[1]}set sessionRotationPeriodMessages(e){Dg.__wbg_set_roomsettings_sessionRotationPeriodMessages(this.__wbg_ptr,!$g(e),$g(e)?0:e)}constructor(){const e=Dg.roomsettings_new();return this.__wbg_ptr=e>>>0,a_.register(this,this.__wbg_ptr,this),this}}const l_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_sas_free(e>>>0,1));class d_{static __wrap(e){e>>>=0;const t=Object.create(d_.prototype);return t.__wbg_ptr=e,l_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,l_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_sas_free(e,0)}get userId(){const e=Dg.sas_userId(this.__wbg_ptr);return V_.__wrap(e)}get deviceId(){const e=Dg.sas_deviceId(this.__wbg_ptr);return wv.__wrap(e)}get otherUserId(){const e=Dg.sas_otherUserId(this.__wbg_ptr);return V_.__wrap(e)}get otherDeviceId(){const e=Dg.sas_otherDeviceId(this.__wbg_ptr);return wv.__wrap(e)}get flowId(){let e,t;try{const r=Dg.sas_flowId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get roomId(){const e=Dg.sas_roomId(this.__wbg_ptr);return 0===e?void 0:Ym.__wrap(e)}supportsEmoji(){return 0!==Dg.sas_supportsEmoji(this.__wbg_ptr)}startedFromRequest(){return 0!==Dg.sas_startedFromRequest(this.__wbg_ptr)}isSelfVerification(){return 0!==Dg.sas_isSelfVerification(this.__wbg_ptr)}haveWeConfirmed(){return 0!==Dg.sas_haveWeConfirmed(this.__wbg_ptr)}hasBeenAccepted(){return 0!==Dg.sas_hasBeenAccepted(this.__wbg_ptr)}cancelInfo(){const e=Dg.sas_cancelInfo(this.__wbg_ptr);return 0===e?void 0:Gp.__wrap(e)}weStarted(){return 0!==Dg.sas_weStarted(this.__wbg_ptr)}accept(){const e=Dg.sas_accept(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}confirm(){return Dg.sas_confirm(this.__wbg_ptr)}cancel(){const e=Dg.sas_cancel(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}cancelWithCode(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.sas_cancelWithCode(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return tp(n[0])}timedOut(){return 0!==Dg.sas_timedOut(this.__wbg_ptr)}canBePresented(){return 0!==Dg.sas_canBePresented(this.__wbg_ptr)}isDone(){return 0!==Dg.sas_isDone(this.__wbg_ptr)}isCancelled(){return 0!==Dg.sas_isCancelled(this.__wbg_ptr)}emoji(){const e=Dg.sas_emoji(this.__wbg_ptr);let t;return 0!==e[0]&&(t=ip(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],4*e[1],4)),t}emojiIndex(){const e=Dg.sas_emojiIndex(this.__wbg_ptr);let t;return 0!==e[0]&&(t=Jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}decimals(){const e=Dg.sas_decimals(this.__wbg_ptr);let t;return 0!==e[0]&&(t=sp(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],2*e[1],2)),t}registerChangesCallback(e){Dg.sas_registerChangesCallback(this.__wbg_ptr,e)}}const u_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_secretsbundle_free(e>>>0,1));class h_{static __wrap(e){e>>>=0;const t=Object.create(h_.prototype);return t.__wbg_ptr=e,u_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,u_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_secretsbundle_free(e,0)}get masterKey(){let e,t;try{const r=Dg.secretsbundle_masterKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get selfSigningKey(){let e,t;try{const r=Dg.secretsbundle_selfSigningKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get userSigningKey(){let e,t;try{const r=Dg.secretsbundle_userSigningKey(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get backupBundle(){const e=Dg.secretsbundle_backupBundle(this.__wbg_ptr);return 0===e?void 0:jp.__wrap(e)}to_json(){const e=Dg.secretsbundle_to_json(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}static from_json(e){const t=Dg.secretsbundle_from_json(e);if(t[2])throw tp(t[1]);return h_.__wrap(t[0])}}const g_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_servername_free(e>>>0,1));class p_{static __wrap(e){e>>>=0;const t=Object.create(p_.prototype);return t.__wbg_ptr=e,g_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,g_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_servername_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.servername_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,g_.register(this,this.__wbg_ptr,this),this}get host(){let e,t;try{const r=Dg.servername_host(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get port(){const e=Dg.servername_port(this.__wbg_ptr);return 16777215===e?void 0:e}isIpLiteral(){return 0!==Dg.servername_isIpLiteral(this.__wbg_ptr)}}const v_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_shieldstate_free(e>>>0,1));class m_{static __wrap(e){e>>>=0;const t=Object.create(m_.prototype);return t.__wbg_ptr=e,v_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,v_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_shieldstate_free(e,0)}get color(){return Dg.__wbg_get_shieldstate_color(this.__wbg_ptr)}set color(e){Dg.__wbg_set_shieldstate_color(this.__wbg_ptr,e)}get code(){const e=Dg.__wbg_get_shieldstate_code(this.__wbg_ptr);return 7===e?void 0:e}set code(e){Dg.__wbg_set_shieldstate_code(this.__wbg_ptr,$g(e)?7:e)}get message(){const e=Dg.shieldstate_message(this.__wbg_ptr);let t;return 0!==e[0]&&(t=jg(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],1*e[1],1)),t}}const __="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_signature_free(e>>>0,1));class f_{static __wrap(e){e>>>=0;const t=Object.create(f_.prototype);return t.__wbg_ptr=e,__.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,__.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_signature_free(e,0)}get ed25519(){const e=Dg.signature_ed25519(this.__wbg_ptr);return 0===e?void 0:xv.__wrap(e)}toBase64(){let e,t;try{const r=Dg.signature_toBase64(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const y_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_signatureuploadrequest_free(e>>>0,1));class b_{static __wrap(e){e>>>=0;const t=Object.create(b_.prototype);return t.__wbg_ptr=e,y_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,y_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_signatureuploadrequest_free(e,0)}get id(){return Dg.__wbg_get_signatureuploadrequest_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_signatureuploadrequest_body(this.__wbg_ptr)}constructor(e,t){const r=Dg.signatureuploadrequest_new(e,t);return this.__wbg_ptr=r>>>0,y_.register(this,this.__wbg_ptr,this),this}get type(){return Dg.signatureuploadrequest_type(this.__wbg_ptr)}}const w_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_signatureverification_free(e>>>0,1));class S_{static __wrap(e){e>>>=0;const t=Object.create(S_.prototype);return t.__wbg_ptr=e,w_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,w_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_signatureverification_free(e,0)}get deviceState(){return Dg.signatureverification_deviceState(this.__wbg_ptr)}get userState(){return Dg.signatureverification_userState(this.__wbg_ptr)}trusted(){return 0!==Dg.signatureverification_trusted(this.__wbg_ptr)}}const E_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_signatures_free(e>>>0,1));class R_{static __wrap(e){e>>>=0;const t=Object.create(R_.prototype);return t.__wbg_ptr=e,E_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,E_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_signatures_free(e,0)}constructor(){const e=Dg.signatures_new();return this.__wbg_ptr=e>>>0,E_.register(this,this.__wbg_ptr,this),this}addSignature(e,t,r){rp(e,V_),rp(t,Tv),rp(r,xv);const n=Dg.signatures_addSignature(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr,r.__wbg_ptr);return 0===n?void 0:dm.__wrap(n)}getSignature(e,t){rp(e,V_),rp(t,Tv);const r=Dg.signatures_getSignature(this.__wbg_ptr,e.__wbg_ptr,t.__wbg_ptr);return 0===r?void 0:xv.__wrap(r)}get(e){rp(e,V_);return Dg.signatures_get(this.__wbg_ptr,e.__wbg_ptr)}clear(){Dg.signatures_clear(this.__wbg_ptr)}isEmpty(){return 0!==Dg.signatures_isEmpty(this.__wbg_ptr)}get count(){return Dg.signatures_count(this.__wbg_ptr)>>>0}asJSON(){const e=Dg.signatures_asJSON(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}}const I_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_storehandle_free(e>>>0,1));class k_{static __wrap(e){e>>>=0;const t=Object.create(k_.prototype);return t.__wbg_ptr=e,I_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,I_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_storehandle_free(e,0)}static open(e,t,r){var n=$g(e)?0:Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=$g(t)?0:Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),s=Bg;return Dg.storehandle_open(n,i,o,s,$g(r)?0:Hg(r))}static openWithKey(e,t,r){const n=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg,o=ep(t,Dg.__wbindgen_malloc),s=Bg;return Dg.storehandle_openWithKey(n,i,o,s,$g(r)?0:Hg(r))}}const T_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_storedroomkeybundledata_free(e>>>0,1));class C_{static __wrap(e){e>>>=0;const t=Object.create(C_.prototype);return t.__wbg_ptr=e,T_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,T_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_storedroomkeybundledata_free(e,0)}get senderUser(){const e=Dg.storedroomkeybundledata_senderUser(this.__wbg_ptr);return V_.__wrap(e)}get roomId(){const e=Dg.storedroomkeybundledata_roomId(this.__wbg_ptr);return Ym.__wrap(e)}get url(){let e,t;try{const r=Dg.storedroomkeybundledata_url(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get encryptionInfo(){let e,t;try{const r=Dg.storedroomkeybundledata_encryptionInfo(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}}const O_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_todeviceencryptioninfo_free(e>>>0,1));class M_{static __wrap(e){e>>>=0;const t=Object.create(M_.prototype);return t.__wbg_ptr=e,O_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,O_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_todeviceencryptioninfo_free(e,0)}get senderCurve25519Key(){let e,t;try{const r=Dg.__wbg_get_todeviceencryptioninfo_senderCurve25519Key(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}set senderCurve25519Key(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg;Dg.__wbg_set_backupsecretsbundle_key(this.__wbg_ptr,t,r)}get sender(){const e=Dg.__wbg_get_todeviceencryptioninfo_sender(this.__wbg_ptr);return V_.__wrap(e)}set sender(e){rp(e,V_);var t=e.__destroy_into_raw();Dg.__wbg_set_todeviceencryptioninfo_sender(this.__wbg_ptr,t)}get senderDevice(){const e=Dg.__wbg_get_todeviceencryptioninfo_senderDevice(this.__wbg_ptr);return 0===e?void 0:wv.__wrap(e)}set senderDevice(e){let t=0;$g(e)||(rp(e,wv),t=e.__destroy_into_raw()),Dg.__wbg_set_todeviceencryptioninfo_senderDevice(this.__wbg_ptr,t)}isSenderVerified(){return 0!==Dg.todeviceencryptioninfo_isSenderVerified(this.__wbg_ptr)}}const P_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_todevicerequest_free(e>>>0,1));class D_{static __wrap(e){e>>>=0;const t=Object.create(D_.prototype);return t.__wbg_ptr=e,P_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,P_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_todevicerequest_free(e,0)}get id(){return Dg.__wbg_get_todevicerequest_id(this.__wbg_ptr)}get event_type(){return Dg.__wbg_get_todevicerequest_event_type(this.__wbg_ptr)}get txn_id(){return Dg.__wbg_get_todevicerequest_txn_id(this.__wbg_ptr)}get body(){return Dg.__wbg_get_todevicerequest_body(this.__wbg_ptr)}constructor(e,t,r,n){const i=Dg.todevicerequest_new(e,t,r,n);return this.__wbg_ptr=i>>>0,P_.register(this,this.__wbg_ptr,this),this}get type(){return Dg.todevicerequest_type(this.__wbg_ptr)}}const A_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_todeviceunabletodecryptinfo_free(e>>>0,1));class x_{static __wrap(e){e>>>=0;const t=Object.create(x_.prototype);return t.__wbg_ptr=e,A_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,A_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_todeviceunabletodecryptinfo_free(e,0)}get reason(){return Dg.__wbg_get_todeviceunabletodecryptinfo_reason(this.__wbg_ptr)}set reason(e){Dg.__wbg_set_todeviceunabletodecryptinfo_reason(this.__wbg_ptr,e)}}const U_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_tracing_free(e>>>0,1));const L_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_utdtodeviceevent_free(e>>>0,1));class N_{static __wrap(e){e>>>=0;const t=Object.create(N_.prototype);return t.__wbg_ptr=e,L_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,L_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_utdtodeviceevent_free(e,0)}get rawEvent(){return Dg.__wbg_get_utdtodeviceevent_rawEvent(this.__wbg_ptr)}get utdInfo(){const e=Dg.__wbg_get_utdtodeviceevent_utdInfo(this.__wbg_ptr);return x_.__wrap(e)}get type(){return Dg.utdtodeviceevent_type(this.__wbg_ptr)}}const F_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_uploadsigningkeysrequest_free(e>>>0,1));class j_{static __wrap(e){e>>>=0;const t=Object.create(j_.prototype);return t.__wbg_ptr=e,F_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,F_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_uploadsigningkeysrequest_free(e,0)}get body(){return Dg.__wbg_get_uploadsigningkeysrequest_body(this.__wbg_ptr)}constructor(e){const t=Dg.uploadsigningkeysrequest_new(e);return this.__wbg_ptr=t>>>0,F_.register(this,this.__wbg_ptr,this),this}}const B_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_userdevices_free(e>>>0,1));class K_{static __wrap(e){e>>>=0;const t=Object.create(K_.prototype);return t.__wbg_ptr=e,B_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,B_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_userdevices_free(e,0)}get(e){rp(e,wv);const t=Dg.userdevices_get(this.__wbg_ptr,e.__wbg_ptr);return 0===t?void 0:yv.__wrap(t)}isAnyVerified(){return 0!==Dg.userdevices_isAnyVerified(this.__wbg_ptr)}keys(){return Dg.userdevices_keys(this.__wbg_ptr)}devices(){return Dg.userdevices_devices(this.__wbg_ptr)}}const q_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_userid_free(e>>>0,1));class V_{static __wrap(e){e>>>=0;const t=Object.create(V_.prototype);return t.__wbg_ptr=e,q_.register(t,t.__wbg_ptr,t),t}static __unwrap(e){return e instanceof V_?e.__destroy_into_raw():0}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,q_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_userid_free(e,0)}constructor(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.userid_new(t,r);if(n[2])throw tp(n[1]);return this.__wbg_ptr=n[0]>>>0,q_.register(this,this.__wbg_ptr,this),this}get localpart(){let e,t;try{const r=Dg.userid_localpart(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}get serverName(){const e=Dg.userid_serverName(this.__wbg_ptr);return p_.__wrap(e)}isHistorical(){return 0!==Dg.userid_isHistorical(this.__wbg_ptr)}toString(){let e,t;try{const r=Dg.userid_toString(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}clone(){const e=Dg.userid_clone(this.__wbg_ptr);return V_.__wrap(e)}}const W_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_verificationrequest_free(e>>>0,1));class G_{static __wrap(e){e>>>=0;const t=Object.create(G_.prototype);return t.__wbg_ptr=e,W_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,W_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_verificationrequest_free(e,0)}static request(e,t,r,n){let i,o;try{rp(e,V_),rp(t,wv),rp(r,V_);var s=$g(n)?0:np(n,Dg.__wbindgen_malloc),a=Bg;const d=Dg.verificationrequest_request(e.__wbg_ptr,t.__wbg_ptr,r.__wbg_ptr,s,a);var c=d[0],l=d[1];if(d[3])throw c=0,l=0,tp(d[2]);return i=c,o=l,jg(c,l)}finally{Dg.__wbindgen_free(i,o,1)}}get ownUserId(){const e=Dg.verificationrequest_ownUserId(this.__wbg_ptr);return V_.__wrap(e)}get otherUserId(){const e=Dg.verificationrequest_otherUserId(this.__wbg_ptr);return V_.__wrap(e)}get otherDeviceId(){const e=Dg.verificationrequest_otherDeviceId(this.__wbg_ptr);return 0===e?void 0:wv.__wrap(e)}get roomId(){const e=Dg.verificationrequest_roomId(this.__wbg_ptr);return 0===e?void 0:Ym.__wrap(e)}get cancelInfo(){const e=Dg.verificationrequest_cancelInfo(this.__wbg_ptr);return 0===e?void 0:Gp.__wrap(e)}isPassive(){return 0!==Dg.verificationrequest_isPassive(this.__wbg_ptr)}isReady(){return 0!==Dg.verificationrequest_isReady(this.__wbg_ptr)}timedOut(){return 0!==Dg.verificationrequest_timedOut(this.__wbg_ptr)}timeRemainingMillis(){return Dg.verificationrequest_timeRemainingMillis(this.__wbg_ptr)}get theirSupportedMethods(){const e=Dg.verificationrequest_theirSupportedMethods(this.__wbg_ptr);if(e[3])throw tp(e[2]);let t;return 0!==e[0]&&(t=ip(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],4*e[1],4)),t}get ourSupportedMethods(){const e=Dg.verificationrequest_ourSupportedMethods(this.__wbg_ptr);if(e[3])throw tp(e[2]);let t;return 0!==e[0]&&(t=ip(e[0],e[1]).slice(),Dg.__wbindgen_free(e[0],4*e[1],4)),t}get flowId(){let e,t;try{const r=Dg.verificationrequest_flowId(this.__wbg_ptr);return e=r[0],t=r[1],jg(r[0],r[1])}finally{Dg.__wbindgen_free(e,t,1)}}isSelfVerification(){return 0!==Dg.verificationrequest_isSelfVerification(this.__wbg_ptr)}weStarted(){return 0!==Dg.verificationrequest_weStarted(this.__wbg_ptr)}isDone(){return 0!==Dg.verificationrequest_isDone(this.__wbg_ptr)}phase(){return Dg.verificationrequest_phase(this.__wbg_ptr)}getVerification(){return Dg.verificationrequest_getVerification(this.__wbg_ptr)}registerChangesCallback(e){Dg.verificationrequest_registerChangesCallback(this.__wbg_ptr,e)}isCancelled(){return 0!==Dg.verificationrequest_isCancelled(this.__wbg_ptr)}acceptWithMethods(e){const t=np(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.verificationrequest_acceptWithMethods(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return tp(n[0])}accept(){const e=Dg.verificationrequest_accept(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}cancel(){const e=Dg.verificationrequest_cancel(this.__wbg_ptr);if(e[2])throw tp(e[1]);return tp(e[0])}startSas(){return Dg.verificationrequest_startSas(this.__wbg_ptr)}generateQrCode(){return Dg.verificationrequest_generateQrCode(this.__wbg_ptr)}scanQrCode(e){rp(e,Hm);return Dg.verificationrequest_scanQrCode(this.__wbg_ptr,e.__wbg_ptr)}}const H_="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>Dg.__wbg_versions_free(e>>>0,1));class z_{static __wrap(e){e>>>=0;const t=Object.create(z_.prototype);return t.__wbg_ptr=e,H_.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,H_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_versions_free(e,0)}get vodozemac(){return Dg.__wbg_get_versions_vodozemac(this.__wbg_ptr)}get matrix_sdk_crypto(){return Dg.__wbg_get_versions_matrix_sdk_crypto(this.__wbg_ptr)}get git_sha(){return Dg.__wbg_get_versions_git_sha(this.__wbg_ptr)}get git_description(){return Dg.__wbg_get_versions_git_description(this.__wbg_ptr)}}var $_=Object.freeze({__proto__:null,Attachment:class{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ap.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_attachment_free(e,0)}static encrypt(e){const t=ep(e,Dg.__wbindgen_malloc),r=Bg,n=Dg.attachment_encrypt(t,r);if(n[2])throw tp(n[1]);return Fv.__wrap(n[0])}static decrypt(e){rp(e,Fv);const t=Dg.attachment_decrypt(e.__wbg_ptr);if(t[3])throw tp(t[2]);var r=Jg(t[0],t[1]).slice();return Dg.__wbindgen_free(t[0],1*t[1],1),r}},BackupDecryptionKey:Up,BackupKeys:Np,BackupSecretsBundle:jp,Base64EncodedPkMessage:Kp,BaseMigrationData:Vp,CancelInfo:Gp,CheckCode:zp,CollectStrategy:Jp,CrossSigningBootstrapRequests:Qp,CrossSigningKeyExport:Zp,CrossSigningStatus:tv,Curve25519PublicKey:nv,Curve25519SecretKey:ov,DecryptedRoomEvent:av,DecryptedToDeviceEvent:lv,DecryptionErrorCode:gp,DecryptionSettings:uv,DehydratedDevice:gv,DehydratedDeviceKey:vv,DehydratedDevices:_v,Device:yv,DeviceId:wv,DeviceKey:Ev,DeviceKeyAlgorithm:Iv,DeviceKeyAlgorithmName:pp,DeviceKeyId:Tv,DeviceKeyName:vp,DeviceLists:Ov,Ecies:class{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Mv.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_ecies_free(e,0)}constructor(){const e=Dg.ecies_new();return this.__wbg_ptr=e>>>0,Mv.register(this,this.__wbg_ptr,this),this}public_key(){const e=Dg.ecies_public_key(this.__wbg_ptr);return nv.__wrap(e)}establish_inbound_channel(e){const t=Vg(e,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),r=Bg,n=Dg.ecies_establish_inbound_channel(this.__wbg_ptr,t,r);if(n[2])throw tp(n[1]);return Yv.__wrap(n[0])}establish_outbound_channel(e,t){rp(e,nv);const r=Vg(t,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg,i=Dg.ecies_establish_outbound_channel(this.__wbg_ptr,e.__wbg_ptr,r,n);if(i[2])throw tp(i[1]);return Sm.__wrap(i[0])}},Ed25519PublicKey:Dv,Ed25519Signature:xv,Emoji:Lv,EncryptedAttachment:Fv,EncryptionAlgorithm:mp,EncryptionInfo:Bv,EncryptionSettings:qv,EstablishedEcies:Wv,EventId:Hv,HistoryVisibility:_p,IdentityKeys:$v,InboundCreationResult:Yv,InboundGroupSession:Xv,InvalidToDeviceEvent:em,KeysBackupRequest:rm,KeysClaimRequest:im,KeysQueryRequest:sm,KeysUploadRequest:cm,LocalTrust:fp,LoggerLevel:yp,MaybeSignature:dm,MegolmDecryptionError:hm,MegolmV1BackupKey:pm,Migration:mm,OlmMachine:fm,OtherUserIdentity:bm,OutboundCreationResult:Sm,OwnUserIdentity:Rm,PickledInboundGroupSession:km,PickledSession:Cm,PkDecryption:Mm,PkEncryption:Dm,PkMessage:xm,PlainTextToDeviceEvent:Lm,ProcessedToDeviceEventType:bp,PutDehydratedDeviceRequest:Fm,Qr:Bm,QrCode:qm,QrCodeData:Wm,QrCodeMode:wp,QrCodeScan:Hm,QrState:Sp,RehydratedDevice:$m,RequestType:Ep,RoomId:Ym,RoomKeyCounts:Xm,RoomKeyImportResult:e_,RoomKeyInfo:r_,RoomKeyWithheldInfo:i_,RoomMessageRequest:s_,RoomSettings:c_,Sas:d_,SecretsBundle:h_,ServerName:p_,ShieldColor:Rp,ShieldState:m_,ShieldStateCode:Ip,Signature:f_,SignatureState:kp,SignatureUploadRequest:b_,SignatureVerification:S_,Signatures:R_,StoreHandle:k_,StoredRoomKeyBundleData:C_,ToDeviceEncryptionInfo:M_,ToDeviceRequest:D_,ToDeviceUnableToDecryptInfo:x_,ToDeviceUnableToDecryptReason:Tp,Tracing:class{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,U_.unregister(this),e}free(){const e=this.__destroy_into_raw();Dg.__wbg_tracing_free(e,0)}static isAvailable(){return 0!==Dg.tracing_isAvailable()}constructor(e){const t=Dg.tracing_new(e);if(t[2])throw tp(t[1]);return this.__wbg_ptr=t[0]>>>0,U_.register(this,this.__wbg_ptr,this),this}set minLevel(e){const t=Dg.tracing_set_minLevel(this.__wbg_ptr,e);if(t[1])throw tp(t[0])}turnOn(){const e=Dg.tracing_turnOn(this.__wbg_ptr);if(e[1])throw tp(e[0])}turnOff(){const e=Dg.tracing_turnOff(this.__wbg_ptr);if(e[1])throw tp(e[0])}},TrustRequirement:Cp,UTDToDeviceEvent:N_,UploadSigningKeysRequest:j_,UserDevices:K_,UserId:V_,VerificationMethod:Op,VerificationRequest:G_,VerificationRequestPhase:Mp,Versions:z_,__wbg_Error_0497d5bdba9362e5:function(e,t){return Error(jg(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const r=Vg(String(t),Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;Gg().setInt32(e+4,n,!0),Gg().setInt32(e+0,r,!0)},__wbg_Window_b0044ac7db258535:function(e){return e.Window},__wbg_WorkerGlobalScope_b74cefefc62a37da:function(e){return e.WorkerGlobalScope},__wbg_add_64c6e51ab0ed12dd:function(){return zg(function(e,t,r){return e.add(t,r)},arguments)},__wbg_add_dd833f9f523abe36:function(e,t){return e.add(t)},__wbg_at_5b2884630cb66ea6:function(e,t){return e.at(t)},__wbg_backupkeys_new:function(e){return Np.__wrap(e)},__wbg_bound_0274374bea7f6bca:function(){return zg(function(e,t){return IDBKeyRange.bound(e,t)},arguments)},__wbg_bound_eb572b424befade3:function(){return zg(function(e,t,r,n){return IDBKeyRange.bound(e,t,0!==r,0!==n)},arguments)},__wbg_buffer_a1a27a0dfa70165d:function(e){return e.buffer},__wbg_call_1b920c3ac0afee4b:function(){return zg(function(e,t,r,n){return e.call(t,r,n)},arguments)},__wbg_call_36f1bbf64b4cf7c7:function(){return zg(function(e,t,r,n,i){return e.call(t,r,n,i)},arguments)},__wbg_call_f2db6205e5c51dc8:function(){return zg(function(e,t,r){return e.call(t,r)},arguments)},__wbg_call_fbe8be8bf6436ce5:function(){return zg(function(e,t){return e.call(t)},arguments)},__wbg_clearTimeout_5a54f8841c30079a:function(e){return clearTimeout(e)},__wbg_clear_e6ec1cc113e1555e:function(){return zg(function(e){return e.clear()},arguments)},__wbg_close_2079e209ea5709b5:function(e){e.close()},__wbg_code_5e459ca721f994f5:function(e){return e.code},__wbg_continue_7d9cdafc888cb902:function(){return zg(function(e){e.continue()},arguments)},__wbg_count_2941fdbb8154c02d:function(){return zg(function(e){return e.count()},arguments)},__wbg_count_5ceb291ba9a02b4b:function(){return zg(function(e){return e.count()},arguments)},__wbg_createIndex_32ba53785b2ef24e:function(){return zg(function(e,t,r,n){return e.createIndex(jg(t,r),n)},arguments)},__wbg_createIndex_a343510ba567e58c:function(){return zg(function(e,t,r,n,i){return e.createIndex(jg(t,r),n,i)},arguments)},__wbg_createObjectStore_b1f08961900155dd:function(){return zg(function(e,t,r){return e.createObjectStore(jg(t,r))},arguments)},__wbg_crosssigningbootstraprequests_new:function(e){return Qp.__wrap(e)},__wbg_crosssigningkeyexport_new:function(e){return Zp.__wrap(e)},__wbg_crosssigningstatus_new:function(e){return tv.__wrap(e)},__wbg_crypto_574e78ad8b13b65f:function(e){return e.crypto},__wbg_debug_58d16ea352cfbca1:function(e){console.debug(e)},__wbg_debug_ada37632f0e8cdde:function(e,t){e.debug(t)},__wbg_decryptedroomevent_new:function(e){return av.__wrap(e)},__wbg_decryptedtodeviceevent_new:function(e){return lv.__wrap(e)},__wbg_dehydrateddevice_new:function(e){return gv.__wrap(e)},__wbg_dehydrateddevicekey_new:function(e){return vv.__wrap(e)},__wbg_deleteObjectStore_7b427b19378475fd:function(){return zg(function(e,t,r){e.deleteObjectStore(jg(t,r))},arguments)},__wbg_delete_1af2aac87b36c0f1:function(){return zg(function(e){return e.delete()},arguments)},__wbg_delete_71b7921c73aa9378:function(){return zg(function(e,t){return e.delete(t)},arguments)},__wbg_device_new:function(e){return yv.__wrap(e)},__wbg_deviceid_new:function(e){return wv.__wrap(e)},__wbg_devicekey_new:function(e){return Ev.__wrap(e)},__wbg_devicekeyid_new:function(e){return Tv.__wrap(e)},__wbg_done_4d01f352bade43b7:function(e){return e.done},__wbg_emoji_new:function(e){return Lv.__wrap(e)},__wbg_encryptedattachment_new:function(e){return Fv.__wrap(e)},__wbg_encryptioninfo_new:function(e){return Bv.__wrap(e)},__wbg_entries_41651c850143b957:function(e){return Object.entries(e)},__wbg_entries_c951fa14164704e7:function(e){return e.entries()},__wbg_error_24afdcd463ac8bd9:function(e,t){e.error(t)},__wbg_error_4e978abc9692c0c5:function(){return zg(function(e){const t=e.error;return $g(t)?0:Hg(t)},arguments)},__wbg_error_51ecdd39ec054205:function(e){console.error(e)},__wbg_error_7534b8e9a36f1ab4:function(e,t){let r,n;try{r=e,n=t,console.error(jg(e,t))}finally{Dg.__wbindgen_free(r,n,1)}},__wbg_from_12ff8e47307bd4c7:function(e){return Array.from(e)},__wbg_getAllKeys_fce3f6ef8201c450:function(){return zg(function(e){return e.getAllKeys()},arguments)},__wbg_getAll_22a744d3b40f0fb5:function(){return zg(function(e){return e.getAll()},arguments)},__wbg_getAll_654e689108532352:function(){return zg(function(e,t,r){return e.getAll(t,r>>>0)},arguments)},__wbg_getAll_864be044b219e256:function(){return zg(function(e,t){return e.getAll(t)},arguments)},__wbg_getRandomValues_38a1ff1ea09f6cc7:function(){return zg(function(e,t){globalThis.crypto.getRandomValues(Jg(e,t))},arguments)},__wbg_getRandomValues_b8f5dbd5f3995a9e:function(){return zg(function(e,t){e.getRandomValues(t)},arguments)},__wbg_getTime_2afe67905d873e92:function(e){return e.getTime()},__wbg_get_92470be87867c2e5:function(){return zg(function(e,t){return Reflect.get(e,t)},arguments)},__wbg_get_a131a44bd1eb6979:function(e,t){return e[t>>>0]},__wbg_get_a4719581b0d717ad:function(){return zg(function(e,t){return e.get(t)},arguments)},__wbg_get_d37904b955701f99:function(){return zg(function(e,t){return e.get(t)},arguments)},__wbg_getwithrefkey_1dc361bd10053bfe:function(e,t){return e[t]},__wbg_global_b6f5c73312f62313:function(e){return e.global},__wbg_inboundgroupsession_new:function(e){return Xv.__wrap(e)},__wbg_index_405783ca8da5f008:function(){return zg(function(e,t,r){return e.index(jg(t,r))},arguments)},__wbg_indexedDB_317016dcb8a872d6:function(){return zg(function(e){const t=e.indexedDB;return $g(t)?0:Hg(t)},arguments)},__wbg_indexedDB_601ec26c63e333de:function(){return zg(function(e){const t=e.indexedDB;return $g(t)?0:Hg(t)},arguments)},__wbg_indexedDB_63b82e158eb67cbd:function(){return zg(function(e){const t=e.indexedDB;return $g(t)?0:Hg(t)},arguments)},__wbg_info_e56933705c348038:function(e){console.info(e)},__wbg_info_f3589034369581f6:function(e,t){e.info(t)},__wbg_instanceof_ArrayBuffer_a8b6f580b363f2bc:function(e){let t;try{t=e instanceof ArrayBuffer}catch(e){t=!1}return t},__wbg_instanceof_Map_80cc65041c96417a:function(e){let t;try{t=e instanceof Map}catch(e){t=!1}return t},__wbg_instanceof_Promise_66f94afc64d9039f:function(e){let t;try{t=e instanceof Promise}catch(e){t=!1}return t},__wbg_instanceof_Uint8Array_ca460677bc155827:function(e){let t;try{t=e instanceof Uint8Array}catch(e){t=!1}return t},__wbg_invalidtodeviceevent_new:function(e){return em.__wrap(e)},__wbg_isArray_2a07fd175d45c496:function(e){return Array.isArray(e)},__wbg_isArray_5f090bed72bd4f89:function(e){return Array.isArray(e)},__wbg_isSafeInteger_90d7c4674047d684:function(e){return Number.isSafeInteger(e)},__wbg_item_15285ca2d766f142:function(e,t,r){const n=t.item(r>>>0);var i=$g(n)?0:Vg(n,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),o=Bg;Gg().setInt32(e+4,o,!0),Gg().setInt32(e+0,i,!0)},__wbg_iterator_4068add5b2aef7a6:function(){return Symbol.iterator},__wbg_key_a17a68df9ec1b180:function(){return zg(function(e){return e.key},arguments)},__wbg_keysbackuprequest_new:function(e){return rm.__wrap(e)},__wbg_keysclaimrequest_new:function(e){return im.__wrap(e)},__wbg_keysqueryrequest_new:function(e){return sm.__wrap(e)},__wbg_keysuploadrequest_new:function(e){return cm.__wrap(e)},__wbg_length_471141fa24df24b2:function(e){return e.length},__wbg_length_ab6d22b5ead75c72:function(e){return e.length},__wbg_length_f00ec12454a5d9fd:function(e){return e.length},__wbg_lowerBound_13c8e875a3fb9f7d:function(){return zg(function(e,t){return IDBKeyRange.lowerBound(e,0!==t)},arguments)},__wbg_maybesignature_new:function(e){return dm.__wrap(e)},__wbg_megolmdecryptionerror_new:function(e){return hm.__wrap(e)},__wbg_message_2d95ea5aff0d63b9:function(e,t){const r=Vg(t.message,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;Gg().setInt32(e+4,n,!0),Gg().setInt32(e+0,r,!0)},__wbg_msCrypto_a61aeb35a24c1329:function(e){return e.msCrypto},__wbg_name_2acff1e83d9735f9:function(e,t){const r=Vg(t.name,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;Gg().setInt32(e+4,n,!0),Gg().setInt32(e+0,r,!0)},__wbg_new_07b483f72211fd66:function(){return new Object},__wbg_new_58353953ad2097cc:function(){return new Array},__wbg_new_8a6f238a6ece86ea:function(){return new Error},__wbg_new_a2957aa5684de228:function(e){return new Date(e)},__wbg_new_a979b4b45bd55c7f:function(){return new Map},__wbg_new_b3a08d2910ee5170:function(e){return new Uint8ClampedArray(e)},__wbg_new_db7d9b0ee94df522:function(e){return new Set(e)},__wbg_new_e30c39c06edaabf2:function(e,t){try{var r={a:e,b:t};const n=new Promise((e,t)=>{const n=r.a;r.a=0;try{return function(e,t,r,n){Dg.closure451_externref_shim(e,t,r,n)}(n,r.b,e,t)}finally{r.a=n}});return n}finally{r.a=r.b=0}},__wbg_new_e52b3efaaa774f96:function(e){return new Uint8Array(e)},__wbg_newnoargs_ff528e72d35de39a:function(e,t){return new Function(jg(e,t))},__wbg_newwithbyteoffsetandlength_06e8c938173769b5:function(e,t,r){return new Uint8ClampedArray(e,t>>>0,r>>>0)},__wbg_newwithbyteoffsetandlength_3b01ecda099177e8:function(e,t,r){return new Uint8Array(e,t>>>0,r>>>0)},__wbg_newwithlength_08f872dc1e3ada2e:function(e){return new Uint8Array(e>>>0)},__wbg_newwithlength_8a0d31010560ce9a:function(e){return new Uint8ClampedArray(e>>>0)},__wbg_newwithmessage_54042111509ba20c:function(){return zg(function(e,t){return new DOMException(jg(e,t))},arguments)},__wbg_next_8bb824d217961b5d:function(e){return e.next},__wbg_next_e2da48d8fff7439a:function(){return zg(function(e){return e.next()},arguments)},__wbg_node_905d3e251edff8a2:function(e){return e.node},__wbg_now_2c95c9de01293173:function(e){return e.now()},__wbg_now_eb0821f3bd9f6529:function(){return Date.now()},__wbg_objectStoreNames_e82275eb2d403a92:function(e){return e.objectStoreNames},__wbg_objectStore_b463d32c86d6b543:function(){return zg(function(e,t,r){return e.objectStore(jg(t,r))},arguments)},__wbg_oldVersion_af5af638a028177c:function(e){return e.oldVersion},__wbg_olmmachine_new:function(e){return fm.__wrap(e)},__wbg_openCursor_7c13a2cd32c6258b:function(){return zg(function(e){return e.openCursor()},arguments)},__wbg_openCursor_a53133c898e0829c:function(){return zg(function(e,t){return e.openCursor(t)},arguments)},__wbg_openCursor_dbd279400634ae67:function(){return zg(function(e){return e.openCursor()},arguments)},__wbg_open_0f04f50fa4d98f67:function(){return zg(function(e,t,r,n){return e.open(jg(t,r),n>>>0)},arguments)},__wbg_open_b70fb421d97aad40:function(){return zg(function(e,t,r){return e.open(jg(t,r))},arguments)},__wbg_otheruseridentity_new:function(e){return bm.__wrap(e)},__wbg_ownuseridentity_new:function(e){return Rm.__wrap(e)},__wbg_parse_c7ba327fb6231e7f:function(){return zg(function(e,t){return JSON.parse(jg(e,t))},arguments)},__wbg_performance_7a3ffd0b17f663ad:function(e){return e.performance},__wbg_pickledinboundgroupsession_unwrap:function(e){return km.__unwrap(e)},__wbg_pickledsession_unwrap:function(e){return Cm.__unwrap(e)},__wbg_plaintexttodeviceevent_new:function(e){return Lm.__wrap(e)},__wbg_process_dc0fbacc7c1c06f7:function(e){return e.process},__wbg_push_73fd7b5550ebf707:function(e,t){return e.push(t)},__wbg_put_7f0b4dcc666f09e3:function(){return zg(function(e,t,r){return e.put(t,r)},arguments)},__wbg_putdehydrateddevicerequest_new:function(e){return Fm.__wrap(e)},__wbg_qr_new:function(e){return Bm.__wrap(e)},__wbg_queueMicrotask_46c1df247678729f:function(e){queueMicrotask(e)},__wbg_queueMicrotask_8acf3ccb75ed8d11:function(e){return e.queueMicrotask},__wbg_randomFillSync_ac0988aba3254290:function(){return zg(function(e,t){e.randomFillSync(t)},arguments)},__wbg_readyState_249e5707a38b7a7a:function(e){const t=e.readyState;return(Pp.indexOf(t)+1||3)-1},__wbg_rehydrateddevice_new:function(e){return $m.__wrap(e)},__wbg_require_60cc747a6bc5215a:function(){return zg(function(){return module.require},arguments)},__wbg_resolve_0dac8c580ffd4678:function(e){return Promise.resolve(e)},__wbg_result_a0f1bf2fe64a516c:function(){return zg(function(e){return e.result},arguments)},__wbg_roomid_unwrap:function(e){return Ym.__unwrap(e)},__wbg_roomkeycounts_new:function(e){return Xm.__wrap(e)},__wbg_roomkeyimportresult_new:function(e){return e_.__wrap(e)},__wbg_roomkeyinfo_new:function(e){return r_.__wrap(e)},__wbg_roomkeywithheldinfo_new:function(e){return i_.__wrap(e)},__wbg_roommessagerequest_new:function(e){return s_.__wrap(e)},__wbg_roomsettings_new:function(e){return c_.__wrap(e)},__wbg_sas_new:function(e){return d_.__wrap(e)},__wbg_secretsbundle_new:function(e){return h_.__wrap(e)},__wbg_setTimeout_db2dbaeefb6f39c7:function(){return zg(function(e,t){return setTimeout(e,t)},arguments)},__wbg_set_3f1d0b984ed272ed:function(e,t,r){e[t]=r},__wbg_set_7422acbe992d64ab:function(e,t,r){e[t>>>0]=r},__wbg_set_d6bdfd275fb8a4ce:function(e,t,r){return e.set(t,r)},__wbg_set_fd40eacc85c5ab66:function(e,t,r){e.set(t,r>>>0)},__wbg_set_fe4e79d1ed3b0e9b:function(e,t,r){e.set(t,r>>>0)},__wbg_set_wasm:Ag,__wbg_setonabort_479ebb5884fcb171:function(e,t){e.onabort=t},__wbg_setonblocked_046331b614d6f8e3:function(e,t){e.onblocked=t},__wbg_setoncomplete_27bdbca012e45c05:function(e,t){e.oncomplete=t},__wbg_setonerror_537b68f474e27d4e:function(e,t){e.onerror=t},__wbg_setonerror_ce5c4d34aed931bb:function(e,t){e.onerror=t},__wbg_setonsuccess_0b2b45bd8cc13b95:function(e,t){e.onsuccess=t},__wbg_setonupgradeneeded_be2e0ae927917f82:function(e,t){e.onupgradeneeded=t},__wbg_setonversionchange_407ebf1ad930c84c:function(e,t){e.onversionchange=t},__wbg_setunique_727cefd7e14cf677:function(e,t){e.unique=0!==t},__wbg_signatures_new:function(e){return R_.__wrap(e)},__wbg_signatureuploadrequest_new:function(e){return b_.__wrap(e)},__wbg_signatureverification_new:function(e){return S_.__wrap(e)},__wbg_stack_0ed75d68575b0f3c:function(e,t){const r=Vg(t.stack,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;Gg().setInt32(e+4,n,!0),Gg().setInt32(e+0,r,!0)},__wbg_static_accessor_GLOBAL_487c52c58d65314d:function(){const e="undefined"==typeof global?null:global;return $g(e)?0:Hg(e)},__wbg_static_accessor_GLOBAL_THIS_ee9704f328b6b291:function(){const e="undefined"==typeof globalThis?null:globalThis;return $g(e)?0:Hg(e)},__wbg_static_accessor_SELF_78c9e3071b912620:function(){const e="undefined"==typeof self?null:self;return $g(e)?0:Hg(e)},__wbg_static_accessor_WINDOW_a093d21393777366:function(){const e="undefined"==typeof window?null:window;return $g(e)?0:Hg(e)},__wbg_storedroomkeybundledata_new:function(e){return C_.__wrap(e)},__wbg_storehandle_new:function(e){return k_.__wrap(e)},__wbg_stringify_c242842b97f054cc:function(){return zg(function(e){return JSON.stringify(e)},arguments)},__wbg_subarray_dd4ade7d53bd8e26:function(e,t,r){return e.subarray(t>>>0,r>>>0)},__wbg_target_15f1da583855ac4e:function(e){const t=e.target;return $g(t)?0:Hg(t)},__wbg_then_82ab9fb4080f1707:function(e,t,r){return e.then(t,r)},__wbg_then_db882932c0c714c6:function(e,t){return e.then(t)},__wbg_todevicerequest_new:function(e){return D_.__wrap(e)},__wbg_transaction_34c41b46ca391af6:function(e){const t=e.transaction;return $g(t)?0:Hg(t)},__wbg_transaction_36c8b28ed4349a9a:function(){return zg(function(e,t,r,n){return e.transaction(jg(t,r),Dp[n])},arguments)},__wbg_transaction_399fc15f5bba1880:function(){return zg(function(e,t,r){return e.transaction(t,Dp[r])},arguments)},__wbg_update_297181dae0cc0af4:function(){return zg(function(e,t){return e.update(t)},arguments)},__wbg_userdevices_new:function(e){return K_.__wrap(e)},__wbg_userid_new:function(e){return V_.__wrap(e)},__wbg_userid_unwrap:function(e){return V_.__unwrap(e)},__wbg_utdtodeviceevent_new:function(e){return N_.__wrap(e)},__wbg_value_17b896954e14f896:function(e){return e.value},__wbg_value_648dc44894c8dc95:function(){return zg(function(e){return e.value},arguments)},__wbg_values_81045499c3c8e670:function(e){return e.values()},__wbg_verificationrequest_new:function(e){return G_.__wrap(e)},__wbg_version_2c3ed4a311fdabdf:function(e){return e.version},__wbg_versions_c01dfd4722a88165:function(e){return e.versions},__wbg_warn_9b968a0475b49f6b:function(e,t){e.warn(t)},__wbg_warn_d89f6637da554c8d:function(e){console.warn(e)},__wbindgen_array_new:function(){return[]},__wbindgen_array_push:function(e,t){e.push(t)},__wbindgen_as_number:function(e){return+e},__wbindgen_bigint_from_i64:function(e){return e},__wbindgen_bigint_from_u64:function(e){return BigInt.asUintN(64,e)},__wbindgen_bigint_get_as_i64:function(e,t){const r="bigint"==typeof t?t:void 0;Gg().setBigInt64(e+8,$g(r)?BigInt(0):r,!0),Gg().setInt32(e+0,!$g(r),!0)},__wbindgen_boolean_get:function(e){return"boolean"==typeof e?e?1:0:2},__wbindgen_cb_drop:function(e){const t=e.original;return 1==t.cnt--&&(t.a=0,!0)},__wbindgen_closure_wrapper1160:function(e,t,r){return Qg(e,t,40,cp)},__wbindgen_closure_wrapper2391:function(e,t,r){return Qg(e,t,432,lp)},__wbindgen_closure_wrapper5618:function(e,t,r){return Qg(e,t,432,dp)},__wbindgen_closure_wrapper7116:function(e,t,r){return Xg(e,t,437,up)},__wbindgen_closure_wrapper7121:function(e,t,r){return Xg(e,t,437,hp)},__wbindgen_debug_string:function(e,t){const r=Vg(Zg(t),Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),n=Bg;Gg().setInt32(e+4,n,!0),Gg().setInt32(e+0,r,!0)},__wbindgen_in:function(e,t){return e in t},__wbindgen_init_externref_table:function(){const e=Dg.__wbindgen_export_4,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},__wbindgen_is_bigint:function(e){return"bigint"==typeof e},__wbindgen_is_function:function(e){return"function"==typeof e},__wbindgen_is_null:function(e){return null===e},__wbindgen_is_object:function(e){return"object"==typeof e&&null!==e},__wbindgen_is_string:function(e){return"string"==typeof e},__wbindgen_is_undefined:function(e){return void 0===e},__wbindgen_jsval_eq:function(e,t){return e===t},__wbindgen_jsval_loose_eq:function(e,t){return e==t},__wbindgen_memory:function(){return Dg.memory},__wbindgen_number_get:function(e,t){const r="number"==typeof t?t:void 0;Gg().setFloat64(e+8,$g(r)?0:r,!0),Gg().setInt32(e+0,!$g(r),!0)},__wbindgen_number_new:function(e){return e},__wbindgen_string_get:function(e,t){const r="string"==typeof t?t:void 0;var n=$g(r)?0:Vg(r,Dg.__wbindgen_malloc,Dg.__wbindgen_realloc),i=Bg;Gg().setInt32(e+4,i,!0),Gg().setInt32(e+0,n,!0)},__wbindgen_string_new:function(e,t){return jg(e,t)},__wbindgen_throw:function(e,t){throw new Error(jg(e,t))},__wbindgen_try_into_number:function(e){let t;try{t=+e}catch(e){t=e}return t},getVersions:ap,start:function(){Dg.start()}});const J_=new URL("./pkg/matrix_sdk_crypto_wasm_bg.wasm","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("matrix-js-sdk.umd.min.js",document.baseURI).href);Ag(new Proxy({},{get(){throw new Error("@matrix-org/matrix-sdk-crypto-wasm was used before it was initialized. Call `initAsync` first.")}}));let Y_=null;async function Q_(e=J_){Y_||(Y_=async function(e){const{instance:t}=await WebAssembly.instantiateStreaming(fetch(e),{"./matrix_sdk_crypto_wasm_bg.js":$_});Ag(t.exports),t.exports.__wbindgen_start()}(e)),await Y_}var X_,Z_;var ef=s(function(){if(Z_)return X_;Z_=1;for(var e=/[\\\"\x00-\x1F]/g,t={},r=0;r<32;++r)t[String.fromCharCode(r)]="\\U"+("0000"+r.toString(16)).slice(-4).toUpperCase();function n(r){return e.lastIndex=0,r.replace(e,function(e){return t[e]})}function i(e){switch(typeof e){case"string":return'"'+n(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=i(e[n]);return","!=t?"[]":r+"]"}(e):function(e){var t="{",r="",o=Object.keys(e);o.sort();for(var s=0;s<o.length;++s){var a=o[s];r+=t+'"'+n(a)+'":',t=",",r+=i(e[a])}return","!=t?"{}":r+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}return t["\b"]="\\b",t["\t"]="\\t",t["\n"]="\\n",t["\f"]="\\f",t["\r"]="\\r",t['"']='\\"',t["\\"]="\\\\",X_={stringify:i}}());class tf{constructor(e,t,r,n,i,s){this.prefixedLogger=e,this.olmMachine=t,this.keyClaimManager=r,this.outgoingRequestManager=n,this.room=i,this.encryptionSettings=s,o(this,"lazyLoadedMembersResolved",!1),o(this,"currentEncryptionPromise",Promise.resolve());var a=i.getJoinedMembers();this.olmMachine.updateTrackedUsers(a.map(e=>new V_(e.userId))).catch(e=>this.prefixedLogger.error("Error initializing tracked users",e))}onCryptoEvent(e){if(JSON.stringify(this.encryptionSettings)!=JSON.stringify(e))throw new Error("Cannot reconfigure an active RoomEncryptor")}onRoomMembership(e){(e.membership==lt.Join||e.membership==lt.Invite&&this.room.shouldEncryptForInvitedMembers())&&this.olmMachine.updateTrackedUsers([new V_(e.userId)]).catch(e=>{this.prefixedLogger.error("Unable to update tracked users",e)})}prepareForEncryption(e,t){var n=this;return r(function*(){yield n.encryptEvent(null,e,t)})()}encryptEvent(e,t,n){var i,o=this,s=new Ue(this.prefixedLogger,e?null!==(i=e.getTxnId())&&void 0!==i?i:"":"prepareForEncryption"),a=this.currentEncryptionPromise.catch(()=>{}).then(r(function*(){yield $(s,"ensureEncryptionSession",r(function*(){yield o.ensureEncryptionSession(s,t,n)})),e&&(yield $(s,"encryptEventInner",r(function*(){yield o.encryptEventInner(s,e)})))}));return this.currentEncryptionPromise=a,a}ensureEncryptionSession(e,t,n){var i=this;return r(function*(){if("m.megolm.v1.aes-sha2"!==i.encryptionSettings.algorithm)throw new Error("Cannot encrypt in ".concat(i.room.roomId," for unsupported algorithm '").concat(i.encryptionSettings.algorithm,"'"));e.debug("Starting encryption");var o=yield i.room.getEncryptionTargetMembers();i.lazyLoadedMembersResolved?(e.debug("Processing outgoing requests in background"),i.outgoingRequestManager.doProcessOutgoingRequests()):(yield $(e,"loadMembersIfNeeded: updateTrackedUsers",r(function*(){yield i.olmMachine.updateTrackedUsers(o.map(e=>new V_(e.userId)))})),e.debug("Updated tracked users"),i.lazyLoadedMembersResolved=!0,e.debug("Processing outgoing requests"),yield $(e,"doProcessOutgoingRequests",r(function*(){yield i.outgoingRequestManager.doProcessOutgoingRequests()}))),e.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(i.room.shouldEncryptForInvitedMembers(),"):"),o.map(e=>"".concat(e.userId," (").concat(e.membership,")")));var s=o.map(e=>new V_(e.userId));yield $(e,"ensureSessionsForUsers",r(function*(){yield i.keyClaimManager.ensureSessionsForUsers(e,s)}));var a=new qv;switch(a.historyVisibility=function(e){switch(e){case ra.Invited:return _p.Invited;case ra.Joined:return _p.Joined;case ra.Shared:return _p.Shared;case ra.WorldReadable:return _p.WorldReadable}}(i.room.getHistoryVisibility()),a.algorithm=mp.MegolmV1AesSha2,"number"==typeof i.encryptionSettings.rotation_period_ms&&(a.rotationPeriod=BigInt(1e3*i.encryptionSettings.rotation_period_ms)),"number"==typeof i.encryptionSettings.rotation_period_msgs&&(a.rotationPeriodMessages=BigInt(i.encryptionSettings.rotation_period_msgs)),n.kind){case $a.AllDevicesIsolationMode:var c,l=null!==(c=i.room.getBlacklistUnverifiedDevices())&&void 0!==c?c:t;a.sharingStrategy=Jp.deviceBasedStrategy(l,n.errorOnVerifiedUserProblems);break;case $a.OnlySignedDevicesIsolationMode:a.sharingStrategy=Jp.identityBasedStrategy()}yield $(e,"shareRoomKey",r(function*(){var e=yield i.olmMachine.shareRoomKey(new Ym(i.room.roomId),s,a);if(e)for(var t of e)yield i.outgoingRequestManager.outgoingRequestProcessor.makeOutgoingRequest(t)}))})()}forceDiscardSession(){var e=this;return r(function*(){(yield e.olmMachine.invalidateGroupSession(new Ym(e.room.roomId)))&&e.prefixedLogger.info("Discarded existing group session")})()}encryptEventInner(e,t){var n=this;return r(function*(){e.debug("Encrypting actual message content");var r,i=new Ym(n.room.roomId),o=t.getType(),s=JSON.stringify(t.getContent());r=t.isState()?yield n.olmMachine.encryptStateEvent(i,o,t.getStateKey(),s):yield n.olmMachine.encryptRoomEvent(i,o,s),t.makeEncrypted(Ve.RoomMessageEncrypted,JSON.parse(r),n.olmMachine.identityKeys.curve25519.toBase64(),n.olmMachine.identityKeys.ed25519.toBase64()),e.debug("Encrypted event successfully")})()}}var rf="/_matrix/client/unstable/org.matrix.msc3814.v1",nf="org.matrix.msc3814";class of extends qe{constructor(e,t,r,n,i){super(),this.logger=e,this.olmMachine=t,this.http=r,this.outgoingRequestProcessor=n,this.secretStorage=i,o(this,"intervalId",void 0)}cacheKey(e){var t=this;return r(function*(){yield t.olmMachine.dehydratedDevices().saveDehydratedDeviceKey(e),t.emit(Ha.DehydrationKeyCached)})()}isSupported(){var e=this;return r(function*(){try{yield e.http.authedRequest(jn.Get,"/dehydrated_device",void 0,void 0,{prefix:rf})}catch(e){var t=e;if("M_UNRECOGNIZED"===t.errcode)return!1;if("M_NOT_FOUND"===t.errcode)return!0;throw e}return!0})()}start(){var e=arguments,t=this;return r(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:{};if("boolean"==typeof r&&(r={createNewKey:r}),!r.onlyIfKeyCached||(yield t.olmMachine.dehydratedDevices().getDehydratedDeviceKey())){if(t.stop(),!1!==r.rehydrate)try{yield t.rehydrateDeviceIfAvailable()}catch(e){t.logger.info("dehydration: Error rehydrating device:",e),t.emit(Ha.RehydrationError,e.message)}r.createNewKey&&(yield t.resetKey()),yield t.scheduleDeviceDehydration()}})()}isKeyStored(){var e=this;return r(function*(){return Boolean(yield e.secretStorage.isStored(nf))})()}resetKey(){var e=this;return r(function*(){var t=vv.createRandomKey();return yield e.secretStorage.store(nf,t.toBase64()),yield e.cacheKey(t),t})()}getKey(e){var t=this;return r(function*(){var r=yield t.olmMachine.dehydratedDevices().getDehydratedDeviceKey();if(r)return r;var n=yield t.secretStorage.get(nf);if(void 0===n)return e?yield t.resetKey():null;var i=fo(n);try{var o=vv.createKeyFromArray(i);return yield t.cacheKey(o),o}finally{i.fill(0)}})()}rehydrateDeviceIfAvailable(){var e=this;return r(function*(){var t,r=yield e.getKey(!1);if(!r)return!1;try{t=yield e.http.authedRequest(jn.Get,"/dehydrated_device",void 0,void 0,{prefix:rf})}catch(t){var n=t;if("M_NOT_FOUND"===n.errcode||"M_UNRECOGNIZED"===n.errcode)return e.logger.info("dehydration: No dehydrated device"),!1;throw n}e.logger.info("dehydration: dehydrated device found"),e.emit(Ha.RehydrationStarted);var i=yield e.olmMachine.dehydratedDevices().rehydrate(r,new wv(t.device_id),JSON.stringify(t.device_data));e.logger.info("dehydration: device rehydrated");for(var o=void 0,s=0,a=0,c=x("/dehydrated_device/$device_id/events",{$device_id:t.device_id});;){var l=yield e.http.authedRequest(jn.Post,c,void 0,o?{next_batch:o}:{},{prefix:rf});if(0===l.events.length)break;s+=l.events.length,o=l.next_batch,a+=(yield i.receiveEvents(JSON.stringify(l.events))).length,e.emit(Ha.RehydrationProgress,a,s)}return e.logger.info("dehydration: received ".concat(a," room keys from ").concat(s," to-device events")),e.emit(Ha.RehydrationCompleted),!0})()}createAndUploadDehydratedDevice(){var e=this;return r(function*(){var t=yield e.getKey(!0),r=yield e.olmMachine.dehydratedDevices().create();e.emit(Ha.DehydratedDeviceCreated);var n=yield r.keysForUpload("Dehydrated device",t);yield e.outgoingRequestProcessor.makeOutgoingRequest(n),e.emit(Ha.DehydratedDeviceUploaded),e.logger.info("dehydration: uploaded device")})()}scheduleDeviceDehydration(){var e=this;return r(function*(){e.stop(),yield e.createAndUploadDehydratedDevice(),e.intervalId=setInterval(()=>{e.createAndUploadDehydratedDevice().catch(t=>{e.emit(Ha.DehydratedDeviceRotationError,t.message),e.logger.error("Error creating dehydrated device:",t)})},6048e5)})()}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0)}delete(){var e=this;return r(function*(){e.stop();try{yield e.http.authedRequest(jn.Delete,"/dehydrated_device",void 0,{},{prefix:rf})}catch(e){var t=e;if("M_UNRECOGNIZED"===t.errcode)return;if("M_NOT_FOUND"===t.errcode)return;throw e}})()}}function sf(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}class af{constructor(e,t,r){this.logger=e,this.olmMachine=t,this.http=r}makeOutgoingRequest(e,t){var n=this;return r(function*(){var i;if(e instanceof cm)i=yield n.requestWithRetry(jn.Post,"/_matrix/client/v3/keys/upload",{},e.body);else if(e instanceof sm)i=yield n.requestWithRetry(jn.Post,"/_matrix/client/v3/keys/query",{},e.body);else if(e instanceof im)i=yield n.requestWithRetry(jn.Post,"/_matrix/client/v3/keys/claim",{},e.body);else if(e instanceof b_)i=yield n.requestWithRetry(jn.Post,"/_matrix/client/v3/keys/signatures/upload",{},e.body);else if(e instanceof rm)i=yield n.requestWithRetry(jn.Put,"/_matrix/client/v3/room_keys/keys",{version:e.version},e.body);else if(e instanceof D_)i=yield n.sendToDeviceRequest(e);else if(e instanceof s_){var o="/_matrix/client/v3/rooms/".concat(encodeURIComponent(e.room_id),"/send/")+"".concat(encodeURIComponent(e.event_type),"/").concat(encodeURIComponent(e.txn_id));i=yield n.requestWithRetry(jn.Put,o,{},e.body)}else{if(e instanceof j_)return void(yield n.makeRequestWithUIA(jn.Post,"/_matrix/client/v3/keys/device_signing/upload",{},e.body,t));if(e instanceof Fm){var s=rf+"/dehydrated_device";return void(yield n.rawJsonRequest(jn.Put,s,{},e.body))}n.logger.warn("Unsupported outgoing message",Object.getPrototypeOf(e)),i=""}if(e.id)try{yield $(n.logger,"Mark Request as sent ".concat(e.type),r(function*(){yield n.olmMachine.markRequestAsSent(e.id,e.type,i)}))}catch(e){if(!(e instanceof Error)||"Attempt to use a moved value"!==e.message&&"null pointer passed to rust"!==e.message)throw e;n.logger.debug("Ignoring error '".concat(e.message,"': client is likely shutting down"))}else n.logger.trace("Outgoing request type:".concat(e.type," does not have an ID"))})()}sendToDeviceRequest(e){var t=this;return r(function*(){var r=JSON.parse(e.body),n=[];for(var[i,o]of Object.entries(r.messages))for(var[s,a]of Object.entries(o))n.push("".concat(i,"/").concat(s," (msgid ").concat(a[$e],")"));t.logger.info("Sending batch of to-device messages. type=".concat(e.event_type," txnid=").concat(e.txn_id),n);var c="/_matrix/client/v3/sendToDevice/".concat(encodeURIComponent(e.event_type),"/")+encodeURIComponent(e.txn_id);return yield t.requestWithRetry(jn.Put,c,{},e.body)})()}makeRequestWithUIA(e,t,n,i,s){var a=this;return r(function*(){if(!s)return yield a.requestWithRetry(e,t,n,i);var c=JSON.parse(i),l=function(){var i=r(function*(r){var i=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?sf(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):sf(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({},c);null!==r&&(i.auth=r);var s=yield a.requestWithRetry(e,t,n,JSON.stringify(i));return JSON.parse(s)});return function(e){return i.apply(this,arguments)}}(),d=yield s(l);return JSON.stringify(d)})()}requestWithRetry(e,t,n,i){var o=this;return r(function*(){for(var r=0;;)try{return yield o.rawJsonRequest(e,t,n,i)}catch(e){var s=ii(e,++r,!0);if(s<0)throw e;yield z(s)}})()}rawJsonRequest(e,t,n,i){var o=this;return r(function*(){return yield o.http.authedRequest(e,t,n,i,{json:!1,headers:{"Content-Type":"application/json",Accept:"application/json"},prefix:"",localTimeoutMs:6e4})})()}}class cf{constructor(e,t){this.olmMachine=e,this.outgoingRequestProcessor=t,o(this,"currentClaimPromise",void 0),o(this,"stopped",!1),this.currentClaimPromise=Promise.resolve()}stop(){this.stopped=!0}ensureSessionsForUsers(e,t){var r=this.currentClaimPromise.catch(()=>{}).then(()=>this.ensureSessionsForUsersInner(e,t));return this.currentClaimPromise=r,r}ensureSessionsForUsersInner(e,t){var n=this;return r(function*(){if(n.stopped)throw new Error("Cannot ensure Olm sessions: shutting down");e.info("Checking for missing Olm sessions");var r=yield n.olmMachine.getMissingSessions(t.map(e=>e.clone()));r&&(e.info("Making /keys/claim request"),yield n.outgoingRequestProcessor.makeOutgoingRequest(r)),e.info("Olm sessions prepared")})()}}function lf(e,t){var r=new Map;for(var[n,i]of e.keys.entries())r.set(n.toString(),i.toBase64());var o=Ph.Unverified;e.isBlacklisted()?o=Ph.Blocked:e.isVerified()&&(o=Ph.Verified);var s=new Map,a=e.signatures.get(t);if(a){var c=new Map;for(var[l,d]of a.entries())d.isValid()&&d.signature&&c.set(l,d.signature.toBase64());s.set(t.toString(),c)}var u=e.algorithms,h=new Set;return u.forEach(e=>{switch(e){case mp.MegolmV1AesSha2:h.add("m.megolm.v1.aes-sha2");break;case mp.OlmV1Curve25519AesSha2:default:h.add("m.olm.v1.curve25519-aes-sha2")}}),new Dh({deviceId:e.deviceId.toString(),userId:t.toString(),keys:r,algorithms:Array.from(h),verified:o,signatures:s,displayName:e.displayName,dehydrated:e.isDehydrated})}function df(e){var t,r=new Map(Object.entries(e.keys)),n=null===(t=e.unsigned)||void 0===t?void 0:t.device_display_name,i=new Map;if(e.signatures)for(var o in e.signatures)i.set(o,new Map(Object.entries(e.signatures[o])));return new Dh({deviceId:e.device_id,userId:e.user_id,keys:r,algorithms:e.algorithms,verified:Ph.Unverified,signatures:i,displayName:n})}class uf{constructor(e,t,r,n){this.logger=e,this.olmMachine=t,this.outgoingRequestProcessor=r,this.secretStorage=n}bootstrapCrossSigning(e){var t=this;return r(function*(){if(e.setupNewCrossSigning)yield t.resetCrossSigning(e.authUploadDeviceSigningKeys);else{var r=yield t.olmMachine.crossSigningStatus(),n=yield t.secretStorage.get("m.cross_signing.master"),i=yield t.secretStorage.get("m.cross_signing.self_signing"),o=yield t.secretStorage.get("m.cross_signing.user_signing"),s=Boolean(n&&i&&o),a=r.hasMaster&&r.hasUserSigning&&r.hasSelfSigning;if(t.logger.debug("bootstrapCrossSigning: starting",{setupNewCrossSigning:e.setupNewCrossSigning,olmDeviceHasMaster:r.hasMaster,olmDeviceHasUserSigning:r.hasUserSigning,olmDeviceHasSelfSigning:r.hasSelfSigning,privateKeysInSecretStorage:s}),a)(yield t.secretStorage.hasKey())?s?t.logger.debug("bootstrapCrossSigning: Olm device has private keys and they are saved in secret storage; doing nothing"):(t.logger.debug("bootstrapCrossSigning: Olm device has private keys: exporting to secret storage"),yield t.exportCrossSigningKeysToStorage()):t.logger.warn("bootstrapCrossSigning: Olm device has private keys, but secret storage is not yet set up; doing nothing for now.");else if(s){t.logger.debug("bootstrapCrossSigning: Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally");var c=yield t.olmMachine.importCrossSigningKeys(n,i,o);if(!c.hasMaster||!c.hasSelfSigning||!c.hasUserSigning)throw new Error("importCrossSigningKeys failed to import the keys");var l=yield t.olmMachine.getDevice(t.olmMachine.userId,t.olmMachine.deviceId);try{var d=yield l.verify();yield t.outgoingRequestProcessor.makeOutgoingRequest(d)}finally{l.free()}}else t.logger.debug("bootstrapCrossSigning: Cross-signing private keys not found locally or in secret storage, creating new keys"),yield t.resetCrossSigning(e.authUploadDeviceSigningKeys);t.logger.debug("bootstrapCrossSigning: complete")}})()}resetCrossSigning(e){var t=this;return r(function*(){var r=yield t.olmMachine.bootstrapCrossSigning(!0);for(var n of((yield t.secretStorage.hasKey())?(t.logger.debug("resetCrossSigning: exporting private keys to secret storage"),yield t.exportCrossSigningKeysToStorage()):t.logger.warn("resetCrossSigning: Secret storage is not yet set up; not exporting keys to secret storage yet."),t.logger.debug("resetCrossSigning: publishing public keys to server"),[r.uploadKeysRequest,r.uploadSigningKeysRequest,r.uploadSignaturesRequest]))n&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(n,e))})()}exportCrossSigningKeysToStorage(){var e=this;return r(function*(){var t=yield e.olmMachine.exportCrossSigningKeys();null!=t&&t.masterKey?yield e.secretStorage.store("m.cross_signing.master",t.masterKey):e.logger.error("Cannot export MSK to secret storage, private key unknown"),null!=t&&t.self_signing_key?yield e.secretStorage.store("m.cross_signing.self_signing",t.self_signing_key):e.logger.error("Cannot export SSK to secret storage, private key unknown"),null!=t&&t.userSigningKey?yield e.secretStorage.store("m.cross_signing.user_signing",t.userSigningKey):e.logger.error("Cannot export USK to secret storage, private key unknown")})()}}function hf(e){return gf.apply(this,arguments)}function gf(){return gf=r(function*(e){return pf(e,["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"])}),gf.apply(this,arguments)}function pf(e,t){return vf.apply(this,arguments)}function vf(){return vf=r(function*(e,t){var r=yield e.getDefaultKeyId();if(!r)return!1;for(var n of t){if(!(r in((yield e.isStored(n))||{})))return!1}return!0}),vf.apply(this,arguments)}var mf=function(e){return e.Sas="m.sas.v1",e.ShowQrCode="m.qr_code.show.v1",e.ScanQrCode="m.qr_code.scan.v1",e.Reciprocate="m.reciprocate.v1",e}({});class _f extends qe{constructor(e,t,n,i,s){super(),this.logger=e,this.olmMachine=t,this.inner=n,this.outgoingRequestProcessor=i,this.supportedVerificationMethods=s,o(this,"reEmitter",void 0),o(this,"_accepting",!1),o(this,"_cancelling",!1),o(this,"_verifier",void 0),this.reEmitter=new Nr(this);var a=new WeakRef(this);n.registerChangesCallback(r(function*(){var e;return null===(e=a.deref())||void 0===e?void 0:e.onChange()}))}onChange(){var e=this.inner.getVerification();e instanceof d_?void 0===this._verifier||this._verifier instanceof yf?this.setVerifier(new bf(e,this,this.outgoingRequestProcessor)):this._verifier instanceof bf&&this._verifier.replaceInner(e):e instanceof Bm&&void 0===this._verifier&&this.setVerifier(new yf(e,this.outgoingRequestProcessor)),this.emit(Fa.Change)}setVerifier(e){this._verifier&&this.reEmitter.stopReEmitting(this._verifier,[Fa.Change]),this._verifier=e,this.reEmitter.reEmit(this._verifier,[Fa.Change])}get transactionId(){return this.inner.flowId}get roomId(){var e;return null===(e=this.inner.roomId)||void 0===e?void 0:e.toString()}get initiatedByMe(){return this.inner.weStarted()}get otherUserId(){return this.inner.otherUserId.toString()}get otherDeviceId(){var e;return null===(e=this.inner.otherDeviceId)||void 0===e?void 0:e.toString()}getOtherDevice(){var e=this;return r(function*(){var t=e.inner.otherDeviceId;if(t)return yield e.olmMachine.getDevice(e.inner.otherUserId,t,5)})()}get isSelfVerification(){return this.inner.isSelfVerification()}get phase(){var e=this.inner.phase();switch(e){case Mp.Created:case Mp.Requested:return ja.Requested;case Mp.Ready:return this._accepting?ja.Requested:ja.Ready;case Mp.Transitioned:if(!this._verifier)throw new Error("VerificationRequest: inner phase == Transitioned but no verifier!");return this._verifier.verificationPhase;case Mp.Done:return ja.Done;case Mp.Cancelled:return ja.Cancelled}throw new Error("Unknown verification phase ".concat(e))}get pending(){if(this.inner.isPassive())return!1;var e=this.phase;return e!==ja.Done&&e!==ja.Cancelled}get accepting(){return this._accepting}get declining(){return this._cancelling}get timeout(){return this.inner.timeRemainingMillis()}get methods(){throw new Error("not implemented")}get chosenMethod(){if(this.phase!==ja.Started)return null;var e=this.inner.getVerification();return e instanceof d_?mf.Sas:e instanceof Bm?mf.Reciprocate:null}otherPartySupportsMethod(e){var t=this.inner.theirSupportedMethods;if(void 0===t)return!1;var r=wf[e];return t.some(e=>e===r)}accept(){var e=this;return r(function*(){if(e.inner.phase()!==Mp.Requested||e._accepting)throw new Error("Cannot accept a verification request in phase ".concat(e.phase));e._accepting=!0;try{var t=e.inner.acceptWithMethods(e.supportedVerificationMethods.map(Sf));t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))}finally{e._accepting=!1}e.emit(Fa.Change)})()}cancel(e){var t=this;return r(function*(){if(!t._cancelling){t.logger.info("Cancelling verification request with params:",e),t._cancelling=!0;try{var r=t.inner.cancel();r&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(r))}finally{t._cancelling=!1}}})()}beginKeyVerification(e,t){throw new Error("not implemented")}startVerification(e){var t=this;return r(function*(){if(e!==mf.Sas)throw new Error("Unsupported verification method ".concat(e));if(!(yield t.getOtherDevice()))throw new Error("startVerification(): other device is unknown");var r=yield t.inner.startSas();if(r){var[,n]=r;yield t.outgoingRequestProcessor.makeOutgoingRequest(n)}if(!t._verifier)throw new Error("Still no verifier after startSas() call");return t._verifier})()}scanQRCode(e){var t=this;return r(function*(){var r=Hm.fromBytes(e),n=yield t.inner.scanQrCode(r);if(!t._verifier)throw new Error("Still no verifier after scanQrCode() call");var i=n.reciprocate();return i&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(i)),t._verifier})()}get verifier(){return this.phase===ja.Started?this._verifier:void 0}getQRCodeBytes(){throw new Error("getQRCodeBytes() unsupported in Rust Crypto; use generateQRCode() instead.")}generateQRCode(){var e=this;return r(function*(){if(!(yield e.getOtherDevice()))throw new Error("generateQRCode(): other device is unknown");var t=yield e.inner.generateQrCode();if(t)return t.toBytes()})()}get cancellationCode(){var e,t;return null!==(e=null===(t=this.inner.cancelInfo)||void 0===t?void 0:t.cancelCode())&&void 0!==e?e:null}get cancellingUserId(){var e=this.inner.cancelInfo;return e?e.cancelledbyUs()?this.olmMachine.userId.toString():this.inner.otherUserId.toString():void 0}}class ff extends qe{constructor(e,t){super(),this.inner=e,this.outgoingRequestProcessor=t,o(this,"completionDeferred",void 0),this.completionDeferred=Promise.withResolvers();var n=new WeakRef(this);e.registerChangesCallback(r(function*(){var e;return null===(e=n.deref())||void 0===e?void 0:e.onChange()})),this.completionDeferred.promise.catch(()=>null)}onChange(){if(this.inner.isDone())this.completionDeferred.resolve(void 0);else if(this.inner.isCancelled()){var e=this.inner.cancelInfo();this.completionDeferred.reject(new Error("Verification cancelled by ".concat(e.cancelledbyUs()?"us":"them"," with code ").concat(e.cancelCode(),": ").concat(e.reason())))}this.emit(Fa.Change)}get hasBeenCancelled(){return this.inner.isCancelled()}get userId(){return this.inner.otherUserId.toString()}cancel(e){var t=this.inner.cancel();t&&this.outgoingRequestProcessor.makeOutgoingRequest(t)}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}class yf extends ff{constructor(e,t){super(e,t),o(this,"callbacks",null)}onChange(){null===this.callbacks&&this.inner.hasBeenScanned()&&(this.callbacks={confirm:()=>{this.confirmScanning()},cancel:()=>this.cancel()}),super.onChange()}verify(){var e=this;return r(function*(){null!==e.callbacks&&e.emit(Ba.ShowReciprocateQr,e.callbacks),yield e.completionDeferred.promise})()}get verificationPhase(){switch(this.inner.state()){case Sp.Created:return ja.Ready;case Sp.Scanned:case Sp.Confirmed:case Sp.Reciprocated:return ja.Started;case Sp.Done:return ja.Done;case Sp.Cancelled:return ja.Cancelled;default:throw new Error("Unknown qr code state ".concat(this.inner.state()))}}getReciprocateQrCodeCallbacks(){return this.callbacks}confirmScanning(){var e=this;return r(function*(){var t=e.inner.confirmScanning();t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))})()}}class bf extends ff{constructor(e,t,r){super(e,r),o(this,"callbacks",null)}verify(){var e=this;return r(function*(){yield e.sendAccept(),yield e.completionDeferred.promise})()}sendAccept(){var e=this;return r(function*(){var t=e.inner.accept();t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))})()}onChange(){var e,t=this;if(super.onChange(),null===this.callbacks){var n=this.inner.emoji(),i=this.inner.decimals();if(void 0===n&&void 0===i)return;var o={};n&&(o.emoji=n.map(e=>[e.symbol,e.description])),i&&(o.decimal=[i[0],i[1],i[2]]),this.callbacks={sas:o,confirm:(e=r(function*(){var e=yield t.inner.confirm();for(var r of e)yield t.outgoingRequestProcessor.makeOutgoingRequest(r)}),function(){return e.apply(this,arguments)}),mismatch:()=>{var e=this.inner.cancelWithCode("m.mismatched_sas");e&&this.outgoingRequestProcessor.makeOutgoingRequest(e)},cancel:()=>{var e=this.inner.cancelWithCode("m.user");e&&this.outgoingRequestProcessor.makeOutgoingRequest(e)}},this.emit(Ba.ShowSas,this.callbacks)}}get verificationPhase(){return ja.Started}getShowSasCallbacks(){return this.callbacks}replaceInner(e){if(this.inner!=e){this.inner=e;var t=new WeakRef(this);e.registerChangesCallback(r(function*(){var e;return null===(e=t.deref())||void 0===e?void 0:e.onChange()})),this.sendAccept(),this.onChange()}}}var wf={[mf.Sas]:Op.SasV1,[mf.ScanQrCode]:Op.QrCodeScanV1,[mf.ShowQrCode]:Op.QrCodeShowV1,[mf.Reciprocate]:Op.ReciprocateV1};function Sf(e){var t=wf[e];if(void 0===t)throw new Error("Unknown verification method ".concat(e));return t}class Ef extends qe{constructor(e,t,r,n){super(),this.logger=e,this.olmMachine=t,this.http=r,this.outgoingRequestProcessor=n,o(this,"checkedForBackup",!1),o(this,"serverBackupInfo",void 0),o(this,"activeBackupVersion",null),o(this,"stopped",!1),o(this,"backupKeysLoopRunning",!1),o(this,"keyBackupCheckInProgress",null)}stop(){this.stopped=!0}getActiveBackupVersion(){var e=this;return r(function*(){return(yield e.olmMachine.isBackupEnabled())?e.activeBackupVersion:null})()}getServerBackupInfo(){var e=this;return r(function*(){return yield e.checkKeyBackupAndEnable(!1),e.serverBackupInfo})()}isKeyBackupTrusted(e){var t=this;return r(function*(){var r=yield t.olmMachine.verifyBackup(e),n=yield t.olmMachine.getBackupKeys(),i=null==n?void 0:n.decryptionKey;return{matchesDecryptionKey:!!i&&t.backupInfoMatchesBackupDecryptionKey(e,i),trusted:r.trusted()}})()}checkKeyBackupAndEnable(e){return!e&&this.checkedForBackup?Promise.resolve(null):(this.keyBackupCheckInProgress||(this.keyBackupCheckInProgress=this.doCheckKeyBackup().finally(()=>{this.keyBackupCheckInProgress=null})),this.keyBackupCheckInProgress)}handleBackupSecretReceived(e){var t=this;return r(function*(){var r,n;try{n=yield t.requestKeyBackupVersion()}catch(e){return t.logger.warn("handleBackupSecretReceived: Error checking for latest key backup",e),!1}if(null===(r=n)||void 0===r||!r.version)return t.logger.warn("handleBackupSecretReceived: Received a backup decryption key, but there is no trusted server-side key backup"),!1;try{var i=Up.fromBase64(e);return t.backupInfoMatchesBackupDecryptionKey(n,i)?(t.logger.info("handleBackupSecretReceived: A valid backup decryption key has been received and stored in cache."),yield t.saveBackupDecryptionKey(i,n.version),!0):(t.logger.warn("handleBackupSecretReceived: Private decryption key does not match the public key of the current remote backup."),!1)}catch(e){t.logger.warn("handleBackupSecretReceived: Invalid backup decryption key",e)}return!1})()}saveBackupDecryptionKey(e,t){var n=this;return r(function*(){yield n.olmMachine.saveBackupDecryptionKey(e,t),n.emit(Ha.KeyBackupDecryptionKeyCached,t)})()}importRoomKeys(e,t){var n=this;return r(function*(){yield n.importRoomKeysAsJson(JSON.stringify(e),t)})()}importRoomKeysAsJson(e,t){var n=this;return r(function*(){yield n.olmMachine.importExportedRoomKeys(e,(e,r)=>{var n,i={total:Number(r),successes:Number(e),stage:Xa.LoadKeys,failures:0};null==t||null===(n=t.progressCallback)||void 0===n||n.call(t,i)})})()}importBackedUpRoomKeys(e,t,n){var i=this;return r(function*(){var r=new Map;for(var o of e){var s=new Ym(o.room_id);r.has(s)||r.set(s,new Map),r.get(s).set(o.session_id,o)}yield i.olmMachine.importBackedUpRoomKeys(r,(e,t,r)=>{var i,o={total:Number(t),successes:Number(e),stage:Xa.LoadKeys,failures:Number(r)};null==n||null===(i=n.progressCallback)||void 0===i||i.call(n,o)},t)})()}doCheckKeyBackup(){var e=this;return r(function*(){var t;e.logger.debug("Checking key backup status...");try{t=yield e.requestKeyBackupVersion()}catch(t){return e.logger.warn("Error checking for active key backup",t),e.serverBackupInfo=void 0,null}e.checkedForBackup=!0,t&&!t.version&&(e.logger.warn("active backup lacks a useful 'version'; ignoring it"),t=void 0),e.serverBackupInfo=t;var r=yield e.getActiveBackupVersion();if(!t)return null!==r?(e.logger.debug("No key backup present on server: disabling key backup"),yield e.disableKeyBackup()):e.logger.debug("No key backup present on server: not enabling key backup"),null;var n=yield e.isKeyBackupTrusted(t);return n.matchesDecryptionKey||n.trusted?null===r?(e.logger.debug("Found usable key backup v".concat(t.version,": enabling key backups")),yield e.enableKeyBackup(t)):r!==t.version?(e.logger.debug("On backup version ".concat(r," but found version ").concat(t.version,": switching.")),yield e.disableKeyBackup(),yield e.enableKeyBackup(t)):e.logger.debug("Backup version ".concat(t.version," still current")):null!==r?(e.logger.debug("Key backup present on server but not trusted: disabling key backup"),yield e.disableKeyBackup()):e.logger.debug("Key backup present on server but not trusted: not enabling key backup"),{backupInfo:t,trustInfo:n}})()}enableKeyBackup(e){var t=this;return r(function*(){yield t.olmMachine.enableBackupV1(e.auth_data.public_key,e.version),t.activeBackupVersion=e.version,t.emit(Ha.KeyBackupStatus,!0),t.backupKeysLoop()})()}maybeUploadKey(){var e=this;return r(function*(){null!=e.activeBackupVersion&&e.backupKeysLoop()})()}disableKeyBackup(){var e=this;return r(function*(){yield e.olmMachine.disableBackup(),e.activeBackupVersion=null,e.emit(Ha.KeyBackupStatus,!1)})()}backupKeysLoop(){var e=arguments,t=this;return r(function*(){var n=e.length>0&&void 0!==e[0]?e[0]:1e4;if(t.backupKeysLoopRunning)t.logger.debug("Backup loop already running");else{t.backupKeysLoopRunning=!0,t.logger.debug("Backup: Starting keys upload loop for backup version:".concat(t.activeBackupVersion,"."));var i=Math.random()*n;yield z(i);try{for(var o=0,s=null,a=!0;!t.stopped;){var c=void 0;try{c=yield $(t.logger,"BackupRoomKeys: Get keys to backup from rust crypto-sdk",r(function*(){return yield t.olmMachine.backupRoomKeys()}))}catch(e){t.logger.error("Backup: Failed to get keys to backup from rust crypto-sdk",e)}if(!c||t.stopped||!t.activeBackupVersion)return t.logger.debug("Backup: Ending loop for version ".concat(t.activeBackupVersion,".")),void(c||t.emit(Ha.KeyBackupSessionsRemaining,0));try{if(yield t.outgoingRequestProcessor.makeOutgoingRequest(c),o=0,t.stopped)break;if(!a&&null===s)try{var l=yield t.olmMachine.roomKeyCounts();s=l.total-l.backedUp}catch(e){t.logger.error("Backup: Failed to get key counts from rust crypto-sdk",e)}if(null!==s){t.emit(Ha.KeyBackupSessionsRemaining,s);var d=t.keysCountInBatch(c);s=Math.max(s-d,0)}}catch(e){if(o++,t.logger.error("Backup: Error processing backup request for rust crypto-sdk",e),e instanceof Vn){var u=e.data.errcode;if("M_NOT_FOUND"==u||"M_WRONG_ROOM_KEYS_VERSION"==u){t.logger.debug("Backup: Failed to upload keys to current vesion: ".concat(u,"."));try{yield t.disableKeyBackup()}catch(e){t.logger.error("Backup: An error occurred while disabling key backup:",e)}return t.emit(Ha.KeyBackupFailed,e.data.errcode),t.backupKeysLoopRunning=!1,void t.checkKeyBackupAndEnable(!0)}if(e.isRateLimitError())try{var h=e.getRetryAfterMs();if(h&&h>0){yield z(h);continue}}catch(e){t.logger.warn("Backup: An error occurred while retrieving a rate-limit retry delay",e)}}yield z(1e3*Math.pow(2,Math.min(o-1,4)))}a=!1}}finally{t.backupKeysLoopRunning=!1}}})()}keysCountInBatch(e){return Cf(JSON.parse(e.body))}requestKeyBackupVersion(e){var t=this;return r(function*(){return yield If(t.http,e)})()}setupKeyBackup(e){var t=this;return r(function*(){yield t.deleteAllKeyBackupVersions();var r=Up.createRandomKey(),n=r.megolmV1PublicKey,i={public_key:n.publicKeyBase64};yield e(i);var o=yield t.http.authedRequest(jn.Post,"/room_keys/version",void 0,{algorithm:n.algorithm,auth_data:i},{prefix:ui.V3});return yield t.saveBackupDecryptionKey(r,o.version),{version:o.version,algorithm:n.algorithm,authData:i,decryptionKey:r}})()}deleteAllKeyBackupVersions(){var e=this;return r(function*(){for(var t,r,n=null!==(t=null===(r=yield e.requestKeyBackupVersion())||void 0===r?void 0:r.version)&&void 0!==t?t:null;null!=n;){var i,o;yield e.deleteKeyBackupVersion(n),n=null!==(i=null===(o=yield e.requestKeyBackupVersion())||void 0===o?void 0:o.version)&&void 0!==i?i:null}})()}deleteKeyBackupVersion(e){var t=this;return r(function*(){t.logger.debug("deleteKeyBackupVersion v:".concat(e));var r=x("/room_keys/version/$version",{$version:e});yield t.http.authedRequest(jn.Delete,r,void 0,void 0,{prefix:ui.V3}),t.activeBackupVersion===e&&(t.serverBackupInfo=null,yield t.disableKeyBackup())})()}createBackupDecryptor(e){return new Rf(this.logger,e)}restoreKeyBackup(e,t,n){var i=this;return r(function*(){var r=yield i.downloadKeyBackup(e);return i.importKeyBackup(r,e,t,n)})()}downloadKeyBackup(e){return this.http.authedRequest(jn.Get,"/room_keys/keys",{version:e},void 0,{prefix:ui.V3})}importKeyBackup(e,t,n,i){var o=this;return r(function*(){var s,a=Cf(e),c=0,l=0;null==i||null===(s=i.progressCallback)||void 0===s||s.call(i,{total:a,successes:c,stage:Xa.LoadKeys,failures:l});var d=function(){var e=r(function*(e){var r,s=[],d=function*(t){(yield n.decryptSessions(e.get(t))).forEach(e=>{e.room_id=t,s.push(e)})};for(var u of e.keys())yield*d(u);try{yield o.importBackedUpRoomKeys(s,t),c+=s.length}catch(e){l+=s.length,o.logger.error("Error importing keys from backup",e)}null==i||null===(r=i.progressCallback)||void 0===r||r.call(i,{total:a,successes:c,stage:Xa.LoadKeys,failures:l})});return function(t){return e.apply(this,arguments)}}(),u=0,h=new Map;for(var[g,p]of Object.entries(e.rooms))if(p.sessions)for(var[v,m]of(h.set(g,{}),Object.entries(p.sessions))){h.get(g)[v]=m,(u+=1)>=200&&(yield d(h),(h=new Map).set(g,{}),u=0)}return u>0&&(yield d(h)),{total:a,imported:c}})()}backupInfoMatchesBackupDecryptionKey(e,t){var r;return"m.megolm_backup.v1.curve25519-aes-sha2"!==e.algorithm?(this.logger.warn("backupMatchesPrivateKey: Unsupported backup algorithm",e.algorithm),!1):(null===(r=e.auth_data)||void 0===r?void 0:r.public_key)===t.megolmV1PublicKey.publicKeyBase64}}class Rf{constructor(e,t){this.logger=e,o(this,"decryptionKey",void 0),o(this,"sourceTrusted",void 0),this.decryptionKey=t,this.sourceTrusted=!1}decryptSessions(e){var t=this;return r(function*(){var r=[];for(var[n,i]of Object.entries(e))try{var o=JSON.parse(t.decryptionKey.decryptV1(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));o.session_id=n,r.push(o)}catch(e){t.logger.debug("Failed to decrypt megolm session from backup",e,i)}return r})()}free(){this.decryptionKey.free()}}function If(e,t){return kf.apply(this,arguments)}function kf(){return(kf=r(function*(e,t){try{var r=t?x("/room_keys/version/$version",{$version:t}):"/room_keys/version";return yield e.authedRequest(jn.Get,r,void 0,void 0,{prefix:ui.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}})).apply(this,arguments)}function Tf(e,t){return t.auth_data.public_key===e.megolmV1PublicKey.publicKeyBase64}function Cf(e){var t=0;for(var{sessions:r}of Object.values(e.rooms))t+=Object.keys(r).length;return t}class Of{constructor(e,t,r){this.logger=e,this.olmMachine=t,this.outgoingRequestProcessor=r,o(this,"stopped",!1),o(this,"outgoingRequestLoopRunning",!1),o(this,"nextLoopDeferred",void 0)}stop(){this.stopped=!0}doProcessOutgoingRequests(){this.nextLoopDeferred||(this.nextLoopDeferred=Promise.withResolvers());var e=this.nextLoopDeferred.promise;return this.outgoingRequestLoopRunning||this.outgoingRequestLoop().catch(e=>{this.logger.error("Uncaught error in outgoing request loop",e)}),e}outgoingRequestLoop(){var e=this;return r(function*(){if(e.outgoingRequestLoopRunning)throw new Error("Cannot run two outgoing request loops");e.outgoingRequestLoopRunning=!0;try{for(;!e.stopped&&e.nextLoopDeferred;){var t=e.nextLoopDeferred;e.nextLoopDeferred=void 0,yield e.processOutgoingRequests().then(t.resolve,t.reject)}}finally{e.outgoingRequestLoopRunning=!1}e.nextLoopDeferred&&e.nextLoopDeferred.reject(new Error("OutgoingRequestsManager was stopped"))})()}processOutgoingRequests(){var e=this;return r(function*(){if(!e.stopped){var t,n=yield e.olmMachine.outgoingRequests(),i=function*(t){if(e.stopped)return{v:void 0};try{yield $(e.logger,"Make outgoing request ".concat(t.type),r(function*(){yield e.outgoingRequestProcessor.makeOutgoingRequest(t)}))}catch(r){e.logger.error("Failed to process outgoing request ".concat(t.type,": ").concat(r))}};for(var o of n)if(t=yield*i(o))return t.v}})()}}var Mf=5e3,Pf=function(e){return e.MISSING_DECRYPTION_KEY="MISSING_DECRYPTION_KEY",e.NETWORK_ERROR="NETWORK_ERROR",e.STOPPED="STOPPED",e}(Pf||{});class Df extends Error{constructor(e){super("Failed to get key from backup: ".concat(e)),this.code=e,this.name="KeyDownloadError"}}class Af extends Error{constructor(e){super("Failed to get key from backup: rate limited"),this.retryMillis=e,this.name="KeyDownloadRateLimitError"}}class xf{constructor(e,t,r,n){this.olmMachine=t,this.http=r,this.backupManager=n,o(this,"stopped",!1),o(this,"configuration",null),o(this,"sessionLastCheckAttemptedTime",new Map),o(this,"logger",void 0),o(this,"downloadLoopRunning",!1),o(this,"queuedRequests",[]),o(this,"hasConfigurationProblem",!1),o(this,"currentBackupVersionCheck",null),o(this,"onBackupStatusChanged",()=>{this.hasConfigurationProblem=!1,this.configuration=null,this.getOrCreateBackupConfiguration().then(e=>{e&&this.downloadKeysLoop()})}),this.logger=e.getChild("[PerSessionKeyBackupDownloader]"),n.on(Ha.KeyBackupStatus,this.onBackupStatusChanged),n.on(Ha.KeyBackupFailed,this.onBackupStatusChanged),n.on(Ha.KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}isKeyBackupDownloadConfigured(){return null!==this.configuration}getServerBackupInfo(){var e=this;return r(function*(){return yield e.backupManager.getServerBackupInfo()})()}onDecryptionKeyMissingError(e,t){this.isAlreadyInQueue(e,t)?this.logger.trace("Not checking key backup for session ".concat(t," as it is already queued")):this.wasRequestedRecently(t)?this.logger.trace("Not checking key backup for session ".concat(t," as it was already requested recently")):(this.queuedRequests.push({roomId:e,megolmSessionId:t}),this.downloadKeysLoop())}stop(){this.stopped=!0,this.backupManager.off(Ha.KeyBackupStatus,this.onBackupStatusChanged),this.backupManager.off(Ha.KeyBackupFailed,this.onBackupStatusChanged),this.backupManager.off(Ha.KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}isAlreadyInQueue(e,t){return this.queuedRequests.some(r=>r.roomId==e&&r.megolmSessionId==t)}markAsNotFoundInBackup(e){var t=Date.now();this.sessionLastCheckAttemptedTime.set(e,t),this.sessionLastCheckAttemptedTime.size>100&&(this.sessionLastCheckAttemptedTime=new Map(Array.from(this.sessionLastCheckAttemptedTime).filter((e,r)=>Math.max(t-r,0)<Mf)))}wasRequestedRecently(e){var t=this.sessionLastCheckAttemptedTime.get(e);return!!t&&Math.max(Date.now()-t,0)<Mf}getBackupDecryptionKey(){var e=this;return r(function*(){try{return yield e.olmMachine.getBackupKeys()}catch(e){return null}})()}requestRoomKeyFromBackup(e,t,n){var i=this;return r(function*(){var r=x("/room_keys/keys/$roomId/$sessionId",{$roomId:t,$sessionId:n});return yield i.http.authedRequest(jn.Get,r,{version:e},void 0,{prefix:ui.V3})})()}downloadKeysLoop(){var e=this;return r(function*(){if(!e.downloadLoopRunning&&!e.hasConfigurationProblem){e.downloadLoopRunning=!0;try{for(;e.queuedRequests.length>0;){var t=e.queuedRequests[0];try{var r=yield e.getOrCreateBackupConfiguration();if(!r)return void(e.downloadLoopRunning=!1);var n=yield e.queryKeyBackup(t.roomId,t.megolmSessionId,r);if(e.stopped)return;try{yield e.decryptAndImport(t,n,r)}catch(r){e.logger.error("Error while decrypting and importing key backup for session ".concat(t.megolmSessionId),r)}e.queuedRequests.shift()}catch(r){if(r instanceof Df)switch(r.code){case Pf.MISSING_DECRYPTION_KEY:e.markAsNotFoundInBackup(t.megolmSessionId),e.queuedRequests.shift();break;case Pf.NETWORK_ERROR:yield z(Mf);break;case Pf.STOPPED:return void(e.downloadLoopRunning=!1)}else r instanceof Af&&(yield z(r.retryMillis))}}}finally{e.downloadLoopRunning=!1}}})()}queryKeyBackup(e,t,n){var i=this;return r(function*(){if(i.logger.debug("Checking key backup for session ".concat(t)),i.stopped)throw new Df(Pf.STOPPED);try{var r=yield i.requestRoomKeyFromBackup(n.backupVersion,e,t);return i.logger.debug("Got key from backup for sessionId:".concat(t)),r}catch(e){if(i.stopped)throw new Df(Pf.STOPPED);if(i.logger.info("No luck requesting key backup for session ".concat(t,": ").concat(e)),e instanceof Vn){if("M_NOT_FOUND"==e.data.errcode)throw new Df(Pf.MISSING_DECRYPTION_KEY);if(e.isRateLimitError()){var o;try{var s;o=null!==(s=e.getRetryAfterMs())&&void 0!==s?s:void 0}catch(e){i.logger.warn("Error while retrieving a rate-limit retry delay",e)}throw o&&o>0&&i.logger.info("Rate limited by server, waiting ".concat(o,"ms")),new Af(null!=o?o:Mf)}}throw new Df(Pf.NETWORK_ERROR)}})()}decryptAndImport(e,t,n){var i=this;return r(function*(){var r={[e.megolmSessionId]:t},o=yield n.decryptor.decryptSessions(r);for(var s of o)s.room_id=e.roomId;yield i.backupManager.importBackedUpRoomKeys(o,n.backupVersion)})()}getOrCreateBackupConfiguration(){var e=this;return r(function*(){if(e.configuration)return e.configuration;if(e.hasConfigurationProblem)return null;if(null!=e.currentBackupVersionCheck)return e.logger.debug("Already checking server version, use current promise"),yield e.currentBackupVersionCheck;e.currentBackupVersionCheck=e.internalCheckFromServer();try{return yield e.currentBackupVersionCheck}finally{e.currentBackupVersionCheck=null}})()}internalCheckFromServer(){var e=this;return r(function*(){var t,r,n,i,o=null;try{o=yield e.backupManager.getServerBackupInfo()}catch(t){return e.logger.debug("Backup: error while checking server version: ".concat(t)),e.hasConfigurationProblem=!0,null}if(e.logger.debug("Got current backup version from server: ".concat(null===(t=o)||void 0===t?void 0:t.version)),"m.megolm_backup.v1.curve25519-aes-sha2"!=(null===(r=o)||void 0===r?void 0:r.algorithm))return e.logger.info("Unsupported algorithm ".concat(null===(i=o)||void 0===i?void 0:i.algorithm)),e.hasConfigurationProblem=!0,null;if(null===(n=o)||void 0===n||!n.version)return e.logger.info("No current key backup"),e.hasConfigurationProblem=!0,null;var s=yield e.backupManager.getActiveBackupVersion();if(null==s||o.version!=s)return e.logger.info("The current backup version on the server (".concat(o.version,") is not trusted. Version we are currently backing up to: ").concat(s)),e.hasConfigurationProblem=!0,null;var a=yield e.getBackupDecryptionKey();if(null==a||!a.decryptionKey)return e.logger.debug("Not checking key backup for session (no decryption key)"),e.hasConfigurationProblem=!0,null;if(s!=a.backupVersion)return e.logger.debug("Version for which we have a decryption key (".concat(a.backupVersion,") doesn't match the version we are backing up to (").concat(s,")")),e.hasConfigurationProblem=!0,null;if(o.auth_data.public_key!=a.decryptionKey.megolmV1PublicKey.publicKeyBase64)return e.logger.debug("Key backup on server does not match our decryption key"),e.hasConfigurationProblem=!0,null;var c=e.backupManager.createBackupDecryptor(a.decryptionKey);return e.hasConfigurationProblem=!1,e.configuration={decryptor:c,backupVersion:s},e.configuration})()}}function Uf(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Lf(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Uf(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Uf(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var Nf=[mf.Sas,mf.ScanQrCode,mf.ShowQrCode,mf.Reciprocate];class Ff extends qe{constructor(e,t,r,n,i,s,a){var c=arguments.length>7&&void 0!==arguments[7]&&arguments[7];super(),this.logger=e,this.olmMachine=t,this.http=r,this.userId=n,this.secretStorage=s,this.cryptoCallbacks=a,this.enableEncryptedStateEvents=c,o(this,"RECOVERY_KEY_DERIVATION_ITERATIONS",5e5),o(this,"_trustCrossSignedDevices",!0),o(this,"deviceIsolationMode",new Ja(!1)),o(this,"stopped",!1),o(this,"roomEncryptors",{}),o(this,"eventDecryptor",void 0),o(this,"keyClaimManager",void 0),o(this,"outgoingRequestProcessor",void 0),o(this,"crossSigningIdentity",void 0),o(this,"backupManager",void 0),o(this,"outgoingRequestsManager",void 0),o(this,"perSessionBackupDownloader",void 0),o(this,"dehydratedDeviceManager",void 0),o(this,"reemitter",new Nr(this)),o(this,"globalBlacklistUnverifiedDevices",!1),o(this,"_supportedVerificationMethods",Nf),this.outgoingRequestProcessor=new af(e,t,r),this.outgoingRequestsManager=new Of(this.logger,t,this.outgoingRequestProcessor),this.keyClaimManager=new cf(t,this.outgoingRequestProcessor),this.backupManager=new Ef(e,t,r,this.outgoingRequestProcessor),this.perSessionBackupDownloader=new xf(this.logger,this.olmMachine,this.http,this.backupManager),this.dehydratedDeviceManager=new of(this.logger,t,r,this.outgoingRequestProcessor,s),this.eventDecryptor=new jf(this.logger,t,this.perSessionBackupDownloader),this.reemitter.reEmit(this.backupManager,[Ha.KeyBackupStatus,Ha.KeyBackupSessionsRemaining,Ha.KeyBackupFailed,Ha.KeyBackupDecryptionKeyCached]),this.reemitter.reEmit(this.dehydratedDeviceManager,[Ha.DehydratedDeviceCreated,Ha.DehydratedDeviceUploaded,Ha.RehydrationStarted,Ha.RehydrationProgress,Ha.RehydrationCompleted,Ha.RehydrationError,Ha.DehydrationKeyCached,Ha.DehydratedDeviceRotationError]),this.crossSigningIdentity=new uf(e,t,this.outgoingRequestProcessor,s),this.checkKeyBackupAndEnable()}getOlmMachineOrThrow(){if(this.stopped)throw new Sc;return this.olmMachine}set globalErrorOnUnknownDevices(e){}get globalErrorOnUnknownDevices(){return!1}stop(){this.stopped||(this.stopped=!0,this.keyClaimManager.stop(),this.backupManager.stop(),this.outgoingRequestsManager.stop(),this.perSessionBackupDownloader.stop(),this.dehydratedDeviceManager.stop(),this.olmMachine.close())}encryptEvent(e,t){var n=this;return r(function*(){var t=e.getRoomId(),r=n.roomEncryptors[t];if(!r)throw new Error("Cannot encrypt event in unconfigured room ".concat(t));yield r.encryptEvent(e,n.globalBlacklistUnverifiedDevices,n.deviceIsolationMode)})()}decryptEvent(e){var t=this;return r(function*(){if(!e.getRoomId())throw new Error("to-device event was not decrypted in preprocessToDeviceMessages");return yield t.eventDecryptor.attemptEventDecryption(e,t.deviceIsolationMode)})()}getBackupDecryptor(e,t){var n=this;return r(function*(){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor: expects Uint8Array");if("m.megolm_backup.v1.curve25519-aes-sha2"!=e.algorithm)throw new Error("getBackupDecryptor: Unsupported algorithm ".concat(e.algorithm));var r=Up.fromBase64(vo(t));if(!Tf(r,e))throw new Error("getBackupDecryptor: key backup on server does not match the decryption key");return n.backupManager.createBackupDecryptor(r)})()}importBackedUpRoomKeys(e,t,n){var i=this;return r(function*(){return yield i.backupManager.importBackedUpRoomKeys(e,t,n)})()}maybeAcceptKeyBundle(e,t){var n=this;return r(function*(){var r=new Ue(n.logger,"maybeAcceptKeyBundle(".concat(e,", ").concat(t,")"));r.info("Checking inviter cross-signing keys");var i=n.olmMachine.queryKeysForUsers([new V_(t)]);yield n.outgoingRequestProcessor.makeOutgoingRequest(i);var o=yield n.olmMachine.getReceivedRoomKeyBundleData(new Ym(e),new V_(t));if(o){r.info("Fetching key bundle ".concat(o.url));var s,a=Ce(n.http.opts.baseUrl,o.url,void 0,void 0,void 0,!1,!0,!0);try{var c=new URL(a);s=yield n.http.authedRequest(jn.Get,c.pathname+c.search,{},void 0,{rawResponseBody:!0,prefix:""})}catch(e){throw r.warn("Error downloading encrypted bundle from ".concat(a,":"),e),e}r.info("Received blob of length ".concat(s.size));try{yield n.olmMachine.receiveRoomKeyBundle(o,new Uint8Array(yield s.arrayBuffer()))}catch(e){throw r.warn("Error receiving encrypted bundle:",e),e}}else r.info("No key bundle found for user")})()}getVersion(){var e=ap();return"Rust SDK ".concat(e.matrix_sdk_crypto," (").concat(e.git_sha,"), Vodozemac ").concat(e.vodozemac)}setDeviceIsolationMode(e){this.deviceIsolationMode=e}isEncryptionEnabledInRoom(e){var t=this;return r(function*(){var r=yield t.olmMachine.getRoomSettings(new Ym(e));return Boolean(null==r?void 0:r.algorithm)})()}isStateEncryptionEnabledInRoom(e){var t=this;return r(function*(){var r=yield t.olmMachine.getRoomSettings(new Ym(e));return Boolean(null==r?void 0:r.encryptStateEvents)})()}getOwnDeviceKeys(){var e=this;return r(function*(){var t=e.olmMachine.identityKeys;return{ed25519:t.ed25519.toBase64(),curve25519:t.curve25519.toBase64()}})()}prepareToEncrypt(e){var t=this.roomEncryptors[e.roomId];t&&t.prepareForEncryption(this.globalBlacklistUnverifiedDevices,this.deviceIsolationMode)}forceDiscardSession(e){var t;return null===(t=this.roomEncryptors[e])||void 0===t?void 0:t.forceDiscardSession()}exportRoomKeys(){var e=this;return r(function*(){var t=yield e.olmMachine.exportRoomKeys(()=>!0);return JSON.parse(t)})()}exportRoomKeysAsJson(){var e=this;return r(function*(){return yield e.olmMachine.exportRoomKeys(()=>!0)})()}importRoomKeys(e,t){var n=this;return r(function*(){return yield n.backupManager.importRoomKeys(e,t)})()}importRoomKeysAsJson(e,t){var n=this;return r(function*(){return yield n.backupManager.importRoomKeysAsJson(e,t)})()}userHasCrossSigningKeys(){var e=arguments,t=this;return r(function*(){var r,n=e.length>0&&void 0!==e[0]?e[0]:t.userId,i=e.length>1&&void 0!==e[1]&&e[1],o=yield t.olmMachine.trackedUsers();for(var s of o)if(n===s.toString()){r=s;break}if(void 0!==r){if(n===t.userId){var a=t.olmMachine.queryKeysForUsers([r.clone()]);yield t.outgoingRequestProcessor.makeOutgoingRequest(a)}var c=yield t.olmMachine.getIdentity(r);return null==c||c.free(),void 0!==c}if(i){var l,d=null===(l=(yield t.downloadDeviceList(new Set([n]))).master_keys)||void 0===l?void 0:l[n];return!!d&&Boolean(Object.values(d.keys)[0])}return!1})()}getUserDeviceInfo(e){var t=arguments,n=this;return r(function*(){var r=t.length>1&&void 0!==t[1]&&t[1],i=new Map,o=yield n.getOlmMachineOrThrow().trackedUsers(),s=new Set;o.forEach(e=>s.add(e.toString()));var a=new Set;for(var c of e)s.has(c)?i.set(c,yield n.getUserDevices(c)):a.add(c);if(r&&a.size>=1){var l=yield n.downloadDeviceList(a);Object.entries(l.device_keys).forEach(e=>{var[t,r]=e;return i.set(t,function(e){return new Map(Object.entries(e).map(e=>{var[t,r]=e;return[t,df(r)]}))}(r))})}return i})()}getUserDevices(e){var t=this;return r(function*(){var r=new V_(e),n=yield t.olmMachine.getUserDevices(r,1);try{var i=n.devices();try{return new Map(i.map(e=>[e.deviceId.toString(),lf(e,r)]))}finally{i.forEach(e=>e.free())}}finally{n.free()}})()}downloadDeviceList(e){var t=this;return r(function*(){var r={device_keys:{}};return e.forEach(e=>r.device_keys[e]=[]),yield t.http.authedRequest(jn.Post,"/_matrix/client/v3/keys/query",void 0,r,{prefix:""})})()}getTrustCrossSignedDevices(){return this._trustCrossSignedDevices}setTrustCrossSignedDevices(e){this._trustCrossSignedDevices=e}setDeviceVerified(e,t){var n=arguments,i=this;return r(function*(){var r=!(n.length>2&&void 0!==n[2])||n[2],o=yield i.olmMachine.getDevice(new V_(e),new wv(t));if(!o)throw new Error("Unknown device ".concat(e,"|").concat(t));try{yield o.setLocalTrust(r?fp.Verified:fp.Unset)}finally{o.free()}})()}crossSignDevice(e){var t=this;return r(function*(){var r=yield t.olmMachine.getDevice(new V_(t.userId),new wv(e));if(!r)throw new Error("Unknown device ".concat(e));try{var n=yield r.verify();yield t.outgoingRequestProcessor.makeOutgoingRequest(n)}finally{r.free()}})()}getDeviceVerificationStatus(e,t){var n=this;return r(function*(){var r=yield n.olmMachine.getDevice(new V_(e),new wv(t));if(!r)return null;try{return new Qa({signedByOwner:r.isCrossSignedByOwner(),crossSigningVerified:r.isCrossSigningTrusted(),localVerified:r.isLocallyTrusted(),trustCrossSignedDevices:n._trustCrossSignedDevices})}finally{r.free()}})()}getUserVerificationStatus(e){var t=this;return r(function*(){var r=yield t.getOlmMachineOrThrow().getIdentity(new V_(e));if(void 0===r)return new Ya(!1,!1,!1);var n=r.isVerified(),i=r.wasPreviouslyVerified(),o=r instanceof bm&&r.identityNeedsUserApproval();return r.free(),new Ya(n,i,!1,o)})()}pinCurrentUserIdentity(e){var t=this;return r(function*(){var r=yield t.getOlmMachineOrThrow().getIdentity(new V_(e));if(void 0===r)throw new Error("Cannot pin identity of unknown user");if(r instanceof Rm)throw new Error("Cannot pin identity of own user");yield r.pinCurrentMasterKey()})()}withdrawVerificationRequirement(e){var t=this;return r(function*(){var r=yield t.getOlmMachineOrThrow().getIdentity(new V_(e));if(void 0===r)throw new Error("Cannot withdraw verification of unknown user");yield r.withdrawVerification()})()}isCrossSigningReady(){var e=this;return r(function*(){var{privateKeysInSecretStorage:t,privateKeysCachedLocally:r}=yield e.getCrossSigningStatus(),n=Boolean(r.masterKey)&&Boolean(r.selfSigningKey)&&Boolean(r.userSigningKey),i=yield e.getOwnIdentity();return!(null==i||!i.isVerified())&&(n||t)})()}getCrossSigningKeyId(){var e=arguments,t=this;return r(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:Za.Master,n=yield t.olmMachine.getIdentity(new V_(t.userId));if(!n)return null;try{var i,o=yield t.olmMachine.crossSigningStatus();if(!(o.hasMaster&&o.hasUserSigning&&o.hasSelfSigning))return null;if(!n.isVerified())return null;switch(r){case Za.Master:i=n.masterKey;break;case Za.SelfSigning:i=n.selfSigningKey;break;case Za.UserSigning:i=n.userSigningKey;break;default:return null}var s=JSON.parse(i);return Object.values(s.keys)[0]}finally{n.free()}})()}bootstrapCrossSigning(e){var t=this;return r(function*(){yield t.crossSigningIdentity.bootstrapCrossSigning(e)})()}isSecretStorageReady(){var e=this;return r(function*(){var t=["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"];return null!=(yield e.backupManager.getActiveBackupVersion())&&t.push("m.megolm_backup.v1"),pf(e.secretStorage,t)})()}bootstrapSecretStorage(){var e=arguments,t=this;return r(function*(){var{createSecretStorageKey:r,setupNewSecretStorage:n,setupNewKeyBackup:i}=e.length>0&&void 0!==e[0]?e[0]:{},o=n||!(yield t.secretStorageHasAESKey());if(o){if(!r)throw new Error("unable to create a new secret storage key, createSecretStorageKey is not set");t.logger.info("bootstrapSecretStorage: creating new secret storage key");var s=yield r();if(!s)throw new Error("createSecretStorageKey() callback did not return a secret storage key");yield t.addSecretStorageKeyToSecretStorage(s)}var a=yield t.olmMachine.exportCrossSigningKeys();!(a&&void 0!==a.masterKey&&void 0!==a.self_signing_key&&void 0!==a.userSigningKey)||!o&&(yield hf(t.secretStorage))||(t.logger.info("bootstrapSecretStorage: cross-signing keys not yet exported; doing so now."),yield t.secretStorage.store("m.cross_signing.master",a.masterKey),yield t.secretStorage.store("m.cross_signing.user_signing",a.userSigningKey),yield t.secretStorage.store("m.cross_signing.self_signing",a.self_signing_key)),i?yield t.resetKeyBackup():yield t.saveBackupKeyToStorage()})()}saveBackupKeyToStorage(){var e=this;return r(function*(){var t=yield e.backupManager.getServerBackupInfo();if(t&&t.version){var r=yield e.olmMachine.getBackupKeys();if(r.decryptionKey)if(Tf(r.decryptionKey,t)){var n=r.decryptionKey.toBase64();yield e.secretStorage.store("m.megolm_backup.v1",n)}else e.logger.info("Not saving backup key to secret storage: decryption key does not match backup info");else e.logger.info("Not saving backup key to secret storage: no backup key")}else e.logger.info("Not saving backup key to secret storage: no backup info")})()}addSecretStorageKeyToSecretStorage(e){var t=this;return r(function*(){var r,n,i,o,s=yield t.secretStorage.addKey(lc,{passphrase:null===(r=e.keyInfo)||void 0===r?void 0:r.passphrase,name:null===(n=e.keyInfo)||void 0===n?void 0:n.name,key:e.privateKey});yield t.secretStorage.setDefaultKeyId(s.keyId),null===(i=(o=t.cryptoCallbacks).cacheSecretStorageKey)||void 0===i||i.call(o,s.keyId,s.keyInfo,e.privateKey)})()}secretStorageHasAESKey(){var e=this;return r(function*(){var t=yield e.secretStorage.getKey();if(!t)return!1;var[,r]=t;return r.algorithm===lc})()}getCrossSigningStatus(){var e=this;return r(function*(){var t=yield e.getOlmMachineOrThrow().getIdentity(new V_(e.userId)),r=Boolean(null==t?void 0:t.masterKey)&&Boolean(null==t?void 0:t.selfSigningKey)&&Boolean(null==t?void 0:t.userSigningKey);null==t||t.free();var n=yield hf(e.secretStorage),i=yield e.getOlmMachineOrThrow().crossSigningStatus();return{publicKeysOnDevice:r,privateKeysInSecretStorage:n,privateKeysCachedLocally:{masterKey:Boolean(null==i?void 0:i.hasMaster),userSigningKey:Boolean(null==i?void 0:i.hasUserSigning),selfSigningKey:Boolean(null==i?void 0:i.hasSelfSigning)}}})()}createRecoveryKeyFromPassphrase(e){var t=this;return r(function*(){if(e){var r=yo(32),n=yield Wa(e,r,t.RECOVERY_KEY_DERIVATION_ITERATIONS);return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:t.RECOVERY_KEY_DERIVATION_ITERATIONS,salt:r}},privateKey:n,encodedPrivateKey:Va(n)}}var i=new Uint8Array(32);return globalThis.crypto.getRandomValues(i),{privateKey:i,encodedPrivateKey:Va(i)}})()}getEncryptionInfoForEvent(e){var t=this;return r(function*(){return t.eventDecryptor.getEncryptionInfoForEvent(e)})()}getVerificationRequestsToDeviceInProgress(e){return this.olmMachine.getVerificationRequests(new V_(e)).filter(e=>void 0===e.roomId&&!e.isCancelled()).map(e=>this.makeVerificationRequest(e))}findVerificationRequestDMInProgress(e,t){if(!t)throw new Error("missing userId");var r=this.olmMachine.getVerificationRequests(new V_(t)).find(t=>{var r;return(null===(r=t.roomId)||void 0===r?void 0:r.toString())===e&&!t.isCancelled()});if(r)return this.makeVerificationRequest(r)}requestVerificationDM(e,t){var n=this;return r(function*(){var r=yield n.olmMachine.getIdentity(new V_(e));if(!r)throw new Error("unknown userId ".concat(e));try{var i=n._supportedVerificationMethods.map(e=>Sf(e)),o=yield r.verificationRequestContent(i),s=JSON.parse(o);s.msgtype="m.key.verification.request";var a=JSON.stringify(s),c=yield n.sendVerificationRequestContent(t,a),l=yield r.requestVerification(new Ym(t),new Hv(c),i);return n.makeVerificationRequest(l)}finally{r.free()}})()}sendVerificationRequestContent(e,t){var n=this;return r(function*(){var r=yo(32),{event_id:i}=yield n.http.authedRequest(jn.Put,"/_matrix/client/v3/rooms/".concat(encodeURIComponent(e),"/send/m.room.message/").concat(encodeURIComponent(r)),void 0,t,{prefix:""});return i})()}setSupportedVerificationMethods(e){this._supportedVerificationMethods=null!=e?e:Nf}requestOwnUserVerification(){var e=this;return r(function*(){var t=yield e.olmMachine.getIdentity(new V_(e.userId));if(void 0===t)throw new Error("cannot request verification for this device when there is no existing cross-signing key");try{var[r,n]=yield t.requestVerification(e._supportedVerificationMethods.map(Sf));return yield e.outgoingRequestProcessor.makeOutgoingRequest(n),e.makeVerificationRequest(r)}finally{t.free()}})()}requestDeviceVerification(e,t){var n=this;return r(function*(){var r=yield n.olmMachine.getDevice(new V_(e),new wv(t));if(!r)throw new Error("Not a known device");try{var[i,o]=r.requestVerification(n._supportedVerificationMethods.map(Sf));return yield n.outgoingRequestProcessor.makeOutgoingRequest(o),n.makeVerificationRequest(i)}finally{r.free()}})()}getSessionBackupPrivateKey(){var e=this;return r(function*(){var t=yield e.olmMachine.getBackupKeys();return t.decryptionKey?fo(t.decryptionKey.toBase64()):null})()}storeSessionBackupPrivateKey(e,t){var n=this;return r(function*(){var r=vo(e);if(!t)throw new Error("storeSessionBackupPrivateKey: version is required");yield n.backupManager.saveBackupDecryptionKey(Up.fromBase64(r),t)})()}loadSessionBackupPrivateKeyFromSecretStorage(){var e=this;return r(function*(){var t=yield e.secretStorage.get("m.megolm_backup.v1");if(!t)throw new Error("loadSessionBackupPrivateKeyFromSecretStorage: missing decryption key in secret storage");var r=yield e.backupManager.getServerBackupInfo();if(!r||!r.version)throw new Error("loadSessionBackupPrivateKeyFromSecretStorage: unable to get backup version");var n=Up.fromBase64(t);if(!Tf(n,r))throw new Error("loadSessionBackupPrivateKeyFromSecretStorage: decryption key does not match backup info");yield e.backupManager.saveBackupDecryptionKey(n,r.version)})()}getActiveSessionBackupVersion(){var e=this;return r(function*(){return yield e.backupManager.getActiveBackupVersion()})()}getKeyBackupInfo(){var e=this;return r(function*(){return(yield e.backupManager.getServerBackupInfo())||null})()}isKeyBackupTrusted(e){var t=this;return r(function*(){return yield t.backupManager.isKeyBackupTrusted(e)})()}checkKeyBackupAndEnable(){var e=this;return r(function*(){return yield e.backupManager.checkKeyBackupAndEnable(!0)})()}deleteKeyBackupVersion(e){var t=this;return r(function*(){yield t.backupManager.deleteKeyBackupVersion(e)})()}resetKeyBackup(){var e=this;return r(function*(){var t=yield e.backupManager.setupKeyBackup(t=>e.signObject(t));(yield e.secretStorageHasAESKey())&&(yield e.secretStorage.store("m.megolm_backup.v1",t.decryptionKey.toBase64())),e.checkKeyBackupAndEnable()})()}disableKeyStorage(){var e=this;return r(function*(){var t=yield e.getKeyBackupInfo();null!=t&&t.version?yield e.deleteKeyBackupVersion(t.version):e.logger.error("Can't delete key backup version: no version available"),yield e.deleteSecretStorage(),yield e.dehydratedDeviceManager.delete()})()}signObject(e){var t=this;return r(function*(){var r=new Map(Object.entries(e.signatures||{})),n=e.unsigned;delete e.signatures,delete e.unsigned;var i=r.get(t.userId)||{},o=ef.stringify(e),s=yield t.olmMachine.sign(o),a=JSON.parse(s.asJSON());r.set(t.userId,Lf(Lf({},i),a[t.userId])),void 0!==n&&(e.unsigned=n),e.signatures=Object.fromEntries(r.entries())})()}restoreKeyBackupWithPassphrase(e,t){var n=this;return r(function*(){var r=yield n.backupManager.getServerBackupInfo();if(null==r||!r.version)throw new Error("No backup info available");var i=yield function(e,t){if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return Wa(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits)}(r.auth_data,e);return yield n.storeSessionBackupPrivateKey(i,r.version),n.restoreKeyBackup(t)})()}restoreKeyBackup(e){var t=this;return r(function*(){var r=yield t.olmMachine.getBackupKeys(),{decryptionKey:n,backupVersion:i}=r;if(!n||!i)throw new Error("No decryption key found in crypto store");var o=fo(n.toBase64()),s=yield t.backupManager.requestKeyBackupVersion(i);if(!s)throw new Error("Backup version to restore ".concat(i," not found on server"));var a=yield t.getBackupDecryptor(s,o);try{var c;return null==e||null===(c=e.progressCallback)||void 0===c||c.call(e,{stage:Xa.Fetch}),yield t.backupManager.restoreKeyBackup(i,a,e)}finally{a.free()}})()}isDehydrationSupported(){var e=this;return r(function*(){return yield e.dehydratedDeviceManager.isSupported()})()}startDehydration(){var e=arguments,t=this;return r(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:{};if(!(yield t.isCrossSigningReady())||!(yield t.isSecretStorageReady()))throw new Error("Device dehydration requires cross-signing and secret storage to be set up");return yield t.dehydratedDeviceManager.start(r||{})})()}importSecretsBundle(e){var t=this;return r(function*(){var r=h_.from_json(e);yield t.getOlmMachineOrThrow().importSecretsBundle(r)})()}exportSecretsBundle(){var e=this;return r(function*(){var t=yield e.getOlmMachineOrThrow().exportSecretsBundle(),r=t.to_json();return t.free(),r})()}encryptToDeviceMessages(e,t,n){var i=this;return r(function*(){var o=new Ue(i.logger,"encryptToDeviceMessages"),s=new Set(t.map(e=>{var{userId:t}=e;return t}));yield i.keyClaimManager.ensureSessionsForUsers(o,Array.from(s).map(e=>new V_(e)));var a={batch:[],eventType:Ve.RoomMessageEncrypted};return yield Promise.all(t.map(function(){var t=r(function*(t){var{userId:r,deviceId:o}=t,s=yield i.olmMachine.getDevice(new V_(r),new wv(o));if(s){var c=JSON.parse(yield s.encryptToDeviceEvent(e,n));a.batch.push({deviceId:o,userId:r,payload:c})}else i.logger.warn("encryptToDeviceMessages: unknown device ".concat(r,":").concat(o))});return function(e){return t.apply(this,arguments)}}())),a})()}resetEncryption(e){var t=this;return r(function*(){t.logger.debug("resetEncryption: resetting encryption"),t.dehydratedDeviceManager.delete(),yield t.backupManager.deleteAllKeyBackupVersions(),yield t.deleteSecretStorage(),yield t.crossSigningIdentity.bootstrapCrossSigning({setupNewCrossSigning:!0,authUploadDeviceSigningKeys:e}),yield t.resetKeyBackup(),t.logger.debug("resetEncryption: ended")})()}deleteSecretStorage(){var e=this;return r(function*(){yield e.secretStorage.store("m.cross_signing.master",null),yield e.secretStorage.store("m.cross_signing.self_signing",null),yield e.secretStorage.store("m.cross_signing.user_signing",null),yield e.secretStorage.store("m.megolm_backup.v1",null);var t=yield e.secretStorage.getDefaultKeyId();t&&(yield e.secretStorage.store("m.secret_storage.key.".concat(t),null)),yield e.secretStorage.setDefaultKeyId(null)})()}shareRoomHistoryWithUser(e,t){var n=this;return r(function*(){var r=new Ue(n.logger,"shareRoomHistoryWithUser(".concat(e,", ").concat(t,")")),i=yield n.getOwnIdentity();if(null!=i&&i.isVerified()){r.info("Sharing message history");var o=yield n.getOlmMachineOrThrow().buildRoomKeyBundle(new Ym(e));if(o){var s=yield n.http.uploadContent(o.encryptedData);r.info("Uploaded encrypted key blob: ".concat(JSON.stringify(s)));var a=n.getOlmMachineOrThrow().queryKeysForUsers([new V_(t)]);yield n.outgoingRequestProcessor.makeOutgoingRequest(a),yield n.keyClaimManager.ensureSessionsForUsers(r,[new V_(t)]);var c=yield n.getOlmMachineOrThrow().shareRoomKeyBundleData(new V_(t),new Ym(e),s.content_uri,o.mediaEncryptionInfo,Jp.identityBasedStrategy());for(var l of c)yield n.outgoingRequestProcessor.makeOutgoingRequest(l)}else r.info("No keys to share")}else r.warn("Not sharing message history as the current device is not verified by our cross-signing identity")})()}receiveSyncChanges(e){var t=this;return r(function*(){var{events:r,oneTimeKeysCounts:n=new Map,unusedFallbackKeys:i,devices:o=new Ov}=e;return yield t.olmMachine.receiveSyncChanges(r?JSON.stringify(r):"[]",o,n,i)})()}preprocessToDeviceMessages(e){var t=this;return r(function*(){var r=yield t.receiveSyncChanges({events:e}),n=[];for(var i of r){var o=JSON.parse(i.rawEvent);if(o.type===Ve.KeyVerificationRequest){var s=o.sender,a=o.content.transaction_id;a&&s&&t.onIncomingKeyVerificationRequest(s,a)}switch(i.type){case bp.Decrypted:var c,l=i.encryptionInfo;n.push({message:o,encryptionInfo:{sender:l.sender.toString(),senderDevice:null===(c=l.senderDevice)||void 0===c?void 0:c.toString(),senderCurve25519KeyBase64:l.senderCurve25519Key,senderVerified:l.isSenderVerified()}});break;case bp.PlainText:n.push({message:o,encryptionInfo:null});case bp.UnableToDecrypt:case bp.Invalid:}}return n})()}processKeyCounts(e,t){var n=this;return r(function*(){var r=e&&new Map(Object.entries(e)),i=t&&new Set(t);void 0===r&&void 0===i||(yield n.receiveSyncChanges({oneTimeKeysCounts:r,unusedFallbackKeys:i}))})()}processDeviceLists(e){var t=this;return r(function*(){var r,n,i=new Ov(null===(r=e.changed)||void 0===r?void 0:r.map(e=>new V_(e)),null===(n=e.left)||void 0===n?void 0:n.map(e=>new V_(e)));yield t.receiveSyncChanges({devices:i})})()}onCryptoEvent(e,t){var n=this;return r(function*(){var r=t.getContent(),i=new c_;if("m.megolm.v1.aes-sha2"===r.algorithm){i.algorithm=mp.MegolmV1AesSha2,r["io.element.msc3414.encrypt_state_events"]&&n.enableEncryptedStateEvents&&(n.logger.info("crypto Enabling state event encryption..."),i.encryptStateEvents=!0);try{i.sessionRotationPeriodMs=r.rotation_period_ms,i.sessionRotationPeriodMessages=r.rotation_period_msgs,yield n.olmMachine.setRoomSettings(new Ym(e.roomId),i)}catch(t){return void n.logger.warn("Room ".concat(e.roomId,": ignoring crypto event which caused error: ").concat(t))}var o=n.roomEncryptors[e.roomId];o?o.onCryptoEvent(r):n.roomEncryptors[e.roomId]=new tf(n.logger.getChild("[".concat(e.roomId," encryption]")),n.olmMachine,n.keyClaimManager,n.outgoingRequestsManager,e,r)}else n.logger.warn("Room ".concat(e.roomId,": ignoring crypto event with invalid algorithm ").concat(r.algorithm))})()}onSyncCompleted(e){this.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{this.logger.warn("onSyncCompleted: Error processing outgoing requests",e)})}markAllTrackedUsersAsDirty(){var e=this;return r(function*(){yield e.olmMachine.markAllTrackedUsersAsDirty()})()}onIncomingKeyVerificationRequest(e,t){var r=this.olmMachine.getVerificationRequest(new V_(e),t);r?this.emit(Ha.VerificationRequestReceived,this.makeVerificationRequest(r)):this.logger.info("Ignoring just-received verification request ".concat(t," which did not start a rust-side verification"))}makeVerificationRequest(e){return new _f(this.logger,this.olmMachine,e,this.outgoingRequestProcessor,this._supportedVerificationMethods)}onRoomMembership(e,t,r){var n=this.roomEncryptors[e.getRoomId()];n&&n.onRoomMembership(t)}onRoomKeysUpdated(e){var t=this;return r(function*(){for(var r of e)t.onRoomKeyUpdated(r);t.backupManager.maybeUploadKey()})()}onRoomKeyUpdated(e){var t=this;if(!this.stopped){this.logger.debug("Got update for session ".concat(e.sessionId," from sender ").concat(e.senderKey.toBase64()," in ").concat(e.roomId.toString()));var r=this.eventDecryptor.getEventsPendingRoomKey(e.roomId.toString(),e.sessionId);if(0!==r.length){this.logger.debug("Retrying decryption on events:",r.map(e=>"".concat(e.getId())));var n=function(e){e.attemptDecryption(t,{isRetry:!0}).catch(r=>{t.logger.info("Still unable to decrypt event ".concat(e.getId()," after receiving key"))})};for(var i of r)n(i)}}}onRoomKeysWithheld(e){var t=this;return r(function*(){for(var r of e){t.logger.debug("Got withheld message for session ".concat(r.sessionId," in ").concat(r.roomId.toString()));var n=t.eventDecryptor.getEventsPendingRoomKey(r.roomId.toString(),r.sessionId);if(0===n.length)return;for(var i of(t.logger.debug("Retrying decryption on events:",n.map(e=>"".concat(e.getId()))),n))i.attemptDecryption(t,{isRetry:!0}).catch(e=>{})}})()}onUserIdentityUpdated(e){var t=this;return r(function*(){var r=yield t.getUserVerificationStatus(e.toString());t.emit(Ha.UserTrustStatusChanged,e.toString(),r),e.toString()===t.userId&&(t.emit(Ha.KeysChanged,{}),yield t.checkKeyBackupAndEnable())})()}onDevicesUpdated(e){var t=this;return r(function*(){t.emit(Ha.WillUpdateDevices,e,!1),t.emit(Ha.DevicesUpdated,e,!1)})()}handleSecretReceived(e,t){var n=this;return r(function*(){return n.logger.debug("onReceiveSecret: Received secret ".concat(e)),"m.megolm_backup.v1"===e&&(yield n.backupManager.handleBackupSecretReceived(t))})()}checkSecrets(e){var t=this;return r(function*(){var r=yield t.olmMachine.getSecretsFromInbox(e);for(var n of r)if(yield t.handleSecretReceived(e,n))break;yield t.olmMachine.deleteSecretsFromInbox(e)})()}onLiveEventFromSync(e){var t=this;return r(function*(){if(!e.isState()&&!e.getUnsigned().transaction_id){var n=function(){var n=r(function*(r){(function(e){switch(e.getType()){case Ve.KeyVerificationCancel:case Ve.KeyVerificationDone:case Ve.KeyVerificationMac:case Ve.KeyVerificationStart:case Ve.KeyVerificationKey:case Ve.KeyVerificationReady:case Ve.KeyVerificationAccept:return!0;case Ve.RoomMessage:return e.getContent().msgtype===Ge.KeyVerificationRequest;default:return!1}})(e)&&(yield t.onKeyVerificationEvent(r))});return function(e){return n.apply(this,arguments)}}();if(e.isDecryptionFailure()||e.isEncrypted()){var i=setTimeout(()=>e.off(zd.Decrypted,o),3e5),o=(t,r)=>{r||(clearTimeout(i),e.off(zd.Decrypted,o),n(t))};e.on(zd.Decrypted,o)}else yield n(e)}})()}onKeyVerificationEvent(e){var t=this;return r(function*(){var r=e.getRoomId();if(!r)throw new Error("missing roomId in the event");t.logger.debug("Incoming verification event ".concat(e.getId()," type ").concat(e.getType()," from ").concat(e.getSender())),yield t.olmMachine.receiveVerificationEvent(JSON.stringify({event_id:e.getId(),type:e.getType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getContent(),origin_server_ts:e.getTs()}),new Ym(r)),e.getType()===Ve.RoomMessage&&e.getContent().msgtype===Ge.KeyVerificationRequest&&t.onIncomingKeyVerificationRequest(e.getSender(),e.getId()),t.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{t.logger.warn("onKeyVerificationRequest: Error processing outgoing requests",e)})})()}getOwnIdentity(){var e=this;return r(function*(){return yield e.olmMachine.getIdentity(new V_(e.userId))})()}}class jf{constructor(e,t,r){this.logger=e,this.olmMachine=t,this.perSessionBackupDownloader=r,o(this,"eventsPendingKey",new _e(()=>new _e(()=>new Set)))}attemptEventDecryption(e,t){var n=this;return r(function*(){var r;switch(n.addEventToPendingList(e),t.kind){case $a.AllDevicesIsolationMode:r=Cp.Untrusted;break;case $a.OnlySignedDevicesIsolationMode:r=Cp.CrossSignedOrLegacy}try{var i=yield n.olmMachine.decryptRoomEvent(Bf(e),new Ym(e.getRoomId()),new uv(r));return n.removeEventFromPendingList(e),{clearEvent:JSON.parse(i.event),claimedEd25519Key:i.senderClaimedEd25519Key,senderCurve25519Key:i.senderCurve25519Key,forwardingCurve25519KeyChain:i.forwardingCurve25519KeyChain}}catch(t){if(!(t instanceof hm))throw new Gd(za.UNKNOWN_ERROR,"Unknown error");n.onMegolmDecryptionError(e,t,yield n.perSessionBackupDownloader.getServerBackupInfo())}})()}onMegolmDecryptionError(e,t,r){var n=e.getWireContent(),i={sender_key:n.sender_key,session_id:n.session_id};if(t.code===gp.MissingRoomKey||t.code===gp.UnknownMessageIndex){this.perSessionBackupDownloader.onDecryptionKeyMissingError(e.getRoomId(),n.session_id);var o=e.getMembershipAtEvent();if(o&&o!==lt.Join&&o!==lt.Invite)throw new Gd(za.HISTORICAL_MESSAGE_USER_NOT_JOINED,"This message was sent when we were not a member of the room.",i);if(e.getTs()<=this.olmMachine.deviceCreationTimeMs)throw null===r?new Gd(za.HISTORICAL_MESSAGE_NO_KEY_BACKUP,"This message was sent before this device logged in, and there is no key backup on the server.",i):this.perSessionBackupDownloader.isKeyBackupDownloadConfigured()?new Gd(za.HISTORICAL_MESSAGE_WORKING_BACKUP,"This message was sent before this device logged in. Key backup is working, but we still do not (yet) have the key.",i):new Gd(za.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED,"This message was sent before this device logged in, and key backup is not working.",i)}if(t.maybe_withheld){var s="The sender has disabled encrypting to unverified devices."===t.maybe_withheld?za.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:za.MEGOLM_KEY_WITHHELD;throw new Gd(s,t.maybe_withheld,i)}switch(t.code){case gp.MissingRoomKey:throw new Gd(za.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",i);case gp.UnknownMessageIndex:throw new Gd(za.OLM_UNKNOWN_MESSAGE_INDEX,"The sender's device has not sent us the keys for this message at this index.",i);case gp.SenderIdentityVerificationViolation:throw this.removeEventFromPendingList(e),new Gd(za.SENDER_IDENTITY_PREVIOUSLY_VERIFIED,"The sender identity is unverified, but was previously verified.");case gp.UnknownSenderDevice:throw this.removeEventFromPendingList(e),new Gd(za.UNKNOWN_SENDER_DEVICE,"The sender device is not known.");case gp.UnsignedSenderDevice:throw this.removeEventFromPendingList(e),new Gd(za.UNSIGNED_SENDER_DEVICE,"The sender identity is not cross-signed.");default:throw new Gd(za.UNKNOWN_ERROR,t.description,i)}}getEncryptionInfoForEvent(e){var t=this;return r(function*(){if(!e.getClearContent()||e.isDecryptionFailure())return null;if(null!==e.status)return{shieldColour:ec.NONE,shieldReason:null};var r=yield t.olmMachine.getRoomEventEncryptionInfo(Bf(e),new Ym(e.getRoomId()));return function(e,t){if(void 0===t)return null;var r,n,i=t.shieldState(!1);switch(i.color){case Rp.Grey:r=ec.GREY;break;case Rp.None:r=ec.NONE;break;default:r=ec.RED}switch(i.code){case void 0:case null:n=null;break;case Ip.AuthenticityNotGuaranteed:n=tc.AUTHENTICITY_NOT_GUARANTEED;break;case Ip.UnknownDevice:n=tc.UNKNOWN_DEVICE;break;case Ip.UnsignedDevice:n=tc.UNSIGNED_DEVICE;break;case Ip.UnverifiedIdentity:n=tc.UNVERIFIED_IDENTITY;break;case Ip.SentInClear:n=tc.SENT_IN_CLEAR;break;case Ip.VerificationViolation:n=tc.VERIFICATION_VIOLATION;break;case Ip.MismatchedSender:n=tc.MISMATCHED_SENDER;break;default:n=tc.UNKNOWN}return{shieldColour:r,shieldReason:n}}(t.logger,r)})()}getEventsPendingRoomKey(e,t){var r=this.eventsPendingKey.get(e);if(!r)return[];var n=r.get(t);return n?[...n]:[]}addEventToPendingList(e){var t=e.getRoomId();t&&this.eventsPendingKey.getOrCreate(t).getOrCreate(e.getWireContent().session_id).add(e)}removeEventFromPendingList(e){var t=e.getRoomId();if(t){var r=this.eventsPendingKey.getOrCreate(t);if(r){var n=r.get(e.getWireContent().session_id);n&&(n.delete(e),0===n.size&&(r.delete(e.getWireContent().session_id),0===r.size&&this.eventsPendingKey.delete(t)))}}}}function Bf(e){return JSON.stringify({event_id:e.getId(),type:e.getWireType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getWireContent(),origin_server_ts:e.getTs()})}function Kf(){return Kf=r(function*(e){var t,{logger:r,legacyStore:n}=e;if(yield Q_(),yield n.containsData()){yield n.startup();var i=null;if(yield n.doTxn("readonly",[vg.STORE_ACCOUNT],e=>{n.getAccount(e,e=>{i=e})}),i){var o=yield n.getMigrationState();if(!(o>=ye.MEGOLM_SESSIONS_MIGRATED)){var s=yield function(e,t){return Vf.apply(this,arguments)}(r,n),a=yield function(e,t){return Wf.apply(this,arguments)}(r,n),c=1+s+a;r.info("Migrating data from legacy crypto store. ".concat(s," olm sessions and ").concat(a," megolm sessions to migrate."));var l=0;u(0);var d=(new TextEncoder).encode(e.legacyPickleKey);o===ye.NOT_STARTED&&(r.info("Migrating data from legacy crypto store. Step 1: base data"),yield function(e,t,r,n,i,o,s){return qf.apply(this,arguments)}(e.http,e.userId,e.deviceId,n,d,e.storeHandle,r),o=ye.INITIAL_DATA_MIGRATED,yield n.setMigrationState(o)),u(1),o===ye.INITIAL_DATA_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 2: olm sessions (".concat(s," sessions to migrate).")),yield function(e,t,r,n,i){return Gf.apply(this,arguments)}(r,n,d,e.storeHandle,u),o=ye.OLM_SESSIONS_MIGRATED,yield n.setMigrationState(o)),o===ye.OLM_SESSIONS_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 3: megolm sessions (".concat(a," sessions to migrate).")),yield function(e,t,r,n,i){return Hf.apply(this,arguments)}(r,n,d,e.storeHandle,u),o=ye.MEGOLM_SESSIONS_MIGRATED,yield n.setMigrationState(o)),null===(t=e.legacyMigrationProgressListener)||void 0===t||t.call(e,-1,-1),r.info("Migration from legacy crypto store complete")}}else r.debug("Legacy crypto store is not set up (no account found). Not migrating.")}function u(t){var r;l+=t,null===(r=e.legacyMigrationProgressListener)||void 0===r||r.call(e,l,c)}}),Kf.apply(this,arguments)}function qf(){return qf=r(function*(e,t,r,n,i,o,s){var a=new Vp;a.userId=new V_(t),a.deviceId=new wv(r),yield n.doTxn("readonly",[vg.STORE_ACCOUNT],e=>n.getAccount(e,e=>{a.pickledAccount=null!=e?e:""}));var c=yield $f(n,i,"m.megolm_backup.v1");if(c){for(var l=!1,d=null;!l;)try{d=yield If(e),l=!0}catch(e){s.info("Failed to get backup version during migration, retrying in 2 seconds",e),yield z(2e3)}if(d&&"m.megolm_backup.v1.curve25519-aes-sha2"==d.algorithm)try{var u,h=Up.fromBase64(c),g=null===(u=d.auth_data)||void 0===u?void 0:u.public_key;h.megolmV1PublicKey.publicKeyBase64==g?(a.backupVersion=d.version,a.backupRecoveryKey=c):s.debug("The backup key to migrate does not match the active backup version","Cached pub key: ".concat(h.megolmV1PublicKey.publicKeyBase64),"Active pub key: ".concat(g))}catch(e){s.warn("Failed to check if the backup key to migrate matches the active backup version",e)}}a.privateCrossSigningMasterKey=yield $f(n,i,"master"),a.privateCrossSigningSelfSigningKey=yield $f(n,i,"self_signing"),a.privateCrossSigningUserSigningKey=yield $f(n,i,"user_signing"),yield mm.migrateBaseData(a,i,o,s)}),qf.apply(this,arguments)}function Vf(){return Vf=r(function*(e,t){var r;return e.debug("Counting olm sessions to be migrated"),yield t.doTxn("readonly",[vg.STORE_SESSIONS],e=>t.countEndToEndSessions(e,e=>r=e)),r}),Vf.apply(this,arguments)}function Wf(){return Wf=r(function*(e,t){return e.debug("Counting megolm sessions to be migrated"),yield t.countEndToEndInboundGroupSessions()}),Wf.apply(this,arguments)}function Gf(){return Gf=r(function*(e,t,r,n,i){for(;;){var o=yield t.getEndToEndSessionsBatch();if(null===o)return;e.debug("Migrating batch of ".concat(o.length," olm sessions"));var s=[];for(var a of o){var c=new Cm;c.senderKey=a.deviceKey,c.pickle=a.session,c.lastUseTime=c.creationTime=new Date(a.lastReceivedMessageTs),s.push(c)}yield mm.migrateOlmSessions(s,r,n,e),yield t.deleteEndToEndSessionsBatch(o),i(o.length)}}),Gf.apply(this,arguments)}function Hf(){return Hf=r(function*(e,t,r,n,i){for(;;){var o=yield t.getEndToEndInboundGroupSessionsBatch();if(null===o)return;e.debug("Migrating batch of ".concat(o.length," megolm sessions"));var s=[];for(var a of o){var c,l=a.sessionData,d=new km;d.pickle=l.session,d.roomId=new Ym(l.room_id),d.senderKey=a.senderKey,d.senderSigningKey=null===(c=l.keysClaimed)||void 0===c?void 0:c.ed25519,d.backedUp=!a.needsBackup,d.imported=!0===l.untrusted,s.push(d)}yield mm.migrateMegolmSessions(s,r,n,e),yield t.deleteEndToEndInboundGroupSessionsBatch(o),i(o.length)}}),Hf.apply(this,arguments)}function zf(){return zf=r(function*(e){var{logger:t,legacyStore:r,olmMachine:n}=e;if((yield r.containsData())&&!((yield r.getMigrationState())>=ye.ROOM_SETTINGS_MIGRATED)){var i={};for(var[o,s]of(yield r.doTxn("readwrite",[vg.STORE_ROOMS],e=>{r.getEndToEndRooms(e,e=>{i=e})}),t.debug("Migrating ".concat(Object.keys(i).length," sets of room settings")),Object.entries(i)))try{var a=new c_;if("m.megolm.v1.aes-sha2"!==s.algorithm){t.warn("Room ".concat(o,": ignoring room with invalid algorithm ").concat(s.algorithm));continue}a.algorithm=mp.MegolmV1AesSha2,a.sessionRotationPeriodMs=s.rotation_period_ms,a.sessionRotationPeriodMessages=s.rotation_period_msgs,yield n.setRoomSettings(new Ym(o),a)}catch(e){t.warn("Room ".concat(o,": ignoring settings ").concat(JSON.stringify(s)," which caused error ").concat(e))}t.debug("Completed room settings migration"),yield r.setMigrationState(ye.ROOM_SETTINGS_MIGRATED)}}),zf.apply(this,arguments)}function $f(e,t,r){return Jf.apply(this,arguments)}function Jf(){return(Jf=r(function*(e,t,r){var n=yield new Promise(t=>{e.doTxn("readonly",[vg.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,r)})});return n&&n.ciphertext&&n.iv&&n.mac?yield ac(n,t,r):n instanceof Uint8Array?vo(n):void 0})).apply(this,arguments)}function Yf(){return Yf=r(function*(e){var{legacyCryptoStore:t,rustCrypto:r,logger:n}=e,i=yield r.getOwnIdentity();if(i&&!i.isVerified()){var o=yield function(e){return Qf.apply(this,arguments)}(t);if(o){var s=JSON.parse(i.masterKey);if(s.keys&&0!==Object.keys(s.keys).length){var a=Object.values(s.keys)[0];a&&a==o&&(n.info("Post Migration: Migrating legacy trusted MSK: ".concat(o," to locally verified.")),yield i.verify())}else n.error("Post Migration | Unexpected error: no master key in the rust session.")}}}),Yf.apply(this,arguments)}function Qf(){return(Qf=r(function*(e){var t=null;return yield e.doTxn("readonly","account",r=>{e.getCrossSigningKeys(r,e=>{var r=null==e?void 0:e.master;r&&0!=Object.keys(r.keys).length&&(t=Object.values(r.keys)[0])})}),t})).apply(this,arguments)}function Xf(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Zf(){return Zf=r(function*(e){var t,{logger:r}=e;r.debug("Initialising Rust crypto-sdk WASM artifact"),yield Q_(),r.debug("Opening Rust CryptoStore"),t=e.storePrefix?e.storeKey?yield k_.openWithKey(e.storePrefix,e.storeKey,r):yield k_.open(e.storePrefix,e.storePassphrase,r):yield k_.open(null,null,r),e.legacyCryptoStore&&(yield function(e){return Kf.apply(this,arguments)}(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Xf(Object(r),!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Xf(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({legacyStore:e.legacyCryptoStore,storeHandle:t},e)));var n=yield function(e,t,r,n,i,o,s,a,c){return ey.apply(this,arguments)}(r,e.http,e.userId,e.deviceId,e.secretStorage,e.cryptoCallbacks,t,e.legacyCryptoStore,e.enableEncryptedStateEvents);return t.free(),r.debug("Completed rust crypto-sdk setup"),n}),Zf.apply(this,arguments)}function ey(){return ey=r(function*(e,t,r,n,i,o,s,a,c){e.debug("Init OlmMachine");var l=yield fm.initFromStore(new V_(r),new wv(n),s,e);a&&(yield function(e){return zf.apply(this,arguments)}({logger:e,legacyStore:a,olmMachine:l})),l.roomKeyRequestsEnabled=!1;var d=new Ff(e,l,t,r,n,i,o,c);if((yield l.registerRoomKeyUpdatedCallback(e=>d.onRoomKeysUpdated(e)),yield l.registerRoomKeysWithheldCallback(e=>d.onRoomKeysWithheld(e)),yield l.registerUserIdentityUpdatedCallback(e=>d.onUserIdentityUpdated(e)),yield l.registerDevicesUpdatedCallback(e=>d.onDevicesUpdated(e)),d.checkSecrets("m.megolm_backup.v1"),yield l.registerReceiveSecretCallback((e,t)=>d.checkSecrets(e)),yield l.outgoingRequests(),a&&(yield a.containsData()))&&(yield a.getMigrationState())<ye.INITIAL_OWN_KEY_QUERY_DONE){e.debug("Performing initial key query after migration");for(var u=!1;!u;)try{yield d.userHasCrossSigningKeys(r),u=!0}catch(t){e.error("Failed to check for cross-signing keys after migration, retrying",t)}yield function(e){return Yf.apply(this,arguments)}({legacyCryptoStore:a,rustCrypto:d,logger:e}),yield a.setMigrationState(ye.INITIAL_OWN_KEY_QUERY_DONE)}return d}),ey.apply(this,arguments)}var ty=Object.freeze({__proto__:null,initRustCrypto:function(e){return Zf.apply(this,arguments)}});return Pg});
